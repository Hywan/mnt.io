<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="content-security-policy" content="default-src 'self'; child-src 'self' https://www.youtube-nocookie.com; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:">
  <meta name="viewport" content="width=device-width, minimum-scale=1">

  <title>Prelude</title>

  <link rel="stylesheet" href="https://mnt.io/style/min/main.css?h=c1d7c9eded14e7411b85">
  <link rel="stylesheet" href="https://mnt.io/style/min/syntax-theme.css?h=ef9797b0398b3ffe9058">
  <link rel="stylesheet" href="https://mnt.io/style/min/search.css" fetchpriority="low">

  <meta name="author" content="Ivan Enderlin">
  <meta name="description" content="Let&#x27;s start by explaining what Gutenberg is, how our own Rust works, and what we need to do.">
  <meta name="keywords" content="rust, binding, gutenberg">
  <meta property="og:title" content="Prelude ‚Äî from the series From Rust to beyond">
  <meta property="og:site_name" content="mnt.io">
  <meta property="og:locale" content="en_GB">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://mnt.io/series/from-rust-to-beyond/prelude/">
  <meta property="og:image" content="https://mnt.io/image/site-poster.jpg">
  <meta name="fediverse:creator" content="@hywan@floss.social">

  <script defer src="https://mnt.io/search/pagefind-ui.js" fetchpriority="low"></script>
</head>
<body class="content-grid">

<nav id="menu" class="full-width content-grid">
  <ul>
    <li><a href="/" accesskey="h">Home</a></li>
    <li><a href="https://mnt.io/articles/" accesskey="a">Articles</a></li>
    <li><a href="https://mnt.io/series/" accesskey="s">Series</a></li>
    <li><a href="https://matrix.to/#/&#x23;mnt_io:matrix.org" title="Public Matrix room to discuss about this blog's content" target="_blank" accesskey="d">Discuss</a></li>
    <li>
      <a href="javascript:document.getElementById('search').showModal()" accesskey="k">
        <svg viewBox="0 0 500 500" class="icon">
          <description>Search</description>
          <circle r="180" cx="210" cy="210" fill="none" stroke="currentColor" stroke-width="40" />
          <line x1="340" y1="340" x2="480" y2="480" stroke="currentColor" stroke-width="40" stroke-linecap="round" />
        </svg>
      </a>
    </li>
  </ul>
</nav>

<dialog id="search" tabindex="-1" closedby="any"></dialog>

<main vocab="https://schema.org">

  <article class="series-episode" typeof="Article" data-pagefind-body>
    <header>
      <h1 property="name" style="view-transition-name: series-episode-title-prelude">Prelude</h1>

      <nav property="isPartOf" typeof="CreativeWorkSeries">
        <p>From the series <a href="/series/from-rust-to-beyond/" property="url"><span property="name">From Rust to beyond</span></a>.</p>
      </nav>

      
  <div class="metadata" data-pagefind-ignore="all">
    <time title="Published date" datetime="2018-08-21" property="datePublished">August 21, 2018</time>
    <span title="Reading time" property="timeRequired" content="PT5M">5 minutes read</span>
    
    <span title="Keywords" property="keywords" content="rust, binding, gutenberg">
      Keywords:&nbsp;<a href="/keywords/rust">rust</a>, <a href="/keywords/binding">binding</a>, <a href="/keywords/gutenberg">gutenberg</a></span>
    
      <span><a href="https://github.com/Hywan/mnt.io/edit/main/content/series&#x2F;from-rust-to-beyond&#x2F;2018-08-21-prelude&#x2F;index.md" title="Submit a patch for this page">Edit</a> this page</span>
      
      <meta property="description" content="Let&#x27;s start by explaining what Gutenberg is, how our own Rust works, and what we need to do." />
      
    
  </div>

    </header>

    <p><a rel="noopener external" target="_blank" href="https://automattic.com/">At my work</a>, I had an opportunity to start an
experiment: Writing a single parser implementation in Rust for <a rel="noopener external" target="_blank" href="https://github.com/WordPress/gutenberg">the new
Gutenberg post format</a>, bound to
many platforms and environments.</p>
<figure>
<p><img src="https://mnt.io/series/from-rust-to-beyond/prelude/./gutenberg.png" alt="Gutenberg&#39;s logo" loading="lazy" decoding="async" /></p>
  <figcaption>
<p>Gutenberg&#39;s logo.</p>
  </figcaption>
</figure>
<p>This series of posts is about those bindings, and explains how to send
Rust beyond earth, into many different galaxies.</p>
<h2 id="">The Gutenberg post format<a role="presentation" class="anchor" href="#" title="Anchor link to this header">#</a>
</h2>
<p>Let&#39;s introduce quickly what Gutenberg is, and why a new post format. If
you want an in-depth presentation, I highly recommend to read <a rel="noopener external" target="_blank" href="https://lamda.blog/2018/04/22/the-language-of-gutenberg/">The
Language of
Gutenberg</a>.
Note that this is¬†<em>not</em> required for the reader to understand the
Gutenberg post format.</p>
<p><a rel="noopener external" target="_blank" href="https://github.com/WordPress/gutenberg">Gutenberg</a> is the next
WordPress editor. It is a little revolution on its own. The features it
unlocks are very powerful.</p>
<blockquote>
<p>The editor will create a new page- and post-building experience that
makes writing rich posts effortless, and has ‚Äúblocks‚Äù to make it easy
what today might take shortcodes, custom HTML, or ‚Äúmystery meat‚Äù embed
discovery. ‚Äî Matt Mullenweg</p>
</blockquote>
<p>The format of a blog post was HTML. And it continues to be. However,
another semantics layer is added through annotations. Annotations are
written in comments and borrow the XML syntax, e.g.:</p>
<pre class="giallo z-code"><code data-lang="xml"><span class="giallo-l"><span class="z-comment">&lt;!-- wp:ns/block-name {&quot;attributes&quot;: &quot;as JSON&quot;} --&gt;</span></span>
<span class="giallo-l"><span class="z-punctuation z-definition z-tag">  &lt;</span><span class="z-entity z-name z-tag">p</span><span class="z-punctuation z-definition z-tag">&gt;</span><span>phrase</span><span class="z-punctuation z-definition z-tag">&lt;/</span><span class="z-entity z-name z-tag">p</span><span class="z-punctuation z-definition z-tag">&gt;</span></span>
<span class="giallo-l"><span class="z-comment">&lt;!-- /wp:ns/block-name --&gt;</span></span></code></pre>
<p>The Gutenberg format provides 2 constructions: Block, and Phrase. The
example above contains both: There is a block wrapping a phrase. A
phrase is basically anything that is not a block. Let&#39;s describe the
example:</p>
<ul>
<li>It starts with an annotation (<code>&lt;!-- ‚Ä¶ --&gt;</code>),</li>
<li>The <code>wp:</code> is mandatory to represent a Gutenberg block,</li>
<li>It is followed by a fully qualified block name, which is a pair of an optional
namespace (here sets to <code>ns</code> , defaults to <code>core</code>) and a block name (here
sets to <code>block-name</code>), separated by a slash,</li>
<li>A block has optional attributes encoded as a JSON object (see
<a rel="noopener external" target="_blank" href="https://tools.ietf.org/html/rfc7159">RFC 7159, Section 4, Objects</a>),</li>
<li>Finally, a block has optional children, i.e. a heterogeneous collection of
blocks or phrases. In the example above, there is one child that is the phrase
<code>&lt;p&gt;phrase&lt;/p&gt;</code>. And the following example below shows a block with no child:</li>
</ul>
<pre class="giallo z-code"><code data-lang="xml"><span class="giallo-l"><span class="z-comment">&lt;!-- wp:ns/block-name {&quot;attributes&quot;: &quot;as JSON&quot;} /--&gt;</span></span></code></pre>
<p>The complete grammar can be found in <a rel="noopener external" target="_blank" href="https://hywan.github.io/gutenberg-parser-rs/gutenberg_post_parser/parser/index.html">the parser&#39;s
documentation</a>.</p>
<p>Finally, the parser is used on the <em>editor</em> side, not on the <em>rendering</em>
side. Once rendered, the blog post is a regular HTML file. Some blocks
are dynamics though, but this is another topic.</p>
<figure>
<p><img src="https://mnt.io/series/from-rust-to-beyond/prelude/./block-logic-flow.png" alt="Block logic flow" loading="lazy" decoding="async" /></p>
  <figcaption>
<p>The logic flow of the editor (<a rel="noopener external" target="_blank" href="https://make.wordpress.org/core/2017/05/05/editor-how-little-blocks-work/">How Little Blocks
Work</a>).</p>
  </figcaption>
</figure>
<p>The grammar is relatively small. The challenges are however to be as
much performant and memory efficient as possible on many platforms. Some
posts can reach megabytes, and we don&#39;t want the parser to be the
bottleneck. Even if it is used when creating the post state (cf. the
schema above), we have measured several seconds to load some posts. Time
during which the user is blocked, and waits, or see an error. In other
scenarii, we have hit memory limit of the language&#39;s virtual machines.</p>
<p>Hence this experimental project! The current parsers are written in
JavaScript (with <a rel="noopener external" target="_blank" href="https://pegjs.org/">PEG.js</a>) and in PHP (with
<a rel="noopener external" target="_blank" href="https://github.com/nylen/phpegjs"><code>phpegjs</code></a>). This Rust project
proposes a parser written in Rust, that can run in the JavaScript and in
the PHP virtual machines, and on many other platforms. Let&#39;s try to be
very performant and memory efficient!</p>
<h2 id="-1">Why Rust?<a role="presentation" class="anchor" href="#-1" title="Anchor link to this header">#</a>
</h2>
<p>That&#39;s an excellent question! Thanks for asking. I can summarize my
choice with a bullet list:</p>
<ul>
<li>It is fast, and we need speed,</li>
<li>It is memory safe, and also memory efficient,</li>
<li>No garbage collector, which simplifies memory management across
environments,</li>
<li>It can expose a C API (<a rel="noopener external" target="_blank" href="https://doc.rust-lang.org/std/ffi/index.html">with Foreign Function Interface,
FFI</a>), which eases the
integration into multiple environments,</li>
<li>It compiles to <a rel="noopener external" target="_blank" href="https://doc.rust-lang.org/nightly/rustc/platform-support.html">many
targets</a>,</li>
<li>Because I love it.</li>
</ul>
<p>One of the goal of the experimentation is to maintain a single
implementation (maybe the future reference implementation) with multiple
bindings.</p>
<h2 id="-2">The parser<a role="presentation" class="anchor" href="#-2" title="Anchor link to this header">#</a>
</h2>
<p>The parser is written in Rust. It relies on the fabulous <a rel="noopener external" target="_blank" href="https://github.com/Geal/nom/">nom
library</a>.</p>
<figure>
<p><img src="https://mnt.io/series/from-rust-to-beyond/prelude/./nom.png" alt="nom" loading="lazy" decoding="async" /></p>
  <figcaption>
<p><em>nom will happily take a byte out of your files</em> üôÇ</p>
  </figcaption>
</figure>
<p>The source code is available in <a rel="noopener external" target="_blank" href="https://github.com/Hywan/gutenberg-parser-rs">the <code>src/</code> directory in the
repository</a>. It is very
small and fun to read.</p>
<p>The parser produces an Abstract Syntax Tree (AST) of the grammar, where
nodes of the tree are defined as:</p>
<pre class="giallo z-code"><code data-lang="rust"><span class="giallo-l"><span class="z-keyword">pub</span><span class="z-storage"> enum</span><span class="z-entity z-name"> Node</span><span>&lt;&#39;</span><span class="z-entity z-name">a</span><span>&gt; {</span></span>
<span class="giallo-l"><span class="z-entity z-name">    Block</span><span> {</span></span>
<span class="giallo-l"><span class="z-variable">        name</span><span class="z-keyword z-operator">:</span><span> (</span><span class="z-entity z-name">Input</span><span>&lt;&#39;</span><span class="z-entity z-name">a</span><span>&gt;,</span><span class="z-entity z-name"> Input</span><span>&lt;&#39;</span><span class="z-entity z-name">a</span><span>&gt;),</span></span>
<span class="giallo-l"><span class="z-variable">        attributes</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> Option</span><span>&lt;</span><span class="z-entity z-name">Input</span><span>&lt;&#39;</span><span class="z-entity z-name">a</span><span>&gt;&gt;,</span></span>
<span class="giallo-l"><span class="z-variable">        children</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> Vec</span><span>&lt;</span><span class="z-entity z-name">Node</span><span>&lt;&#39;</span><span class="z-entity z-name">a</span><span>&gt;&gt;</span></span>
<span class="giallo-l"><span>    },</span></span>
<span class="giallo-l"><span class="z-entity z-name z-function">    Phrase</span><span>(</span><span class="z-entity z-name">Input</span><span>&lt;&#39;</span><span class="z-entity z-name">a</span><span>&gt;)</span></span>
<span class="giallo-l"><span>}</span></span></code></pre>
<p>That&#39;s all! We find again the block name, the attributes and the
children, and the phrase. Block children are defined as a collection of
node, this is recursive. <code>Input&lt;'a&gt;</code> is defined as <code>&amp;'a [u8]</code>, i.e. a
slice of bytes.</p>
<p>The main parser entry is <a rel="noopener external" target="_blank" href="https://hywan.github.io/gutenberg-parser-rs/gutenberg_post_parser/fn.root.html">the <code>root</code>
function</a>.
It represents the axiom of the grammar, and is defined as:</p>
<pre class="giallo z-code"><code data-lang="rust"><span class="giallo-l"><span class="z-keyword">pub fn</span><span class="z-entity z-name z-function"> root</span><span>(</span></span>
<span class="giallo-l"><span class="z-variable">¬†¬†¬† input</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> Input</span></span>
<span class="giallo-l"><span>)</span><span class="z-keyword z-operator"> -&gt;</span><span class="z-entity z-name"> Result</span><span>&lt;(</span><span class="z-entity z-name">Input</span><span>,</span><span class="z-entity z-name"> Vec</span><span>&lt;</span><span class="z-variable">ast</span><span class="z-keyword z-operator">::</span><span class="z-entity z-name">Node</span><span>&gt;),</span><span class="z-variable"> nom</span><span class="z-keyword z-operator">::</span><span class="z-entity z-name">Err</span><span>&lt;</span><span class="z-entity z-name">Input</span><span>&gt;&gt;;</span></span></code></pre>
<p>So the parser returns a collection of nodes in the best case. Here is an
simple example:</p>
<pre class="giallo z-code"><code data-lang="rust"><span class="giallo-l"><span class="z-keyword">use</span><span class="z-entity z-name"> gutenberg_post_parser</span><span class="z-keyword z-operator">::</span><span>{root,</span><span class="z-entity z-name"> ast</span><span class="z-keyword z-operator">::</span><span class="z-entity z-name">Node</span><span>};</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage">let</span><span class="z-variable"> input</span><span class="z-keyword z-operator"> = &amp;</span><span class="z-string">b&quot;&lt;!-- wp:foo {</span><span class="z-constant z-character">\&quot;</span><span class="z-string">bar</span><span class="z-constant z-character">\&quot;</span><span class="z-string">: true} /--&gt;&quot;</span><span>[</span><span class="z-keyword z-operator">..</span><span>];</span></span>
<span class="giallo-l"><span class="z-storage">let</span><span class="z-variable"> output</span><span class="z-keyword z-operator"> =</span><span class="z-entity z-name"> Ok</span><span>(</span></span>
<span class="giallo-l"><span>    (</span></span>
<span class="giallo-l"><span class="z-comment">        // The remaining data.</span></span>
<span class="giallo-l"><span class="z-keyword z-operator">        &amp;</span><span class="z-string">b&quot;&quot;</span><span>[</span><span class="z-keyword z-operator">..</span><span>],</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // The Abstract Syntax Tree.</span></span>
<span class="giallo-l"><span class="z-entity z-name z-function">        vec!</span><span>[</span></span>
<span class="giallo-l"><span class="z-entity z-name">            Node</span><span class="z-keyword z-operator">::</span><span class="z-entity z-name">Block</span><span> {</span></span>
<span class="giallo-l"><span class="z-variable">                name</span><span class="z-keyword z-operator">:</span><span> (</span><span class="z-keyword z-operator">&amp;</span><span class="z-string">b&quot;core&quot;</span><span>[</span><span class="z-keyword z-operator">..</span><span>],</span><span class="z-keyword z-operator"> &amp;</span><span class="z-string">b&quot;foo&quot;</span><span>[</span><span class="z-keyword z-operator">..</span><span>]),</span></span>
<span class="giallo-l"><span class="z-variable">                attributes</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> Some</span><span>(</span><span class="z-keyword z-operator">&amp;</span><span class="z-string">b&quot;{</span><span class="z-constant z-character">\&quot;</span><span class="z-string">bar</span><span class="z-constant z-character">\&quot;</span><span class="z-string">: true}&quot;</span><span>[</span><span class="z-keyword z-operator">..</span><span>]),</span></span>
<span class="giallo-l"><span class="z-variable">                children</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name z-function"> vec!</span><span>[]</span></span>
<span class="giallo-l"><span>            }</span></span>
<span class="giallo-l"><span>        ]</span></span>
<span class="giallo-l"><span>    )</span></span>
<span class="giallo-l"><span>);</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-entity z-name z-function">assert_eq!</span><span>(</span><span class="z-entity z-name z-function">root</span><span>(</span><span class="z-variable">input</span><span>),</span><span class="z-variable"> output</span><span>);</span></span></code></pre>
<p>The <code>root</code> function and the AST will be the items we are going to use
and manipulate in the bindings. The internal items of the parser will
stay private.</p>
<h2 id="-3">Bindings<a role="presentation" class="anchor" href="#-3" title="Anchor link to this header">#</a>
</h2>
<figure role="presentation">
<p><img src="https://mnt.io/series/from-rust-to-beyond/prelude/./rust-to.png" alt="Rust to" loading="lazy" decoding="async" /></p>
</figure>
<p>From now, our goal is to expose the <code>root</code> function and the <code>Node</code> enum
in different platforms or environments. Ready?</p>
<p>3‚Ä¶ 2‚Ä¶ 1‚Ä¶ lift-off!</p>


    <nav class="previous-next-episodes"><a href="https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;" class="button text-align-end">The WebAssembly galaxy&nbsp;‚ùØ</a></nav>
  </article>

</main>

<footer class="full-width content-grid">
  <div class="footer">
    <div>
      <h2>Contact me</h2>

      <ul>
        <li><a href="https://matrix.to/#/@mnt_io:matrix.org" title="Say hi on Matrix">@mnt_io:matrix.org</a></li>
        <li><a href="mailto:ivan@mnt.io" title="Good ol' email">ivan@mnt.io</a></li>
        <li><a href="https://floss.social/@hywan" title="Say hi on Mastodon" rel="me">Mastodon</a></li>
        <li><a href="https://github.com/Hywan" title="Say hi on Github">Github</a></li>
      </ul>
    </div>
    <div>
      <h2>Recommendations</h2>

      <ul>
        <li><a href="https://fasterthanli.me/">fasterthanli.me</a></li>
        <li><a href="https://without.boats/blog/">without.boats</a></li>
        <li><a href="https://faultlore.com/blah/">faultlore</a></li>
        <li><a href="https://smallcultfollowing.com/babysteps/blog/">smallcultfollowing</a></li>
        <li><a href="https://orlp.net/blog/">orlp</a></li>
        <li><a href="https://blog.m-ou.se/">m-ou.se</a></li>
        <li><a href="https://nadrieril.github.io/">nadrieril</a></li>
      </ul>
    </div>

    <div>
      <h2>More</h2>

      <ul>
        <li><a href="https://mnt.io/lore/">Lore</a></li>
        <li><a href="https://mnt.io/rss.xml">RSS</a></li>
        <li><a href="https://mnt.io/atom.xml">Atom</a></li>
        <li><a href="https://github.com/Hywan/mnt.io" title="Source code of this site">Source code</a></li>
        <li><a href="https://dblp.org/search/index.php?query=Ivan%20Enderlin" title="Computer Science Bibliography">DBLP</a></li>
      </ul>
    </div>
  </div>
</footer>

<script>
  window.addEventListener('DOMContentLoaded', (_event) => {
    new PagefindUI({
      element: "#search",
      resetStyles: false,
      showSubResults: true,
      showImages: false,
    });
  });
</script>
</body>
</html>
