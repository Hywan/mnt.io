<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta http-equiv="content-security-policy" content="default-src 'self'; child-src 'self' https://www.youtube-nocookie.com; script-src 'self' https://cloud.umami.is">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Observability</title>

  <link rel="stylesheet" href="https://mnt.io/style/min/main.css?h=07499e1a541446a085e6" />
  <link rel="stylesheet" href="https://mnt.io/style/min/syntax-theme.css?h=ef9797b0398b3ffe9058" />

  <meta name="author" content="Ivan Enderlin" />
  <meta name="description" content="The basis of reactive programming is observability. Let&#x27;s play with it." />
  <meta name="keywords" content="rust, async, future, stream" />
  <meta property="og:title" content="Observability — from the series Reactive programming in Rust" />
  <meta property="og:site_name" content="mnt.io" />
  <meta property="og:locale" content="en_GB" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="https://mnt.io/series/reactive-programming-in-rust/observability/" />
  <meta property="og:image" content="https://mnt.io/image/site-poster.jpg">
  <meta name="fediverse:creator" content="@hywan@floss.social" />
</head>
<body class="content-grid">

<nav id="menu" class="full-width content-grid">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="https://mnt.io/articles/">Articles</a></li>
    <li><a href="https://mnt.io/series/">Series</a></li>
    <li><a href="https://matrix.to/#/&#x23;mnt_io:matrix.org" title="Public Matrix room to discuss about this blog's content">Discuss</a></li>
  </ul>
</nav>

<main vocab="https://schema.org">

  <article class="series-episode" typeof="Article">
    <header>
      <h1 property="name">Observability</h1>

      <nav property="isPartOf" typeof="CreativeWorkSeries">
        <p>From the series <a href="/series/reactive-programming-in-rust/" property="url"><span property="name">Reactive programming in Rust</span></a>.</p>
      </nav>

      
  <div class="metadata">
    <time title="Published date" datetime="2024-09-19" property="datePublished">September 19, 2024</time>
    <span title="Reading time" property="timeRequired" content="PT24M">24 minutes read</span>
    
    <span title="Keywords" property="keywords" content="rust, async, future, stream">
      Keywords:&nbsp;<a href="/keywords/rust">rust</a>, <a href="/keywords/async">async</a>, <a href="/keywords/future">future</a>, <a href="/keywords/stream">stream</a></span>
    
      <span><a href="https://github.com/Hywan/mnt.io/edit/main/content/series&#x2F;reactive-programming-in-rust&#x2F;2024-09-19-observability&#x2F;index.md" title="Submit a patch for this page">Edit</a> this page</span>
      
      <meta property="description" content="The basis of reactive programming is observability. Let&#x27;s play with it." />
      
    
  </div>

    </header>

    <p>Imagine a collection of values <code>T</code>. This collection can be updated by inserting
new values, removing existing ones, or the collection can truncated, cleared…
This collection acts as <a href="https://doc.rust-lang.org/std/vec/index.html">the standard <code>Vec</code></a>. However, there is a
subtlety: This collection is <em>observable</em>. It is possible for someone to
<em>subscribe</em> to this collection and to receive its updates.</p>
<p>This observability pattern is the basis of reactive programming. It applies to
any kind of type. Actually, it can be generalised as a single <code>Observable&lt;T&gt;</code>
type. For collections though, we will see that an <code>ObservableVector&lt;T&gt;</code> type is
more efficient.</p>
<p>I’ve recently played a lot with this pattern as part of my work inside the
<a href="https://github.com/matrix-org/matrix-rust-sdk">Matrix Rust SDK</a>, a set of Rust libraries that aim at developing robust
<a href="https://matrix.org/">Matrix</a> clients or bridges. It is notoriously used by the next generation
Matrix client developed by <a href="https://element.io/">Element</a>, namely <a href="https://element.io/labs/element-x">Element X</a>. The Matrix Rust SDK is
cross-platform. Element X has two implementations: on iOS, iPadOS and macOS with
Swift, and on Android with Kotlin. Both languages are using our Rust bindings
to <a href="https://www.swift.org/">Swift</a> and <a href="https://kotlinlang.org/">Kotlin</a>. This is the story for another series (how we have
automated this, how we support asynchronous flows from Rust to foreign languages
etc.), but for the moment, let’s keep focus on reactive programming.</p>
<p>Taking the Element X use case, the room list –which is the central piece of the
app– is fully dynamic:</p>
<ul>
<li>Rooms are sorted by recency, so rooms move to the top when a new interesting
message is received,</li>
<li>The list can be filtered by room properties (one can filter by group or
people, favourites, unreads, invites…),</li>
<li>The list is also searchable by room names.</li>
</ul>
<p>The rooms exposed by the room list are stored in a unique <em>observable</em> type.
Why is it dynamic? Because the app continuously sync new data that update the
internal state: when a room gets an update from the network, the room list is
automatically updated. The beauty of it: we have nothing to do. Sorters and
filters are run automatically. Why? Spoiler: because everything is a <code>Stream</code>.</p>
<p>Thanks to the Rust async model, every part is lazy. The app never needs to ask
for Rust if a new update is present. It literally just waits for them.</p>
<p>I believe this reactive programming approach is pretty interesting to explore.
And this is precisely the goal of this series. We are going to play with
<code>Stream</code> a lot, with higher-order <code>Stream</code> a lot more, and w…</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>Hold on a second! I believe this first step is a bit steep for someone who's not
familiar with asynchronous code in Rust, don't you think?</p>
<p>Before digging in the implementation details you are obviously eager to share,
maybe we can start with examples.</p>

</div>
<p>Alrighty. Fair. Before digging into the really fun bits, we need some basis.</p>
<h2 id="baby-steps-with-reactive-programming">Baby steps with reactive programming</h2>
<p>Everything we are going to share with you has been implemented in <a href="https://docs.rs/eyeball">a library
called <code>eyeball</code></a>. To give you a good idea of what reactive
programming in Rust can look like, let's create a Rust program:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo new<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>bin</span> playground</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Creating</span></span><span class="z-meta z-function-call z-arguments z-shell"> binary (application</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">playground</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> package</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cd playground</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo add eyeball</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Updating</span></span><span class="z-meta z-function-call z-arguments z-shell"> crates.io index</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> eyeball v0.8.8 to dependencies</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Features:</span></span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> __bench</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> async-lock</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> tracing</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Updating</span></span><span class="z-meta z-function-call z-arguments z-shell"> crates.io index</span>
</span><span class="z-source z-shell z-bash">     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Locking</span></span><span class="z-meta z-function-call z-arguments z-shell"> 3 packages to latest compatible versions</span>
</span></code></pre>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">eyeball<span class="z-punctuation z-accessor z-rust">::</span></span>Observable<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">7</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> subscriber <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>subscribe<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">13</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>What do we see here? First off, <code>observable</code> is an observable value. Proof
is: It is possible to subscribe to it, see <code>subscriber</code>. Both <code>observable</code> and
<code>subscriber</code> are seeing the same initial value: 7. When <code>observable</code> receives a
new value, 13, both <code>observable</code> and <code>subscriber</code> are seeing the updated value. Let's take it for a spin:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:8:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Observable::get(</span><span class="z-keyword z-operator z-logical z-job z-shell">&amp;</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">observable</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:9:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.get(</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:13:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Observable::get(</span><span class="z-keyword z-operator z-logical z-job z-shell">&amp;</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">observable</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">13</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:14:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.get(</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">13</span></span>
</span></code></pre>
<p>Tadaa. Fantastic, isn't it?</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>I… I am… speechless? Is it <em>really</em> reactive programming? Where is the
reactivity here? It seems like you've only shared a value between an <em>owner</em> and
a <em>watcher</em>. You're calling them <em>observable</em> and <em>subscriber</em>, alright, but how
is this thing reactive? I only see synchronous code for the moment.</p>

</div>
<p>Hold on. You told me to start slow. You're right though: the <code>Observable</code> owns
the value. The <code>Subscriber</code> is able to read the value from the <code>Observable</code>.
However, <code>Subscriber::next</code> returns a <a href="https://doc.rust-lang.org/std/future/trait.Future.html"><code>Future</code></a>! Let's add this:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> …
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> …
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">error[E0728]:</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">await</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> is only allowed inside <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">async</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> functions and blocks</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">--</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;</span> src/main.rs:16:28</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">3</span></span>  <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fn</span></span><span class="z-meta z-function-call z-arguments z-shell"> main(</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">---------</span></span><span class="z-meta z-function-call z-arguments z-shell"> this is not <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">async</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">...</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">16</span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dbg!</span></span><span class="z-meta z-function-call z-arguments z-shell">(subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash">   <span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-pipe z-shell">|</span>                            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">^^^^^</span></span><span class="z-meta z-function-call z-arguments z-shell"> only allowed inside <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">async</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> functions and blocks</span>
</span></code></pre>
<p>Indeed. Almighty <code>rustc</code> is correct. The <code>main</code> function is not <code>async</code>. We need
an asynchronous runtime. Let's use <a href="https://docs.rs/smol">the <code>smol</code> project</a>, I enjoy it a
lot: it's a small, fast and well-written async runtime:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo add smol</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Updating</span></span><span class="z-meta z-function-call z-arguments z-shell"> crates.io index</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> smol v2.0.2 to dependencies</span>
</span><span class="z-source z-shell z-bash">      <span class="z-support z-function z-test z-begin z-shell">[</span><span class="z-meta z-function-call z-arguments z-shell"> … snip … <span class="z-support z-function z-test z-end z-shell">]</span></span>
</span></code></pre>
<p>Now let's modify our <code>main</code> function a little bit:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">eyeball<span class="z-punctuation z-accessor z-rust">::</span></span>Observable<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">smol<span class="z-punctuation z-accessor z-rust">::</span></span>block_on<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>async <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">7</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> subscriber <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>subscribe<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">13</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>get<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">get</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Please <code>rustc</code>, be nice…</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:9:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Observable::get(</span><span class="z-keyword z-operator z-logical z-job z-shell">&amp;</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">observable</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:10:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.get(</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">7</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:14:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> Observable::get(</span><span class="z-keyword z-operator z-logical z-job z-shell">&amp;</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">observable</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">13</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:15:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.get(</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">13</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:17:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">13,</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre>
<p>Hurray!</p>
<p>We can even have a bit more ergonomics by using <a href="https://docs.rs/smol-macros">the <code>smol-macros</code>
crate</a> which sets up a default <a href="https://docs.rs/smol/2.0.2/smol/struct.Executor.html">async runtime
<code>Executor</code></a> for us. It's useful in our case as we want to play
with something else (reactive programming), and don't want to focus on the async
runtime itself:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo add smol-macros macro_rules_attribute</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Updating</span></span><span class="z-meta z-function-call z-arguments z-shell"> crates.io index</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> smol-macros v0.1.1 to dependencies</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> macro_rules_attribute v0.2.0 to dependencies</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Features:</span></span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> better-docs</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> verbose-expansions</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Updating</span></span><span class="z-meta z-function-call z-arguments z-shell"> crates.io index</span>
</span><span class="z-source z-shell z-bash">     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Locking</span></span><span class="z-meta z-function-call z-arguments z-shell"> 4 packages to latest compatible versions</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> macro_rules_attribute v0.2.0</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> macro_rules_attribute-proc_macro v0.2.0</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> paste v1.0.15</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> smol-macros v0.1.1</span>
</span></code></pre>
<p>We will take the opportunity to improve our program a little bit. Let's spawn a
<code>Future</code> that will continuously read new updates from the <code>subscriber</code>.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">time<span class="z-punctuation z-accessor z-rust">::</span></span>Duration<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">eyeball<span class="z-punctuation z-accessor z-rust">::</span></span>Observable<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">macro_rules_attribute<span class="z-punctuation z-accessor z-rust">::</span></span>apply<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">smol<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>Executor<span class="z-punctuation z-separator z-rust">,</span> Timer</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">smol_macros<span class="z-punctuation z-accessor z-rust">::</span></span>main<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">apply</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">main!</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust">async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">executor</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span>Executor</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">7</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> subscriber <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>subscribe<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Task that reads new updates from `observable`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> task <span class="z-keyword z-operator z-assignment z-rust">=</span> executor<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">spawn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>async <span class="z-storage z-modifier z-rust">move</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">while</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>new_value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>new_value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Now, let&#39;s update `observable`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">13</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Timer<span class="z-punctuation z-accessor z-rust">::</span></span>after<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_secs<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">17</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Timer<span class="z-punctuation z-accessor z-rust">::</span></span>after<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">Duration<span class="z-punctuation z-accessor z-rust">::</span></span>from_secs<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">23</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Wait on the task.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    task<span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>The little <code>Timer::after</code> calls are here to pretend the values are coming from
random events, for the moment. Let's run it again to see if we get the same
result:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:16:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = 13</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:16:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = 17</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:16:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = 23</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">^C</span></span>
</span></code></pre>
<p>Here we go, perfect! See, ah ha! It's async and nice now.</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>I believe I start to appreciate it. However, I foresee you might hide something
behind these <code>Time::after</code>. Am I right?</p>
<p>And this <code>task.await</code> at the end makes the program to never finish. It explains
the need to send <a href="https://man.freebsd.org/cgi/man.cgi?query=signal">a <code>SIGINT</code> signal</a> to the program to interrupt it,
right?</p>

</div>
<p>You're slick. Indeed, I wanted to focus on the <code>observable</code> and the
<code>subscriber</code>. Because there is a subtlety here. If the <code>Timer::after</code> are
removed, only the last update will be displayed on the output by <code>dbg!</code>.
And that's perfectly normal. The async runtime will execute all the
<code>Observable::set(&amp;mut observable, new_value)</code> in a row, and then, once there
is an await point, another task will have room to run. In this case, that's
<code>subscriber.next().await</code>.</p>
<p>The subscriber only receives the <strong>last</strong> update, and that's pretty important
to understand. There is no buffer of all the previous updates here, no memory,
no trace, <code>subscriber</code> returns the last value when it is called. Note that this
is not always the case as we will see with <code>ObservableVector</code> later, but for the
moment, that's the case.</p>
<p>And yes, if we want the <code>task</code> to get a chance to consume more updates, we need
to tell the executor we will wait while the current other tasks are waken up. To
do that, we can use <a href="https://docs.rs/smol/2.0.2/smol/future/fn.yield_now.html">the <code>smol::yield_now</code> function</a>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Now, let&#39;s update `observable`.
</span></span><span class="z-source z-rust">    <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">13</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Eh `executor`: `task` can run now, we will wait!
</span></span><span class="z-source z-rust">    <span class="z-support z-function z-rust">yield_now</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> More updates.
</span></span><span class="z-source z-rust">    <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">17</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">    <span class="z-meta z-path z-rust">Observable<span class="z-punctuation z-accessor z-rust">::</span></span>set<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> observable<span class="z-punctuation z-separator z-rust">,</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">23</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Eh `executor`: _bis repetita placent_!
</span></span><span class="z-source z-rust">    <span class="z-support z-function z-rust">yield_now</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust">    <span class="z-support z-function z-rust">drop</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
</span><span class="z-source z-rust">    task<span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">}
</span></code></pre>
<p>Let's see what happens:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:14:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = 13</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:14:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = 23</span>
</span></code></pre>
<p>Eh, see, <code>new_value = 17</code> is <strong>not</strong> displayed, because the <code>observable</code> is
updated but the <code>subscriber</code> is suspended by the executor. But the others are
read, good good.</p>
<p>Note that we are dropping the <code>observable</code>. Once it's dropped, the <code>subscriber</code>
won't be able to read any value from it, so it's going to close itself, and the
<code>task</code> will end. That's why waiting on the task with <code>task.await</code> will terminate
this time. And thus, the program will finish gracefully.</p>
<p>And that's it. That's the basis of reactive programming. Also note that
<code>Subscriber&lt;T&gt;</code> implements <a href="https://doc.rust-lang.org/std/marker/trait.Send.html"><code>Send</code></a> and <a href="https://doc.rust-lang.org/std/marker/trait.Sync.html"><code>Sync</code></a> if <code>T</code> implements <code>Send</code> and
<code>Sync</code>, i.e. if the observed type implements these traits. That's pretty useful
actually: it is possible to send the subscriber in a different thread, and keep
waiting for new updates.</p>
<h2 id="attack-of-the-clones">Attack of the Clones</h2>
<p>However, at the beginning of this episode, we were talking about a collection.
Let's focus on <a href="https://doc.rust-lang.org/std/vec/index.html"><code>Vec</code></a>.</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>Why do we focus on <code>Vec</code> <em>only</em>? Why not <code>HashMap</code>, <code>HashSet</code>, <code>BTreeSet</code>,
<code>BTreeMap</code>, <code>BinaryHeap</code>, <code>LinkedList</code> or even <code>VecDeque</code>? It seems a bit
non-inclusive if you ask me. Are you aware there isn't only <code>Vec</code> in life?</p>

</div>
<p>Well, the reason is simple: <code>Vec</code> is supported by <code>eyeball</code>. It's a matter of
time and work to support other collections, it's definitely not impossible but
you will see that it's not trivial neither to support all these collections for
a simple reason: Did you notice that <code>Subscriber</code> produces an owned <code>T</code>? Not a
<code>&amp;T</code>, but a <code>T</code>. That's because
<a href="https://docs.rs/eyeball/0.8.8/eyeball/struct.Subscriber.html#method.next-1"><code>Subscriber::next</code></a> requires <code>T: Clone</code>. It means
that the observed value will be cloned every time it is broadcasted to a
subscriber.</p>
<p><a href="https://doc.rust-lang.org/std/clone/trait.Clone.html">Cloning a value</a> may be expensive. Here we are manipulating <code>usize</code>,
which is a primitive type, so it's all fine (it boils down to a <a href="https://en.cppreference.com/w/c/string/byte/memcpy"><code>memcpy</code></a>).
But imagine an <code>Observable&lt;Vec&lt;BigType&gt;&gt;</code> where <code>BigType</code> is 512 bytes: the
memory impact is going to be quickly noticeable. So th…</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>… Excuse my interruption! You know how I love reading books. I like
defining myself as a bibliophile. Anyway. During my perusal of the <code>eyeball</code>
documentation, I have found
<a href="https://docs.rs/eyeball/0.8.8/eyeball/struct.Subscriber.html#method.next_ref-1"><code>Subscriber::next_ref</code></a>. The documentation
says:</p>
<blockquote>
<p>Wait for an update and get a read lock for the updated value.</p>
</blockquote>
<p>and later:</p>
<blockquote>
<p>You can use this method to get updates of an <code>Observable</code> where the inner type
does not implement <code>Clone</code>.</p>
</blockquote>

</div>
<p>Can you stop cutting me off please? It's really unpleasant. And do not forget we
are not alone… <i>doing sideways head movement</i></p>
<p>You're right though. There is <code>Subscriber::next_ref</code>. However, if you are such
an <em>assiduous reader</em>, you may have read the end of the documentation, aren't
you?</p>
<blockquote>
<p>However, the <code>Observable</code> will be locked (not updateable) while any read guards
are alive.</p>
</blockquote>
<p>Blocking the <code>Observable</code> might be tolerable in some cases, but it cannot be
generalised to all use cases. A user is more likely to prefer <code>next</code> instead of
<code>next_ref</code> by default.</p>
<p>Back to our <code>Observable&lt;Vec&lt;BigType&gt;&gt;</code> then. Imagine the collection contains a
lot of items: cloning the entire <code>Vec&lt;_&gt;</code> for every update to every subscriber
is a pretty inefficient way of programming. Remember that, as a programmer, we
have the responsibility to make our programs use as few resources as possible,
so that hardwares can be used longer. The hardware is the most polluting segment
of our digital world.</p>
<p>So. How a data structure like <code>Vec</code> can be cloned cheaply? We could put
it inside an <a href="https://doc.rust-lang.org/std/sync/struct.Arc.html"><code>Arc</code></a> right? Cloning an <em>Atomically Reference Counted</em> value
is really cheap: <a href="https://github.com/rust-lang/rust/blob/f6bcd094abe174a218f7cf406e75521be4199f88/library/alloc/src/sync.rs#L2118-L2170">it increases the counter by 1 atomically</a>,
the inner value is untouched. Nonetheless, we have a mutation problem now.
If we have <code>Observable&lt;Arc&lt;Vec&lt;_&gt;&gt;&gt;</code>, it means that the subscribers will be
<code>Subscriber&lt;Arc&lt;Vec&lt;_&gt;&gt;&gt;</code>. In this case, every time the observable wants to
mutate the data, it is going to… be… impossible because an <code>Arc</code> is nothing
less than a shared reference, and shared references in Rust disallow mutation by
default. Using <code>Observable::set</code> will create a new <code>Arc</code>, but we cannot update
the value <em>inside</em> the <code>Arc</code>, except if we use a lock… Well, we are adding more
and more complexity.</p>
<p><q lang="la">Spes salutis</q><sup class="footnote-reference"><a href="#spes_salutis">1</a></sup>! Fortunately for us, <em>immutable
data structures</em> exist in Rust.</p>
<blockquote>
<p>An immutable data structure is a data structure which can be copied and modified
efficiently without altering the original.</p>
</blockquote>
<p>It can be modified. However, as soon as it is copied (or cloned), it is still
possible to modify the copy but the original data is not modified. That's
extremely powerful.</p>
<p>Such structures bring many advantages, but one of them is <em>structural sharing</em>:</p>
<blockquote>
<p>If two data structures are mostly copies of each other, most of the memory
they take up will be shared between them. This implies that making copies of
an immutable data structure is cheap: it's really only a matter of copying
a pointer and increasing a reference counter, where in the case of <a href="https://doc.rust-lang.org/std/vec/index.html"><code>Vec</code></a> you
have to allocate the same amount of memory all over again and make a copy of
every element it contains. For immutable data structures, extra memory isn't
allocated until you modify either the copy or the original, and then only the
memory needed to record the difference.</p>
</blockquote>
<p>Well, <i>taking a deep breath</i>, it sounds exactly like what we
need to solve our issue, isn't it? The <code>Observable&lt;Immutable&lt;_&gt;&gt;</code> and the
<code>Subscriber&lt;Immutable&lt;_&gt;&gt;</code>s will share the same value, with the observable
being able to mutate its inner value. The subscribers can modify the received
value too, in an efficient way, without conflicting with the value from the
observable. Both values will continue to live on their side, but cloning the
value is cheap.</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>Dare I ask how immutable data structures are implemented? It sounds like complex
beasts.</p>
<p>I mean… a naive implementation sounds <em>relatively doable</em> but I am guessing there
is a lot of subtleties, possible conflicts, and many memory guarantees that I am
not anticipating yet, right?</p>

</div>
<p>Oh… <q lang="la">beati pauperes in spiritu</q><sup class="footnote-reference"><a href="#beati_pauperes_in_spiritu">2</a></sup>… it
is actually really complex. It may be a topic for another series or articles.
For the moment, if you interested, let me redirect you to one research paper
that proposes an immutable <code>Vec</code>: <cite>RRR Vector: A Practical General
Immutable Sequence</cite><sup class="footnote-reference"><a href="#SRUB2015">3</a></sup>. Be cool though, understanding this part is
not necessary at all for what we are talking now. It's a great tool we are going
to use, no matter how it works internally.</p>
<p>Do you know the other good news? We don't have to implement it by ourselves,
because some nice people already did it! Enter <a href="https://docs.rs/imbl">the <code>imbl</code> crate</a>. This
crate provides <a href="https://docs.rs/imbl/3.0.0/imbl/struct.Vector.html">a <code>Vector</code> type</a>. It can be used like a regular
<code>Vec</code>. (Side note: it's even smarter than a <code>Vec</code> because it implements smart
head and tail chunking<sup class="footnote-reference"><a href="#UCR2014">4</a></sup>, and allocates in the stack or on the heap
depending on the size of the collection, similarly to <a href="https://docs.rs/smallvec">the <code>smallvec</code>
crate</a>. End of digression)</p>
<h2 id="observable-immutable-collection">Observable (immutable) collection</h2>
<p>The <code>imbl</code> crate then. It provides <a href="https://docs.rs/imbl/3.0.0/imbl/struct.Vector.html">a <code>Vector</code> type</a>. <code>eyeball</code>
provides a crate for working with immutable data structures (how surprising
huh?): <a href="https://docs.rs/eyeball-im">this crate is <code>eyeball-im</code></a>.</p>
<p>Instead of providing an <code>Observable&lt;T&gt;</code> type, it provides <a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/struct.ObservableVector.html">an
<code>ObservableVector&lt;T&gt;</code> type</a> which is a <code>Vector</code>,
but an observable one! Let's see… what do we have… <i>scroll the
documentation</i>, hmm, interesting, <i>scroll more…</i>, okay, that's
interesting:</p>
<ul>
<li>First off, there is methods like <code>append</code>, <code>pop_back</code>, <code>pop_front</code>,
<code>push_back</code>, <code>push_front</code>, <code>remove</code>, <code>insert</code>, <code>set</code>, <code>truncate</code> and <code>clear</code>.
It seems this collection is pretty flexible. The vocabulary is clear. They all
take a <code>&amp;mut self</code>, cool.</li>
<li>Then, there is a <code>with_capacity</code> method, this is intriguing, <i>add to
notes</i>,</li>
<li>Finally, we find our not-so-ol' friend <code>subscribe</code>, but this time it returns a
<a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/struct.VectorSubscriber.html"><code>VectorSubscriber&lt;T&gt;</code></a>.</li>
</ul>
<p>Let's explore <code>VectorSubscriber</code> a bit more, would you? <i>Scroll the
document</i>, contrary to
<a href="https://docs.rs/eyeball/0.8.8/eyeball/struct.Subscriber.html#method.next-1"><code>Subscriber::next</code></a>, there is no <code>next</code> method. How
are we supposed to wait on an update?</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>Confer to the assiduous reader! If you read <em>carefully</em> the documentation of the
<code>Subscriber::next</code> method, you will see:</p>
<blockquote>
<p>This method is a convenience so you don't have to import a <code>Stream</code> extension
trait such as <code>futures::StreamExt</code> or <code>tokio_stream::StreamExt</code>.</p>
</blockquote>

</div>
<p>… fair enough. So <code>Subscriber::next</code> mimics <code>StreamExt::next</code>. Okay. Let's look
at <a href="https://docs.rs/futures/0.3.30/futures/stream/trait.Stream.html"><code>Stream</code></a> first, it's from <a href="https://docs.rs/futures">the <code>futures</code>
crate</a>. <code>Stream</code> defines itself as:</p>
<blockquote>
<p>A stream of values produced asynchronously.</p>
<p>If <code>Future&lt;Output = T&gt;</code> is an asynchronous version of <code>T</code>, then <code>Stream&lt;Item = T&gt;</code> is an asynchronous version of <code>Iterator&lt;Item = T&gt;</code>. A stream represents
a sequence of value-producing events that occur asynchronously to the caller.</p>
<p>The trait is modeled after <code>Future</code>, but allows <code>poll_next</code> to be called even
after a value has been produced, yielding None once the stream has been fully
exhausted.</p>
</blockquote>
<p>We aren't going to teach everything about <code>Stream</code>: why this design, its
pros and cons… However, <i>wave its hand to ask you to come
closer</i>, did you notice how <a href="https://doc.rust-lang.org/std/future/trait.Future.html#tymethod.poll"><code>Future::poll</code></a> returns <code>Poll&lt;Self::Output&gt;</code>,
whilst <a href="https://docs.rs/futures/0.3.30/futures/stream/trait.Stream.html#tymethod.poll_next"><code>Stream::poll_next</code></a> returns
<code>Poll&lt;Option&lt;Self::Item&gt;&gt;</code>? It's really similar to <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#tymethod.next"><code>Iterator::next</code></a> which
returns <code>Option&lt;Self::Item&gt;</code>.</p>
<p>Let's take a look at <a href="https://doc.rust-lang.org/std/task/enum.Poll.html"><code>Poll&lt;T&gt;</code></a> don't you mind? It's an enum with 2 variants:</p>
<ul>
<li><code>Ready(value)</code> means a <code>value</code> is immediately ready,</li>
<li><code>Pending</code> means no value is ready yet.</li>
</ul>
<p>Then, what <code>Poll&lt;Option&lt;T&gt;&gt;</code> represents for a <code>Stream</code>?</p>
<ul>
<li><code>Poll::Ready(Some(value))</code> means this stream has successfully produced a
<code>value</code>, and may produce more values on subsequent <code>poll_next</code> calls,</li>
<li><code>Poll::Ready(None)</code> means the stream has terminated (and <code>poll_next</code> should
not be called anymore),</li>
<li><code>Poll::Pending</code> means no value is ready yet.</li>
</ul>
<p>It makes perfect sense. A <code>Future</code> produces a single value, whilst a <code>Stream</code>
produces multiple values, and <code>Poll::Ready(None)</code> represents the termination of
the stream, similarly to <code>None</code> to represent the termination of an <code>Iterator</code>.
Ahh, I love consistency.</p>
<p>We have the basis. Now let's see <a href="https://docs.rs/futures/0.3.30/futures/stream/trait.StreamExt.html"><code>StreamExt</code></a>. It's
a trait extending <code>Stream</code> to add convenient combinator methods. Amongst other
things, we find <a href="https://docs.rs/futures/0.3.30/futures/prelude/stream/trait.StreamExt.html#method.next"><code>StreamExt::next</code></a>! Ah ha!
It returns a <code>Next</code> type which implements a <code>Future</code>, exactly what <code>eyeball</code>
does actually. Remember our:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> from `main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-control z-rust">while</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>new_value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>new_value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span><span class="z-source z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></code></pre>
<p>It is exactly the same pattern with <code>StreamExt::next</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> from the documentation of `StreamExt::Next`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">futures<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">stream<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-separator z-rust">,</span> StreamExt</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> stream <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">stream<span class="z-punctuation z-accessor z-rust">::</span></span>iter<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span><span class="z-keyword z-operator z-range z-rust">..</span><span class="z-keyword z-operator z-assignment z-rust">=</span><span class="z-constant z-numeric z-integer z-decimal z-rust">3</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>stream<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>stream<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">2</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>stream<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">3</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>stream<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-type z-rust">None</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>Pieces start to come together, don't they?</p>
<p>End of the detour. Back to <code>eyeball_im::VectorSubscriber&lt;T&gt;</code> . It is possible to
transform this type into a <code>Stream</code> with its
<a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/struct.VectorSubscriber.html#method.into_stream"><code>into_stream</code></a> method. It returns
a <a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/struct.VectorSubscriberStream.html"><code>VectorSubscriberStream</code></a>. Naming is
hard, but if I would have to guess, I would say it implements… a… <code>Stream</code>?</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> from `eyeball-im`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span></span><span class="z-meta z-impl z-rust"><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>T<span class="z-punctuation z-separator z-rust">:</span> <span class="z-support z-type z-rust">Clone</span> <span class="z-keyword z-operator z-rust">+</span> <span class="z-support z-type z-rust">Send</span> <span class="z-keyword z-operator z-rust">+</span> <span class="z-support z-type z-rust">Sync</span> <span class="z-keyword z-operator z-rust">+</span> <span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-impl z-rust"> Stream <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">VectorSubscriberStream</span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Item</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-generic z-rust">VectorDiff<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>T<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></code></pre>
<p><a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/struct.VectorSubscriberStream.html#impl-Stream-for-VectorSubscriberStream%3CT%3E">Yes, it does</a>!</p>
<p>Dust blown away, the puzzle starts to appear clearly. Let's back on coding!</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo add eyeball-im futures</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Updating</span></span><span class="z-meta z-function-call z-arguments z-shell"> crates.io index</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> eyeball-im v0.5.0 to dependencies</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Features:</span></span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> serde</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> tracing</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Adding</span></span><span class="z-meta z-function-call z-arguments z-shell"> futures v0.3.30 to dependencies</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Features:</span></span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> alloc</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> async-await</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> executor</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> std</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> bilock</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> cfg-target-has-atomic</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> compat</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> futures-executor</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> io-compat</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> thread-pool</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> unstable</span>
</span><span class="z-source z-shell z-bash">             <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">-</span></span><span class="z-meta z-function-call z-arguments z-shell"> write-all-vectored</span>
</span><span class="z-source z-shell z-bash">      <span class="z-support z-function z-test z-begin z-shell">[</span><span class="z-meta z-function-call z-arguments z-shell"> … snip … <span class="z-support z-function z-test z-end z-shell">]</span></span>
</span></code></pre>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">eyeball_im<span class="z-punctuation z-accessor z-rust">::</span></span>ObservableVector<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">futures<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">stream<span class="z-punctuation z-accessor z-rust">::</span></span>StreamExt<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">macro_rules_attribute<span class="z-punctuation z-accessor z-rust">::</span></span>apply<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">smol<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span><span class="z-meta z-path z-rust">future<span class="z-punctuation z-accessor z-rust">::</span></span>yield_now<span class="z-punctuation z-separator z-rust">,</span> Executor</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">smol_macros<span class="z-punctuation z-accessor z-rust">::</span></span>main<span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">apply</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">main!</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust">async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">executor</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span>Executor</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ObservableVector<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Subscribe to `observable` and get a `Stream`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> subscriber <span class="z-keyword z-operator z-assignment z-rust">=</span> observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">subscribe</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_stream</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push one value.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Task that reads new updates from `observable`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> task <span class="z-keyword z-operator z-assignment z-rust">=</span> executor<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">spawn</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>async <span class="z-storage z-modifier z-rust">move</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">        <span class="z-keyword z-control z-rust">while</span> <span class="z-storage z-type z-rust">let</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>new_value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">            <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>new_value</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-rust">        </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
</span></span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust"><span class="z-meta z-block z-rust">    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Now, let&#39;s update `observable`.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Eh `executor`: `task` can run now!
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">yield_now</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> More updates.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Eh `executor`, same.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">yield_now</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-function z-rust">drop</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>observable</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    task<span class="z-punctuation z-accessor z-dot z-rust">.</span>await<span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Time to show off:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:18:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = PushBack <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:18:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = PushBack <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:18:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = PushBack <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:18:13]</span></span><span class="z-meta z-function-call z-arguments z-shell"> new_value = PushBack <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span>
</span></code></pre>
<p>Do you see something new?</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>Hmm, indeed. With <code>Observable</code>, some values may “miss” because <code>Observable</code>
and <code>Subscriber</code> have no buffer. The subscribers only return the current value
when asked for. However, with <code>ObservableVector</code>, things are different: no
missing values. There are all here. As if there… was a buffer!</p>
<p>And the values returned by the subscriber are not the raw <code>T</code>:
we see <code>PushBack</code>. It comes from, <i>check the documentation</i>,
<a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/enum.VectorDiff.html"><code>VectorDiff::PushBack</code></a>!</p>

</div>
<p>Good eyes, well done.</p>
<p>First off, that's correct that <code>PushBack</code> comes from
<a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/enum.VectorDiff.html"><code>VectorDiff</code></a>. Let's come back to this piece in
a second: it is the cornerstone of the entire series, it deserves a bit of
explanations.</p>
<p>Second, yes, <code>VectorSubscriber</code> returns <strong>all values</strong>! There is actually a
buffer. It's a bit annoying to continue with a <code>task</code> as we did so far, let's
use <a href="https://doc.rust-lang.org/std/macro.assert_eq.html"><code>assert_eq!</code></a> instead.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">eyeball_im<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>ObservableVector<span class="z-punctuation z-separator z-rust">,</span> VectorDiff</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>                                 ^^^^^^^^^^ new!
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> …
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">apply</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">main!</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
</span><span class="z-source z-rust">async <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">main</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">_executor</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-rust">&amp;</span>Executor</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ObservableVector<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> subscriber <span class="z-keyword z-operator z-assignment z-rust">=</span> observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">subscribe</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_stream</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push one value.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push another value.
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">        <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-group z-rust">    </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:16:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">PushBack</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:26:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">PushBack</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:30:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">PushBack</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:34:9]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">PushBack</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre>
<p>Beautiful! However… the code is a bit verbose, isn't it? <i>Desperately waiting
for an affirmative answer</i>, okay, okay, something you may not know about me:
I love macros. There. I said it. Let's quickly craft one:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> before the `main` function
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-support z-function z-rust">macro_rules!</span> <span class="z-entity z-name z-macro z-rust">assert_next_eq</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span></span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust">    <span class="z-meta z-group z-macro-matcher z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span> <span class="z-variable z-parameter z-macro z-rust">$stream</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">ident</span>, <span class="z-variable z-parameter z-macro z-rust">$expr</span><span class="z-punctuation z-separator z-rust">:</span><span class="z-storage z-type z-rust">expr</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust"><span class="z-keyword z-operator z-rust">$</span>(</span>,<span class="z-punctuation z-section z-group z-end z-rust">)</span></span>? <span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">=&gt;</span> <span class="z-meta z-block z-macro-body z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-macro-body z-rust">        <span class="z-support z-macro z-rust">assert_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-support z-macro z-rust">dbg!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span> <span class="z-variable z-other z-rust">$stream</span> <span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">next</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span>await</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-separator z-rust">,</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span> <span class="z-variable z-other z-rust">$expr</span> </span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-meta z-block z-macro-body z-rust">    <span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-macro-matcher z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"></span></span><span class="z-meta z-macro z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This macro does exactly what our <code>assert_eq!</code> was doing, except now it's shorter
to use, and thus more pleasant. Don't believe me? See by yourself:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> at the end of the `main` function
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push one value.
</span></span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_next_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push another value.
</span></span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_next_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_next_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_next_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>There we go.</p>
<p>Having a scientific and rigorous approach is important in our domain. We said
<code>ObservableVector</code> seems to contain a buffer, and <code>VectorSubscriber</code> seems to
pop values from this buffer. Let's play with that. I see two things to test:</p>
<ol>
<li>Modify the <code>ObservableVector</code>, and subscribe to it <em>after</em>: Does the
subscriber receive the update before it was created?</li>
<li>How many values the buffer can hold?</li>
</ol>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ObservableVector<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push a value before the subscriber exists.
</span></span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> subscriber <span class="z-keyword z-operator z-assignment z-rust">=</span> observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">subscribe</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_stream</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push another value.
</span></span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_next_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<p>If the <code>subscriber</code> receives <code>a</code>, it must fail, otherwise no error:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:25:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">PushBack</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre>
<p>Look Ma', no error!</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>We have learned that a <code>VectorSubscriber</code> is aware of the new updates that are
made once it exists. A <code>VectorSubscriber</code> is not aware of updates that happened
before its creation.</p>
<p>In the example, <code>VectorDiff::PushBack { value: 'a' }</code> is not received before
<code>subscriber</code> was created. However, <code>VectorDiff::PushBack { value: 'b' }</code> is
received because it happened after <code>subscriber</code> was created. It makes perfect
sense.</p>
<p>It suggests that the buffer lives inside <code>VectorSubscriber</code>, and not inside
<code>ObservableVector</code>. Or maybe the buffer is shared between the observable and the
subscribers, with the buffer having some specific semantics, like a <em>channel</em>.
We would need to look at the implementation to be sure.</p>

</div>
<p>Agree. This is left as an exercise for the reader, <i>wink to you</i>.</p>
<p>We have an answer to question 1. What about question 2? The size of the buffer.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ObservableVector<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> subscriber <span class="z-keyword z-operator z-assignment z-rust">=</span> observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">subscribe</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">into_stream</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> Push ALL THE VALUES!
</span></span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>e<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>f<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>g<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>h<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>i<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>j<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>k<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>l<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>m<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>n<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>o<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>p<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_next_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> no need to assert the others
</span></span></code></pre>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:36:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">PushBack</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre>
<p>Hmm, the buffer doesn't seem to be full with 16 values. Let's add a couple more:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> in `src/main.rs`
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> [ … snip … ]
</span></span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>n<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>o<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>p<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>q<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>                    ^ new!
</span></span><span class="z-source z-rust">observable<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>r<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>                    ^ new!
</span></span><span class="z-source z-rust">
</span><span class="z-source z-rust"><span class="z-support z-macro z-rust">assert_next_eq!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>subscriber<span class="z-punctuation z-separator z-rust">,</span> <span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value<span class="z-punctuation z-separator z-rust">:</span> <span class="z-string z-quoted z-single z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-rust">&#39;</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></code></pre>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:38:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Reset</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        values: [
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>e<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>f<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>g<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>h<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>i<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>j<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>k<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>l<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>m<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>n<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>o<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>p<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>q<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">            <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>r<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        ]<span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">thread</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>main<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> panicked at src/main.rs:38:5:</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">assertion</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">left</span></span><span class="z-meta z-function-call z-arguments z-shell"> == right</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> failed</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">left:</span></span><span class="z-meta z-function-call z-arguments z-shell"> Some(Reset <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span> values: <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>d<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>e<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>f<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>g<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>h<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>i<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>j<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>k<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>l<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>m<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>n<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>o<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>p<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>q<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span>, <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>r<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">right:</span></span><span class="z-meta z-function-call z-arguments z-shell"> Some(PushBack <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span> value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">note:</span></span><span class="z-meta z-function-call z-arguments z-shell"> run with <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-variable z-other z-readwrite z-assignment z-shell">RUST_BACKTRACE</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">1</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span> environment variable to display a backtrace</span>
</span></code></pre>
<p>Oh! An error, great! Our <code>assert_next_eq!</code> has failed. <code>subscriber</code>
does not receive a <code>VectorDiff::PopBack</code> but a <code>VectorDiff::Reset</code>.
Let's play with
<a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/struct.ObservableVector.html#method.with_capacity"><code>ObservableVector::with_capacity</code></a>
a moment, maybe it's related to the buffer capacity? Let's change a single line:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> observable <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-path z-rust">ObservableVector<span class="z-punctuation z-accessor z-rust">::</span></span>with_capacity<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span><span class="z-source z-rust"><span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>                                     ^^^^^^^^^^^^^^^^^ new!
</span></span></code></pre>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>quiet</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[src/main.rs:38:5]</span></span><span class="z-meta z-function-call z-arguments z-shell"> subscriber.next(</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">.await</span></span><span class="z-meta z-function-call z-arguments z-shell"> = Some(</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">PushBack</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">        value: <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span>,</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>We have learned that <code>ObservableVector::with_capacity</code> controls the size of
the buffer.</p>
<p>The name could suggest that it controls the capacity of the observed <code>Vector</code>,
<em>à la</em> <a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.with_capacity"><code>Vec::with_capacity</code></a>, but it must not be confused.</p>
<p>For a reason we ignore so far, when the buffer is full, we receive a
<code>VectorDiff::Reset</code>. We need to learn more about this type.</p>

</div>
<h2 id="observable-differences">Observable differences</h2>
<p>The previous section was explaining how immutable data structures could save us
by cheaply and efficiently cloning the data between the observable and its
subscribers. However, we see that <a href="https://docs.rs/eyeball-im"><code>eyeball-im</code></a>, despite using <a href="https://docs.rs/imbl"><code>imbl</code></a>, does
not share an <a href="https://docs.rs/imbl/3.0.0/imbl/struct.Vector.html"><code>imbl::Vector</code></a> but an <a href="https://docs.rs/eyeball-im/0.5.0/eyeball_im/enum.VectorDiff.html"><code>eyeball_im::VectorDiff</code></a>. Why such design?
It looks like a drama. A betrayal. An act of treachery!</p>
<p>Well. Firstly, <code>eyeball-im</code> is relying on some immutable properties of <code>Vector</code>.
And secondly, the reason for which <code>VectorDiff</code> exists is simple. If a
subscriber receives <code>Vector</code>s, how is the user able to see what has changed? The
user (!) would be responsible to <em>calculate</em> the differences between 2 <code>Vector</code>s
every time! Not only this is costly, but it is utterly error-prone.</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>Are you suggesting that <code>VectorSubscriber</code> (or <code>VectorSubscriberStream</code>)
calculates the differences between the <code>Vector</code>s itself so that the user doesn't
have to?</p>
<p>I still see many problems though. I believe the order of the <code>VectorDiff</code>s
matters a lot for some use cases. For example, let's consider two consecutive
<code>Vector</code>s:</p>
<ol>
<li><code>['a', 'b', 'c']</code> and</li>
<li><code>['a', 'c', 'b']</code>.</li>
</ol>
<p>Has <code>'b'</code> been removed and pushed back, or <code>'c'</code> been popped back and inserted?
How can you decide between the twos?</p>

</div>
<p>We can't —it would be implementation specifics anyway— and we don't want to.
The user is manipulating the <code>ObservableVector</code> in a special way, and we should
ideally not change that.</p>
<p>These <code>VectorDiff</code> actually comes from <code>ObservableVector</code> itself! Let's look at
the implementation of
<a href="https://github.com/jplatte/eyeball/blob/4254403e385715380753bb0def20fb0398e91ebd/eyeball-im/src/vector.rs#L107-L114"><code>ObservableVector::push_back</code></a>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">push_back</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">self</span>, <span class="z-variable z-parameter z-rust">value</span><span class="z-punctuation z-separator z-rust">:</span> T</span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> [ … snip … ]
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span>values<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push_back</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>value<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">clone</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>   ^^^^^^ this is a `Vector`!
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-variable z-language z-rust">self</span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">broadcast_diff</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">VectorDiff<span class="z-punctuation z-accessor z-rust">::</span></span>PushBack <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> value </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
</span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust">    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span>                  ^^^^^^^^^^ here you are…
</span></span></span></span><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Each method adding or removing values on the <code>ObservableVector</code> emits its own
<code>VectorDiff</code> variant. No calculation, it's purely a mapping:</p>
<figure>
<table><thead><tr><th><code>ObservableVector::…</code></th><th><code>VectorDiff::…</code></th><th>Meaning</th></tr></thead><tbody>
<tr><td><code>append(values)</code></td><td><code>Append { values }</code></td><td>Append many <code>values</code></td></tr>
<tr><td><code>clear()</code></td><td><code>Clear</code></td><td>Clear out all the values</td></tr>
<tr><td><code>insert(index, value)</code></td><td><code>Insert { index, value }</code></td><td>Insert a <code>value</code> at <code>index</code> </td></tr>
<tr><td><code>pop_back()</code></td><td><code>PopBack</code></td><td>Remove the value at the back</td></tr>
<tr><td><code>pop_front()</code></td><td><code>PopFront</code></td><td>Remove the value at the front</td></tr>
<tr><td><code>push_back(value)</code></td><td><code>PushBack { value }</code></td><td>Add <code>value</code> at the back</td></tr>
<tr><td><code>push_front(value)</code></td><td><code>PushFront { value }</code></td><td>Add <code>value</code> at the front</td></tr>
<tr><td><code>remove(index)</code></td><td><code>Remove { index } </code></td><td>Remove value at <code>index</code></td></tr>
<tr><td><code>set(index, value)</code></td><td><code>Set { index, value }</code></td><td>Replace value at <code>index</code> by <code>value</code></td></tr>
<tr><td><code>truncate(length)</code></td><td><code>Truncate { length }</code></td><td>Truncate to <code>length</code> values</td></tr>
</tbody></table>
  <figcaption>
<p>Mappings of <code>ObservableVector</code> methods to <code>VectorDiff</code> variants.</p>
  </figcaption>
</figure>
<p>See, for each <code>VectorDiff</code> variant, there is an <code>ObservableVector</code> method
triggering it.</p>
<div class="conversation" data-character="comte">
  <div class="conversation--character">
    <span lang="fr">Le Comte</span>

    <picture role="presentation">
      <source srcset="/image/comte.avif" type="image/avif" />
      <source srcset="/image/comte.webp" type="image/webp" />
      <img src="/image/comte.png" />
    </picture>

  </div>
  <p>And what about <code>VectorDiff::Reset</code>?</p>
<p>We were receiving it when the buffer was full apparently. You are not mentioning
it, and if I take a close look at <code>ObservableVector</code>'s documentation, I don't
see any <code>reset</code> method. Is it only an internal thing?</p>

</div>
<p>You are correct. When the buffer is full, the subscriber will provide a
<code>VectorDiff::Reset { values }</code> where <code>values</code> is the full list of values. The
documentation says:</p>
<blockquote>
<p>The subscriber lagged too far behind, and the next update that should have
been received has already been discarded from the internal buffer.</p>
</blockquote>
<p>If the subscriber didn't catch all the updates, the best thing it can do is to
say: <q>Okay, I am late at the party, I've missed several things, so here is the
current state!</q>. This is not ideal, but the subscriber is responsible to not
lag, and this design avoids having missing values. If a subscriber receives
too much <code>VectorDiff::Reset</code>s, the user may consider increasing the capacity of
the <code>ObservableVector</code>.</p>
<h2 id="filtering-and-sorting-with-higher-order-streams">Filtering and sorting with higher-order <code>Stream</code>s</h2>
<p>We are reaching the end of this episode. And you know what? We have set all the
parts to talk about higher-order <code>Stream</code>, <i>chante victory and dance at the
same time</i>!</p>
<p>At the beginning of this episode, we were saying that the Matrix Rust SDK is
able to filter and to sort an <code>ObservableVector</code> representing all the rooms.
How? <code>VectorSubscriberStream</code> <em>is</em> a <code>Stream</code>. More specifically, it is a
<code>Stream&lt;Item = VectorDiff&lt;T&gt;&gt;</code>. Now questions:</p>
<ul>
<li>What's the difference between an unfiltered <code>Vector</code> and a filtered <code>Vector</code>?</li>
<li>What's the difference between an unsorted <code>Vector</code> and a sorted <code>Vector</code>?</li>
<li>What's the difference between a filtered <code>Vector</code> and a sorted <code>Vector</code>?</li>
<li>and so on.</li>
</ul>
<p>All of them are strictly <code>Stream&lt;Item = VectorDiff&lt;T&gt;&gt;</code>! However, the
<code>VectorDiff</code>s aren't the same. A simple example. Let's say we build a vector by
inserting <code>1</code>, <code>2</code>, <code>3</code> and <code>4</code>. We subscribe to it, and we want to filter out
all the even numbers. Instead of receiving:</p>
<ul>
<li><code>VectorDiff::Insert { index: 0, value: 1 }</code>,</li>
<li><code>VectorDiff::Insert { index: 1, value: 2 }</code>,</li>
<li><code>VectorDiff::Insert { index: 2, value: 3 }</code>,</li>
<li><code>VectorDiff::Insert { index: 3, value: 4 }</code>.</li>
</ul>
<p>… we want to receive:</p>
<ul>
<li><code>VectorDiff::Insert { index: 0, value: 1 }</code>,</li>
<li><code>VectorDiff::Insert { index: 1, value: 3 }</code>: note the <code>index</code>, it is not 2
but 1!</li>
</ul>
<p>We will see how all that works in the next episodes and how powerful this design
is, especially when it comes to cross-platform UI (user interface). We are going
to learn so much about <code>Stream</code> and <code>Future</code>, it's going to be fun!</p>
<div class="footnote-definition" id="spes_salutis"><sup class="footnote-definition-label">1</sup>
<p>Latine expression meaning <em>salvation hope</em>.</p>
</div>
<div class="footnote-definition" id="beati_pauperes_in_spiritu"><sup class="footnote-definition-label">2</sup>
<p>Latine expression meaning <em>bless are the poor in spirit</em>.</p>
</div>
<div class="footnote-definition" id="SRUB2015"><sup class="footnote-definition-label">3</sup>
<p><cite><a href="https://infoscience.epfl.ch/server/api/core/bitstreams/7c8b929f-1f68-4948-8ea8-e364e4899b2a/content">Relaxed-Radix-Balanced
(RRR) Vector: A Practical General Purpose Immutable
Sequence</a></cite> by Sticki N., Rompf T., Ureche V. and Bagwell P. (2015,
August), in <i>Proceedings of the 20th ACM SIGPLAN International Conference
on Functional Programming (pp. 342-354).</i></p>
</div>
<div class="footnote-definition" id="UCR2014"><sup class="footnote-definition-label">4</sup>
<p><cite><a href="http://deepsea.inria.fr/pasl/chunkedseq.pdf">Theory
and Practise of Chunked Sequences</a></cite> by Acar U. A., Charguéraud
A., and Rainey M. (2014), in <i>Algorithms-ESA 2014: 22th Annual European
Symposium, Wroclaw, Poland, September 8-10, 2014. Proceedings 21 (pp.
25-36).</i>, Springer Berlin Heidelberg.</p>
</div>


    <nav class="previous-next-episodes"><div class="button button--disabled text-align-end">(coming soon)&nbsp;❯</div></nav>
  </article>

</main>

<footer class="full-width content-grid">
  <div class="footer">
    <div>
      <h2>Contact me</h2>

      <ul>
        <li><a href="https://matrix.to/#/@mnt_io:matrix.org" title="Say hi on Matrix">@mnt_io:matrix.org</a></li>
        <li><a href="mailto:ivan@mnt.io" title="Good ol' email">ivan@mnt.io</a></li>
        <li><a href="https://floss.social/@hywan" title="Say hi on Mastodon" rel="me">Mastodon</a></li>
        <li><a href="https://github.com/Hywan" title="Say hi on Github">Github</a></li>
      </ul>
    </div>
    <div>
      <h2>Recommendations</h2>

      <ul>
        <li><a href="https://fasterthanli.me/">fasterthanli.me</a></li>
        <li><a href="https://without.boats/blog/">without.boats</a></li>
        <li><a href="https://faultlore.com/blah/">faultlore.com</a></li>
        <li><a href="https://smallcultfollowing.com/babysteps/blog/">smallcultfollowing.com</a></li>
        <li><a href="https://orlp.net/blog/">orlp.net</a></li>
      </ul>
    </div>

    <div>
      <h2>More</h2>

      <ul>
        <li><a href="https://mnt.io/lore/">Lore</a></li>
        <li><a href="https://mnt.io/rss.xml">RSS</a></li>
        <li><a href="https://mnt.io/atom.xml">Atom</a></li>
        <li><a href="https://github.com/Hywan/mnt.io" title="Source code of this site">Source code</a></li>
        <li><a href="https://dblp.org/search/index.php?query=Ivan%20Enderlin" title="Computer Science Bibliography">DBLP</a></li>
      </ul>
    </div>
  </div>
</footer>

<script defer src="https://cloud.umami.is/script.js" data-website-id="30754987-0af7-4ea0-9bd3-711c543b6ecb"></script>
</body>
</html>
