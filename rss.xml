<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title></title>
      <link>https://mnt.io</link>
      <description></description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://mnt.io/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Mon, 23 Feb 2026 00:00:00 +0000</lastBuildDate>
      <item>
          <title>About memory pressure, lock contention, and Data-oriented Design</title>
          <pubDate>Mon, 23 Feb 2026 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/about-memory-pressure-lock-contention-and-data-oriented-design/</link>
          <guid>https://mnt.io/articles/about-memory-pressure-lock-contention-and-data-oriented-design/</guid>
          <description xml:base="https://mnt.io/articles/about-memory-pressure-lock-contention-and-data-oriented-design/">&lt;p&gt;I&#x27;m here to narrate you a story about performance. Recently, I was in the same
room as some Memory Pressure and some Lock Contention. It took me a while to
recognize them. Legend says it only happens in obscure, low-level systems,
but I&#x27;m here to refute the legend. While exploring, I had the pleasure of fixing a
funny bug in a higher-order stream: lucky us, to top it all off, we even have a
sweet treat! This story is also a pretext to introduce you to Data-oriented Design,
and to show how it improved execution time by 98.7% and throughput
by 7718.5%. I believe we have all the ingredients for a juicy story. Let&#x27;s cook,
and &lt;em lang=&quot;fr&quot;&gt;bon appétit !&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;on-a-beautiful-morning&quot;&gt;On a Beautiful Morning…&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#on-a-beautiful-morning&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Switching on my &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;dygma.com&#x2F;pages&#x2F;defy&quot;&gt;Dygma Defy&lt;&#x2F;a&gt;, unlocking my computer, reading the news from
my colleagues, when suddenly I come across this message:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Does anyone also experience a frozen room list?&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Ah yeah, for some years now, I&#x27;ve been employed by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;&quot;&gt;Element&lt;&#x2F;a&gt; to work on the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&quot;&gt;Matrix
Rust SDK&lt;&#x2F;a&gt;. If one needs to write a complete, modern, cross-platform, fast Matrix
client or bot, this SDK is an excellent choice. The SDK is composed of many
crates. Some are very low in the stack and are not aimed at being used directly by
developers, like &lt;code&gt;matrix_sdk_crypto&lt;&#x2F;code&gt;. Some others are higher in the stack -
the highest is for User Interfaces (UI) with &lt;code&gt;matrix_sdk_ui&lt;&#x2F;code&gt;. While
it is a bit opinionated, it is designed to provide the high-quality features
everybody expects in a modern Matrix client.&lt;&#x2F;p&gt;
&lt;p&gt;One of these features is the Room List. The Room List is a place where users spend
a lot of their time in a messaging application (along with the Timeline, i.e. the room&#x27;s
messages). Some expectations for this component:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Be superfast,&lt;&#x2F;li&gt;
&lt;li&gt;List all the rooms,&lt;&#x2F;li&gt;
&lt;li&gt;Interact with rooms (open them, mark them as unread etc.),&lt;&#x2F;li&gt;
&lt;li&gt;Filter the rooms,&lt;&#x2F;li&gt;
&lt;li&gt;Sort the rooms.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let&#x27;s focus on the part that interests us today: &lt;em&gt;Sort the rooms&lt;&#x2F;em&gt;. The Room List
holds… no rooms. It actually provides a &lt;em&gt;stream of updates about rooms&lt;&#x2F;em&gt;; more
precisely a &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;Room&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. What does this mean? The
stream yields a vector of “diffs” of rooms. I&#x27;m writing &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;reactive-programming-in-rust&#x2F;&quot;&gt;a series about reactive
programming&lt;&#x2F;a&gt; - you might be
interested to read more about it. Otherwise, here is what you need to know.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;enum.VectorDiff.html&quot;&gt;The &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; type&lt;&#x2F;a&gt; comes from &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;&quot;&gt;the &lt;code&gt;eyeball-im&lt;&#x2F;code&gt;
crate&lt;&#x2F;a&gt;, initially created for the Matrix Rust SDK as a solid
foundation for reactive programming. It looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Append&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vector&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Clear&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PushFront&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PopFront&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PopBack&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Insert&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Set&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Remove&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Truncate&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Reset&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vector&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It represents a &lt;em&gt;change&lt;&#x2F;em&gt; in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;struct.ObservableVector.html&quot;&gt;an &lt;code&gt;ObservableVector&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.
This is like a &lt;code&gt;Vec&lt;&#x2F;code&gt;, but &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;struct.ObservableVector.html#method.subscribe&quot;&gt;one can subscribe to the
changes&lt;&#x2F;a&gt;, and will receive… well… &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s!&lt;&#x2F;p&gt;
&lt;p&gt;The Room List type merges several streams into a single stream representing
the list of rooms. For example, let&#x27;s imagine the room at index 3 receives a
new message. Its “preview” (the &lt;em&gt;latest event&lt;&#x2F;em&gt; displayed beneath the room&#x27;s
name e.g. &lt;q&gt;Alice: Hello!&lt;&#x2F;q&gt;) changes. Also, the Room List
sorts rooms by their “recency” (the &lt;em&gt;time&lt;&#x2F;em&gt; something happened in the room). And since the
“preview” has changed, its “recency” changes too, which means the room is sorted
and re-positioned. Then, we expect the Room List&#x27;s stream to yield:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Set { index: 3, value: new_room }&lt;&#x2F;code&gt; because of the new “preview”,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Remove { index: 3 }&lt;&#x2F;code&gt; to remove the room… immediately followed by&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::PushFront { value: new_room }&lt;&#x2F;code&gt; to insert the room at the top of the Room List.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;This reactive programming mechanism has proven to be extremely efficient.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I did my calculation: the size of &lt;code&gt;VectorDiff&amp;lt;Room&amp;gt;&lt;&#x2F;code&gt; is 72 bytes (mostly
because &lt;code&gt;Room&lt;&#x2F;code&gt; contains &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;sync&#x2F;struct.Arc.html&quot;&gt;an &lt;code&gt;Arc&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; over the real struct type). This is
pretty small for an update. Not only it brings a small memory footprint, but it
crosses the FFI boundary pretty easily, making it easy to map to other languages
like Swift or Kotlin - languages that provide UI components, like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;swiftui&#x2F;&quot;&gt;SwiftUI&lt;&#x2F;a&gt; or
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;compose&quot;&gt;Jetpack Compose&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Absolutely! These are two popular UI components where a &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; maps
straightforwardly to their List component update operations. They are actually
(remarkably) pretty similar to each other&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-vectordiff_on_other_uis-1&quot;&gt;&lt;a href=&quot;#fn-vectordiff_on_other_uis&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;You&#x27;re always a good digression companion, thank you. Let&#x27;s go back on our
problem:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;What does &quot;frozen&quot; mean for the Room List?&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;It means that the Room List is simply… &lt;em&gt;blank&lt;&#x2F;em&gt;, &lt;em&gt;empty&lt;&#x2F;em&gt;, &lt;em lang=&quot;fr&quot;&gt;vide&lt;&#x2F;em&gt;, &lt;em
lang=&quot;es&quot;&gt;vacía&lt;&#x2F;em&gt;, &lt;em lang=&quot;it&quot;&gt;vuoto&lt;&#x2F;em&gt;, &lt;em lang=&quot;ar&quot;&gt;خلو&lt;&#x2F;em&gt;… well,
you get the idea.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;What could freeze the Room List?&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;What are our options?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;It would be a real pleasure if you let me assist you in this task.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The network sync is not running properly, hence giving the &lt;em&gt;impression&lt;&#x2F;em&gt; of a
frozen Room List? Hmm, no, everything works as expected here. Moreover, local
data should be displayed.&lt;&#x2F;li&gt;
&lt;li&gt;The “source streams” used by the Room List are not yielding the expected
updates? No, everything works like a charm.&lt;&#x2F;li&gt;
&lt;li&gt;The “merge of streams” is broken for some reasons? No, it seems fine.&lt;&#x2F;li&gt;
&lt;li&gt;The filtering of the streams? Not touched since a long time.&lt;&#x2F;li&gt;
&lt;li&gt;The sorting? Ah, maybe, I reckon we have changed something here…&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Indeed, we have changed one sorter recently. Let&#x27;s take a look at how this Room List stream is computed, shall we?&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; stream!&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    loop&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Wait for the filter to be updated.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; filter&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; filter_cell&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;take&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Get the “raw” entries.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;entries&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Combine normal stream updates with other room updates.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; merge_streams&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;clone&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; other_updates&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;filter&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;filter&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sort_by&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_lexicographic&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vec!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Sort by latest event&amp;#39;s kind.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_latest_event&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Sort rooms by their recency.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_recency&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Finally, sort by name.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_name&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            ]))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;dynamic_head_with_initial_value&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;page_size&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; limit_stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Clearing the stream before chaining with the real stream.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        yield&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; once&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ready&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vec!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Reset&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; initial_values&lt;&#x2F;span&gt;&lt;span&gt; }]))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;chain&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;switch&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There is a lot going on here. Sadly, we are not going to explain everything in
this beautiful piece of art&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-switch-1&quot;&gt;&lt;a href=&quot;#fn-switch&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;.filter()&lt;&#x2F;code&gt;, &lt;code&gt;.sort_by()&lt;&#x2F;code&gt; and &lt;code&gt;.dynamic_head_with_initial_value()&lt;&#x2F;code&gt; methods
are part of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im-util&#x2F;0.10.0&#x2F;eyeball_im_util&#x2F;&quot;&gt;the &lt;code&gt;eyeball-im-util&lt;&#x2F;code&gt; crate&lt;&#x2F;a&gt;. They are used
to filter, sort etc. a stream: They are essentially mapping a &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt; to another &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. In
other terms, they “change” the &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s on-the-fly to simulate filtering,
sorting, or something else. Let&#x27;s see a very concrete example with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im-util&#x2F;0.10.0&#x2F;eyeball_im_util&#x2F;vector&#x2F;struct.Sort.html&quot;&gt;the &lt;code&gt;Sort&lt;&#x2F;code&gt;
higher-order stream&lt;&#x2F;a&gt; (the following example
is mostly a copy of the documentation of &lt;code&gt;Sort&lt;&#x2F;code&gt;, but &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;pull&#x2F;43&quot;&gt;since I wrote this
algorithm, I guess you, dear reader, will find it acceptable&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s imagine we have a vector of &lt;code&gt;char&lt;&#x2F;code&gt;. We want a &lt;code&gt;Stream&lt;&#x2F;code&gt; of &lt;em&gt;changes&lt;&#x2F;em&gt; about this vector
(the famous &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;). We also want to &lt;em&gt;simulate&lt;&#x2F;em&gt; a sorted vector, by only
modifying the &lt;em&gt;changes&lt;&#x2F;em&gt;. The solution looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; std&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;cmp&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Ordering&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball_im&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ObservableVector&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span&gt;};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball_im_util&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorObserverExt&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; stream_assert&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{assert_next_eq, assert_pending};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Our comparison function.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cmp&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;where&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    T&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ord&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cmp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;right&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Our vector.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ObservableVector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;char&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sort_by&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;cmp&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                                            ^^^&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                                            |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                                            there&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_empty&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_pending!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Alrighty. That&#x27;s a good start. &lt;code&gt;vector&lt;&#x2F;code&gt; is empty, so the initial values from the
subscribe are empty, and the &lt;code&gt;stream&lt;&#x2F;code&gt; is also pending&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-stream_assert-1&quot;&gt;&lt;a href=&quot;#fn-stream_assert&quot;&gt;3&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;. I think it&#x27;s time to
play with this new toy, isn&#x27;t it?&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Append unsorted values.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;append&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;e&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;]);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; We get a `VectorDiff::Append` with sorted values!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Append&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;e&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;] }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_pending!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Let&amp;#39;s recap what we have. `vector` is our `ObservableVector`,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; `stream` is the “sorted view”&#x2F;“sorted stream” of `vector`:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | index    | 0 1 2 |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `vector` | d b e |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `stream` | b d e |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So far, so good. It looks naive and simple: one operation in, one operation out.
It&#x27;s funnier when things get more complicated though:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Append multiple other values.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;append&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;f&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;g&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;]);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; We get three `VectorDiff`s this time!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushFront&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Insert&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Append&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;f&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;g&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;] }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_pending!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Let&amp;#39;s recap what we have:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | index    | 0 1 2 3 4 5 6 |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `vector` | d b e f g a c |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `stream` | a b c d e f g |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              ^   ^     ^^^&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              |   |     |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              |   |     with `VectorDiff::Append { .. }`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              |   with `VectorDiff::Insert { index: 2, .. }`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              with `VectorDiff::PushFront { .. }`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Notice how &lt;code&gt;vector&lt;&#x2F;code&gt; is &lt;em&gt;never&lt;&#x2F;em&gt; sorted. That&#x27;s the power of these higher-order
streams of &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s: light and —more importantly— &lt;strong&gt;combinable&lt;&#x2F;strong&gt;! I repeat
myself: we are always mapping a &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt; to another
&lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. That&#x27;s the same type! The whole collection
is never computed entirely, except for the initial values: only the changes are
handled and trigger a computation. Knowing that, in the manner of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;future&#x2F;trait.Future.html&quot;&gt;&lt;code&gt;Future&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,
&lt;code&gt;Stream&lt;&#x2F;code&gt; is lazy —i.e. it does something only when polled—, it makes things
pretty efficient. And…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;… as your favourite digression companion, I really, deeply, appreciate these
details. Nonetheless, I hope you don&#x27;t mind if… I suggest to you that… you
might want to, maybe, go back to… &lt;small&gt;the main… subject, don&#x27;t you think?&lt;&#x2F;small&gt;&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Which topic? Ah! The frozen Room List! Sorters are &lt;em&gt;not&lt;&#x2F;em&gt; the culprit. There.
Happy? Short enough?&lt;&#x2F;p&gt;
&lt;p&gt;These details were important. Kind of. I hope you&#x27;ve learned something along
the way. Next, let&#x27;s see how a sorter works, and how it could be responsible
for our memory pressure and lock contention.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;randomness&quot;&gt;Randomness&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#randomness&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Taking a step back, I was asking myself: &lt;q&gt;Is it really frozen?&lt;&#x2F;q&gt;. The cherry
on the cake: I was unable to reproduce the problem! Even the reporters of
the problem were unable to reproduce it consistently. Hmm, a random problem?
Fortunately, two of the reporters are obstinate. Ultimately, we got analysis.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;picture&gt;
    &lt;source srcset=&quot;.&amp;#x2F;memory-pressure.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
    &lt;source srcset=&quot;.&amp;#x2F;memory-pressure.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
    &lt;img src=&quot;.&amp;#x2F;memory-pressure.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
  &lt;&#x2F;picture&gt;
  &lt;figcaption&gt;
    &lt;p&gt;Memory analysis of Element X in Android Studio (Element X is based on the Matrix
Rust SDK). It presents a callback tree, with the number of allocations and
deallocations for each node in this tree. Thanks &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jmartinesp&quot;&gt;Jorge&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
&lt;p&gt;And, holy cow, we see &lt;strong&gt;a lot&lt;&#x2F;strong&gt; of memory allocations, exactly 322&#x27;042 to be
precise, counting for 743Mib, for the &lt;code&gt;eyeball_im_util::vector::sort::SortBy&lt;&#x2F;code&gt;
type! I don&#x27;t remember exactly how many rooms are part of the Room List, but
it&#x27;s probably around 500-600.&lt;&#x2F;p&gt;

    &lt;p&gt;&lt;small&gt;Download fullsize image as: &lt;a href=&quot;.&amp;#x2F;memory-pressure.avif&quot; title=&quot;Download the AVIF image&quot;&gt;AVIF&lt;&#x2F;a&gt;,
      &lt;a href=&quot;.&amp;#x2F;memory-pressure.webp&quot; title=&quot;Download the WebP image&quot;&gt;WebP&lt;&#x2F;a&gt;,
      &lt;a href=&quot;.&amp;#x2F;memory-pressure.png&quot; title=&quot;Download the PNG image&quot;&gt;PNG&lt;&#x2F;a&gt;.&lt;&#x2F;small&gt;&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The Room List wasn&#x27;t frozen. It was taking &lt;strong&gt;a lot&lt;&#x2F;strong&gt; of time to yield values.
Sometimes, up to 5 minutes on a phone. Alright, we have two problems to solve
here:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Why is it random?&lt;&#x2F;li&gt;
&lt;li&gt;Why so many memory allocations and deallocations?&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;The second problem will be discussed in the next section. Let&#x27;s start with the
first problem in this section, shall we?&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s start at the beginning. &lt;code&gt;eyeball_im_util::vector::sort::SortBy&lt;&#x2F;code&gt; is used
like so:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sort_by&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_lexicographic&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vec!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_latest_event&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_recency&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_name&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    ]))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;sort_by&lt;&#x2F;code&gt; receives a sorter: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-ui&#x2F;0.16.0&#x2F;matrix_sdk_ui&#x2F;room_list_service&#x2F;sorters&#x2F;fn.new_sorter_lexicographic.html&quot;&gt;&lt;code&gt;new_sorter_lexicographic&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. It&#x27;s from
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-ui&#x2F;0.16.0&#x2F;matrix_sdk_ui&#x2F;room_list_service&#x2F;sorters&#x2F;&quot;&gt;&lt;code&gt;matrix_sdk_ui::room_list::sorters&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, and it&#x27;s a constructor for a…
lexicographic sorter. All sorters must implement &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-ui&#x2F;0.16.0&#x2F;matrix_sdk_ui&#x2F;room_list_service&#x2F;sorters&#x2F;trait.Sorter.html&quot;&gt;the &lt;code&gt;Sorter&lt;&#x2F;code&gt; trait&lt;&#x2F;a&gt;.
Once again, it&#x27;s a trait from &lt;code&gt;matrix_sdk_ui&lt;&#x2F;code&gt;, nothing fancy, it&#x27;s simply this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Trait “alias”.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; trait&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Fn&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; All functions `F` are auto-implementing `Sorter`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;impl&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;F&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; for&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; F&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;where&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    F&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Fn&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Put it differently, all functions with two parameters of type &lt;code&gt;&amp;amp;Room&lt;&#x2F;code&gt;, and with
a return type &lt;code&gt;Ordering&lt;&#x2F;code&gt; is considered a sorter. There. It&#x27;s crystal clear now,
except… what&#x27;s a lexicographic sorter?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Should I really quote the documentation of &lt;code&gt;new_sorter_lexicographic&lt;&#x2F;code&gt;? My work here is turning into a tragedy.&lt;&#x2F;p&gt;
&lt;p&gt;It creates a new sorter that will run multiple sorters. When the
&lt;math&gt;&lt;msup&gt;&lt;mi&gt;n&lt;&#x2F;mi&gt;&lt;mtext&gt;nth&lt;&#x2F;mtext&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt; sorter returns &lt;code&gt;Ordering::Equal&lt;&#x2F;code&gt;, the next
sorter is called. It stops as soon as a sorter returns &lt;code&gt;Ordering::Greater&lt;&#x2F;code&gt; or
&lt;code&gt;Ordering::Less&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This is an implementation of a lexicographic order as defined for &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Lexicographic_order#Cartesian_products&quot;&gt;cartesian
products&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;In short, we are executing 3 sorters: by &lt;em&gt;latest event&lt;&#x2F;em&gt;, by &lt;em&gt;recency&lt;&#x2F;em&gt;
and by &lt;em&gt;name&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;None of these sorters are using any form of randomness. It&#x27;s a
&lt;em lang=&quot;fr&quot;&gt;cul-de-sac&lt;&#x2F;em&gt;. Let&#x27;s take a step back by looking at &lt;code&gt;SortBy&lt;&#x2F;code&gt;
in &lt;code&gt;eyeball_im_util&lt;&#x2F;code&gt; itself maybe? &lt;i&gt;Scroll the documentation&lt;&#x2F;i&gt;, not here,
&lt;i&gt;read the initial patch&lt;&#x2F;i&gt;, hmm, I see a mention of a binary search, &lt;i&gt;jump
into the code&lt;&#x2F;i&gt;, ah, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;blob&#x2F;b7dc6fde71e507459ecbd7519a8a22f12bf2a8de&#x2F;eyeball-im-util&#x2F;src&#x2F;vector&#x2F;sort.rs#L315-L318&quot;&gt;here, look at the comment&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;When looking for the &lt;em&gt;position&lt;&#x2F;em&gt; of a value (e.g. where to insert a new
value?), &lt;code&gt;Vector::binary_search_by&lt;&#x2F;code&gt; is used — it is possible because the
&lt;code&gt;Vector&lt;&#x2F;code&gt; is sorted. When looking for the &lt;em&gt;unsorted index&lt;&#x2F;em&gt; of a value,
&lt;code&gt;Iterator::position&lt;&#x2F;code&gt; is used.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&#x2F;7.0.0&#x2F;imbl&#x2F;type.Vector.html#method.binary_search_by&quot;&gt;&lt;code&gt;Vector::binary_search_by&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; doesn&#x27;t mention any form of randomness in its documentation. Another &lt;em lang=&quot;fr&quot;&gt;cul-de-sac&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Remember that the Room List appears frozen but it is actually blank. The problem
is not when the stream receives an update, but when the stream is “created”,
i.e. when the initial items are sorted for the first time before receiving
updates.&lt;&#x2F;p&gt;
&lt;p&gt;Moreover, the comment says &lt;q&gt;it is possible because the &lt;code&gt;Vector&lt;&#x2F;code&gt; is sorted&lt;&#x2F;q&gt;,
which indicates that “the vector” (I guess it&#x27;s a buffer somewhere) &lt;em&gt;has been
sorted&lt;&#x2F;em&gt; one way or another. What do you think?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Ah! Brilliant. That&#x27;s correct! Looking at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;blob&#x2F;b7dc6fde71e507459ecbd7519a8a22f12bf2a8de&#x2F;eyeball-im-util&#x2F;src&#x2F;vector&#x2F;sort.rs#L261&quot;&gt;the constructor of
&lt;code&gt;SortBy&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; (or its implementation), we notice it&#x27;s using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&#x2F;7.0.0&#x2F;imbl&#x2F;type.Vector.html#method.sort_by&quot;&gt;&lt;code&gt;Vector::sort_by&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. And guess what? It&#x27;s relying on… &lt;i&gt;drum roll&lt;&#x2F;i&gt;…
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jneem&#x2F;imbl&#x2F;blob&#x2F;6feb48d04ed9bd2a004968541d1a90d61c423d31&#x2F;src&#x2F;vector&#x2F;mod.rs#L1575-L1583&quot;&gt;quicksort&lt;&#x2F;a&gt;! Following the path, we see
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jneem&#x2F;imbl&#x2F;blob&#x2F;6feb48d04ed9bd2a004968541d1a90d61c423d31&#x2F;src&#x2F;sort.rs#L177-L185&quot;&gt;it actually creates a pseudo random number generator (PRNG) to do the
quicksort&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Phew. Finally. Time for a cup of tea and a biscuit&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-biscuit-1&quot;&gt;&lt;a href=&quot;#fn-biscuit&quot;&gt;4&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;My guess here is the following. Depending on the (pseudo randomly) generated
pivot index, the number of comparisons may vary each time this runs. We can enter
a pathological case where more comparisons means more memory pressure,
which means slower sorting, which means… A Frozen Room List&lt;sup&gt;&lt;abbr
title=&quot;Trademark&quot;&gt;TM&lt;&#x2F;abbr&gt;&lt;&#x2F;sup&gt;, &lt;i&gt;play horror movie music&lt;&#x2F;i&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;memory-pressure&quot;&gt;Memory Pressure&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#memory-pressure&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A memory allocator is responsible for… well… allocating the memory. If you believe
this is a simple problem, please retract this offensive thought quickly: what an
oaf! Memory is managed based on the strategy or strategies used by the memory
allocator: there is not a unique solution. Each memory allocator comes with
tradeoffs: do you allocate and replace multiple similar small objects several
times in a row, do you need fixed-size blocks of memory, dynamic blocks etc.&lt;&#x2F;p&gt;
&lt;p&gt;Allocating memory is not free. The memory allocator has a cost in itself
—which could be mitigated by implementing a custom memory allocator maybe—,
but there is also &lt;strong&gt;a hardware cost&lt;&#x2F;strong&gt;, and it&#x27;s comparatively more difficult to
mitigate. Memory is allocated on the heap, i.e. &lt;em&gt;the RAM&lt;&#x2F;em&gt;, also called &lt;em&gt;the
main memory&lt;&#x2F;em&gt; (not be confused with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CPU_cache&quot;&gt;CPU caches: L1, L2…&lt;&#x2F;a&gt;). The RAM
is nice and all, but it lives far from the CPU. It &lt;em&gt;takes time&lt;&#x2F;em&gt; to allocate
something on the heap and…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Hold on a second. I heard it is around 100-150 nanoseconds to fetch a data from
the heap. In what world is this “costly”? How is this “far” from the CPU?&lt;&#x2F;p&gt;
&lt;p&gt;I understand we are talking about &lt;em&gt;random&lt;&#x2F;em&gt; accesses (the &lt;em&gt;R&lt;&#x2F;em&gt; in RAM), and
multiple indirections, but still, it sounds pretty fast, right?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Hmm, &lt;i&gt;refrain from opening the Pandora&#x27;s box&lt;&#x2F;i&gt; - let&#x27;s try to stay high-level
here, shall we? Be careful: the numbers I am going to present can vary depending on
your hardware, but the important part is &lt;strong&gt;the scale&lt;&#x2F;strong&gt;: keep that in mind.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Operation&lt;&#x2F;th&gt;&lt;th style=&quot;text-align: right&quot;&gt;Time&lt;&#x2F;th&gt;&lt;th style=&quot;text-align: right&quot;&gt;“Human scale”&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;Fetch from L1 cache&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;1ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;1mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Branch misprediction&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;3ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;3mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Fetch from L2 cache&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;4ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;4mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Mutex lock&#x2F;unlock&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;17ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;17mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Fetch from the main memory&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;100ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;1h40mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;SSD random read&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;16&#x27;000ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;11.11 days&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;figcaption&gt;
&lt;p&gt;Latency numbers for the year 2020 for various operations (source:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;people.eecs.berkeley.edu&#x2F;~rcs&#x2F;research&#x2F;interactive_latency.html&quot;&gt;&lt;cite&gt;Latency Numbers Every Programmer Shoud Know&lt;&#x2F;cite&gt; from Colin Scott (UC
Berkeley)&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;The time in the second column is given in nanoseconds, i.e.
&lt;math&gt;
&lt;mfrac&gt;
&lt;mn&gt;1&lt;&#x2F;mn&gt;
&lt;mn&gt;1&#x27;000&#x27;000&#x27;000&lt;&#x2F;mn&gt;
&lt;&#x2F;mfrac&gt;
&lt;&#x2F;math&gt;
second. The time in the third column is “humanized” to give us a better sense of
the scale here: we imagine 1ns maps to 1min.&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Do you see the difference between the L1&#x2F;L2 caches and the main memory? 1ns to
100ns is the same difference as 1mn to 1h40. So, yes, it takes time to read
from memory. That&#x27;s why we try to avoid allocations as much as possible.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;svg viewBox=&quot;0 0 200 35&quot; role=&quot;img&quot;&gt;
  &lt;style&gt;
  text { font-size: 4pt }
  circle {
    fill: oklch(69.50% .140 76.18);
    animation: 4s linear 0s infinite alternate slide;
  }
  .l1 { animation-duration: .5s }
  .ram { animation-duration: 50s }
  @keyframes slide {
    from {
      transform: translateX(15%);
    }
    to {
      transform: translateX(85%);
    }
  }
  &lt;&#x2F;style&gt;
  &lt;text x=&quot;0&quot; y=&quot;12&quot;&gt;CPU&lt;&#x2F;text&gt;
  &lt;text x=&quot;0&quot; y=&quot;27&quot;&gt;CPU&lt;&#x2F;text&gt;
  &lt;text x=&quot;180&quot; y=&quot;12&quot;&gt;L1&lt;&#x2F;text&gt;
  &lt;text x=&quot;180&quot; y=&quot;27&quot;&gt;RAM&lt;&#x2F;text&gt;
  &lt;circle cx=&quot;0&quot; cy=&quot;10&quot; r=&quot;4&quot; class=&quot;l1&quot; &#x2F;&gt;
  &lt;circle cx=&quot;0&quot; cy=&quot;25&quot; r=&quot;4&quot; class=&quot;ram&quot; &#x2F;&gt;
&lt;&#x2F;svg&gt;
&lt;figcaption&gt;
&lt;p&gt;Not comfortable with numbers? Let&#x27;s try to visualise it with 1ns = 1s!&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Sadly, in our case, it appears we are allocating 322&#x27;042 times to sort the
initial rooms of the Room List, for a total of 743&#x27;151&#x27;616 bits allocated,
with 287 bytes per allocation. Of course, if we are doing quick napkin
maths&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-napkin-math-1&quot;&gt;&lt;a href=&quot;#fn-napkin-math&quot;&gt;5&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;, it should take around 200ms. We are far from The Frozen
Room List&lt;sup&gt;&lt;abbr title=&quot;Trademark&quot;&gt;TM&lt;&#x2F;abbr&gt;&lt;&#x2F;sup&gt;, but there is more going
on.&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-suspens-1&quot;&gt;&lt;a href=&quot;#fn-suspens&quot;&gt;6&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Do you remember the memory allocator? Its role is to also avoid &lt;em&gt;fragmentation&lt;&#x2F;em&gt;
as much as possible. The number of memory “blocks” isn&#x27;t infinite: when memory
blocks are freed, and new ones are allocated later, maybe the previous blocks
are no longer available and cannot be reused. The allocator has to find a good
place, while keeping fragmentation under control. Maybe the blocks must be moved
to create enough space to insert the new blocks (it&#x27;s often preferable to have
contiguous blocks).&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s what I call &lt;strong&gt;memory pressure&lt;&#x2F;strong&gt;. We are asking too much, too fast, and
the memory allocator we use in the Matrix Rust SDK is not designed to handle
this use case.&lt;&#x2F;p&gt;
&lt;p&gt;What are our solutions then?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;May I suggest an approach? What about finding where we are allocating and
deallocating memory? Then we might be able to reduce either the number of
allocations, or the size of the value being allocated (and deallocated), with
the hope of making the memory allocator happier. Possible solutions:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;If the allocated value is too large to fit in the stack, we could return a
pointer to it if possible,&lt;&#x2F;li&gt;
&lt;li&gt;Maybe we don&#x27;t need the full value: we could return just a pointer to a
fragment of it?&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Excellent ideas. Let&#x27;s track which sorter creates the problem. We start
with the sorter that was recently modified: &lt;code&gt;latest_event&lt;&#x2F;code&gt;. In short, this sorter
compares the &lt;code&gt;LatestEventValue&lt;&#x2F;code&gt; of two rooms: the idea is that rooms with a
&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt; representing a &lt;em&gt;local event&lt;&#x2F;em&gt;, i.e. an event that is not sent
yet, or is sending, must be at the top of the Room List. Alright, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;3eb693acadb08db8e41de90ef51730d206168e7c&#x2F;crates&#x2F;matrix-sdk-ui&#x2F;src&#x2F;room_list_service&#x2F;sorters&#x2F;latest_event.rs#L64C1-L69C2&quot;&gt;let&#x27;s look at
its core part&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; new_sorter&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; latest_events&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;latest_event&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;latest_event&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    move&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;| -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cmp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;latest_events&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span&gt;) }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Alright. For each sorting iteration, the &lt;code&gt;Room::latest_event&lt;&#x2F;code&gt; method is called
twice. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;3eb693acadb08db8e41de90ef51730d206168e7c&#x2F;crates&#x2F;matrix-sdk-base&#x2F;src&#x2F;room&#x2F;latest_event.rs#L38&quot;&gt;This method is as follows&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; latest_event&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; LatestEventValue&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;clone&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Oh, there it is. We are acquiring a read lock over the &lt;code&gt;info&lt;&#x2F;code&gt; value, then we
are reading the &lt;code&gt;latest_event&lt;&#x2F;code&gt; field, and we are cloning the value. Cloning
is important here as we don&#x27;t want to hold the read lock for too long. This
is our culprit. The size of the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;3eb693acadb08db8e41de90ef51730d206168e7c&#x2F;crates&#x2F;matrix-sdk-base&#x2F;src&#x2F;latest_event.rs#L29&quot;&gt;&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; type
is 144 bytes (it doesn&#x27;t count the size of the event itself, because this size
is dynamic).&lt;&#x2F;p&gt;
&lt;p&gt;Before going further, let&#x27;s check whether another sorter has a similar problem,
shall we? &lt;i&gt;Look at the other sorters&lt;&#x2F;i&gt;, oh!, turns out &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;01c0775e5974ad8a8690f5c580e79612ddcdfa2d&#x2F;crates&#x2F;matrix-sdk-ui&#x2F;src&#x2F;room_list_service&#x2F;sorters&#x2F;recency.rs#L90&quot;&gt;the &lt;code&gt;recency&lt;&#x2F;code&gt;
sorter&lt;&#x2F;a&gt; also uses the &lt;code&gt;latest_event&lt;&#x2F;code&gt; method! Damn, this is
becoming really annoying.&lt;&#x2F;p&gt;
&lt;p&gt;Question: do we need the entire &lt;code&gt;LatestEventValue&lt;&#x2F;code&gt;? Probably not!&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;For the &lt;code&gt;latest_event&lt;&#x2F;code&gt; sorter, we actually only need to know when this
&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt; is &lt;em&gt;local&lt;&#x2F;em&gt;, that&#x27;s it.&lt;&#x2F;li&gt;
&lt;li&gt;For the &lt;code&gt;recency&lt;&#x2F;code&gt; sorter, we only need to know the timestamp of the
&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;So instead of copying the whole value in memory twice per sorter iteration, for
two sorters, let&#x27;s try to write more specific methods:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; latest_event_is_local&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_local&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; latest_event_timestamp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;MilliSecondsSinceUnixEpoch&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;timestamp&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Just like that, &lt;strong&gt;the throughput has been improved by 18%&lt;&#x2F;strong&gt; according to the
&lt;code&gt;room_list&lt;&#x2F;code&gt; benchmark. You can see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;commit&#x2F;62eb1996d917fb1928bdb9bba40d78a6eefe0bbd&quot;&gt;the patch in “action”&lt;&#x2F;a&gt;. Can we
declare victory over memory pressure?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I beg your pardon, but I don&#x27;t believe it&#x27;s a victory. We have reduced the size
of allocations, but not the number of allocations itself.&lt;&#x2F;p&gt;
&lt;p&gt;Well, actually, &lt;code&gt;latest_event_is_local&lt;&#x2F;code&gt; returns a &lt;code&gt;bool&lt;&#x2F;code&gt;: it
can fit in the stack. And &lt;code&gt;latest_event_timestamp&lt;&#x2F;code&gt; returns an
&lt;code&gt;Option&amp;lt;MilliSecondsSinceUnixEpoch&amp;gt;&lt;&#x2F;code&gt;, where &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;ruma&#x2F;0.14.1&#x2F;ruma&#x2F;struct.MilliSecondsSinceUnixEpoch.html&quot;&gt;&lt;code&gt;MilliSecondsSinceUnixEpoch&lt;&#x2F;code&gt; is a
&lt;code&gt;Uint&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, which &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;js_int&#x2F;0.2.2&#x2F;js_int&#x2F;struct.UInt.html&quot;&gt;itself is a &lt;code&gt;f64&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;: it can
also fit in the stack.&lt;&#x2F;p&gt;
&lt;p&gt;So, yes, we may have reduced the number of allocations greatly, that&#x27;s agreed,
it explains the 18% throughput improvement. However, issue reporters were
mentioning a lag of 5 minutes or so, do you remember? How do you explain the
remaining 4 minutes 6 seconds then? This is still unacceptable, right?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Definitely yes! Everything above 200ms (from our napkin maths) is unacceptable
here. Memory pressure was an important problem, and it&#x27;s now solved, but it
wasn&#x27;t the only problem.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;lock-contention&quot;&gt;Lock Contention&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#lock-contention&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The assiduous reader may have noticed that we are still dealing with a lock here.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;…&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;        ^^^^^^&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;        |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;        this read lock acquisition&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Do you remember we had 322&#x27;042 allocations? It represents the number of times the &lt;code&gt;latest_event&lt;&#x2F;code&gt; method was called basically, which means…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;… the lock is acquired 322&#x27;042 times!&lt;&#x2F;p&gt;
&lt;p&gt;…&lt;&#x2F;p&gt;
&lt;p&gt;… no?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;… yes… and please, stop interrupting me, I was trying to build up a suspense for
a climax.&lt;&#x2F;p&gt;
&lt;p&gt;Anyway. Avoiding a lock isn&#x27;t an easy task. However, this lock around &lt;code&gt;info&lt;&#x2F;code&gt;
is particularly annoying because it&#x27;s called by almost all sorters! They need
information about a &lt;code&gt;Room&lt;&#x2F;code&gt;; all information are in this &lt;code&gt;info&lt;&#x2F;code&gt; field, which is a
read-write lock. Hmmm.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s change our strategy. We need to take a step back:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;The sorters need these data.&lt;&#x2F;li&gt;
&lt;li&gt;The data won&#x27;t change when the sorters run.&lt;&#x2F;li&gt;
&lt;li&gt;When a data changes, it actually runs the sorters.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Maybe we could fetch, ahead of time, all the necessary data for all sorters in
a single type: it will be refreshed when the data change, so right before the
sorters run again.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;The idea here is to organise the data around a specific layout. The focus on the
data layout aims at being CPU cache friendly as much as possible. This kind of
approach is called &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Data-oriented_design&quot;&gt;&lt;em&gt;Data-oriented Design&lt;&#x2F;em&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;That&#x27;s correct. If the type is small enough, it can fit more easily in the
CPU caches, like L1 or L2. Do you remember how fast they are? 1ns and 4ns,
much faster than the 100ns for the main memory. Moreover, it removes the lock
contention and the memory pressure entirely!&lt;&#x2F;p&gt;
&lt;details&gt;
&lt;summary&gt;
&lt;p&gt;I highly recommend watching the following talks&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-talks-1&quot;&gt;&lt;a href=&quot;#fn-talks&quot;&gt;7&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; if you want to learn more about Data-oriented Design (DoD)&lt;&#x2F;p&gt;
&lt;&#x2F;summary&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;rX0ItVEVjHc&quot;
    title=&quot;Data-Oriented Design and C++, by Mike Acton, at the CppCon 2014&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Data-Oriented Design and C++, by Mike Acton, at the CppCon 2014&lt;&#x2F;p&gt;

    &lt;p&gt;The transformation of data is the only purpose of any program. Common approaches in C++ which are antithetical to this goal will be presented in the context of a performance-critical domain (console game development). Additionally, limitations inherent in any C++ compiler and how that affects the practical use of the language when transforming that data will be demonstrated. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;CppCon&#x2F;CppCon2014&#x2F;tree&#x2F;master&#x2F;Presentations&#x2F;Data-Oriented%20Design%20and%20C%2B%2B&quot;&gt;View the slides&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;WDIkqP4JbkE&quot;
    title=&quot;Cpu Caches and Why You Care, by Scott Meyers, at the code::dive conference 2014&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Cpu Caches and Why You Care, by Scott Meyers, at the code::dive conference 2014&lt;&#x2F;p&gt;

    &lt;p&gt;This talk explores CPU caches and their impact on program performance.&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;p&gt;So. Let&#x27;s be serious: I suggest to try to do some Data-oriented Design here,
shall we? We start by putting all our data in a single type:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItem&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::latest_event_timestamp`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_latest_event_timestamp&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;MilliSecondsSinceUnixEpoch&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::latest_event_is_local`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_latest_event_is_local&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::recency_stamp`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_recency_stamp&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomRecencyStamp&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::cached_display_name`, already as a string.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_display_name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::is_space`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_is_space&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Cache of `Room::state`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_state&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomState&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItem&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; refresh_cached_data&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; room&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;cached_latest_event_timestamp &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; room&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_latest_event_timestamp&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; etc.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;At this point, the size of &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; is 64 bytes, acceptably small!&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;The L1 and L2 caches nowadays have a size of several kilobytes. You can try to
run &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;man.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=sysctl&quot;&gt;&lt;code&gt;sysctl&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; or &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;linux.die.net&#x2F;man&#x2F;1&#x2F;getconf&quot;&gt;&lt;code&gt;getconf&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; in a shell to see how much your hardware supports
(look for an entry like “cache line”, or “cache line size” for example).&lt;&#x2F;p&gt;
&lt;p&gt;On my system for example, the L1 (data) cache size is 65Kb, and the cache line
size is 128 bytes.&lt;&#x2F;p&gt;
&lt;p&gt;Ideally, we —at the very least— want one &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; to fit in a cache line.
Compacting the type to avoid inner paddings would be ideal. If there is a
&lt;em&gt;cache miss&lt;&#x2F;em&gt; in L1, the CPU will look at the next cache, so L2, and so on, until
reaching the main memory. The cost of a cache miss is then: look up in L1, plus
cache miss, plus look up in L2 etc.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;commit&#x2F;a84c97b292c658109bfb40391b5f10b0708276d4&quot;&gt;A bit of plumbing later&lt;&#x2F;a&gt;, this new &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; type is
used everywhere by the Room List, by all its filters and all its sorters. For
example, the &lt;code&gt;latest_event&lt;&#x2F;code&gt; sorter now looks like:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; new_sorter&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; latest_events&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomListItem&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomListItem&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;cached_latest_event_is_local,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;cached_latest_event_is_local)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    move&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;| -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cmp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;latest_events&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span&gt;) }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The lock acquisitions happen only in the &lt;code&gt;refresh_cached_data&lt;&#x2F;code&gt;, when a new
update happens, but not during the filtering or sorting anymore. Let&#x27;s see what
the benchmark has to say now.&lt;&#x2F;p&gt;
&lt;p&gt;Before:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellscript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; cargo bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; room_list&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomList&#x2F;Create&#x2F;1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; rooms ×&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    time:   [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;53.027&lt;&#x2F;span&gt;&lt;span&gt; ms &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;53.149&lt;&#x2F;span&gt;&lt;span&gt; ms &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;53.273&lt;&#x2F;span&gt;&lt;span&gt; ms]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    thrpt:&lt;&#x2F;span&gt;&lt;span&gt;  [18.771&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Kelem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 18.815&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Kelem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 18.858&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Kelem&#x2F;s]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;After:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellscript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; cargo bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; room_list&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomList&#x2F;Create&#x2F;1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; rooms ×&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;           time:   [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;676.29&lt;&#x2F;span&gt;&lt;span&gt; µs &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;676.84&lt;&#x2F;span&gt;&lt;span&gt; µs &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;677.50&lt;&#x2F;span&gt;&lt;span&gt; µs]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;           thrpt:&lt;&#x2F;span&gt;&lt;span&gt;  [1.4760&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Melem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1.4775&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Melem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1.4787&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Melem&#x2F;s]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    change:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;           time:   [-98.725% -98.721% -98.716%] (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0.00&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0.05&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;           thrpt:&lt;&#x2F;span&gt;&lt;span&gt;  [+7686.9%&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; +7718.5% +7745.6%]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;           Performance&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; has improved.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Boom!&lt;&#x2F;p&gt;
&lt;p&gt;We don&#x27;t see the 5 minutes lag mentioned by the reporters, but remember it&#x27;s
random. Nonetheless, &lt;strong&gt;the performance impact is huge&lt;&#x2F;strong&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;From 18.8Kelem&#x2F;s to 1.4Melem&#x2F;s,&lt;&#x2F;li&gt;
&lt;li&gt;From 53ms to 676µs, or —to compare with the same unit— 0.676ms, so &lt;strong&gt;78× faster&lt;&#x2F;strong&gt;!&lt;&#x2F;li&gt;
&lt;li&gt;The throughput has improved by 7718.5%, and the time by 98.7%.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Can we claim victory now?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Apparently yes! The reporters were unable to reproduce the problem anymore. It
seems it&#x27;s solved! Looking at profilers, we see millions fewer allocations in
the benchmark runs (the benchmark does a lot of allocations for the setup, but
the difference is pretty noticeable).&lt;&#x2F;p&gt;
&lt;p&gt;Data-oriented Design is fascinating. Understanding how computers work, how the
memory and the CPU work, is crucial to optimise algorithms. The changes we&#x27;ve
applied are small compared to performance improvement it has brought!&lt;&#x2F;p&gt;
&lt;p&gt;You said everything above 200ms is unacceptable. With 676µs, I reckon the target
is reached. It&#x27;s even below the napkin maths about main memory access, which
suggests we are not hitting the RAM anymore in the filters and sorters (not
in an uncivilised way at least). Also, it&#x27;s funny that the difference between
a L1-L2 caches access (1-4ns) and a main memory access (100ns) is in average
40 times faster, which looks suspiciously similar to the 78 times factor we see
here. It confirms we are hitting L1 more frequently than L2, which is a good
sign!&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;The benchmark Iteration Times and Regression graphs are interesting to look at.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;1-iteration-times.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;1-iteration-times.svg&quot; alt=&quot;Iteration times&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;figcaption&gt;
&lt;p&gt;The initial Iteration Times, before our patches. Notice how the points do not
follow any “trend”. It&amp;#39;s a clear sign the program is acting erratically.&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;2-iteration-times.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;2-iteration-times.svg&quot; alt=&quot;Iteration times&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;figcaption&gt;
&lt;p&gt;The final Iteration Times&#x2F;Regression, after our patches. Notice how the points
are linear.&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The second graph is the kind of graph I like. Predictable.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;In this concrete case, it&#x27;s difficult to improve the performance further because
&lt;code&gt;RoomListItem&lt;&#x2F;code&gt; is used by sorters, and by filters, and in other places of the
code. The current usage of &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; falls into the definition of &lt;em&gt;Array
of Structures&lt;&#x2F;em&gt; in the Data-oriented Design terminology. After all, we clearly
have a &lt;code&gt;Vec&amp;lt;RoomListItem&amp;gt;&lt;&#x2F;code&gt; at the root of everything. It is efficient but
&lt;em&gt;Structure of Arrays&lt;&#x2F;em&gt; might be even more efficient. Instead of having:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItem&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    a&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    b&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u64&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    c&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; rooms&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomListItem&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;we would have:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItems&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    a&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;bool&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    b&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    c&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;bool&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; rooms&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItems&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is not applicable in our situation because sorters are iterating over
different fields. However, if you&#x27;re sure only one field in a single loop is
used, this &lt;em&gt;Structure of Arrays&lt;&#x2F;em&gt; is cache friendlier as it loads less data in
the CPU caches: less padding, less useless bytes. By making a better use of the
cache line, not only we are pretty sure the program will run faster, but the
CPU will be better at predicting what data will be loaded in the cache line,
boosting the performance even more!&lt;&#x2F;p&gt;
&lt;p&gt;Just so you know my role here is not restricted to recite documentation or to
summarise Wikipedia entries.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Of course you&amp;#39;re valuable! Now, the surprise.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;The Dessert&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Of course, let&amp;#39;s not forget about our dessert! I won&amp;#39;t dig too much: the
patch contains all the necessary gory details. In short, it&amp;#39;s about how
&lt;code&gt;VectorDiff::Set&lt;&#x2F;code&gt; can create a nasty bug in &lt;code&gt;SortBy&lt;&#x2F;code&gt;. Basically, when a value
in the vector is updated, a &lt;code&gt;VectorDiff::Set&lt;&#x2F;code&gt; is emitted. &lt;code&gt;SortBy&lt;&#x2F;code&gt; is then
responsible for computing a new &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;it was calculating the old position of the value,&lt;&#x2F;li&gt;
&lt;li&gt;it was calculating the new position,&lt;&#x2F;li&gt;
&lt;li&gt;depending on that, it was emitting the appropriate &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;However, the old “value” wasn&amp;#39;t removed from the buffer &lt;em&gt;immediately&lt;&#x2F;em&gt; and
not &lt;em&gt;every time&lt;&#x2F;em&gt;. In theory, it should not cause any problem —it was an
optimisation after all— except if… the items manipulated by the stream are
“shallow clones”. Shallow cloning a value won&amp;#39;t copy the value entirely: we get
a new value, but its state is synced with the original value. This happens with
types such as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[derive(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Clone&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; S&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    inner&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Arc&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here, cloning a value of type &lt;code&gt;S&lt;&#x2F;code&gt; and changing its &lt;code&gt;inner&lt;&#x2F;code&gt; field will also
update the original value.&lt;&#x2F;p&gt;
&lt;p&gt;Just like that, it was possible to systematically create… &lt;strong&gt;an infinite loop&lt;&#x2F;strong&gt;.
Funky isn&amp;#39;t it?&lt;&#x2F;p&gt;
&lt;p&gt;You can view the patch &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;pull&#x2F;80&quot;&gt;Fix an infinite loop when &lt;code&gt;SortBy&amp;lt;Stream&amp;lt;Item = T&amp;gt;&amp;gt;&lt;&#x2F;code&gt; handles a &lt;code&gt;VectorDiff::Set&lt;&#x2F;code&gt; where &lt;code&gt;T&lt;&#x2F;code&gt; is a shallow clone
type&lt;&#x2F;a&gt; to learn more.&lt;&#x2F;p&gt;
&lt;p&gt;I think this is a concrete example of when jumping on an optimisation can lead
to a bug. I&amp;#39;m not saying we should not prematurely optimise our programs: I&amp;#39;m a partisan of the “we should” camp. I&amp;#39;m
saying that bugs can be pretty subtle sometimes, and this bug would have been
avoided if we hadn&amp;#39;t taken a shortcut in this algorithm. It&amp;#39;s important to be
correct first, then measure, then improve.&lt;&#x2F;p&gt;
&lt;p&gt;I hope you&amp;#39;ve learned a couple of things, and you&amp;#39;ve enjoyed your reading.&lt;&#x2F;p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn-vectordiff_on_other_uis&quot;&gt;
&lt;p&gt;On &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;swiftui&#x2F;&quot;&gt;SwiftUI&lt;&#x2F;a&gt;, there is the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;collectiondifference&#x2F;change&quot;&gt;&lt;code&gt;CollectionDifference.Change&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; enum. For example: &lt;code&gt;VectorDiff::PushFront&lt;&#x2F;code&gt;
is equivalent to &lt;code&gt;Change.insert(offset: 0)&lt;&#x2F;code&gt;. On &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;compose&quot;&gt;Jetpack Compose&lt;&#x2F;a&gt;, there is
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;kotlinlang.org&#x2F;api&#x2F;core&#x2F;kotlin-stdlib&#x2F;kotlin.collections&#x2F;-mutable-list&#x2F;&quot;&gt;&lt;code&gt;MutableList&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; object. For example: &lt;code&gt;VectorDiff::Clear&lt;&#x2F;code&gt; is equivalent to
&lt;code&gt;MutableList.clear()&lt;&#x2F;code&gt;! &lt;a href=&quot;#fr-vectordiff_on_other_uis-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-switch&quot;&gt;
&lt;p&gt;I would &lt;em&gt;love&lt;&#x2F;em&gt; to talk about how this &lt;code&gt;Stream&lt;&#x2F;code&gt; produces
a &lt;code&gt;Stream&lt;&#x2F;code&gt;, how the outer stream and the inner stream are switched (with
&lt;code&gt;.switch()&lt;&#x2F;code&gt;!), how we&amp;#39;ve implemented that from scratch, but it&amp;#39;s probably
for another article. Meanwhile, you can take a look at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;async-rx&#x2F;0.1.3&#x2F;async_rx&#x2F;struct.Switch.html&quot;&gt;&lt;code&gt;async_rx::Switch&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-switch-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-stream_assert&quot;&gt;
&lt;p&gt;Do you know &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;stream_assert&#x2F;0.1.1&#x2F;stream_assert&#x2F;&quot;&gt;&lt;code&gt;stream_assert&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;? It&amp;#39;s another crate we&amp;#39;ve
written to easily apply assertions on &lt;code&gt;Stream&lt;&#x2F;code&gt;s. Pretty convenient. &lt;a href=&quot;#fr-stream_assert-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-biscuit&quot;&gt;
&lt;p&gt;Yes, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.biscuitsec.org&#x2F;&quot;&gt;biscuit&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-biscuit-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-napkin-math&quot;&gt;
&lt;p&gt;I highly recommend to read the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;sirupsen&#x2F;napkin-math&#x2F;&quot;&gt;Napkin Math&lt;&#x2F;a&gt; project, with
the great talk at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=IxkSlnrRFqc&quot;&gt;SRECON&amp;#39;19, &lt;cite&gt;Advanced Napkin Math: Estimating System
Performance from First Principles&lt;&#x2F;cite&gt; by Simon Eskildsen&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-napkin-math-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-suspens&quot;&gt;
&lt;p&gt;Do you remember the lock contention? Wait for it. At this step of
the story, I wasn&amp;#39;t aware we had a lock contention yet. &lt;a href=&quot;#fr-suspens-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-talks&quot;&gt;
&lt;p&gt;If you are curious and enjoy watching talks, I&amp;#39;m maintaining
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;playlist?list=PLOkMRkzDhWGX_4YWI4ZYGbwFPqKnDRudf&quot;&gt;a playlist of interesting talks I&amp;#39;ve watched&lt;&#x2F;a&gt;. Also
you can read this old article &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;one-conference-per-day-for-one-year-2017&#x2F;&quot;&gt;Once conference per day, for one year
(2017)&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-talks-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;section&gt;
</description>
      </item>
      <item>
          <title>From 19k to 4.2M events&#x2F;sec: story of a SQLite query optimisation</title>
          <pubDate>Fri, 12 Sep 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation/</link>
          <guid>https://mnt.io/articles/from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation/</guid>
          <description xml:base="https://mnt.io/articles/from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation/">&lt;p&gt;Sit down comfortably. Take a cushion if you wish. This is, &lt;i&gt;clear its
throat&lt;&#x2F;i&gt;, the story of a funny performance quest. The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&quot;&gt;Matrix Rust SDK&lt;&#x2F;a&gt; is a
set of crates aiming at providing all the necessary tooling to develop robust
and safe &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;matrix.org&#x2F;&quot;&gt;Matrix&lt;&#x2F;a&gt; clients. Of course, it involves databases to persist some
data. The Matrix Rust SDK supports multiple databases: in-memory, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;&quot;&gt;SQLite&lt;&#x2F;a&gt;, and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;API&#x2F;IndexedDB_API&quot;&gt;IndexedDB&lt;&#x2F;a&gt;. This story is about the SQLite database.&lt;&#x2F;p&gt;
&lt;p&gt;The structure we want to persist is a novel type we have designed specifically
for the Matrix Rust SDK: a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-common&#x2F;0.14.0&#x2F;matrix_sdk_common&#x2F;linked_chunk&#x2F;index.html&quot;&gt;&lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. It&#x27;s the underlying structure that
holds all events manipulated by the Matrix Rust SDK. It is somewhat similar to
a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Linked_List&quot;&gt;linked list&lt;&#x2F;a&gt;; the differences are subtle and the goal of this article is
&lt;em&gt;not&lt;&#x2F;em&gt; to present all the details. We have developed many API around this type
to make all operations fast and efficient in the context of the Matrix protocol.
What we need to know is that in a &lt;code&gt;LinkedChunk&amp;lt;_, Item, Gap&amp;gt;&lt;&#x2F;code&gt;, each node
contains a &lt;code&gt;ChunkContent&amp;lt;Item, Gap&amp;gt;&lt;&#x2F;code&gt; defined as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ChunkContent&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Item&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Gap&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Gap&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Gap&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Items&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Item&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Put it differently: each node can contain a &lt;em&gt;gap&lt;&#x2F;em&gt;, or a set of &lt;em&gt;items&lt;&#x2F;em&gt; (be
Matrix events).&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;May I recapitulate?&lt;&#x2F;p&gt;
&lt;p&gt;Each Matrix &lt;em&gt;room&lt;&#x2F;em&gt; contains a &lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;, which is a set of &lt;em&gt;chunks&lt;&#x2F;em&gt;. Each
&lt;em&gt;chunk&lt;&#x2F;em&gt; is either a &lt;em&gt;gap&lt;&#x2F;em&gt; or a set of &lt;em&gt;events&lt;&#x2F;em&gt;. It seems to map fairly easily to
SQL tables, isn&#x27;t it?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;You&#x27;re right: it&#x27;s pretty straightforward! Let&#x27;s see the first table:
&lt;code&gt;linked_chunks&lt;&#x2F;code&gt; which contains all the chunks. (Note that the schemas are
simplified for the sake of clarity).&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;linked_chunks&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which linked chunk does this chunk belong to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;linked_chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Identifier of the chunk, unique per linked chunk.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;id&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Identifier of the previous chunk.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;previous&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Identifier of the next chunk.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;next&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Our enum for the content of the chunk: `E` for events, `G` for a gap.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;type&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; TEXT CHECK&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;type&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; IN&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;E&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;G&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)) &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Alrighty. Next contenders: the &lt;code&gt;event_chunks&lt;&#x2F;code&gt; and the &lt;code&gt;gap_chunks&lt;&#x2F;code&gt; tables, which
store the &lt;code&gt;ChunkContent&lt;&#x2F;code&gt;s of each chunk, respectively for &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt;
and &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt;. In &lt;code&gt;event_chunks&lt;&#x2F;code&gt;, each row corresponds to an event. In
&lt;code&gt;gap_chunks&lt;&#x2F;code&gt;, each row corresponds to a gap.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;event_chunks&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which linked chunk does this event belong to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;linked_chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which chunk does this event refer to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- The event ID.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;event_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Position (index) in the **chunk**.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;position&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;gap_chunks&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which linked chunk does this event belong to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;linked_chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which chunk does this gap refer to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Last contender, &lt;code&gt;events&lt;&#x2F;code&gt;. The assiduous reader may have noted that
&lt;code&gt;event_chunks&lt;&#x2F;code&gt; doesn&#x27;t contain the content of the events: only its ID and its
position, &lt;i&gt;roll its eyes&lt;&#x2F;i&gt;… let&#x27;s digress a bit, should we? Why is that? To
handle out-of-band events. In the Matrix protocol, we can receive events via:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#get_matrixclientv3sync&quot;&gt;the &lt;code&gt;&#x2F;sync&lt;&#x2F;code&gt; endpoint&lt;&#x2F;a&gt;, it&#x27;s the main source of inputs, we get most
of the events via this API,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#get_matrixclientv3roomsroomidmessages&quot;&gt;the &lt;code&gt;&#x2F;messages&lt;&#x2F;code&gt; endpoint&lt;&#x2F;a&gt;, when we need to get events around a
particular events; this is helpful if we need to paginate backwards or
forwards around an event,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#get_matrixclientv3roomsroomidcontexteventid&quot;&gt;the &lt;code&gt;&#x2F;context&lt;&#x2F;code&gt; endpoint&lt;&#x2F;a&gt;, if we need to get more context about
an event.&lt;&#x2F;li&gt;
&lt;li&gt;but there is more, like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#mroompinned_events&quot;&gt;pinned events&lt;&#x2F;a&gt;, and so on.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;When an event is fetched but cannot be positioned regarding other events, it is
considered &lt;em&gt;out-of-band&lt;&#x2F;em&gt;: it belongs to zero linked chunk, but we keep it in the
database. Maybe we can attach it to a linked chunk later, or we want to keep it
for saving future network requests. Anyway. You&#x27;re a great digression companion.
Let&#x27;s jump back to our tables.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;events&lt;&#x2F;code&gt; table contains &lt;em&gt;all&lt;&#x2F;em&gt; the events: in-band &lt;em&gt;and&lt;&#x2F;em&gt; out-of-band.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- Events and their content.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;events&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- The ID of the event.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;event_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- The JSON encoded content of the event (it&amp;#39;s an encrypted value).&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;content&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;At some point, we need to fetch metadata about a &lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;. A certain
algorithm needs these metadata to work efficiently. We don&#x27;t need to load all
events, however we need:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;to know all the chunks that are part of a linked chunk,&lt;&#x2F;li&gt;
&lt;li&gt;for each chunk, the number of events: 0 in case of a &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt;
(&lt;code&gt;G&lt;&#x2F;code&gt;), or the number of events in case of a &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt; (&lt;code&gt;E&lt;&#x2F;code&gt;).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;A first implementation has landed in the Matrix Rust SDK. All good. When
suddenly…&lt;&#x2F;p&gt;
&lt;h2 id=&quot;incredibly-slow-sync&quot;&gt;&lt;q cite=&quot;https:&#x2F;&#x2F;github.com&#x2F;element-hq&#x2F;element-x-ios-rageshakes&#x2F;issues&#x2F;4248&quot;&gt;Incredibly slow sync&lt;&#x2F;q&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#incredibly-slow-sync&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A power-user&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-power-user-1&quot;&gt;&lt;a href=&quot;#fn-power-user&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; was &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;element-hq&#x2F;element-x-ios-rageshakes&#x2F;issues&#x2F;4248&quot;&gt;experiencing slowness&lt;&#x2F;a&gt;. It&#x27;s always
a delicate situation. How to know the reason of the slowness? Is it the device?
The network? The asynchronous runtime? A lock contention? The file system? …
The database?&lt;&#x2F;p&gt;
&lt;p&gt;We don&#x27;t have the device within easy reach. Hopefully, Matrix users are always
nice and willing to help! We have added a bunch of logs, then the user has
reproduced the problem, and shared their logs (via a rageshake) with us. Logs
are never trivial to analyse. However, here is a tip we use in the Matrix Rust
SDK: we have a special tracing type that logs the time spent in a portion of the
code; called &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-common&#x2F;0.14.0&#x2F;matrix_sdk_common&#x2F;tracing_timer&#x2F;struct.TracingTimer.html&quot;&gt;&lt;code&gt;TracingTimer&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Basically, when a &lt;code&gt;TracingTimer&lt;&#x2F;code&gt; is created, it keeps its creation time in
memory. And when the &lt;code&gt;TracingTimer&lt;&#x2F;code&gt; is dropped, it emits a log containing the
elapsed time since its creation. It looks like this (it uses
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;tracing&#x2F;&quot;&gt;the &lt;code&gt;tracing&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt;):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; TracingTimer&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; String&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;static DefaultCallsite&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    start&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Instant&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    level&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Level&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Drop&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; for&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; TracingTimer&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; drop&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; enabled&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;level_enabled!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;level)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; interest&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;interest&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            !&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;interest&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_never&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                &amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;__macro_support&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;__is_enabled&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; interest&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        if&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; !&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;enabled&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            return&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; message&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; format!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;_{}_ finished in {:?}&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;id,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;start&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;elapsed&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; fields&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;fields&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; message_field&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; fields&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;field&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;message&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; [(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;message_field&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;message&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;dyn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Value&lt;&#x2F;span&gt;&lt;span&gt;))];&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; This function is hidden from docs, but we have to use it&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; because there is no other way of obtaining a `ValueSet`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; It&amp;#39;s not entirely clear why it is private. See this issue:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; https:&#x2F;&#x2F;github.com&#x2F;tokio-rs&#x2F;tracing&#x2F;issues&#x2F;2363&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; fields&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;value_set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;values&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;dispatch&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;values&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And with that, let&#x27;s use its companion macro &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-common&#x2F;0.14.0&#x2F;matrix_sdk_common&#x2F;macro.timer.html&quot;&gt;&lt;code&gt;timer!&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; (I won&#x27;t copy-paste it
here, it&#x27;s pretty straightforward):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _timer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; timer!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;built something important&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; … build something important …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; `_timer` is dropped here, and will emit a log.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With this technique, we were able to inspect the logs and saw immediately what
was slow… assuming we have added &lt;code&gt;timer!&lt;&#x2F;code&gt;s at the right places! It&#x27;s not magic,
it doesn&#x27;t find performance issues for you. You have to probe the correct places
in your code, and refine if necessary.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I don&#x27;t know if you heard about &lt;em&gt;sampling profilers&lt;&#x2F;em&gt;, but those are programs
far superior at analysing performance problems, compared to your… rustic
&lt;code&gt;TracingTimer&lt;&#x2F;code&gt; (pun intended!). Such programs can provide flamegraphs, call
trees etc.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m personally a regular user of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mstange&#x2F;samply&quot;&gt;samply&lt;&#x2F;a&gt;, a command line CPU profiler relying
on the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;firefox-devtools&#x2F;profiler&quot;&gt;Firefox profiler&lt;&#x2F;a&gt; for its UI. It works on macOS, Linux and Windows.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;I do also use &lt;code&gt;samply&lt;&#x2F;code&gt; pretty often! But you need an access to the processes
to use such tools. Here, the Matrix Rust SDK is used and embedded inside Matrix
clients. We have no access to it. It lives on devices everywhere around the
world. We may use better log analysers to infer “call trees”, but supporting
asynchronous logs (because the code is asynchronous) makes it very difficult.
And I honestly don&#x27;t know if such a thing exists.&lt;&#x2F;p&gt;
&lt;p&gt;So. Yes. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;pull&#x2F;5407&quot;&gt;We found the culprit&lt;&#x2F;a&gt;. With &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;BurntSushi&#x2F;ripgrep&quot;&gt;&lt;code&gt;ripgrep&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, we were able to scan
megabytes of logs and find the culprit pretty quickly. I was looking for lags of
the order of a second. I wasn&#x27;t disappointed:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; rg &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;_method_ finished in.*&amp;gt; load_all_chunks_metadata&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; all.log &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; rg&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;\d+(\.\d+)?s&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --only-matching&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; sort&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --numeric-sort --reverse&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;107.121747125s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;79.909931458s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;10.348993583s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;8.827636417s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;8.614481625s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;8.009787875s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;5.99637875s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;4.118492334s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.910040333s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.718858334s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.689340667s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.661383208s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;107 seconds. Be 1 minute and 47 seconds. Hello sweety.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-slow-query&quot;&gt;The slow query&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-slow-query&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;load_all_chunks_metadata&lt;&#x2F;code&gt; is a method that runs this SQL query:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;    COUNT&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;event_id&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; number_of_events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;FROM&lt;&#x2F;span&gt;&lt;span&gt; linked_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; lc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;LEFT JOIN&lt;&#x2F;span&gt;&lt;span&gt; event_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; ec&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;ON&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;WHERE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;linked_chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;GROUP BY&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;For each chunk of the linked chunk, it counts the number of events associated to
this chunk. That&#x27;s it.&lt;&#x2F;p&gt;
&lt;p&gt;Do you remember that a chunk can be of two kinds: &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt; if it
contains a set of events, or &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt; if it contains a gap, so, no
event.&lt;&#x2F;p&gt;
&lt;p&gt;This query does the following:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;if the chunk is of kind &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt;, it does count all events
associated to itself (via &lt;code&gt;ec.chunk_id = lc.id&lt;&#x2F;code&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;otherwise, the chunk is of kind &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt;, so it will try to count
but… no event is associated to it: it&#x27;s impossible to get
&lt;code&gt;ec.chunk_id = lc.id&lt;&#x2F;code&gt; to be true for a gap. This query will scan &lt;em&gt;all events&lt;&#x2F;em&gt;
for each gap… for no reason whatsoever! This is a linear scan here. If there
are 300 gaps for this linked chunk, and 5000 events, 1.5 millions events will
be scanned for &lt;strong&gt;no reason&lt;&#x2F;strong&gt;!&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;How lovingly inefficient.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;12-6x-faster&quot;&gt;&lt;math&gt;&lt;mn&gt;12.6&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#12-6x-faster&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;q&gt;Let&#x27;s use an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;lang_createindex.html&quot;&gt;&lt;code&gt;INDEX&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;q&gt; I hear you say (let&#x27;s pretend
you&#x27;re saying that, please, for the sake of the narrative!).&lt;&#x2F;p&gt;
&lt;p&gt;A database index provides rapid lookups after all. It has become a reflex
amongst the developer community.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Indexes are designed to quickly locate data without scanning the full table. An
index contains a copy of the data, organised in a way enabling very efficient
search. Behind the scene, it uses various data structures, involving trade-offs
between lookup performance and index size. Most of the time, an index makes it
possible to transform a linear lookup,
&lt;math&gt;
&lt;mi&gt;O&lt;&#x2F;mi&gt;&lt;mo&gt;(&lt;&#x2F;mo&gt;
&lt;mi&gt;n&lt;&#x2F;mi&gt;
&lt;mo&gt;)&lt;&#x2F;mo&gt;
&lt;&#x2F;math&gt;,
to a logarithmic lookup,
&lt;math&gt;
&lt;mi&gt;O&lt;&#x2F;mi&gt;&lt;mo&gt;(&lt;&#x2F;mo&gt;
&lt;mo lspace=&quot;0&quot; rspace=&quot;0&quot;&gt;log&lt;&#x2F;mo&gt;&lt;mo&gt;(&lt;&#x2F;mo&gt;
&lt;mi&gt;n&lt;&#x2F;mi&gt;
&lt;mo&gt;)&lt;&#x2F;mo&gt;
&lt;mo&gt;)&lt;&#x2F;mo&gt;
&lt;&#x2F;math&gt;.
See &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Database_index&quot;&gt;Database index&lt;&#x2F;a&gt; to learn more.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;That&#x27;s correct. But we didn&#x27;t want to use an index here. The reason is twofold:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;More spaces&lt;&#x2F;strong&gt;. Remember that &lt;em&gt;Le Procureur&lt;&#x2F;em&gt; said an index contains a
&lt;em&gt;copy&lt;&#x2F;em&gt; of the data. Here, the data is &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;appendices&#x2F;#event-ids&quot;&gt;the event ID&lt;&#x2F;a&gt;. It&#x27;s not
heavy, but it&#x27;s not nothing. Moreover, we are not counting the &lt;em&gt;key&lt;&#x2F;em&gt; to
associate the &lt;em&gt;copied data&lt;&#x2F;em&gt; to the row containing the real data in the source
table.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Still extra useless time&lt;&#x2F;strong&gt;. We would still need to traverse the index for
gaps, which is pointless.
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;arch.html&quot;&gt;SQLite implements indexes as B-Trees&lt;&#x2F;a&gt;, which is really
efficient, but still, we already know that a gap has zero event because…
it&#x27;s… a gap between events!&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Do you remember that the &lt;code&gt;linked_chunks&lt;&#x2F;code&gt; table has a &lt;code&gt;type&lt;&#x2F;code&gt; column? It contains
&lt;code&gt;E&lt;&#x2F;code&gt; when the chunk is of kind &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt; —it represents a set of
events—, and &lt;code&gt;G&lt;&#x2F;code&gt; when of kind &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt; —it represents a gap—. Maybe…
&lt;i&gt; stare into the void&lt;&#x2F;i&gt;&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;May I interrupt?&lt;&#x2F;p&gt;
&lt;p&gt;Do you know that SQLite provides &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;lang_expr.html#the_case_expression&quot;&gt;a &lt;code&gt;CASE&lt;&#x2F;code&gt; expression&lt;&#x2F;a&gt;? I know it&#x27;s
unusual. SQL designers prefer to think in terms of sets, sub-sets, joins,
temporal tables, partial indexes… but honestly, for what I&#x27;m concerned, in
our case, it&#x27;s simple enough and it can be powerful. It&#x27;s a maddeningly
pragmatic &lt;code&gt;match&lt;&#x2F;code&gt; statement.&lt;&#x2F;p&gt;
&lt;p&gt;Moreover, the &lt;code&gt;type&lt;&#x2F;code&gt; column is already typed as an enum with the &lt;code&gt;CHECK(&quot;type&quot; IN (&#x27;E&#x27;, &#x27;G&#x27;))&lt;&#x2F;code&gt; constraint. Maybe the SQL engine can run some even smarter
optimisations for us.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Oh, that would be brilliant! If &lt;code&gt;type&lt;&#x2F;code&gt; is &lt;code&gt;E&lt;&#x2F;code&gt;, we count the number of events,
otherwise we conclude it&#x27;s &lt;em&gt;de facto&lt;&#x2F;em&gt; zero, isn&#x27;t it? Let&#x27;s try. The SQL query
then becomes:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    CASE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;type&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    WHEN&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;E&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; THEN&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        SELECT&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; COUNT&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;event_id&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        FROM&lt;&#x2F;span&gt;&lt;span&gt; event_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; ec&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        WHERE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    ELSE&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;        0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    END&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    as&lt;&#x2F;span&gt;&lt;span&gt; number_of_events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;FROM&lt;&#x2F;span&gt;&lt;span&gt; linked_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; lc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;WHERE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;linked_chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Since we have spotted the problem, we have written a benchmark to measure the
solutions. The benchmark simulates 10&#x27;000 events, with 1 gap every 80 events.
A set of data we consider &lt;em&gt;realistic&lt;&#x2F;em&gt; somehow for a normal user (not for a
power-user though, because a power-user has usually more gaps than events). Here
are the before&#x2F;after results.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Lower bound&lt;&#x2F;th&gt;
        &lt;th&gt;Estimate&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Upper bound&lt;&#x2F;th&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;thead&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;Throughput&lt;&#x2F;td&gt;
        &lt;td&gt;19.832 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;19.917 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;19.999 Kelem&#x2F;s&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;math&gt;&lt;msup&gt;&lt;mi&gt;R&lt;&#x2F;mi&gt;&lt;mn&gt;2&lt;&#x2F;mn&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;0.0880234&lt;&#x2F;td&gt;
        &lt;td&gt;0.1157540&lt;&#x2F;td&gt;
        &lt;td&gt;0.0857823&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Mean&lt;&#x2F;td&gt;
        &lt;td&gt;500.03 ms&lt;&#x2F;td&gt;
        &lt;td&gt;502.08 ms&lt;&#x2F;td&gt;
        &lt;td&gt;504.24 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Standard Deviation&quot;&gt;Std. Dev.&lt;&#x2F;td&gt;
        &lt;td&gt;2.2740 ms&lt;&#x2F;td&gt;
        &lt;td&gt;3.6256 ms&lt;&#x2F;td&gt;
        &lt;td&gt;4.1963 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Median&lt;&#x2F;td&gt;
        &lt;td&gt;498.23 ms&lt;&#x2F;td&gt;
        &lt;td&gt;500.93 ms&lt;&#x2F;td&gt;
        &lt;td&gt;506.25 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Median Absolute Deviation&quot;&gt;MAD&lt;&#x2F;td&gt;
        &lt;td&gt;129.84 µs&lt;&#x2F;td&gt;
        &lt;td&gt;4.1713 ms&lt;&#x2F;td&gt;
        &lt;td&gt;6.1184 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&#x27;s results for the original query with &lt;code&gt;COUNT&lt;&#x2F;code&gt; and &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;details&gt;
  &lt;summary&gt;
&lt;p&gt;The Probability Distribution Function graph, and the Iteration times graph for
the &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt; approach&lt;&#x2F;p&gt;
  &lt;&#x2F;summary&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-pdf.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-pdf.svg&quot; alt=&quot;Probability distribution function&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Probability Distribution Function for the &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-iteration-times.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-iteration-times.svg&quot; alt=&quot;Iteration times&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Iteration Times for the &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Lower bound&lt;&#x2F;th&gt;
        &lt;th&gt;Estimate&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Upper bound&lt;&#x2F;th&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;thead&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;Throughput&lt;&#x2F;td&gt;
        &lt;td&gt;251.61 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;251.84 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;251.98 Kelem&#x2F;s&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;math&gt;&lt;msup&gt;&lt;mi&gt;R&lt;&#x2F;mi&gt;&lt;mn&gt;2&lt;&#x2F;mn&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;0.9999778&lt;&#x2F;td&gt;
        &lt;td&gt;0.9999833&lt;&#x2F;td&gt;
        &lt;td&gt;0.9999673&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Mean&lt;&#x2F;td&gt;
        &lt;td&gt;39.684 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.703 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.726 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Standard Deviation&quot;&gt;Std. Dev.&lt;&#x2F;td&gt;
        &lt;td&gt;8.8237 µs&lt;&#x2F;td&gt;
        &lt;td&gt;35.948 µs&lt;&#x2F;td&gt;
        &lt;td&gt;47.987 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Median&lt;&#x2F;td&gt;
        &lt;td&gt;39.683 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.691 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.725 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Median Absolute Deviation&quot;&gt;MAD&lt;&#x2F;td&gt;
        &lt;td&gt;1.9369 µs&lt;&#x2F;td&gt;
        &lt;td&gt;13.000 µs&lt;&#x2F;td&gt;
        &lt;td&gt;50.566 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s results for the new query with the &lt;code&gt;CASE&lt;&#x2F;code&gt; expression.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;details&gt;
  &lt;summary&gt;
&lt;p&gt;The Probability Distribution Function graph, and the Linear Regression graph
for the &lt;code&gt;CASE&lt;&#x2F;code&gt; approach&lt;&#x2F;p&gt;
  &lt;&#x2F;summary&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-pdf.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-pdf.svg&quot; alt=&quot;Probability distribution function&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Probability Distribution Function for the &lt;code&gt;CASE&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-linear-regression.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-linear-regression.svg&quot; alt=&quot;Linear regression&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Linear Regression for the &lt;code&gt;CASE&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;p&gt;The throughput and the time are &lt;math&gt;&lt;mn&gt;12.6&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; better. No
&lt;code&gt;INDEX&lt;&#x2F;code&gt;. No more &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt;. Just a simple &lt;code&gt;CASE&lt;&#x2F;code&gt; expression. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;pull&#x2F;5411&quot;&gt;You can see the
patches containing the benchmark and the fix&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But that&amp;#39;s not all…&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;&lt;math&gt;&lt;mn&gt;211&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;It&amp;#39;s clearly better, but we couldn&amp;#39;t stop ourselves. Having spotted the problem,
and having found this solution, it has made us creative! We have noticed that
we are running one query per chunk of kind &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt;. If the linked
chunk contains 100 chunks, it will run 101 queries.&lt;&#x2F;p&gt;
&lt;p&gt;Then suddenly, &lt;i&gt;hit forehead with the hand&amp;#39;s palm&lt;&#x2F;i&gt;, an idea pops! What if
we could only use 2 queries for all scenarios!&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;The first query would count all events for each chunk in &lt;code&gt;events_chunk&lt;&#x2F;code&gt; in
one pass, and would store that in a &lt;code&gt;HashMap&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;The second query would fetch all chunks also in one pass,&lt;&#x2F;li&gt;
&lt;li&gt;Finally, Rust will fill the number of events for each chunk based on the data
in the &lt;code&gt;HashMap&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;The first query translates like so in Rust:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; The first query.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_events_by_chunk_ids&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; transaction&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;prepare&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        r#&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            ec.chunk_id,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            COUNT(ec.event_id)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        FROM event_chunks as ec&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        WHERE ec.linked_chunk_id = ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        GROUP BY ec.chunk_id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        &amp;quot;#&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;query_map&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;hashed_linked_chunk_id&lt;&#x2F;span&gt;&lt;span&gt;,),&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Ok&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    })&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;collect&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;HashMap&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And the second query translates like so&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-simplified-code-1&quot;&gt;&lt;a href=&quot;#fn-simplified-code&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;transaction&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;prepare&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        r#&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.id,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.previous,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.next,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.type&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        FROM linked_chunks as lc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        WHERE lc.linked_chunk_id = ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        &amp;quot;#&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;query_map&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;hashed_linked_chunk_id&lt;&#x2F;span&gt;&lt;span&gt;,),&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Ok&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; String&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    })&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;| -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;identifier&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; chunk_type&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Let&amp;#39;s use the `HashMap` from the first query here!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_events&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_events_by_chunk_ids&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;copied&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;unwrap_or&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Ok&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ChunkMetadata&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            identifier&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            number_of_events&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        })&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    })&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;collect&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Only two queries. All tests are passing. Now let&amp;#39;s see what the benchmark has to
say!&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Lower bound&lt;&#x2F;th&gt;
        &lt;th&gt;Estimate&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Upper bound&lt;&#x2F;th&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;thead&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;Throughput&lt;&#x2F;td&gt;
        &lt;td&gt;4.1490 Melem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;4.1860 Melem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;4.2221 Melem&#x2F;s&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;math&gt;&lt;msup&gt;&lt;mi&gt;R&lt;&#x2F;mi&gt;&lt;mn&gt;2&lt;&#x2F;mn&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;0.9961591&lt;&#x2F;td&gt;
        &lt;td&gt;0.9976310&lt;&#x2F;td&gt;
        &lt;td&gt;0.9960356&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Mean&lt;&#x2F;td&gt;
        &lt;td&gt;2.3670 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.3824 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.3984 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Standard Deviation&quot;&gt;Std. Dev.&lt;&#x2F;td&gt;
        &lt;td&gt;16.065 µs&lt;&#x2F;td&gt;
        &lt;td&gt;26.872 µs&lt;&#x2F;td&gt;
        &lt;td&gt;31.871 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Median&lt;&#x2F;td&gt;
        &lt;td&gt;2.3556 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.3801 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.4047 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Median Absolute Deviation&quot;&gt;MAD&lt;&#x2F;td&gt;
        &lt;td&gt;3.8003 µs&lt;&#x2F;td&gt;
        &lt;td&gt;36.438 µs&lt;&#x2F;td&gt;
        &lt;td&gt;46.445 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s results for the two queries approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;details&gt;
  &lt;summary&gt;
&lt;p&gt;The Probability Distribution Function graph, and the Linear Regression graph
for the two queries approach&lt;&#x2F;p&gt;
  &lt;&#x2F;summary&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-pdf.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-pdf.svg&quot; alt=&quot;Probability distribution function&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Probability Distribution Function for the two queries approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-linear-regression.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-linear-regression.svg&quot; alt=&quot;Linear regression&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Linear Regression for the two queries approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;p&gt;&lt;strong&gt;It is &lt;math&gt;&lt;mn&gt;16.7&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster compared to the previous
solution, so &lt;math&gt;&lt;mn&gt;211&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster than the first query!
We went from 502ms to 2ms. That&amp;#39;s mental! From a throughput of 19.9 Kelem&#x2F;s
to 4.2 Melem&#x2F;s!&lt;&#x2F;strong&gt; &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;pull&#x2F;5425&quot;&gt;You can see the patches containing the improvement&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The throughput is measured by &lt;em&gt;element&lt;&#x2F;em&gt;, where an &lt;em&gt;element&lt;&#x2F;em&gt; here represents
a Matrix event. Consequently, 4 Melem&#x2F;s means 4 millions events per second,
which means that &lt;code&gt;load_all_chunks_metadata&lt;&#x2F;code&gt; can do its computation at a rate of
4 millions events per second.&lt;&#x2F;p&gt;
&lt;p&gt;I think we can stop here. Performance are finally acceptable.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;Lessons&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;bheisler.github.io&#x2F;criterion.rs&#x2F;book&#x2F;index.html&quot;&gt;Write benchmarks (with Criterion)&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;Run benchmarks.&lt;&#x2F;li&gt;
&lt;li&gt;Be aware of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;queryplanner-ng.html&quot;&gt;the SQL query planner&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;Be careful with joins.&lt;&#x2F;li&gt;
&lt;li&gt;Know your data.&lt;&#x2F;li&gt;
&lt;li&gt;Take a step back and count.&lt;&#x2F;li&gt;
&lt;li&gt;SQLite is fast.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Notice how the SQL tables layout didn&amp;#39;t change. Notice how the &lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;
implementation didn&amp;#39;t change. Only the SQL queries have changed, and it has
dramatically improved the situation.&lt;&#x2F;p&gt;
&lt;p&gt;This is joint effort between &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;bouvier.cc&#x2F;&quot;&gt;Benjamin Bouvier&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;poljar&quot;&gt;Damir Jelić&lt;&#x2F;a&gt; and
I.&lt;&#x2F;p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn-power-user&quot;&gt;
&lt;p&gt;We consider a &lt;em&gt;power-user&lt;&#x2F;em&gt; a user with more than 2000 rooms. I
hear your laugth! But guess what? We have users with more than 4000 rooms.
And I&amp;#39;m excluding bots here. The Matrix Rust SDK can be used to develop
bots, which can sit in thousands and thousands rooms easily. That said: we
have to be performant. &lt;a href=&quot;#fr-power-user-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-simplified-code&quot;&gt;
&lt;p&gt;The code has been simplified a little bit. In reality, basic
Rust types, like &lt;code&gt;u64&lt;&#x2F;code&gt; or &lt;code&gt;Option&amp;lt;u64&amp;gt;&lt;&#x2F;code&gt;, are mapped to linked chunk&amp;#39;s types. &lt;a href=&quot;#fr-simplified-code-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;section&gt;
</description>
      </item>
      <item>
          <title>Sliding Sync at the Matrix Conference</title>
          <pubDate>Wed, 30 Oct 2024 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/sliding-sync-at-the-matrix-conference/</link>
          <guid>https://mnt.io/articles/sliding-sync-at-the-matrix-conference/</guid>
          <description xml:base="https://mnt.io/articles/sliding-sync-at-the-matrix-conference/">&lt;p&gt;Berlin. &lt;time datetime=&quot;2024-09-21 10:00&quot;&gt;Saturday, September 21, 2024.
10am&lt;&#x2F;time&gt;. I was live on stage and broadcasted on Internet, to talk about
(Simplified) Sliding Sync, the next sync mechanism for Matrix, at the first
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;2024.matrix.org&#x2F;&quot;&gt;Matrix Conference&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;matrix.org&#x2F;&quot;&gt;Matrix&lt;&#x2F;a&gt; is an open network for secure, decentralised communication. It is an
important technology for Internet.&lt;&#x2F;p&gt;
&lt;p&gt;Matrix is a protocol. Everyone can implement it: either by providing its own
server and connect it to the federation, or by providing its own client and
connect it to the federation too. Nobody has a full control over the network,
and nobody controls the clients nor the servers. And yet, end-to-end encryption
is working, synchronisation is working, and everybody can talk to everybody,
communities organize themselves, the network grows and grows.&lt;&#x2F;p&gt;
&lt;p&gt;I am working at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;&quot;&gt;Element&lt;&#x2F;a&gt; since 2 years now. I am paid to work on the [Matrix
Rust SDK], a project owned by the Matrix organisation. Everything we do is
available to the entire Matrix community, not only for Element. Well, this is
the open source world.&lt;&#x2F;p&gt;
&lt;p&gt;Matrix previous synchronisation mechanism is slow and inefficient. To put
Matrix on the hands of everyone for a daily pleasant usage, we have started
to experiment with a new sync mechanism, called Sliding Sync. The MSC —which
stands for Matrix Spec Changes, like RFC for example—, so the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-spec-proposals&#x2F;blob&#x2F;kegan&#x2F;sync-v3&#x2F;proposals&#x2F;3575-sync.md&quot;&gt;MSC3575&lt;&#x2F;a&gt; was
our experimental foundation to play with a new sync mechanism. After many sweat
and tears, we ultimately found a working pattern and design that fulfill a
large majority of our usecases. Along the way, the implementation inside the
Sliding Sync Proxy —a proxy that sits on the top of a homeserver&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-1-1&quot;&gt;&lt;a href=&quot;#fn-1&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; to provide
this new sync mechanism— was starting to feel really buggy and was really slow.
It was time to clean up everything, including the MSC.&lt;&#x2F;p&gt;
&lt;p&gt;Enter &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-spec-proposals&#x2F;blob&#x2F;erikj&#x2F;sss&#x2F;proposals&#x2F;4186-simplified-sliding-sync.md&quot;&gt;MSC4186&lt;&#x2F;a&gt;, which is basically Simplified Sliding Sync. We have mostly
removed features from &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-spec-proposals&#x2F;blob&#x2F;kegan&#x2F;sync-v3&#x2F;proposals&#x2F;3575-sync.md&quot;&gt;MSC3575&lt;&#x2F;a&gt;, so that the implementation on the server-side
is much simpler and lighter. Simplified Sliding Sync is now implemented and
enabled by default on &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;element-hq&#x2F;synapse&#x2F;&quot;&gt;Synapse&lt;&#x2F;a&gt;, one of the major homeserver implementations.
Other homeservers have implemented MSC3575 and are working on supporting
MSC4186.&lt;&#x2F;p&gt;
&lt;p&gt;Sliding Sync has a huge impact on the overall user experience. Syncing is now
fast and almost transparent. It also works linearly whether the user has 10
or 10&#x27;000 rooms.&lt;&#x2F;p&gt;
&lt;p&gt;My talk can be viewed here:&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;kI2lSCVEunw&quot;
    title=&quot;Simplified Sliding Sync, by Ivan Enderlin, at the Matrix Conference 2024, Berlin&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Simplified Sliding Sync, by Ivan Enderlin, at the Matrix Conference 2024, Berlin&lt;&#x2F;p&gt;

    &lt;p&gt;&lt;a href=&quot;.&#x2F;slides.pdf&quot;&gt;Download the slides as PDF (21MiB)&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;h2 id=&quot;other-talks&quot;&gt;Other talks&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#other-talks&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;2024.matrix.org&#x2F;watch&#x2F;&quot;&gt;All the talks are available online&lt;&#x2F;a&gt;, including talks from the public
sector, like NATO, Sweden, French or German administrations… I encourage you to
check the list! Nonetheless, I take the opportunity of this article to highlight
some announcement talks, or technical (Matrix internals) talks, I&#x27;ve enjoyed.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;matrix-2-0-and-the-launch-of-element-x&quot;&gt;Matrix 2.0 and the launch of Element X!&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#matrix-2-0-and-the-launch-of-element-x&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Two presentations for the price of one: &lt;cite&gt;Matrix 2.0 Is Here!&lt;&#x2F;cite&gt; by
Matthew Hogdson. 10 years after the original launch of Matrix, and 5 years after
Matrix 1.0, what a best anniversary to announce Matrix 2.0.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;ZiRYdqkzjDU&quot;
    title=&quot;Matrix 2.0 Is Here!, by Matthew Hogdson, at the Matrix Conference 2024, Berlin&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Matrix 2.0 Is Here!, by Matthew Hogdson, at the Matrix Conference 2024, Berlin&lt;&#x2F;p&gt;

    &lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;2024.matrix.org&#x2F;documents&#x2F;talk_slides&#x2F;LAB3%202024-09-20%2010_15%20Matthew%20-%20Matrix%202.0%20is%20Here_%20The%20Matrix%20Conference%20Keynote.pdf&quot;&gt;View and download the slides&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The second video is &lt;cite&gt;Element X Launch!&lt;&#x2F;cite&gt; by Amandine Le Pape, Ștefan
Ceriu, and Amsha Kalra. They present Element X, how it&#x27;s been designed,
developed, how it uses the Matrix Rust SDK, and where you can see awesome demos
of Element X with Element Call and so on! It was a great moment for everyone
working at Element and users!&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;gHyHO3xPfQU&quot;
    title=&quot;Element X Launch!, by Amandine Le Pape, Ștefan Ceriu, and Amsha Kalra, at the Matrix Conference 2024, Berlin&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Element X Launch!, by Amandine Le Pape, Ștefan Ceriu, and Amsha Kalra, at the Matrix Conference 2024, Berlin&lt;&#x2F;p&gt;

    &lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;2024.matrix.org&#x2F;documents&#x2F;talk_slides&#x2F;LAB3%202024-09-20%2017_45%20Amandine%20Le%20Pape,%20Amsha%20Kalra,%20Stefan%20Ceriu%20-%20Element%20X%20Launch%20Complete%20Presentation.pdf&quot;&gt;View and download the slides&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;h3 id=&quot;unable-to-decrypt-this-mesage&quot;&gt;Unable to decrypt this mesage&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#unable-to-decrypt-this-mesage&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;cite&gt;Unable to decrypt this message&lt;&#x2F;cite&gt; by Kegan Dougal. This talk explains
why one can see an &lt;em&gt;Unable To Decrypt&lt;&#x2F;em&gt; error while trying to view a message in
Matrix. Most problems have been solved today, but the great message about this
presentation is to show how hard it is (was!) to provide reliable end-to-end
encryption over a federated network. One homeserver can be overused and then
slowed down, or a connection between two servers can be broken, or one device
lost its connectivity because it&#x27;s used in the subway, or whatever. All these
classes of problems are illustrated and explained. I liked it a lot because it
gives a good sense of why end-to-end encryption is hard over a giant
decentralised, federated network, with encryption keys being renewed frequently,
and how problems have been solved.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;FHzh2Y7BABQ&quot;
    title=&quot;Unable to decrypt this message, by Kegan Dougal, at the Matrix Conference 2024, Berlin&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Unable to decrypt this message, by Kegan Dougal, at the Matrix Conference 2024, Berlin&lt;&#x2F;p&gt;

    &lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;2024.matrix.org&#x2F;documents&#x2F;talk_slides&#x2F;LAB4%202024-09-21%2014_30%20Kegan%20Dougal%20-%20Unable%20to%20decrypt%20this%20message.pdf&quot;&gt;View and download the slides&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;h3 id=&quot;news-from-the-matrix-rust-sdk&quot;&gt;News from the Matrix Rust SDK&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#news-from-the-matrix-rust-sdk&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;cite&gt;Strengthening the Base: Laying the Groundwork for a more robust Rust
SDK&lt;&#x2F;cite&gt; by Benjamin Bouvier, a good friend! This talk explains the recent
updates of the Matrix Rust SDK: how we have designed new API to make the
developer experience easier and more robust.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;KOaoZKc1tgo&quot;
    title=&quot;Strengthening the Base: Laying the Groundwork for a more robust Rust SDK, by Benjamin Bouvier, at the Matrix Conference 2024, Berlin&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Strengthening the Base: Laying the Groundwork for a more robust Rust SDK, by Benjamin Bouvier, at the Matrix Conference 2024, Berlin&lt;&#x2F;p&gt;

    &lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;2024.matrix.org&#x2F;documents&#x2F;talk_slides&#x2F;LAB3%202024-09-20%2011_15%20Benjamin%20Bouvier%20-%20Rust%20SDK%20Foundation.pdf&quot;&gt;View and download the slides&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;h2 id=&quot;about-transport&quot;&gt;About transport&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#about-transport&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;I currently live in Switzerland. The conference was in Germany. Europe has a
fantastic rail network, and more importantly, a unique &lt;strong&gt;night train&lt;&#x2F;strong&gt; network!&lt;&#x2F;p&gt;
&lt;p&gt;Going there by plane would have generated 1&#x27;344 &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Global_warming_potential&quot;&gt;kg CO&lt;sub&gt;2&lt;&#x2F;sub&gt;eq&lt;&#x2F;a&gt;,
be 68% of my annual carbon budget (for a sustainable world, we should all be at
2&#x27;000 kg maximum). Taking the train however has generated
&lt;strong&gt;6.5 kg CO&lt;sub&gt;2&lt;&#x2F;sub&gt;eq, be 0.33% of my annual carbon budget&lt;&#x2F;strong&gt;. It&#x27;s 206 times
less than the plane!&lt;&#x2F;p&gt;
&lt;p&gt;If you are curious &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;back-on-track.eu&#x2F;night-train-map&#x2F;&quot;&gt;to try night train, you can check this map&lt;&#x2F;a&gt;
that lists all possible connections, stops, companies operating the trains
etc. Taking the night train is a nice way of travelling, and it saves a lot
of emissions.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;ve taken a regular day train to go to Berlin, and a night train to come back
home.&lt;&#x2F;p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn-1&quot;&gt;
&lt;p&gt;A &lt;em&gt;homeserver&lt;&#x2F;em&gt; in the Matrix terminology is simply a Matrix server. &lt;a href=&quot;#fr-1-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;section&gt;
</description>
      </item>
      <item>
          <title>Building a new site!</title>
          <pubDate>Tue, 08 Oct 2024 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/building-a-new-site/</link>
          <guid>https://mnt.io/articles/building-a-new-site/</guid>
          <description xml:base="https://mnt.io/articles/building-a-new-site/">&lt;p&gt;The time has come. I needed to rewrite my site from scratch. It was first
implemented with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jekxyl&#x2F;jekxyl&quot;&gt;Jekxyl&lt;&#x2F;a&gt;, a static site generator written with
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Xyl&quot;&gt;the XYL language&lt;&#x2F;a&gt;, a language I&#x27;ve developed inside &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Central&quot;&gt;Hoa&lt;&#x2F;a&gt;. I&#x27;ve migrated
my blog to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wordpress.com&quot;&gt;WordPress.com&lt;&#x2F;a&gt; when
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;bye-bye-liip-hello-automattic&#x2F;&quot;&gt;I was working there&lt;&#x2F;a&gt;.
The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;WordPress&#x2F;gutenberg&quot;&gt;Gutenberg editor&lt;&#x2F;a&gt; is really great, but there is no great
support for &lt;code&gt;&amp;lt;code&amp;gt;&lt;&#x2F;code&gt;. Plus, the theme I was using was pretty heavy. The
homepage was 1.15MiB! A simple article was 1.9MiB. Clearly not really efficient.
I wanted something more customisable, something light, something I can hack, and
more importantly, I wanted to start series.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;enter-zola&quot;&gt;Enter Zola&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#enter-zola&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.getzola.org&#x2F;&quot;&gt;Zola&lt;&#x2F;a&gt; is a static site generator written in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.rust-lang.org&#x2F;&quot;&gt;Rust&lt;&#x2F;a&gt;. It uses &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;commonmark.org&#x2F;&quot;&gt;CommonMark&lt;&#x2F;a&gt; for
the markup, which is nice and straightforward to use. The template system is
powerful and simple. Zola can build 34 pages in 392ms at the time of writing, I
consider this is fast.&lt;&#x2F;p&gt;
&lt;p&gt;Nothing particular to say. It&#x27;s a boring tool, which is great compliment. It
just works! In a couple of hours, I was able to get everything up and running.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;site-s-features&quot;&gt;Site&#x27;s features&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#site-s-features&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The site contains articles and series. A series is composed of several episodes.
That&#x27;s it. The URL patterns are the followings:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;&#x2F;articles&#x2F;&amp;lt;article-id&amp;gt;&#x2F;&lt;&#x2F;code&gt; to view an article,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;series&#x2F;&amp;lt;series-id&amp;gt;&#x2F;&lt;&#x2F;code&gt; to view all episodes of a series,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;series&#x2F;&amp;lt;series-id&amp;gt;&#x2F;&amp;lt;episode-id&amp;gt;&#x2F;&lt;&#x2F;code&gt; to view a particular episode of a series.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;homepage&quot;&gt;Homepage&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#homepage&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;The homepage provides:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;the latest series, and&lt;&#x2F;li&gt;
&lt;li&gt;pinned articles.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;To &lt;em&gt;pin&lt;&#x2F;em&gt; an article, I add the following TOML declarations in the frontmatter of
an article:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;toml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;extra&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;pinned&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This &lt;code&gt;pinned&lt;&#x2F;code&gt; declaration is not recognised by Zola: the &lt;code&gt;[extra]&lt;&#x2F;code&gt; section
contains user-defined values. Then, it&#x27;s a matter of filtering by this value in
the template:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;html&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;{% for page in section.pages | filter(attribute = &amp;quot;extra.pinned&amp;quot;, value = true) -%}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That&#x27;s a nice feature to promote some articles.&lt;&#x2F;p&gt;
&lt;p&gt;In comparison to WordPress.com, the new homepage is 36.8KiB, that&#x27;s 31 times
less!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;articles&quot;&gt;Articles&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#articles&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;An article has some metadata like:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;the publishing time,&lt;&#x2F;li&gt;
&lt;li&gt;the reading time,&lt;&#x2F;li&gt;
&lt;li&gt;keywords,&lt;&#x2F;li&gt;
&lt;li&gt;edition.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;If you read this article in October 2024, you might see all that in this very
article. The beauty of this hides in the source code though:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;html&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;main&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; vocab&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;https:&#x2F;&#x2F;schema.org&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;  &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;article&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;article&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; typeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Article&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;header&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;h1&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;name&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;Building a new site!&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;h1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;metadata&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;time&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; title&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Published date&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; datetime&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;2024-10-08&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;datePublished&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;October 08, 2024&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;time&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; title&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Reading time&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;timeRequired&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; content&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;PT2M&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;2 minutes read&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; title&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Keywords&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;keywords&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; content&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;rust, site&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;          Keywords:&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;&amp;amp;nbsp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; href&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&#x2F;keywords&#x2F;rust&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;rust&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; href&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&#x2F;keywords&#x2F;site&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;site&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; href&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&#x2F;keywords&#x2F;rdfa&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;rdfa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; href&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;mnt.io&#x2F;edit&#x2F;main&#x2F;content&#x2F;articles&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;&amp;amp;#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;2024-10-08-building-a-new-site&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;&amp;amp;#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;index.md&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; title&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Submit a patch for this page&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;Edit&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; this page&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;meta&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;description&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; content&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;…&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt; &#x2F;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;      &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;    &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;header&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &amp;lt;!-- … --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;First off, the site uses HTML semantics as much as possible with &lt;code&gt;article&lt;&#x2F;code&gt;,
&lt;code&gt;header&lt;&#x2F;code&gt;, &lt;code&gt;time&lt;&#x2F;code&gt;, &lt;code&gt;meta&lt;&#x2F;code&gt; etc. Second, you may also notice the &lt;code&gt;vocab&lt;&#x2F;code&gt;, &lt;code&gt;typeof&lt;&#x2F;code&gt;,
&lt;code&gt;property&lt;&#x2F;code&gt; and &lt;code&gt;content&lt;&#x2F;code&gt; attributes. This is an extension to HTML for &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.w3.org&#x2F;TR&#x2F;rdfa-primer&#x2F;&quot;&gt;Resource
Description Framework in Attributes&lt;&#x2F;a&gt; (RDFa for short). This is common to
add more semantics data to your content. It helps automated tools to analyse the
content of a Web document, and makes sense of it. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;schema.org&#x2F;&quot;&gt;schema.org&lt;&#x2F;a&gt; is a
collaborative effort to create schemas for structured data, and that&#x27;s what I
use in this site for the moment.&lt;&#x2F;p&gt;
&lt;p&gt;Last neat thing: did you notice you can edit the page? The code lives on Github,
and everyone is free to submit a patch!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;series&quot;&gt;Series&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#series&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;A series is pretty similar to an article, except that it adds another level of
indirection with episodes.&lt;&#x2F;p&gt;
&lt;p&gt;Similarly to articles with &lt;code&gt;pinned&lt;&#x2F;code&gt;, a series has its own metadata:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;toml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;extra&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;complete&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;complete&lt;&#x2F;code&gt; indicates whether the series is complete or in progress.&lt;&#x2F;p&gt;
&lt;p&gt;A series also has buttons to navigate to the previous or the next episodes.
Nothing fancy, but it&#x27;s fun to be able to do all that with Zola.&lt;&#x2F;p&gt;
&lt;p&gt;The hierarchy is intuitive to understand, and it uses RDFa heavily too, for
example a series overview with all its episodes looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;html&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;main&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; vocab&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;https:&#x2F;&#x2F;schema.org&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;  &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;section&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; typeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;CreativeWorkSeries&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;h1&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;name&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;From Rust to beyond&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;h1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &amp;lt;!-- … --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;h2&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;Episodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;h2&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; role&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;list&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; role&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;listitem&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;article-poster&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;hasPart&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; typeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Article&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; href&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&#x2F;series&#x2F;from-rust-to-beyond&#x2F;prelude&#x2F;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;url&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;Episode 1 – &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;name&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;Prelude&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;metadata&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;          &amp;lt;!-- … --&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; &lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;      &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; role&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;listitem&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;article-poster&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;hasPart&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; typeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Article&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; href&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;url&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;Episode 2 – &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; property&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;name&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;The WebAssembly galaxy&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;span&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end z-punctuation z-definition z-tag z-begin&quot;&gt;&amp;gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;a&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;metadata&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;          &amp;lt;!-- … --&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; &lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-begin&quot;&gt;        &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;div&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag z-end&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;      &amp;lt;!-- … --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;First off, we use the &lt;code&gt;role&lt;&#x2F;code&gt; HTML attribute to change the semantics
of some elements: here &lt;code&gt;div&lt;&#x2F;code&gt; become a &lt;code&gt;ul&lt;&#x2F;code&gt; or a &lt;code&gt;li&lt;&#x2F;code&gt;. Second, we use
&lt;code&gt;typeof=&quot;CreativeWorkSeries&quot;&lt;&#x2F;code&gt; to describe a series, which is composed
of different parts: &lt;code&gt;property=&quot;hasPart&quot;&lt;&#x2F;code&gt;. Each part is an article:
&lt;code&gt;typeof=&quot;Article&quot;&lt;&#x2F;code&gt;, which has its own semantics: &lt;code&gt;property=&quot;name&quot;&lt;&#x2F;code&gt; etc. The
markup is extremely simple but it contains all required information. HTML is
really powerful, I&#x27;m not going to lie!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;discuss&quot;&gt;Discuss&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#discuss&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;One novelty is the &lt;em&gt;Discuss&lt;&#x2F;em&gt; menu item at the top of the site. It contains a
link to a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;matrix.org&#x2F;&quot;&gt;Matrix&lt;&#x2F;a&gt; public room: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;matrix.to&#x2F;#&#x2F;#mnt_io:matrix.org&quot;&gt;https:&#x2F;&#x2F;matrix.to&#x2F;#&#x2F;#mnt_io:matrix.org&lt;&#x2F;a&gt;, where
anybody can come to talk about an article, a series, ask questions, or simply
chill. You&#x27;re very welcome there!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;good-ol-web&quot;&gt;Good ol&#x27; Web&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#good-ol-web&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The site has a short CSS stylesheet written by hand with no framework (oh yeah).
It weights 11KiB (uncompressed), heavy, I know.&lt;&#x2F;p&gt;
&lt;p&gt;The site also has &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;RSS&quot;&gt;RSS&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Atom_(web_standard)&quot;&gt;Atom&lt;&#x2F;a&gt; feeds for syndications. It even has a
blogroll under the &lt;em&gt;Recommandations&lt;&#x2F;em&gt; Section in the footer. Well, you get it,
I&#x27;m nostalgic of the old Web. It&#x27;s absolutely incredible what it is possible
to achieve today with HTML and CSS without any frameworks or polyfills. So much
resources are wasted nowadays…&lt;&#x2F;p&gt;
&lt;h2 id=&quot;personnages&quot;&gt;&lt;q&gt;Personnages&lt;&#x2F;q&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#personnages&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The biggest novelty is &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;lore&#x2F;&quot;&gt;the lore&lt;&#x2F;a&gt; I&#x27;ve developed for this new version
of the site. Please, welcome 3 characters: &lt;em&gt;Le Compte&lt;&#x2F;em&gt;, &lt;em&gt;Le Factotum&lt;&#x2F;em&gt;, and &lt;em&gt;Le
Procureur&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;These characters will help to explain not trivial concepts by interacting with
me. Let me copy the lore here.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;le-comte&quot;&gt;Le Comte&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#le-comte&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;My name is &lt;em&gt;Le Comte&lt;&#x2F;em&gt;. I enjoy being the main character of this story. I am
mostly here to learn, and to interrogate our dear author.&lt;&#x2F;p&gt;
&lt;p&gt;My resources are unlimited. I am fortunate to have a fortune with a secret
origin. If I want to understand something, I will work as hard as possible to
try to make light on it. My new caprice is these new modern things people are
calling &lt;em&gt;computers&lt;&#x2F;em&gt;. They seem really powerful and I want to learn everything
about them!&lt;&#x2F;p&gt;
&lt;p&gt;I often ask help to my Factotum for the dirty, and sometimes illegal tasks. I
rarely ask help to Le Procureur, we don&#x27;t really appreciate his presence.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;h3 id=&quot;le-factotum&quot;&gt;Le Factotum&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#le-factotum&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;My name is &lt;em&gt;Le Factotum&lt;&#x2F;em&gt;. It&#x27;s a latin word, literally saying “do everything”.
I&#x27;m here to assist Le Comte in its fancies.&lt;&#x2F;p&gt;
&lt;p&gt;Even if I have an uneventful life now, Le Comte is partly aware of my smuggling
past. He says no word about it, but he knows I kept contact with old friends
across various countries and cultures. These relations are useful to Le Comte to
achieve its quests to learn everything about computers.&lt;&#x2F;p&gt;
&lt;p&gt;Fundamentally, when Le Comte wants to do something manky, he asks me the best
way to do that. And I always have a solution.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;h3 id=&quot;le-procureur&quot;&gt;Le Procureur&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#le-procureur&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;My name is &lt;em&gt;Le Procureur&lt;&#x2F;em&gt;. I am the son of the Law and the Order. I know what
is legal, and what is illegal. If an information is missing, a detail, an
exactness, I know where to find the answer.&lt;&#x2F;p&gt;
&lt;p&gt;Some people believe I am irritating, but I consider myself the defenser of
discipline.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;h2 id=&quot;optimised-for-smallness-speed-semantics-and-fun&quot;&gt;Optimised for smallness, speed, semantics and fun!&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#optimised-for-smallness-speed-semantics-and-fun&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;At this step, it should be clear the site has been optimised for smallness,
speed and semantics. Even the fonts aren&#x27;t custom: I use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;modernfontstacks.com&#x2F;&quot;&gt;Modern Font Stacks&lt;&#x2F;a&gt;
to find a font stacks that work on most computers. Two devices may not have the
same look and feel for this site and that&#x27;s perfectly fine. That&#x27;s the nature of
the Web.&lt;&#x2F;p&gt;
&lt;p&gt;I encourage you &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;mnt.io&quot;&gt;to read the source code of this site&lt;&#x2F;a&gt;, to fork it, to
play with it, to get inspired by it. It&#x27;s important to own your content, and to
not give your work to other platforms.&lt;&#x2F;p&gt;
&lt;p&gt;I really hope you&#x27;ll enjoy the content I&#x27;m preparing. You can start with the
first episode of the new series:
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;reactive-programming-in-rust&#x2F;observability&#x2F;&quot;&gt;Reactive programming in Rust, Observability&lt;&#x2F;a&gt;.
See you there!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Observability</title>
          <pubDate>Thu, 19 Sep 2024 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/series/reactive-programming-in-rust/observability/</link>
          <guid>https://mnt.io/series/reactive-programming-in-rust/observability/</guid>
          <description xml:base="https://mnt.io/series/reactive-programming-in-rust/observability/">&lt;p&gt;Imagine a collection of values &lt;code&gt;T&lt;&#x2F;code&gt;. This collection can be updated by inserting
new values, removing existing ones, or the collection can truncated, cleared…
This collection acts as &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;vec&#x2F;index.html&quot;&gt;the standard &lt;code&gt;Vec&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. However, there is a
subtlety: This collection is &lt;em&gt;observable&lt;&#x2F;em&gt;. It is possible for someone to
&lt;em&gt;subscribe&lt;&#x2F;em&gt; to this collection and to receive its updates.&lt;&#x2F;p&gt;
&lt;p&gt;This observability pattern is the basis of reactive programming. It applies to
any kind of type. Actually, it can be generalised as a single &lt;code&gt;Observable&amp;lt;T&amp;gt;&lt;&#x2F;code&gt;
type. For collections though, we will see that an &lt;code&gt;ObservableVector&amp;lt;T&amp;gt;&lt;&#x2F;code&gt; type is
more efficient.&lt;&#x2F;p&gt;
&lt;p&gt;I’ve recently played a lot with this pattern as part of my work inside the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&quot;&gt;Matrix Rust SDK&lt;&#x2F;a&gt;, a set of Rust libraries that aim at developing robust
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;matrix.org&#x2F;&quot;&gt;Matrix&lt;&#x2F;a&gt; clients or bridges. It is notoriously used by the next generation
Matrix client developed by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;&quot;&gt;Element&lt;&#x2F;a&gt;, namely &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;labs&#x2F;element-x&quot;&gt;Element X&lt;&#x2F;a&gt;. The Matrix Rust SDK is
cross-platform. Element X has two implementations: on iOS, iPadOS and macOS with
Swift, and on Android with Kotlin. Both languages are using our Rust bindings
to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.swift.org&#x2F;&quot;&gt;Swift&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;kotlinlang.org&#x2F;&quot;&gt;Kotlin&lt;&#x2F;a&gt;. This is the story for another series (how we have
automated this, how we support asynchronous flows from Rust to foreign languages
etc.), but for the moment, let’s keep focus on reactive programming.&lt;&#x2F;p&gt;
&lt;p&gt;Taking the Element X use case, the room list –which is the central piece of the
app– is fully dynamic:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Rooms are sorted by recency, so rooms move to the top when a new interesting
message is received,&lt;&#x2F;li&gt;
&lt;li&gt;The list can be filtered by room properties (one can filter by group or
people, favourites, unreads, invites…),&lt;&#x2F;li&gt;
&lt;li&gt;The list is also searchable by room names.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The rooms exposed by the room list are stored in a unique &lt;em&gt;observable&lt;&#x2F;em&gt; type.
Why is it dynamic? Because the app continuously sync new data that update the
internal state: when a room gets an update from the network, the room list is
automatically updated. The beauty of it: we have nothing to do. Sorters and
filters are run automatically. Why? Spoiler: because everything is a &lt;code&gt;Stream&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Thanks to the Rust async model, every part is lazy. The app never needs to ask
for Rust if a new update is present. It literally just waits for them.&lt;&#x2F;p&gt;
&lt;p&gt;I believe this reactive programming approach is pretty interesting to explore.
And this is precisely the goal of this series. We are going to play with
&lt;code&gt;Stream&lt;&#x2F;code&gt; a lot, with higher-order &lt;code&gt;Stream&lt;&#x2F;code&gt; a lot more, and w…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Hold on a second! I believe this first step is a bit steep for someone who&#x27;s not
familiar with asynchronous code in Rust, don&#x27;t you think?&lt;&#x2F;p&gt;
&lt;p&gt;Before digging in the implementation details you are obviously eager to share,
maybe we can start with examples.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Alrighty. Fair. Before digging into the really fun bits, we need some basis.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;baby-steps-with-reactive-programming&quot;&gt;Baby steps with reactive programming&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#baby-steps-with-reactive-programming&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Everything we are going to share with you has been implemented in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball&quot;&gt;a library
called &lt;code&gt;eyeball&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. To give you a good idea of what reactive
programming in Rust can look like, let&#x27;s create a Rust program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo new --bin playground&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Creating binary (application) `playground` package&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cd playground&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo add eyeball&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Updating crates.io index&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding eyeball v0.8.8 to dependencies&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             Features:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - __bench&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - async-lock&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - tracing&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Updating crates.io index&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;     Locking 3 packages to latest compatible versions&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Observable&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;7&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 13&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What do we see here? First off, &lt;code&gt;observable&lt;&#x2F;code&gt; is an observable value. Proof
is: It is possible to subscribe to it, see &lt;code&gt;subscriber&lt;&#x2F;code&gt;. Both &lt;code&gt;observable&lt;&#x2F;code&gt; and
&lt;code&gt;subscriber&lt;&#x2F;code&gt; are seeing the same initial value: 7. When &lt;code&gt;observable&lt;&#x2F;code&gt; receives a
new value, 13, both &lt;code&gt;observable&lt;&#x2F;code&gt; and &lt;code&gt;subscriber&lt;&#x2F;code&gt; are seeing the updated value. Let&#x27;s take it for a spin:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:8:5] Observable::get(&amp;amp;observable) = 7&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:9:5] subscriber.get() = 7&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:13:5] Observable::get(&amp;amp;observable) = 13&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:14:5] subscriber.get() = 13&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Tadaa. Fantastic, isn&#x27;t it?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I… I am… speechless? Is it &lt;em&gt;really&lt;&#x2F;em&gt; reactive programming? Where is the
reactivity here? It seems like you&#x27;ve only shared a value between an &lt;em&gt;owner&lt;&#x2F;em&gt; and
a &lt;em&gt;watcher&lt;&#x2F;em&gt;. You&#x27;re calling them &lt;em&gt;observable&lt;&#x2F;em&gt; and &lt;em&gt;subscriber&lt;&#x2F;em&gt;, alright, but how
is this thing reactive? I only see synchronous code for the moment.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Hold on. You told me to start slow. You&#x27;re right though: the &lt;code&gt;Observable&lt;&#x2F;code&gt; owns
the value. The &lt;code&gt;Subscriber&lt;&#x2F;code&gt; is able to read the value from the &lt;code&gt;Observable&lt;&#x2F;code&gt;.
However, &lt;code&gt;Subscriber::next&lt;&#x2F;code&gt; returns a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;future&#x2F;trait.Future.html&quot;&gt;&lt;code&gt;Future&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;! Let&#x27;s add this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;error[E0728]: `await` is only allowed inside `async` functions and blocks&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  --&amp;gt; src&#x2F;main.rs:16:28&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;   |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3  | fn main() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;   | --------- this is not `async`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;...&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;16 |     dbg!(subscriber.next().await);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;   |                            ^^^^^ only allowed inside `async` functions and blocks&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Indeed. Almighty &lt;code&gt;rustc&lt;&#x2F;code&gt; is correct. The &lt;code&gt;main&lt;&#x2F;code&gt; function is not &lt;code&gt;async&lt;&#x2F;code&gt;. We need
an asynchronous runtime. Let&#x27;s use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;smol&quot;&gt;the &lt;code&gt;smol&lt;&#x2F;code&gt; project&lt;&#x2F;a&gt;, I enjoy it a
lot: it&#x27;s a small, fast and well-written async runtime:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo add smol&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Updating crates.io index&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding smol v2.0.2 to dependencies&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      [ … snip … ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now let&#x27;s modify our &lt;code&gt;main&lt;&#x2F;code&gt; function a little bit:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Observable&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    smol&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;block_on&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;async&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;7&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 13&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    })&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Please &lt;code&gt;rustc&lt;&#x2F;code&gt;, be nice…&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:9:9] Observable::get(&amp;amp;observable) = 7&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:10:9] subscriber.get() = 7&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:14:9] Observable::get(&amp;amp;observable) = 13&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:15:9] subscriber.get() = 13&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:17:9] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    13,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Hurray!&lt;&#x2F;p&gt;
&lt;p&gt;We can even have a bit more ergonomics by using &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;smol-macros&quot;&gt;the &lt;code&gt;smol-macros&lt;&#x2F;code&gt;
crate&lt;&#x2F;a&gt; which sets up a default &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;smol&#x2F;2.0.2&#x2F;smol&#x2F;struct.Executor.html&quot;&gt;async runtime
&lt;code&gt;Executor&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; for us. It&#x27;s useful in our case as we want to play
with something else (reactive programming), and don&#x27;t want to focus on the async
runtime itself:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo add smol-macros macro_rules_attribute&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Updating crates.io index&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding smol-macros v0.1.1 to dependencies&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding macro_rules_attribute v0.2.0 to dependencies&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             Features:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - better-docs&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - verbose-expansions&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Updating crates.io index&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;     Locking 4 packages to latest compatible versions&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding macro_rules_attribute v0.2.0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding macro_rules_attribute-proc_macro v0.2.0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding paste v1.0.15&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding smol-macros v0.1.1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We will take the opportunity to improve our program a little bit. Let&#x27;s spawn a
&lt;code&gt;Future&lt;&#x2F;code&gt; that will continuously read new updates from the &lt;code&gt;subscriber&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; std&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;time&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Duration&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Observable&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; macro_rules_attribute&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;apply;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; smol&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Executor&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Timer&lt;&#x2F;span&gt;&lt;span&gt;};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; smol_macros&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;main;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[apply(main&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;!&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;async fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;executor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Executor&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;7&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Task that reads new updates from `observable`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; task&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; executor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;spawn&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;async move&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        while&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; let&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;new_value&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;            dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;new_value&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Now, let&amp;#39;s update `observable`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 13&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Timer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;after&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Duration&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;from_secs&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 17&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Timer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;after&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Duration&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;from_secs&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 23&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Wait on the task.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    task&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The little &lt;code&gt;Timer::after&lt;&#x2F;code&gt; calls are here to pretend the values are coming from
random events, for the moment. Let&#x27;s run it again to see if we get the same
result:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:16:13] new_value = 13&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:16:13] new_value = 17&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:16:13] new_value = 23&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;^C&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here we go, perfect! See, ah ha! It&#x27;s async and nice now.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I believe I start to appreciate it. However, I foresee you might hide something
behind these &lt;code&gt;Time::after&lt;&#x2F;code&gt;. Am I right?&lt;&#x2F;p&gt;
&lt;p&gt;And this &lt;code&gt;task.await&lt;&#x2F;code&gt; at the end makes the program to never finish. It explains
the need to send &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;man.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=signal&quot;&gt;a &lt;code&gt;SIGINT&lt;&#x2F;code&gt; signal&lt;&#x2F;a&gt; to the program to interrupt it,
right?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;You&#x27;re slick. Indeed, I wanted to focus on the &lt;code&gt;observable&lt;&#x2F;code&gt; and the
&lt;code&gt;subscriber&lt;&#x2F;code&gt;. Because there is a subtlety here. If the &lt;code&gt;Timer::after&lt;&#x2F;code&gt; are
removed, only the last update will be displayed on the output by &lt;code&gt;dbg!&lt;&#x2F;code&gt;.
And that&#x27;s perfectly normal. The async runtime will execute all the
&lt;code&gt;Observable::set(&amp;amp;mut observable, new_value)&lt;&#x2F;code&gt; in a row, and then, once there
is an await point, another task will have room to run. In this case, that&#x27;s
&lt;code&gt;subscriber.next().await&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The subscriber only receives the &lt;strong&gt;last&lt;&#x2F;strong&gt; update, and that&#x27;s pretty important
to understand. There is no buffer of all the previous updates here, no memory,
no trace, &lt;code&gt;subscriber&lt;&#x2F;code&gt; returns the last value when it is called. Note that this
is not always the case as we will see with &lt;code&gt;ObservableVector&lt;&#x2F;code&gt; later, but for the
moment, that&#x27;s the case.&lt;&#x2F;p&gt;
&lt;p&gt;And yes, if we want the &lt;code&gt;task&lt;&#x2F;code&gt; to get a chance to consume more updates, we need
to tell the executor we will wait while the current other tasks are waken up. To
do that, we can use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;smol&#x2F;2.0.2&#x2F;smol&#x2F;future&#x2F;fn.yield_now.html&quot;&gt;the &lt;code&gt;smol::yield_now&lt;&#x2F;code&gt; function&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Now, let&amp;#39;s update `observable`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 13&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Eh `executor`: `task` can run now, we will wait!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    yield_now&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; More updates.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 17&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 23&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Eh `executor`: _bis repetita placent_!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    yield_now&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    drop&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    task&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Let&#x27;s see what happens:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:14:13] new_value = 13&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:14:13] new_value = 23&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Eh, see, &lt;code&gt;new_value = 17&lt;&#x2F;code&gt; is &lt;strong&gt;not&lt;&#x2F;strong&gt; displayed, because the &lt;code&gt;observable&lt;&#x2F;code&gt; is
updated but the &lt;code&gt;subscriber&lt;&#x2F;code&gt; is suspended by the executor. But the others are
read, good good.&lt;&#x2F;p&gt;
&lt;p&gt;Note that we are dropping the &lt;code&gt;observable&lt;&#x2F;code&gt;. Once it&#x27;s dropped, the &lt;code&gt;subscriber&lt;&#x2F;code&gt;
won&#x27;t be able to read any value from it, so it&#x27;s going to close itself, and the
&lt;code&gt;task&lt;&#x2F;code&gt; will end. That&#x27;s why waiting on the task with &lt;code&gt;task.await&lt;&#x2F;code&gt; will terminate
this time. And thus, the program will finish gracefully.&lt;&#x2F;p&gt;
&lt;p&gt;And that&#x27;s it. That&#x27;s the basis of reactive programming. Also note that
&lt;code&gt;Subscriber&amp;lt;T&amp;gt;&lt;&#x2F;code&gt; implements &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;marker&#x2F;trait.Send.html&quot;&gt;&lt;code&gt;Send&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;marker&#x2F;trait.Sync.html&quot;&gt;&lt;code&gt;Sync&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; if &lt;code&gt;T&lt;&#x2F;code&gt; implements &lt;code&gt;Send&lt;&#x2F;code&gt; and
&lt;code&gt;Sync&lt;&#x2F;code&gt;, i.e. if the observed type implements these traits. That&#x27;s pretty useful
actually: it is possible to send the subscriber in a different thread, and keep
waiting for new updates.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;attack-of-the-clones&quot;&gt;Attack of the Clones&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#attack-of-the-clones&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;However, at the beginning of this episode, we were talking about a collection.
Let&#x27;s focus on &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;vec&#x2F;index.html&quot;&gt;&lt;code&gt;Vec&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Why do we focus on &lt;code&gt;Vec&lt;&#x2F;code&gt; &lt;em&gt;only&lt;&#x2F;em&gt;? Why not &lt;code&gt;HashMap&lt;&#x2F;code&gt;, &lt;code&gt;HashSet&lt;&#x2F;code&gt;, &lt;code&gt;BTreeSet&lt;&#x2F;code&gt;,
&lt;code&gt;BTreeMap&lt;&#x2F;code&gt;, &lt;code&gt;BinaryHeap&lt;&#x2F;code&gt;, &lt;code&gt;LinkedList&lt;&#x2F;code&gt; or even &lt;code&gt;VecDeque&lt;&#x2F;code&gt;? It seems a bit
non-inclusive if you ask me. Are you aware there isn&#x27;t only &lt;code&gt;Vec&lt;&#x2F;code&gt; in life?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Well, the reason is simple: &lt;code&gt;Vec&lt;&#x2F;code&gt; is supported by &lt;code&gt;eyeball&lt;&#x2F;code&gt;. It&#x27;s a matter of
time and work to support other collections, it&#x27;s definitely not impossible but
you will see that it&#x27;s not trivial neither to support all these collections for
a simple reason: Did you notice that &lt;code&gt;Subscriber&lt;&#x2F;code&gt; produces an owned &lt;code&gt;T&lt;&#x2F;code&gt;? Not a
&lt;code&gt;&amp;amp;T&lt;&#x2F;code&gt;, but a &lt;code&gt;T&lt;&#x2F;code&gt;. That&#x27;s because
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball&#x2F;0.8.8&#x2F;eyeball&#x2F;struct.Subscriber.html#method.next-1&quot;&gt;&lt;code&gt;Subscriber::next&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; requires &lt;code&gt;T: Clone&lt;&#x2F;code&gt;. It means
that the observed value will be cloned every time it is broadcasted to a
subscriber.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;clone&#x2F;trait.Clone.html&quot;&gt;Cloning a value&lt;&#x2F;a&gt; may be expensive. Here we are manipulating &lt;code&gt;usize&lt;&#x2F;code&gt;,
which is a primitive type, so it&#x27;s all fine (it boils down to a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.cppreference.com&#x2F;w&#x2F;c&#x2F;string&#x2F;byte&#x2F;memcpy&quot;&gt;&lt;code&gt;memcpy&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;).
But imagine an &lt;code&gt;Observable&amp;lt;Vec&amp;lt;BigType&amp;gt;&amp;gt;&lt;&#x2F;code&gt; where &lt;code&gt;BigType&lt;&#x2F;code&gt; is 512 bytes: the
memory impact is going to be quickly noticeable. So th…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;… Excuse my interruption! You know how I love reading books. I like
defining myself as a bibliophile. Anyway. During my perusal of the &lt;code&gt;eyeball&lt;&#x2F;code&gt;
documentation, I have found
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball&#x2F;0.8.8&#x2F;eyeball&#x2F;struct.Subscriber.html#method.next_ref-1&quot;&gt;&lt;code&gt;Subscriber::next_ref&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. The documentation
says:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Wait for an update and get a read lock for the updated value.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;and later:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;You can use this method to get updates of an &lt;code&gt;Observable&lt;&#x2F;code&gt; where the inner type
does not implement &lt;code&gt;Clone&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Can you stop cutting me off please? It&#x27;s really unpleasant. And do not forget we
are not alone… &lt;i&gt;doing sideways head movement&lt;&#x2F;i&gt;&lt;&#x2F;p&gt;
&lt;p&gt;You&#x27;re right though. There is &lt;code&gt;Subscriber::next_ref&lt;&#x2F;code&gt;. However, if you are such
an &lt;em&gt;assiduous reader&lt;&#x2F;em&gt;, you may have read the end of the documentation, aren&#x27;t
you?&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;However, the &lt;code&gt;Observable&lt;&#x2F;code&gt; will be locked (not updateable) while any read guards
are alive.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Blocking the &lt;code&gt;Observable&lt;&#x2F;code&gt; might be tolerable in some cases, but it cannot be
generalised to all use cases. A user is more likely to prefer &lt;code&gt;next&lt;&#x2F;code&gt; instead of
&lt;code&gt;next_ref&lt;&#x2F;code&gt; by default.&lt;&#x2F;p&gt;
&lt;p&gt;Back to our &lt;code&gt;Observable&amp;lt;Vec&amp;lt;BigType&amp;gt;&amp;gt;&lt;&#x2F;code&gt; then. Imagine the collection contains a
lot of items: cloning the entire &lt;code&gt;Vec&amp;lt;_&amp;gt;&lt;&#x2F;code&gt; for every update to every subscriber
is a pretty inefficient way of programming. Remember that, as a programmer, we
have the responsibility to make our programs use as few resources as possible,
so that hardwares can be used longer. The hardware is the most polluting segment
of our digital world.&lt;&#x2F;p&gt;
&lt;p&gt;So. How a data structure like &lt;code&gt;Vec&lt;&#x2F;code&gt; can be cloned cheaply? We could put
it inside an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;sync&#x2F;struct.Arc.html&quot;&gt;&lt;code&gt;Arc&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; right? Cloning an &lt;em&gt;Atomically Reference Counted&lt;&#x2F;em&gt; value
is really cheap: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rust-lang&#x2F;rust&#x2F;blob&#x2F;f6bcd094abe174a218f7cf406e75521be4199f88&#x2F;library&#x2F;alloc&#x2F;src&#x2F;sync.rs#L2118-L2170&quot;&gt;it increases the counter by 1 atomically&lt;&#x2F;a&gt;,
the inner value is untouched. Nonetheless, we have a mutation problem now.
If we have &lt;code&gt;Observable&amp;lt;Arc&amp;lt;Vec&amp;lt;_&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;, it means that the subscribers will be
&lt;code&gt;Subscriber&amp;lt;Arc&amp;lt;Vec&amp;lt;_&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. In this case, every time the observable wants to
mutate the data, it is going to… be… impossible because an &lt;code&gt;Arc&lt;&#x2F;code&gt; is nothing
less than a shared reference, and shared references in Rust disallow mutation by
default. Using &lt;code&gt;Observable::set&lt;&#x2F;code&gt; will create a new &lt;code&gt;Arc&lt;&#x2F;code&gt;, but we cannot update
the value &lt;em&gt;inside&lt;&#x2F;em&gt; the &lt;code&gt;Arc&lt;&#x2F;code&gt;, except if we use a lock… Well, we are adding more
and more complexity.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;q lang=&quot;la&quot;&gt;Spes salutis&lt;&#x2F;q&gt;&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-spes_salutis-1&quot;&gt;&lt;a href=&quot;#fn-spes_salutis&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;! Fortunately for us, &lt;em&gt;immutable
data structures&lt;&#x2F;em&gt; exist in Rust.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;An immutable data structure is a data structure which can be copied and modified
efficiently without altering the original.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;It can be modified. However, as soon as it is copied (or cloned), it is still
possible to modify the copy but the original data is not modified. That&#x27;s
extremely powerful.&lt;&#x2F;p&gt;
&lt;p&gt;Such structures bring many advantages, but one of them is &lt;em&gt;structural sharing&lt;&#x2F;em&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;If two data structures are mostly copies of each other, most of the memory
they take up will be shared between them. This implies that making copies of
an immutable data structure is cheap: it&#x27;s really only a matter of copying
a pointer and increasing a reference counter, where in the case of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;vec&#x2F;index.html&quot;&gt;&lt;code&gt;Vec&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; you
have to allocate the same amount of memory all over again and make a copy of
every element it contains. For immutable data structures, extra memory isn&#x27;t
allocated until you modify either the copy or the original, and then only the
memory needed to record the difference.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Well, &lt;i&gt;taking a deep breath&lt;&#x2F;i&gt;, it sounds exactly like what we
need to solve our issue, isn&#x27;t it? The &lt;code&gt;Observable&amp;lt;Immutable&amp;lt;_&amp;gt;&amp;gt;&lt;&#x2F;code&gt; and the
&lt;code&gt;Subscriber&amp;lt;Immutable&amp;lt;_&amp;gt;&amp;gt;&lt;&#x2F;code&gt;s will share the same value, with the observable
being able to mutate its inner value. The subscribers can modify the received
value too, in an efficient way, without conflicting with the value from the
observable. Both values will continue to live on their side, but cloning the
value is cheap.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Dare I ask how immutable data structures are implemented? It sounds like complex
beasts.&lt;&#x2F;p&gt;
&lt;p&gt;I mean… a naive implementation sounds &lt;em&gt;relatively doable&lt;&#x2F;em&gt; but I am guessing there
is a lot of subtleties, possible conflicts, and many memory guarantees that I am
not anticipating yet, right?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Oh… &lt;q lang=&quot;la&quot;&gt;beati pauperes in spiritu&lt;&#x2F;q&gt;&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-beati_pauperes_in_spiritu-1&quot;&gt;&lt;a href=&quot;#fn-beati_pauperes_in_spiritu&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;… it
is actually really complex. It may be a topic for another series or articles.
For the moment, if you interested, let me redirect you to one research paper
that proposes an immutable &lt;code&gt;Vec&lt;&#x2F;code&gt;: &lt;cite&gt;RRR Vector: A Practical General
Immutable Sequence&lt;&#x2F;cite&gt;&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-SRUB2015-1&quot;&gt;&lt;a href=&quot;#fn-SRUB2015&quot;&gt;3&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;. Be cool though, understanding this part is
not necessary at all for what we are talking now. It&#x27;s a great tool we are going
to use, no matter how it works internally.&lt;&#x2F;p&gt;
&lt;p&gt;Do you know the other good news? We don&#x27;t have to implement it by ourselves,
because some nice people already did it! Enter &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&quot;&gt;the &lt;code&gt;imbl&lt;&#x2F;code&gt; crate&lt;&#x2F;a&gt;. This
crate provides &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&#x2F;3.0.0&#x2F;imbl&#x2F;struct.Vector.html&quot;&gt;a &lt;code&gt;Vector&lt;&#x2F;code&gt; type&lt;&#x2F;a&gt;. It can be used like a regular
&lt;code&gt;Vec&lt;&#x2F;code&gt;. (Side note: it&#x27;s even smarter than a &lt;code&gt;Vec&lt;&#x2F;code&gt; because it implements smart
head and tail chunking&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-UCR2014-1&quot;&gt;&lt;a href=&quot;#fn-UCR2014&quot;&gt;4&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;, and allocates in the stack or on the heap
depending on the size of the collection, similarly to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;smallvec&quot;&gt;the &lt;code&gt;smallvec&lt;&#x2F;code&gt;
crate&lt;&#x2F;a&gt;. End of digression)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;observable-immutable-collection&quot;&gt;Observable (immutable) collection&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#observable-immutable-collection&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The &lt;code&gt;imbl&lt;&#x2F;code&gt; crate then. It provides &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&#x2F;3.0.0&#x2F;imbl&#x2F;struct.Vector.html&quot;&gt;a &lt;code&gt;Vector&lt;&#x2F;code&gt; type&lt;&#x2F;a&gt;. &lt;code&gt;eyeball&lt;&#x2F;code&gt;
provides a crate for working with immutable data structures (how surprising
huh?): &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&quot;&gt;this crate is &lt;code&gt;eyeball-im&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Instead of providing an &lt;code&gt;Observable&amp;lt;T&amp;gt;&lt;&#x2F;code&gt; type, it provides &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;struct.ObservableVector.html&quot;&gt;an
&lt;code&gt;ObservableVector&amp;lt;T&amp;gt;&lt;&#x2F;code&gt; type&lt;&#x2F;a&gt; which is a &lt;code&gt;Vector&lt;&#x2F;code&gt;,
but an observable one! Let&#x27;s see… what do we have… &lt;i&gt;scroll the
documentation&lt;&#x2F;i&gt;, hmm, interesting, &lt;i&gt;scroll more…&lt;&#x2F;i&gt;, okay, that&#x27;s
interesting:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;First off, there is methods like &lt;code&gt;append&lt;&#x2F;code&gt;, &lt;code&gt;pop_back&lt;&#x2F;code&gt;, &lt;code&gt;pop_front&lt;&#x2F;code&gt;,
&lt;code&gt;push_back&lt;&#x2F;code&gt;, &lt;code&gt;push_front&lt;&#x2F;code&gt;, &lt;code&gt;remove&lt;&#x2F;code&gt;, &lt;code&gt;insert&lt;&#x2F;code&gt;, &lt;code&gt;set&lt;&#x2F;code&gt;, &lt;code&gt;truncate&lt;&#x2F;code&gt; and &lt;code&gt;clear&lt;&#x2F;code&gt;.
It seems this collection is pretty flexible. The vocabulary is clear. They all
take a &lt;code&gt;&amp;amp;mut self&lt;&#x2F;code&gt;, cool.&lt;&#x2F;li&gt;
&lt;li&gt;Then, there is a &lt;code&gt;with_capacity&lt;&#x2F;code&gt; method, this is intriguing, &lt;i&gt;add to
notes&lt;&#x2F;i&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;Finally, we find our not-so-ol&#x27; friend &lt;code&gt;subscribe&lt;&#x2F;code&gt;, but this time it returns a
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;struct.VectorSubscriber.html&quot;&gt;&lt;code&gt;VectorSubscriber&amp;lt;T&amp;gt;&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let&#x27;s explore &lt;code&gt;VectorSubscriber&lt;&#x2F;code&gt; a bit more, would you? &lt;i&gt;Scroll the
document&lt;&#x2F;i&gt;, contrary to
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball&#x2F;0.8.8&#x2F;eyeball&#x2F;struct.Subscriber.html#method.next-1&quot;&gt;&lt;code&gt;Subscriber::next&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, there is no &lt;code&gt;next&lt;&#x2F;code&gt; method. How
are we supposed to wait on an update?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Confer to the assiduous reader! If you read &lt;em&gt;carefully&lt;&#x2F;em&gt; the documentation of the
&lt;code&gt;Subscriber::next&lt;&#x2F;code&gt; method, you will see:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;This method is a convenience so you don&#x27;t have to import a &lt;code&gt;Stream&lt;&#x2F;code&gt; extension
trait such as &lt;code&gt;futures::StreamExt&lt;&#x2F;code&gt; or &lt;code&gt;tokio_stream::StreamExt&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;… fair enough. So &lt;code&gt;Subscriber::next&lt;&#x2F;code&gt; mimics &lt;code&gt;StreamExt::next&lt;&#x2F;code&gt;. Okay. Let&#x27;s look
at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;futures&#x2F;0.3.30&#x2F;futures&#x2F;stream&#x2F;trait.Stream.html&quot;&gt;&lt;code&gt;Stream&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; first, it&#x27;s from &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;futures&quot;&gt;the &lt;code&gt;futures&lt;&#x2F;code&gt;
crate&lt;&#x2F;a&gt;. &lt;code&gt;Stream&lt;&#x2F;code&gt; defines itself as:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;A stream of values produced asynchronously.&lt;&#x2F;p&gt;
&lt;p&gt;If &lt;code&gt;Future&amp;lt;Output = T&amp;gt;&lt;&#x2F;code&gt; is an asynchronous version of &lt;code&gt;T&lt;&#x2F;code&gt;, then &lt;code&gt;Stream&amp;lt;Item = T&amp;gt;&lt;&#x2F;code&gt; is an asynchronous version of &lt;code&gt;Iterator&amp;lt;Item = T&amp;gt;&lt;&#x2F;code&gt;. A stream represents
a sequence of value-producing events that occur asynchronously to the caller.&lt;&#x2F;p&gt;
&lt;p&gt;The trait is modeled after &lt;code&gt;Future&lt;&#x2F;code&gt;, but allows &lt;code&gt;poll_next&lt;&#x2F;code&gt; to be called even
after a value has been produced, yielding None once the stream has been fully
exhausted.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;We aren&#x27;t going to teach everything about &lt;code&gt;Stream&lt;&#x2F;code&gt;: why this design, its
pros and cons… However, &lt;i&gt;wave its hand to ask you to come
closer&lt;&#x2F;i&gt;, did you notice how &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;future&#x2F;trait.Future.html#tymethod.poll&quot;&gt;&lt;code&gt;Future::poll&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; returns &lt;code&gt;Poll&amp;lt;Self::Output&amp;gt;&lt;&#x2F;code&gt;,
whilst &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;futures&#x2F;0.3.30&#x2F;futures&#x2F;stream&#x2F;trait.Stream.html#tymethod.poll_next&quot;&gt;&lt;code&gt;Stream::poll_next&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; returns
&lt;code&gt;Poll&amp;lt;Option&amp;lt;Self::Item&amp;gt;&amp;gt;&lt;&#x2F;code&gt;? It&#x27;s really similar to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;iter&#x2F;trait.Iterator.html#tymethod.next&quot;&gt;&lt;code&gt;Iterator::next&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; which
returns &lt;code&gt;Option&amp;lt;Self::Item&amp;gt;&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s take a look at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;task&#x2F;enum.Poll.html&quot;&gt;&lt;code&gt;Poll&amp;lt;T&amp;gt;&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; don&#x27;t you mind? It&#x27;s an enum with 2 variants:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Ready(value)&lt;&#x2F;code&gt; means a &lt;code&gt;value&lt;&#x2F;code&gt; is immediately ready,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;Pending&lt;&#x2F;code&gt; means no value is ready yet.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Then, what &lt;code&gt;Poll&amp;lt;Option&amp;lt;T&amp;gt;&amp;gt;&lt;&#x2F;code&gt; represents for a &lt;code&gt;Stream&lt;&#x2F;code&gt;?&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Poll::Ready(Some(value))&lt;&#x2F;code&gt; means this stream has successfully produced a
&lt;code&gt;value&lt;&#x2F;code&gt;, and may produce more values on subsequent &lt;code&gt;poll_next&lt;&#x2F;code&gt; calls,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;Poll::Ready(None)&lt;&#x2F;code&gt; means the stream has terminated (and &lt;code&gt;poll_next&lt;&#x2F;code&gt; should
not be called anymore),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;Poll::Pending&lt;&#x2F;code&gt; means no value is ready yet.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;It makes perfect sense. A &lt;code&gt;Future&lt;&#x2F;code&gt; produces a single value, whilst a &lt;code&gt;Stream&lt;&#x2F;code&gt;
produces multiple values, and &lt;code&gt;Poll::Ready(None)&lt;&#x2F;code&gt; represents the termination of
the stream, similarly to &lt;code&gt;None&lt;&#x2F;code&gt; to represent the termination of an &lt;code&gt;Iterator&lt;&#x2F;code&gt;.
Ahh, I love consistency.&lt;&#x2F;p&gt;
&lt;p&gt;We have the basis. Now let&#x27;s see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;futures&#x2F;0.3.30&#x2F;futures&#x2F;stream&#x2F;trait.StreamExt.html&quot;&gt;&lt;code&gt;StreamExt&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. It&#x27;s
a trait extending &lt;code&gt;Stream&lt;&#x2F;code&gt; to add convenient combinator methods. Amongst other
things, we find &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;futures&#x2F;0.3.30&#x2F;futures&#x2F;prelude&#x2F;stream&#x2F;trait.StreamExt.html#method.next&quot;&gt;&lt;code&gt;StreamExt::next&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;! Ah ha!
It returns a &lt;code&gt;Next&lt;&#x2F;code&gt; type which implements a &lt;code&gt;Future&lt;&#x2F;code&gt;, exactly what &lt;code&gt;eyeball&lt;&#x2F;code&gt;
does actually. Remember our:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; from `main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;while&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; let&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;new_value&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;new_value&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is exactly the same pattern with &lt;code&gt;StreamExt::next&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; from the documentation of `StreamExt::Next`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; futures&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; StreamExt&lt;&#x2F;span&gt;&lt;span&gt;};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;iter&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;..=&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; None&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Pieces start to come together, don&#x27;t they?&lt;&#x2F;p&gt;
&lt;p&gt;End of the detour. Back to &lt;code&gt;eyeball_im::VectorSubscriber&amp;lt;T&amp;gt;&lt;&#x2F;code&gt; . It is possible to
transform this type into a &lt;code&gt;Stream&lt;&#x2F;code&gt; with its
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;struct.VectorSubscriber.html#method.into_stream&quot;&gt;&lt;code&gt;into_stream&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; method. It returns
a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;struct.VectorSubscriberStream.html&quot;&gt;&lt;code&gt;VectorSubscriberStream&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. Naming is
hard, but if I would have to guess, I would say it implements… a… &lt;code&gt;Stream&lt;&#x2F;code&gt;?&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; from `eyeball-im`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;impl&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Clone&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Send&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sync&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span&gt; &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;static&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; for&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorSubscriberStream&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    type&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Item&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;struct.VectorSubscriberStream.html#impl-Stream-for-VectorSubscriberStream%3CT%3E&quot;&gt;Yes, it does&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
&lt;p&gt;Dust blown away, the puzzle starts to appear clearly. Let&#x27;s back on coding!&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo add eyeball-im futures&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Updating crates.io index&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding eyeball-im v0.5.0 to dependencies&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             Features:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - serde&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - tracing&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      Adding futures v0.3.30 to dependencies&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             Features:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             + alloc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             + async-await&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             + executor&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             + std&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - bilock&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - cfg-target-has-atomic&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - compat&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - futures-executor&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - io-compat&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - thread-pool&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - unstable&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;             - write-all-vectored&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      [ … snip … ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball_im&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ObservableVector&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; futures&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;StreamExt&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; macro_rules_attribute&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;apply;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; smol&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;future&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;yield_now,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Executor&lt;&#x2F;span&gt;&lt;span&gt;};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; smol_macros&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;main;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[apply(main&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;!&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;async fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;executor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Executor&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ObservableVector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Subscribe to `observable` and get a `Stream`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;into_stream&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Push one value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Task that reads new updates from `observable`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; task&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; executor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;spawn&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;async move&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        while&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; let&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;new_value&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;            dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;new_value&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Now, let&amp;#39;s update `observable`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Eh `executor`: `task` can run now!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    yield_now&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; More updates.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Eh `executor`, same.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    yield_now&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    drop&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    task&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Time to show off:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:18:13] new_value = PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    value: &amp;#39;a&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:18:13] new_value = PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    value: &amp;#39;b&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:18:13] new_value = PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    value: &amp;#39;c&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:18:13] new_value = PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    value: &amp;#39;d&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Do you see something new?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Hmm, indeed. With &lt;code&gt;Observable&lt;&#x2F;code&gt;, some values may “miss” because &lt;code&gt;Observable&lt;&#x2F;code&gt;
and &lt;code&gt;Subscriber&lt;&#x2F;code&gt; have no buffer. The subscribers only return the current value
when asked for. However, with &lt;code&gt;ObservableVector&lt;&#x2F;code&gt;, things are different: no
missing values. There are all here. As if there… was a buffer!&lt;&#x2F;p&gt;
&lt;p&gt;And the values returned by the subscriber are not the raw &lt;code&gt;T&lt;&#x2F;code&gt;:
we see &lt;code&gt;PushBack&lt;&#x2F;code&gt;. It comes from, &lt;i&gt;check the documentation&lt;&#x2F;i&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;enum.VectorDiff.html&quot;&gt;&lt;code&gt;VectorDiff::PushBack&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Good eyes, well done.&lt;&#x2F;p&gt;
&lt;p&gt;First off, that&#x27;s correct that &lt;code&gt;PushBack&lt;&#x2F;code&gt; comes from
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;enum.VectorDiff.html&quot;&gt;&lt;code&gt;VectorDiff&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. Let&#x27;s come back to this piece in
a second: it is the cornerstone of the entire series, it deserves a bit of
explanations.&lt;&#x2F;p&gt;
&lt;p&gt;Second, yes, &lt;code&gt;VectorSubscriber&lt;&#x2F;code&gt; returns &lt;strong&gt;all values&lt;&#x2F;strong&gt;! There is actually a
buffer. It&#x27;s a bit annoying to continue with a &lt;code&gt;task&lt;&#x2F;code&gt; as we did so far, let&#x27;s
use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;macro.assert_eq.html&quot;&gt;&lt;code&gt;assert_eq!&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; instead.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball_im&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ObservableVector&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span&gt;};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                 ^^^^^^^^^^ new!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[apply(main&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;!&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;async fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_executor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Executor&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ObservableVector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;into_stream&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Push one value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    );&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Push another value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    );&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    );&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    );&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:16:9] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        value: &amp;#39;a&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:26:9] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        value: &amp;#39;b&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:30:9] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        value: &amp;#39;c&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:34:9] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        value: &amp;#39;d&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Beautiful! However… the code is a bit verbose, isn&#x27;t it? &lt;i&gt;Desperately waiting
for an affirmative answer&lt;&#x2F;i&gt;, okay, okay, something you may not know about me:
I love macros. There. I said it. Let&#x27;s quickly craft one:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; before the `main` function&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;macro_rules! assert_next_eq&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    (&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; $&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;ident&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; $&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;expr&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;expr&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; $&lt;&#x2F;span&gt;&lt;span&gt;(,)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt; )&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;dbg!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; $&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; $&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;expr&lt;&#x2F;span&gt;&lt;span&gt; ));&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This macro does exactly what our &lt;code&gt;assert_eq!&lt;&#x2F;code&gt; was doing, except now it&#x27;s shorter
to use, and thus more pleasant. Don&#x27;t believe me? See by yourself:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; at the end of the `main` function&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Push one value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Push another value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There we go.&lt;&#x2F;p&gt;
&lt;p&gt;Having a scientific and rigorous approach is important in our domain. We said
&lt;code&gt;ObservableVector&lt;&#x2F;code&gt; seems to contain a buffer, and &lt;code&gt;VectorSubscriber&lt;&#x2F;code&gt; seems to
pop values from this buffer. Let&#x27;s play with that. I see two things to test:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Modify the &lt;code&gt;ObservableVector&lt;&#x2F;code&gt;, and subscribe to it &lt;em&gt;after&lt;&#x2F;em&gt;: Does the
subscriber receive the update before it was created?&lt;&#x2F;li&gt;
&lt;li&gt;How many values the buffer can hold?&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ObservableVector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Push a value before the subscriber exists.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;into_stream&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Push another value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If the &lt;code&gt;subscriber&lt;&#x2F;code&gt; receives &lt;code&gt;a&lt;&#x2F;code&gt;, it must fail, otherwise no error:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:25:5] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        value: &amp;#39;b&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Look Ma&#x27;, no error!&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;We have learned that a &lt;code&gt;VectorSubscriber&lt;&#x2F;code&gt; is aware of the new updates that are
made once it exists. A &lt;code&gt;VectorSubscriber&lt;&#x2F;code&gt; is not aware of updates that happened
before its creation.&lt;&#x2F;p&gt;
&lt;p&gt;In the example, &lt;code&gt;VectorDiff::PushBack { value: &#x27;a&#x27; }&lt;&#x2F;code&gt; is not received before
&lt;code&gt;subscriber&lt;&#x2F;code&gt; was created. However, &lt;code&gt;VectorDiff::PushBack { value: &#x27;b&#x27; }&lt;&#x2F;code&gt; is
received because it happened after &lt;code&gt;subscriber&lt;&#x2F;code&gt; was created. It makes perfect
sense.&lt;&#x2F;p&gt;
&lt;p&gt;It suggests that the buffer lives inside &lt;code&gt;VectorSubscriber&lt;&#x2F;code&gt;, and not inside
&lt;code&gt;ObservableVector&lt;&#x2F;code&gt;. Or maybe the buffer is shared between the observable and the
subscribers, with the buffer having some specific semantics, like a &lt;em&gt;channel&lt;&#x2F;em&gt;.
We would need to look at the implementation to be sure.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Agree. This is left as an exercise for the reader, &lt;i&gt;wink to you&lt;&#x2F;i&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;We have an answer to question 1. What about question 2? The size of the buffer.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ObservableVector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; subscriber&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;into_stream&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Push ALL THE VALUES!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;e&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;f&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;g&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;h&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;i&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;j&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;k&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;l&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;m&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;n&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;o&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;p&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; no need to assert the others&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:36:5] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        value: &amp;#39;a&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Hmm, the buffer doesn&#x27;t seem to be full with 16 values. Let&#x27;s add a couple more:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; in `src&#x2F;main.rs`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; [ … snip … ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;n&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;o&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;p&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;q&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                    ^ new!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;r&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                    ^ new!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;subscriber&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:38:5] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Reset {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        values: [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;a&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;b&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;c&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;d&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;e&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;f&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;g&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;h&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;i&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;j&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;k&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;l&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;m&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;n&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;o&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;p&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;q&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            &amp;#39;r&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ],&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;thread &amp;#39;main&amp;#39; panicked at src&#x2F;main.rs:38:5:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;assertion `left == right` failed&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  left: Some(Reset { values: [&amp;#39;a&amp;#39;, &amp;#39;b&amp;#39;, &amp;#39;c&amp;#39;, &amp;#39;d&amp;#39;, &amp;#39;e&amp;#39;, &amp;#39;f&amp;#39;, &amp;#39;g&amp;#39;, &amp;#39;h&amp;#39;, &amp;#39;i&amp;#39;, &amp;#39;j&amp;#39;, &amp;#39;k&amp;#39;, &amp;#39;l&amp;#39;, &amp;#39;m&amp;#39;, &amp;#39;n&amp;#39;, &amp;#39;o&amp;#39;, &amp;#39;p&amp;#39;, &amp;#39;q&amp;#39;, &amp;#39;r&amp;#39;] })&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt; right: Some(PushBack { value: &amp;#39;a&amp;#39; })&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Oh! An error, great! Our &lt;code&gt;assert_next_eq!&lt;&#x2F;code&gt; has failed. &lt;code&gt;subscriber&lt;&#x2F;code&gt;
does not receive a &lt;code&gt;VectorDiff::PopBack&lt;&#x2F;code&gt; but a &lt;code&gt;VectorDiff::Reset&lt;&#x2F;code&gt;.
Let&#x27;s play with
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;struct.ObservableVector.html#method.with_capacity&quot;&gt;&lt;code&gt;ObservableVector::with_capacity&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;
a moment, maybe it&#x27;s related to the buffer capacity? Let&#x27;s change a single line:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; observable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ObservableVector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;with_capacity&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;32&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                     ^^^^^^^^^^^^^^^^^ new!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cargo run --quiet&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[src&#x2F;main.rs:38:5] subscriber.next().await = Some(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    PushBack {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        value: &amp;#39;a&amp;#39;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;We have learned that &lt;code&gt;ObservableVector::with_capacity&lt;&#x2F;code&gt; controls the size of
the buffer.&lt;&#x2F;p&gt;
&lt;p&gt;The name could suggest that it controls the capacity of the observed &lt;code&gt;Vector&lt;&#x2F;code&gt;,
&lt;em&gt;à la&lt;&#x2F;em&gt; &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;vec&#x2F;struct.Vec.html#method.with_capacity&quot;&gt;&lt;code&gt;Vec::with_capacity&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, but it must not be confused.&lt;&#x2F;p&gt;
&lt;p&gt;For a reason we ignore so far, when the buffer is full, we receive a
&lt;code&gt;VectorDiff::Reset&lt;&#x2F;code&gt;. We need to learn more about this type.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;h2 id=&quot;observable-differences&quot;&gt;Observable differences&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#observable-differences&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The previous section was explaining how immutable data structures could save us
by cheaply and efficiently cloning the data between the observable and its
subscribers. However, we see that &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&quot;&gt;&lt;code&gt;eyeball-im&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, despite using &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&quot;&gt;&lt;code&gt;imbl&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, does
not share an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&#x2F;3.0.0&#x2F;imbl&#x2F;struct.Vector.html&quot;&gt;&lt;code&gt;imbl::Vector&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; but an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.5.0&#x2F;eyeball_im&#x2F;enum.VectorDiff.html&quot;&gt;&lt;code&gt;eyeball_im::VectorDiff&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. Why such design?
It looks like a drama. A betrayal. An act of treachery!&lt;&#x2F;p&gt;
&lt;p&gt;Well. Firstly, &lt;code&gt;eyeball-im&lt;&#x2F;code&gt; is relying on some immutable properties of &lt;code&gt;Vector&lt;&#x2F;code&gt;.
And secondly, the reason for which &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; exists is simple. If a
subscriber receives &lt;code&gt;Vector&lt;&#x2F;code&gt;s, how is the user able to see what has changed? The
user (!) would be responsible to &lt;em&gt;calculate&lt;&#x2F;em&gt; the differences between 2 &lt;code&gt;Vector&lt;&#x2F;code&gt;s
every time! Not only this is costly, but it is utterly error-prone.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Are you suggesting that &lt;code&gt;VectorSubscriber&lt;&#x2F;code&gt; (or &lt;code&gt;VectorSubscriberStream&lt;&#x2F;code&gt;)
calculates the differences between the &lt;code&gt;Vector&lt;&#x2F;code&gt;s itself so that the user doesn&#x27;t
have to?&lt;&#x2F;p&gt;
&lt;p&gt;I still see many problems though. I believe the order of the &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s
matters a lot for some use cases. For example, let&#x27;s consider two consecutive
&lt;code&gt;Vector&lt;&#x2F;code&gt;s:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;[&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]&lt;&#x2F;code&gt; and&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;[&#x27;a&#x27;, &#x27;c&#x27;, &#x27;b&#x27;]&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Has &lt;code&gt;&#x27;b&#x27;&lt;&#x2F;code&gt; been removed and pushed back, or &lt;code&gt;&#x27;c&#x27;&lt;&#x2F;code&gt; been popped back and inserted?
How can you decide between the twos?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;We can&#x27;t —it would be implementation specifics anyway— and we don&#x27;t want to.
The user is manipulating the &lt;code&gt;ObservableVector&lt;&#x2F;code&gt; in a special way, and we should
ideally not change that.&lt;&#x2F;p&gt;
&lt;p&gt;These &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; actually comes from &lt;code&gt;ObservableVector&lt;&#x2F;code&gt; itself! Let&#x27;s look at
the implementation of
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;blob&#x2F;4254403e385715380753bb0def20fb0398e91ebd&#x2F;eyeball-im&#x2F;src&#x2F;vector.rs#L107-L114&quot;&gt;&lt;code&gt;ObservableVector::push_back&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; [ … snip … ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push_back&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;clone&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;   ^^^^^^ this is a `Vector`!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;broadcast_diff&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span&gt; });&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;                  ^^^^^^^^^^ here you are…&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Each method adding or removing values on the &lt;code&gt;ObservableVector&lt;&#x2F;code&gt; emits its own
&lt;code&gt;VectorDiff&lt;&#x2F;code&gt; variant. No calculation, it&#x27;s purely a mapping:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;code&gt;ObservableVector::…&lt;&#x2F;code&gt;&lt;&#x2F;th&gt;&lt;th&gt;&lt;code&gt;VectorDiff::…&lt;&#x2F;code&gt;&lt;&#x2F;th&gt;&lt;th&gt;Meaning&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;append(values)&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;Append { values }&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Append many &lt;code&gt;values&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;clear()&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;Clear&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Clear out all the values&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;insert(index, value)&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;Insert { index, value }&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Insert a &lt;code&gt;value&lt;&#x2F;code&gt; at &lt;code&gt;index&lt;&#x2F;code&gt; &lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;pop_back()&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;PopBack&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Remove the value at the back&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;pop_front()&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;PopFront&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Remove the value at the front&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;push_back(value)&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;PushBack { value }&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Add &lt;code&gt;value&lt;&#x2F;code&gt; at the back&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;push_front(value)&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;PushFront { value }&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Add &lt;code&gt;value&lt;&#x2F;code&gt; at the front&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;remove(index)&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;Remove { index }&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Remove value at &lt;code&gt;index&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;set(index, value)&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;Set { index, value }&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Replace value at &lt;code&gt;index&lt;&#x2F;code&gt; by &lt;code&gt;value&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;truncate(length)&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;Truncate { length }&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Truncate to &lt;code&gt;length&lt;&#x2F;code&gt; values&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Mappings of &lt;code&gt;ObservableVector&lt;&#x2F;code&gt; methods to &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; variants.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;See, for each &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; variant, there is an &lt;code&gt;ObservableVector&lt;&#x2F;code&gt; method
triggering it.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;And what about &lt;code&gt;VectorDiff::Reset&lt;&#x2F;code&gt;?&lt;&#x2F;p&gt;
&lt;p&gt;We were receiving it when the buffer was full apparently. You are not mentioning
it, and if I take a close look at &lt;code&gt;ObservableVector&lt;&#x2F;code&gt;&#x27;s documentation, I don&#x27;t
see any &lt;code&gt;reset&lt;&#x2F;code&gt; method. Is it only an internal thing?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;You are correct. When the buffer is full, the subscriber will provide a
&lt;code&gt;VectorDiff::Reset { values }&lt;&#x2F;code&gt; where &lt;code&gt;values&lt;&#x2F;code&gt; is the full list of values. The
documentation says:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;The subscriber lagged too far behind, and the next update that should have
been received has already been discarded from the internal buffer.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;If the subscriber didn&#x27;t catch all the updates, the best thing it can do is to
say: &lt;q&gt;Okay, I am late at the party, I&#x27;ve missed several things, so here is the
current state!&lt;&#x2F;q&gt;. This is not ideal, but the subscriber is responsible to not
lag, and this design avoids having missing values. If a subscriber receives
too much &lt;code&gt;VectorDiff::Reset&lt;&#x2F;code&gt;s, the user may consider increasing the capacity of
the &lt;code&gt;ObservableVector&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;filtering-and-sorting-with-higher-order-streams&quot;&gt;Filtering and sorting with higher-order &lt;code&gt;Stream&lt;&#x2F;code&gt;s&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#filtering-and-sorting-with-higher-order-streams&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We are reaching the end of this episode. And you know what? We have set all the
parts to talk about higher-order &lt;code&gt;Stream&lt;&#x2F;code&gt;, &lt;i&gt;chante victory and dance at the
same time&lt;&#x2F;i&gt;!&lt;&#x2F;p&gt;
&lt;p&gt;At the beginning of this episode, we were saying that the Matrix Rust SDK is
able to filter and to sort an &lt;code&gt;ObservableVector&lt;&#x2F;code&gt; representing all the rooms.
How? &lt;code&gt;VectorSubscriberStream&lt;&#x2F;code&gt; &lt;em&gt;is&lt;&#x2F;em&gt; a &lt;code&gt;Stream&lt;&#x2F;code&gt;. More specifically, it is a
&lt;code&gt;Stream&amp;lt;Item = VectorDiff&amp;lt;T&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. Now questions:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;What&#x27;s the difference between an unfiltered &lt;code&gt;Vector&lt;&#x2F;code&gt; and a filtered &lt;code&gt;Vector&lt;&#x2F;code&gt;?&lt;&#x2F;li&gt;
&lt;li&gt;What&#x27;s the difference between an unsorted &lt;code&gt;Vector&lt;&#x2F;code&gt; and a sorted &lt;code&gt;Vector&lt;&#x2F;code&gt;?&lt;&#x2F;li&gt;
&lt;li&gt;What&#x27;s the difference between a filtered &lt;code&gt;Vector&lt;&#x2F;code&gt; and a sorted &lt;code&gt;Vector&lt;&#x2F;code&gt;?&lt;&#x2F;li&gt;
&lt;li&gt;and so on.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;All of them are strictly &lt;code&gt;Stream&amp;lt;Item = VectorDiff&amp;lt;T&amp;gt;&amp;gt;&lt;&#x2F;code&gt;! However, the
&lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s aren&#x27;t the same. A simple example. Let&#x27;s say we build a vector by
inserting &lt;code&gt;1&lt;&#x2F;code&gt;, &lt;code&gt;2&lt;&#x2F;code&gt;, &lt;code&gt;3&lt;&#x2F;code&gt; and &lt;code&gt;4&lt;&#x2F;code&gt;. We subscribe to it, and we want to filter out
all the even numbers. Instead of receiving:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Insert { index: 0, value: 1 }&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Insert { index: 1, value: 2 }&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Insert { index: 2, value: 3 }&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Insert { index: 3, value: 4 }&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;… we want to receive:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Insert { index: 0, value: 1 }&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Insert { index: 1, value: 3 }&lt;&#x2F;code&gt;: note the &lt;code&gt;index&lt;&#x2F;code&gt;, it is not 2
but 1!&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;We will see how all that works in the next episodes and how powerful this design
is, especially when it comes to cross-platform UI (user interface). We are going
to learn so much about &lt;code&gt;Stream&lt;&#x2F;code&gt; and &lt;code&gt;Future&lt;&#x2F;code&gt;, it&#x27;s going to be fun!&lt;&#x2F;p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn-spes_salutis&quot;&gt;
&lt;p&gt;Latine expression meaning &lt;em&gt;salvation hope&lt;&#x2F;em&gt;. &lt;a href=&quot;#fr-spes_salutis-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-beati_pauperes_in_spiritu&quot;&gt;
&lt;p&gt;Latine expression meaning &lt;em&gt;bless are the poor in spirit&lt;&#x2F;em&gt;. &lt;a href=&quot;#fr-beati_pauperes_in_spiritu-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-SRUB2015&quot;&gt;
&lt;p&gt;&lt;cite&gt;&lt;a href=&quot;https:&#x2F;&#x2F;infoscience.epfl.ch&#x2F;server&#x2F;api&#x2F;core&#x2F;bitstreams&#x2F;7c8b929f-1f68-4948-8ea8-e364e4899b2a&#x2F;content&quot;&gt;Relaxed-Radix-Balanced
(RRR) Vector: A Practical General Purpose Immutable
Sequence&lt;&#x2F;a&gt;&lt;&#x2F;cite&gt; by Sticki N., Rompf T., Ureche V. and Bagwell P. (2015,
August), in &lt;i&gt;Proceedings of the 20th ACM SIGPLAN International Conference
on Functional Programming (pp. 342-354).&lt;&#x2F;i&gt; &lt;a href=&quot;#fr-SRUB2015-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-UCR2014&quot;&gt;
&lt;p&gt;&lt;cite&gt;&lt;a href=&quot;http:&#x2F;&#x2F;deepsea.inria.fr&#x2F;pasl&#x2F;chunkedseq.pdf&quot;&gt;Theory
and Practise of Chunked Sequences&lt;&#x2F;a&gt;&lt;&#x2F;cite&gt; by Acar U. A., Charguéraud
A., and Rainey M. (2014), in &lt;i&gt;Algorithms-ESA 2014: 22th Annual European
Symposium, Wroclaw, Poland, September 8-10, 2014. Proceedings 21 (pp.
25-36).&lt;&#x2F;i&gt;, Springer Berlin Heidelberg. &lt;a href=&quot;#fr-UCR2014-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;section&gt;
</description>
      </item>
      <item>
          <title>I&#x27;ve loved Wasmer, I still love Wasmer</title>
          <pubDate>Mon, 04 Oct 2021 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/i-leave-wasmer/</link>
          <guid>https://mnt.io/articles/i-leave-wasmer/</guid>
          <description xml:base="https://mnt.io/articles/i-leave-wasmer/">&lt;p&gt;This article could also have been titled &lt;em&gt;How I failed to change
Wasmer&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Today is my last day at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wasmer.io&#x2F;&quot;&gt;Wasmer&lt;&#x2F;a&gt;. For those who
don&#x27;t know this name, it has a twofold meaning: it&#x27;s a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;very popular
WebAssembly runtime&lt;&#x2F;a&gt;, as well as a
startup. I want to write about what I&#x27;ve been able to accomplish during
my time at Wasmer (a high overview, not a technical view), and what
&lt;em&gt;forces&lt;&#x2F;em&gt; me to leave the company despite being one of its co-founder. I
reckon my testimony can help other people to avoid digging into the hell
I (and my colleagues) had to endure. I&#x27;m available for work, you can
contact me at &lt;a href=&quot;mailto:ivan@mnt.io&quot;&gt;ivan@mnt.io&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;@mnt_io&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;ivan-enderlin&#x2F;&quot;&gt;ivan-enderlin&lt;&#x2F;a&gt; (LinkedIn).&lt;&#x2F;p&gt;
&lt;h2 id=&quot;from-nothing-to-pure-awesomeness&quot;&gt;From nothing to pure awesomeness&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#from-nothing-to-pure-awesomeness&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;ve joined the Wasmer company at its early beginning, in March 2019.
The company was 3 months old. My initial role was to write and to
improve the runtime itself, and to create many embeddings, i.e. ways to
integrate the Wasmer runtime inside various technologies, so that
WebAssembly can run everywhere.&lt;&#x2F;p&gt;
&lt;p&gt;I can say with confidence that my work is a success. I&#x27;ve learned a lot,
and I&#x27;ve worked on so many different projects, technologies, hacked so
many things, collaborated with so many people, every action was led by
the &lt;strong&gt;passion&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;At the time of writing, Wasmer has an incredible growth. In 2.5 years
only, the runtime has more than 10&#x27;500 stars on Github, and is &lt;strong&gt;one of
the most popular WebAssembly runtime in the world&lt;&#x2F;strong&gt;! It&#x27;s used by many
various companies, such as &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;confio.tech&#x2F;&quot;&gt;Confio&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;fluence.network&#x2F;&quot;&gt;Fluence
Labs&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hotg.dev&#x2F;&quot;&gt;HOT-G&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;brave.com&#x2F;&quot;&gt;Brave&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;google.com&#x2F;&quot;&gt;Google&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.apple.com&#x2F;&quot;&gt;Apple&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spacemesh.io&#x2F;&quot;&gt;SpaceMesh&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;linkerd.io&#x2F;&quot;&gt;Linkerd&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.singlestore.com&#x2F;&quot;&gt;SingleStore&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.clever-cloud.com&#x2F;&quot;&gt;CleverCloud&lt;&#x2F;a&gt; or
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;konghq.com&#x2F;&quot;&gt;Kong&lt;&#x2F;a&gt; to name a few (for the ones I can name
though, however other companies are also using Wasmer in very critical
environments).&lt;&#x2F;p&gt;
&lt;p&gt;Most of my engineering job happened on the Wasmer runtime itself. At the
time of writing, I&#x27;m the #2 contributor on the project. I was working
on &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;f9ff574e10d4ee97f836565bdae99035e04ac879&#x2F;lib&quot;&gt;every parts of the
runtime&lt;&#x2F;a&gt;:
the API, the C API, the compilers, the ABI (mostly WASI), the engines,
the middlewares, and the VM itself which is the most low-level
foundamental layer of the runtime.&lt;&#x2F;p&gt;
&lt;p&gt;The runtime provides so many features. It is an impressively powerful
runtime for WebAssembly, and I&#x27;m saying that with a neutral and
respectful mindset. Not everything is perfect obviously but I did my
best to set up a truly user-friendly learning environment, with an
important documentation and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;f9ff574e10d4ee97f836565bdae99035e04ac879&#x2F;examples&quot;&gt;a collection of
examples&lt;&#x2F;a&gt;
that illustrate many features. I strongly believe it contributed to
Wasmer&#x27;s popularity to great extent.&lt;&#x2F;p&gt;
&lt;p&gt;I would like to highlight the most notable embedding projects I&#x27;ve
created:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;master&#x2F;lib&#x2F;c-api&quot;&gt;&lt;code&gt;wasmer-c-api&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; is
the C embedding for Wasmer. It&#x27;s part of the Wasmer runtime itself, and is
fully written in Rust.
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;wasmer-c-api&#x2F;*&#x2F;wasmer_c_api&#x2F;wasm_c_api&#x2F;index.html&quot;&gt;The documentation, the C
examples&lt;&#x2F;a&gt;,
everything is super polished to offer the best experience possible. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;MarkMcCaskey&quot;&gt;Mark
McCaskey&lt;&#x2F;a&gt; and I are the authors of this
project.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer-python&quot;&gt;&lt;code&gt;wasmer-python&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; is the Python
embedding for Wasmer. At the time of writing, it&#x27;s been installed more than 5
millions times (I&#x27;m counting the compiler packages too, like
&lt;code&gt;wasmer-compiler-cranelift&lt;&#x2F;code&gt; and so on), and 1300 stars on Github. There is
about 300&#x27;000 downloads per months, and it continues to grow! The code is
written in Rust, and it relies on
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;pyo3.rs&#x2F;&quot;&gt;the awesome &lt;code&gt;pyo3&lt;&#x2F;code&gt; project&lt;&#x2F;a&gt; .&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer-go&#x2F;&quot;&gt;&lt;code&gt;wasmer-go&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; is the Go embedding for
Wasmer. It&#x27;s hard to know how much total downloads we have because of how the
Go ecosystem is designed, but we have about 60&#x27;000 downloads per months from
Github (I&#x27;m excluding the forks of the project), and 1600 stars on Github. The
code is written in Go and uses &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;golang.org&#x2F;cmd&#x2F;cgo&#x2F;&quot;&gt;&lt;code&gt;cgo&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; to bind
against the C API. Almost all blockchain projects that use WebAssembly are
using &lt;code&gt;wasmer-go&lt;&#x2F;code&gt;, which is a popularity I wasn&#x27;t expecting.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer-ruby&#x2F;&quot;&gt;&lt;code&gt;wasmer-ruby&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; is the Ruby
embedding for Wasmer. It&#x27;s not as popular as the others, but it&#x27;s also very
polished and it&#x27;s finding its place in the Ruby ecosystem. The code is written
in Rust, and it relies on
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;danielpclark&#x2F;rutie&quot;&gt;the awesome &lt;code&gt;rutie&lt;&#x2F;code&gt; project&lt;&#x2F;a&gt; .&lt;&#x2F;li&gt;
&lt;li&gt;I won&#x27;t detail all the projects, but there is also
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer-php&quot;&gt;&lt;code&gt;wasmer-php&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer-java&quot;&gt;&lt;code&gt;wasmer-java&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer-postgres&quot;&gt;&lt;code&gt;wasmer-postgres&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;… Because of
the Wasmer runtime API and C API we have designed, many developers around the
globe have been able to create a lot more embeddings, such as in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;migueldeicaza&#x2F;WasmerSharp&quot;&gt;C#&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;chances&#x2F;wasmer-d&quot;&gt;D&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;tessi&#x2F;wasmex&quot;&gt;Elixir&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;dirkschumacher&#x2F;wasmr&quot;&gt;R&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;AlwaysRightInstitute&#x2F;SwiftyWasmer&quot;&gt;Swift&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;zigwasm&#x2F;wasmer-zig&quot;&gt;Zig&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;dart-lang&#x2F;wasm&quot;&gt;Dart&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;helmutkian&#x2F;cl-wasm-runtime&quot;&gt;Lisp&lt;&#x2F;a&gt; and so on.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Other fun notable projects are:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;sonde-rs&quot;&gt;&lt;code&gt;sonde-rs&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, a library to
compile USDT probes into a Rust library,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;llvm-custom-builds&quot;&gt;&lt;code&gt;llvm-custom-builds&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, a
sandbox to produce custom LLVM builds for various platforms,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;loupe&quot;&gt;&lt;code&gt;loupe&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, a set of tools to
analyse and to profile Rust code,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;interface-types&quot;&gt;&lt;code&gt;wasmer-interface-types&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, a
“living” (understand an unstable playground) library that implements
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;interface-types&quot;&gt;the WebAssembly Interface Types proposal&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;inline-c-rs&#x2F;&quot;&gt;&lt;code&gt;inline-c-rs&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, to write and
to execute C code inside Rust,&lt;&#x2F;li&gt;
&lt;li&gt;in-memory filesystem, that acts exactly like &lt;code&gt;std::fs&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;As you might think, I&#x27;ve learned so much. The impostor syndrom was very
present because I was constantly trying to do something I didn&#x27;t know.
It&#x27;s part of the routine at Wasmer: Trying something for the first time.
But it&#x27;s also what kept me motivated, and it was the energy for my
passion.&lt;&#x2F;p&gt;
&lt;p&gt;This list above shows released projects, but I&#x27;ve also experimented (and
sometimes at two hairs of a release) with:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Unikernel&quot;&gt;Unikernels&lt;&#x2F;a&gt;; this one was really
fun, given a WebAssembly module and a filesystem, we were able to generate a
unikernel that was executing the given program,&lt;&#x2F;li&gt;
&lt;li&gt;Parser; to write the fastest WebAssembly parser possible, it was working, but
never released,&lt;&#x2F;li&gt;
&lt;li&gt;HAL (Hardware Abstraction Layer) ABI for WebAssembly, so that we can run
WebAssembly on small chips super easily (think of IoT),&lt;&#x2F;li&gt;
&lt;li&gt;Networking; an extension to WASI to support networking (TCP and UDP sockets),
with an implementation in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.rust-lang.org&#x2F;&quot;&gt;Rust&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;C_standard_library&quot;&gt;libc&lt;&#x2F;a&gt;, and even
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ziglang&#x2F;zig&#x2F;&quot;&gt;Zig&lt;&#x2F;a&gt;! We were able to compile C programs to
WebAssembly like cURL, or TCP servers written with kqueue or epoll etc, and to
execute them on any platforms.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;All those things were working.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s absolutely crazy what WebAssembly can do today, and I still truly
and deeply believe in this technology. I&#x27;m not the only one:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.ycombinator.com&#x2F;companies&#x2F;wasmer&quot;&gt;YCombinator&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;speedinvest&#x2F;the-next-generation-of-cloud-computing-investing-in-wasmer-768c9aac5922&quot;&gt;SpeedInvest&lt;&#x2F;a&gt;
are also founders that believe in Wasmer.&lt;&#x2F;p&gt;
&lt;p&gt;So. What a dream, huh?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-toxic-working-environment&quot;&gt;The toxic working environment&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-toxic-working-environment&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;WebAssembly is &lt;em&gt;nothing&lt;&#x2F;em&gt; without its community. I won&#x27;t name people to
avoid missing important persons, but all the contributors are doing
amazing work, to create something new, something special, something
&lt;em&gt;right&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Wasmer is a success. The Wasmer runtime is &lt;em&gt;nothing&lt;&#x2F;em&gt; without the
incredible, marvelous, exceptional team of engineers behind it. In no
particular order: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;lachlansneff&quot;&gt;Lachlan Sneff&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;MarkMcCaskey&quot;&gt;Mark McCaskey&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jubianchi&quot;&gt;Julien
Bianchi&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nlewycky&quot;&gt;Nick
Lewycky&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;losfair&quot;&gt;Heyang
Zhou&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;xmclark&quot;&gt;Mackenzie
Clark&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;bjfish&quot;&gt;Brandon
Fish&lt;&#x2F;a&gt;. All of them, with no exception, have
put a lot of passion in this project. It is what it is today because of
them and also because of the contributors we have been honored to
welcome. The open source side of Wasmer was intense but also an
important source of joy. It is a respectful place to work.&lt;&#x2F;p&gt;
&lt;p&gt;However, the inside reality was very different. All the employees
hereinabove have left the company. Almost all of them due to a burn-out
or conflicts or strong disagreements with the company leadership. I am
leaving due to a severe burn-out. I would like to briefly share my
journey to my first burn-out in few points:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;I&#x27;ve started as an engineer. I love coding. I love hacking. In Wasmer, I&#x27;ve
found a place to learn a lot and to express my passion. We had a lot of
pressure mostly because our friendly “competitors” had more people dedicated
to work on their runtimes, more money, more power, better marketing and so on.
That&#x27;s the inevitable burden of any startup. When you&#x27;re competing against
giants, that&#x27;s what happens. And that&#x27;s OK. It&#x27;s part of the game.&lt;&#x2F;li&gt;
&lt;li&gt;During that time, we were delivering more and more projects, more and more
features, at an incredible pace. New hats: Release manager, project manager,
more product ownership, more customers to be connected with, more contributors
to help, more issues to triage, blog writer etc. The pace was accelerating too
fast, something we did notice on multiple occasions.&lt;&#x2F;li&gt;
&lt;li&gt;The CEO, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;syrusakbary&quot;&gt;Syrus Akbary&lt;&#x2F;a&gt;, had evidently a lot
of pressure on its shoulders. It sadly resulted in the worst possible way:
micro-management, stress, pressure, bad leadership, lack of vision, lack of
trust in the employees, changing the roadmap constantly, lies, secrets etc.&lt;&#x2F;li&gt;
&lt;li&gt;As one of the older in the company, with a family of two kids, I probably got
more “wisdom”. I&#x27;ve decided to create a safe place for employees to express
their frustrations, their needs, to find solutions together. &lt;em&gt;De facto&lt;&#x2F;em&gt;, I
became the “person of trust” in the company. I got new hats, new pressures.&lt;&#x2F;li&gt;
&lt;li&gt;SARS-CoV-2 hit. School at home. Lock-down. More micro-management, more stress.
Wasmer was running out of money. I brought a new investor that saved the
company. New hat.&lt;&#x2F;li&gt;
&lt;li&gt;After too many departures (85% of the engineering team!), I tried to take more
space and to take more responsabilities in the company. That was at the
beginning of 2021. It was my last attempt to save the company from a disaster
before leaving. &lt;strong&gt;I couldn&#x27;t imagine leaving such brilliant and successful
projects without having tried everything I could&lt;&#x2F;strong&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;Then &lt;strong&gt;I became a &lt;em&gt;late co-founder&lt;&#x2F;em&gt; of Wasmer&lt;&#x2F;strong&gt;. Too many new hats: Doing
hiring interviews, accountabilities, helping to define the roadmap (with
another awesome person, friend, and employee), handling legal aspects to hire
people in multiple countries with non-precarious contracts etc.&lt;&#x2F;li&gt;
&lt;li&gt;Obviously, I was also doing the job of all the engineers that have left. They
were not replaced for unknown reasons. It was absolutely madness. The pace was
unsustainable.&lt;&#x2F;li&gt;
&lt;li&gt;Finally, the crack. The CEO continued to change the roadmap, to take bad
decisions, to not recognize all the efforts we were doing to save&#x2F;grow the
company. It was my turn to be declared in a &lt;em&gt;severe&lt;&#x2F;em&gt; burn-out by my physician.
The last engineer to fall.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Another point: Syrus Akbary also has made many public errors that have
created hostility against the company. Hopefully people were smart and
kind enough to make the difference between the employees and the CEO (I
won&#x27;t name the people but they will recognize themselves: Thank you). I
tried to fix that situation. Discussing with dozens of person to restore
empathy and forgiveness, to create better collaboration, to cure and
move forward. It was exhausting. I know people have appreciated what I
did, but my mental health was ruined.&lt;&#x2F;p&gt;
&lt;p&gt;Considering all the time I&#x27;ve devoted to the company, the very few
consideration I got in return, the countless work hours (4 days per
week, but frequently closing the computer at 1am due to very late
meetings, I was working like hell), the precarious contract I had (did
you ever see a co-founder with a freelancer contract?), the toxic
working environment, the constant pressure etc., my passion was intact
but my motivation was seriously damaged. Doing overtime was never
recorded and was happening more than frequently, but taking half a day
to take care of a sick child was immediately counted as holidays; the
balance was broken. Criticisms. Micro-management. Disapprovals.
Rewriting the facts and the reality to criticize what you&#x27;re doing,
flipping things against you, avoiding discussion when things get stormy.
We even had a meeting titled “Why you&#x27;re not productive enough” whilst
everyone was working as hell, right after the rewrite of the entire
runtime to release Wasmer 1.0, a period we all affectionately called
“The Rewrite of Hell”. The team deserved vacations, congratulations,
attentions, gratitude, … not such a shitty meeting. Well, you get the
idea.&lt;&#x2F;p&gt;
&lt;p&gt;When I&#x27;ve been declared in a severe burn-out, I had to take a break. The
reaction from the CEO was… unexpected: Zero empathy, asking to never
ever being sick again (otherwise I will be fired), dividing my equities,
asking me to work more, saying I&#x27;ve never been involved in the company
etc. That was the final straw to me. That&#x27;s &lt;em&gt;the&lt;&#x2F;em&gt; wrong way to treat an
employee, a collaborator, a contributor, the co-founder.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-s-next&quot;&gt;What&#x27;s next?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-s-next&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;I need to recover. As you can imagine, working 2.5 years at this pace
leaves sequelae. Hopefully a couple of months should suffice.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m still in love with Wasmer, the &lt;strong&gt;runtime&lt;&#x2F;strong&gt;, the open source projects
we have created. It has a bright future. More companies are contributing
to it, more individual contributors are bringing their stones to the
monument. The project is owned by the public, by the users, by the
contributors, they are doing most of the work today. It&#x27;s well tested,
well documented, it&#x27;s easy to contribute to it. It&#x27;s a fabulous open
source piece of technology.&lt;&#x2F;p&gt;
&lt;p&gt;I strongly &lt;em&gt;hope&lt;&#x2F;em&gt; Wasmer, the &lt;strong&gt;company&lt;&#x2F;strong&gt;, will change. The products
that are going to be released are absolutely fantastic. It&#x27;s a
technology shift. It will enable the Decentralized Web, how we compile
and distribute programs, how we will even consume programs. Wasmer has a
solid bright future. I really &lt;em&gt;hope&lt;&#x2F;em&gt; things will change, and I wish the
best to and am passing on the torch to the adventurers that will
continue to move the company forward. I&#x27;m just too &lt;em&gt;skeptical&lt;&#x2F;em&gt; that
things can improve or even slightly change. We have built something
great. Please take a great care of it.&lt;&#x2F;p&gt;
&lt;p&gt;As I said, I&#x27;m available for a new adventure, you can contact me at
&lt;a href=&quot;mailto:ivan@mnt.io&quot;&gt;ivan@mnt.io&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;@mnt_io&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;ivan-enderlin&#x2F;&quot;&gt;ivan-enderlin&lt;&#x2F;a&gt; (LinkedIn).&lt;&#x2F;p&gt;
&lt;p&gt;Discussions &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&#x2F;status&#x2F;1445310721185783811&quot;&gt;on
Twitter&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;news.ycombinator.com&#x2F;item?id=28772863&quot;&gt;on
HackerNews&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Bye bye WhatsApp, hello ?</title>
          <pubDate>Tue, 19 Jan 2021 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/bye-bye-whatsapp-hello/</link>
          <guid>https://mnt.io/articles/bye-bye-whatsapp-hello/</guid>
          <description xml:base="https://mnt.io/articles/bye-bye-whatsapp-hello/">&lt;p&gt;Ce billet est en français, essentiellement à destination de mes ami(e)s
et familles, il sert à vulgariser très rapidement les enjeux autour de
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.whatsapp.com&#x2F;&quot;&gt;WhatsApp&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.signal.org&#x2F;fr&#x2F;&quot;&gt;Signal&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;telegram.org&#x2F;&quot;&gt;Telegram&lt;&#x2F;a&gt;
et &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;&quot;&gt;Matrix&lt;&#x2F;a&gt; (&lt;em&gt;spoiler&lt;&#x2F;em&gt;, c&#x27;est le gagnant). Tout le
monde me pose la même question, alors voici une réponse rapidement en
brouillon qui va m&#x27;éviter du copier&#x2F;coller !&lt;&#x2F;p&gt;
&lt;p&gt;Je ne rentre volontairement &lt;em&gt;pas&lt;&#x2F;em&gt; dans les détails. Il faut que ce
document reste à la portée de tous, sans aucune connaissance en réseau,
chiffrement, sécurité etc. Ceux qui ont ces connaissances savent déjà
que Matrix est &lt;em&gt;le&lt;&#x2F;em&gt; réseau vers lequel aller ;-).&lt;&#x2F;p&gt;
&lt;h2 id=&quot;les-bases&quot;&gt;Les bases&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#les-bases&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Quand on parle de messageries, il y a 2 choses primordiales plus 1 bonus :&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;le chiffrement ;&lt;&#x2F;li&gt;
&lt;li&gt;la topologie du réseau (c&#x27;est facile, n&#x27;ayez pas peur) ;&lt;&#x2F;li&gt;
&lt;li&gt;l&#x27;accès libre et gratuit sans restriction au code source (&lt;em&gt;open
source&lt;&#x2F;em&gt;).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Nous pouvons aussi parler du modèle économique du réseau rapidement,
voir le tableau comparatif.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;le-chiffrement&quot;&gt;Le chiffrement&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#le-chiffrement&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Pour respecter la vie privée et éviter l&#x27;espionnage et le vol des
données, il faut que le chiffrement se fasse de bout en bout (&lt;em&gt;end to
end encryption&lt;&#x2F;em&gt;). Ça veut dire que vous seul avez la clé pour chiffrer
et&#x2F;ou déchiffrer vos messages, et personne d&#x27;autre. Par message,
j&#x27;entends message texte, audio, image, vidéo, appels audios-vidéos,
tout. Vos données sont à vous, et uniquement vous, et personne ne peut
les utiliser, à part la personne avec qui vous les partagez (qui elle,
normalement à une clé de déchiffrement par exemple). Les clés servent
aussi à identifier la personne avec qui vous parlez, ça permet d&#x27;éviter
le vol d&#x27;identité.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;la-topologie&quot;&gt;La topologie&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#la-topologie&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;La plupart des réseaux sont centralisés : ça veut dire qu&#x27;on a un gros
silot, un énorme ordinateur&#x2F;serveur, et que tout le monde est dessus. Ça
pose plein de problèmes :&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;impossible d&#x27;avoir le contrôle dessus ;&lt;&#x2F;li&gt;
&lt;li&gt;impossible de faire confiance ;&lt;&#x2F;li&gt;
&lt;li&gt;faille unique.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Je prends l&#x27;exemple de WhatsApp pour illustrer tout ça parce que ça
parle à tout le monde : Facebook décide unilatéralement de déchiffrer le
réseau, personne n&#x27;a le contrôle dessus, c&#x27;est une violation grave de la
vie privée de milliards de personnes et on ne peut rien faire (à part
quitter le réseau). Avions-nous confiance dans ce que faisait Facebook
avec nos données WhatsApp avant ? Non, aucunement. Ils disaient que
c&#x27;était chiffré, l&#x27;était-ce vraiment ? J&#x27;accorde plus de confiance dans
ceux qui ont créé et chiffré le réseau avant qu&#x27;il ne soit racheté par
Facebook, donc j&#x27;ai envie d&#x27;y croire, mais… &lt;em&gt;je ne peux pas le vérifier&lt;&#x2F;em&gt;
! Pourquoi ? Parce que personne (en dehors de quelques employés chez
Facebook) n&#x27;a accès au code source, aux programmes, qui font tourner
WhatsApp. Et pour le côté &lt;em&gt;faille unique&lt;&#x2F;em&gt;, si Facebook est attaqué,
c&#x27;est l&#x27;entièreté du réseau qui s&#x27;effondre, c&#x27;est une faille unique, un
&lt;em&gt;single point of failure&lt;&#x2F;em&gt; comme on dit dans le métier. Pareil si le
réseau est &lt;em&gt;hacké&lt;&#x2F;em&gt;, c&#x27;est un accès illimité à tout le réseau.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Aucune transparence = aucune confiance.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Mais il existe une alternative majeure bien sûr ! Les réseaux
décentralisés. Au lieu d&#x27;avoir un serveur, il y a en des centaines, des
milliers. Il n&#x27;y a plus de contrôle possible. Il n&#x27;y a plus de &lt;em&gt;single
point of failure&lt;&#x2F;em&gt;. Un &lt;em&gt;hacker&lt;&#x2F;em&gt; ne peut accéder au pire qu&#x27;aux données
d&#x27;un seul serveur, pas de tous les serveurs (il existe pleins
d&#x27;exceptions mais je vulgarise, hein). Nous pouvons créer autant de
serveurs que nous le souhaitons. Souvent, ce sont des réseaux open
source, donc nous pouvons lire le code des programmes, vérifier qu&#x27;ils
font bien ce qu&#x27;ils proclament faire.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tableau-comparatif&quot;&gt;Tableau comparatif&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#tableau-comparatif&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Comparons les services populaires avec ces critères de bases.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Service&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;&lt;strong&gt;Chiffrement&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;&lt;strong&gt;Topologie&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;&lt;strong&gt;Open source&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;WhatsApp&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;bout en bout (pour le moment)&lt;&#x2F;td&gt;
        &lt;td&gt;centralisé (US)&lt;&#x2F;td&gt;
        &lt;td&gt;non&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Telegram&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;bout en bout (pour le moment)&lt;&#x2F;td&gt;
        &lt;td&gt;centralisé (Dubaï, US)&lt;&#x2F;td&gt;
        &lt;td&gt;non&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Signal&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;bout en bout&lt;&#x2F;td&gt;
        &lt;td&gt;centralisé (US)&lt;&#x2F;td&gt;
        &lt;td&gt;oui mais…&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Matrix&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;bout en bout&lt;&#x2F;td&gt;
        &lt;td&gt;décentralisé&lt;&#x2F;td&gt;
        &lt;td&gt;oui&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Comparons la base !&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Signal est open source, mais nous ne pouvons pas vérifier ce qui est
installé sur les serveurs, parce que le serveur est privé. De plus, le
serveur open source n&#x27;a pas été &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;signalapp&#x2F;Signal-Server&quot;&gt;mis à jour depuis avril
2020&lt;&#x2F;a&gt;, en année
Informatique, c&#x27;est très long. Ça cache quelque chose ? Aucune idée, je
ne peux pas le savoir, car je n&#x27;ai pas d&#x27;éléments pour prendre une
décision. Est-ce que je veux déposer mes données privées sur un service
dans lequel je n&#x27;ai pas confiance ?&lt;&#x2F;p&gt;
&lt;p&gt;En plus, Signal comme WhatsApp sont hébergés&#x2F;situés aux US, avec les
lois liberticides qu&#x27;on leur connaît bien (comme le Cloud Act). Signal
limite la casse grâce au chiffrement de bout en bout, mais peut être
qu&#x27;une &lt;em&gt;backdoor&lt;&#x2F;em&gt; est présente et qu&#x27;on ne le saura jamais.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Aucune transparence = aucune confiance&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Les réseaux décentralisés sont supérieurs à tous les niveaux (pas de
contrôle, pas de hack massif etc.). Les réseaux open source sont ceux en
qui nous pouvons avoir confiance. Donc le choix est vite fait, le
gagnant ici est Matrix.&lt;&#x2F;p&gt;
&lt;p&gt;Comparons maintenant comment les services sont financés, parce que c&#x27;est
important. Si un service n&#x27;est pas rentable, il pourrait avoir de
l&#x27;appétit pour les données de ses utilisateurs, et là c&#x27;est dangereux
(c&#x27;est exactement ce qu&#x27;il se passe avec Facebook et WhatsApp).&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Service&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;&lt;strong&gt;Revenues&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;WhatsApp&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;Facebook veut utiliser les données privées pour vendre de la publicité ciblée.&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Telegram&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;Les fondateurs sont millionnaires et injectent de l&#x27;argent.&lt;br&gt;Dans peu de temps, financement via pubs et comptes premiums.&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Signal&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;Organisation à but non-lucratif qui opère via des dons.&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;strong&gt;Matrix&lt;&#x2F;strong&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;Matrix développe, offre ou vend des services autour du réseau, mais pas autour des données !&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Comment sont financés les services ?&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Les gagnants ici sont Signal et Matrix.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion-matrix-gagnant&quot;&gt;Conclusion : Matrix gagnant&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#conclusion-matrix-gagnant&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Dans le cas des réseaux centralisés, Signal est une meilleure
alternative à WhatsApp et Telegram de part son mode de financement (donc
son appétit pour les données des utilisateurs), mais ils sont tous
sujets aux même problèmes : aucune confiance car pas de transparence,
hébergés aux US etc.&lt;&#x2F;p&gt;
&lt;p&gt;Mais les réseaux décentralisés sont supérieurs car ils résolvent tous
ces problèmes ! Matrix est décentralisé, est financé par des services
autour du réseau mais pas par les données du réseau (qui sont
inaccessibles de toute façon, elles n&#x27;existent que sur vos téléphones et
ordinateurs, nul part ailleurs).&lt;&#x2F;p&gt;
&lt;p&gt;J&#x27;utilise Matrix. Je vous conseille d&#x27;utiliser Matrix. Partir sur
Signal, c&#x27;est sortir de la gueule d&#x27;un loup pour aller dans celle d&#x27;un
autre. Je suis admiratif du travail des développeurs de chez Signal, ils
sont vraiment bons, leur protocole de chiffrement est magnifique, mais
je n&#x27;ai pas confiance dans leur service parce que je ne &lt;em&gt;peux&lt;&#x2F;em&gt; pas. Et
personne ne le &lt;em&gt;peut&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;J&#x27;utilise aussi WhatsApp et Signal pour rester en contact avec mes amis
et ma famille, et leur dire d&#x27;utiliser Matrix, mais je n&#x27;y publierai
jamais de données personnelles, photos ou quoi que ce soit, je n&#x27;ai
aucune confiance. Libre à vous aussi d&#x27;utiliser plusieurs réseaux, après
tout nous jonglons déjà avec plusieurs réseaux (mail, SMS, WhatsApp,
Matrix, Twitter, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;mastodon.social&#x2F;about&quot;&gt;Mastodon&lt;&#x2F;a&gt; etc.), ça
n&#x27;est pas un problème !&lt;&#x2F;p&gt;
&lt;h2 id=&quot;premier-pas-avec-matrix&quot;&gt;Premier pas avec Matrix&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#premier-pas-avec-matrix&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;C&#x27;est parti, petit tuto Matrix. Le réseau est exceptionnel, mais le
client officiel (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;&quot;&gt;Element&lt;&#x2F;a&gt;) est encore un peu «
brut » à utiliser comparé à Signal ou WhatsApp. Notez que ça évolue très
très vite (je compte 616 contributeurs qui travaillent dessus
bénévolement, encore une grande force de l&#x27;open source !).&lt;&#x2F;p&gt;
&lt;p&gt;Ce qui va vous titiller le plus c&#x27;est : vous ne pouvez pas toujours
identifier vos contacts par numéro de téléphone (seulement s&#x27;ils sont
enregistrés sur un serveur d&#x27;identité). Pourquoi ? Parce que votre
compte à un identifiant, comme une adresse email. Le mien est
&lt;code&gt;@mnt_io:matrix.org&lt;&#x2F;code&gt; (le format est &lt;code&gt;@identifiant:serveur&lt;&#x2F;code&gt;). C&#x27;est bien
meilleur pour la vie privée. Et pis, ça n&#x27;est pas différent de MSN ou de
tout autre réseau de l&#x27;époque, c&#x27;est vraiment WhatsApp qui a imposé la «
découvertabilité » par le numéro de téléphone. Bien que très pratique,
c&#x27;est dangereux pour la vie privée.&lt;&#x2F;p&gt;
&lt;p&gt;Donc, go, on installe le client :&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;sur &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;apps.apple.com&#x2F;us&#x2F;app&#x2F;element-messenger&#x2F;id1083446067&quot;&gt;iOS, macOS
etc&lt;&#x2F;a&gt;.,&lt;&#x2F;li&gt;
&lt;li&gt;sur
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;play.google.com&#x2F;store&#x2F;apps&#x2F;details?id=im.vector.app&amp;amp;hl=en_US&amp;amp;gl=US&quot;&gt;Android&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;sur votre &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;get-started&quot;&gt;bureau ou votre
navigateur&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Puis on crée un compte, et ajoutez moi. C&#x27;est parti !&lt;&#x2F;p&gt;
&lt;p&gt;Matrix&#x2F;Element est basé sur les groupes. Les chats « directs » (1:1)
sont des groupes aussi. Vous pouvez même rejoindre des &lt;em&gt;rooms&lt;&#x2F;em&gt; (gros
groupes, des communautés) avec des centaines voire des milliers de
personnes dedans. C&#x27;est très flexible.&lt;&#x2F;p&gt;
&lt;p&gt;Parce que c&#x27;est open source, n&#x27;importe qui peut écrire son propre client
(programme qui se connecte au réseau). Il existe des clients
alternatives, comme &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;nio.chat&#x2F;&quot;&gt;Nio&lt;&#x2F;a&gt; ou
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;fluffychat.im&#x2F;en&#x2F;&quot;&gt;FluffyChat&lt;&#x2F;a&gt;, ou même &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;matrix.org&#x2F;docs&#x2F;projects&#x2F;client&#x2F;ditto-chat&quot;&gt;Ditto
Chat&lt;&#x2F;a&gt;. Tous ces
clients sont encore en beta, mais ça montre un futur très excitant pour
Matrix avec des clients de plus en plus aboutis !&lt;&#x2F;p&gt;
&lt;h3 id=&quot;matrix-element-vector-hein&quot;&gt;Matrix, Element, Vector, hein ?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#matrix-element-vector-hein&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;ul&gt;
&lt;li&gt;Element c&#x27;est le nom de l&#x27;entreprise qui travaille&#x2F;développe le réseau, les
serveurs et le client ;&lt;&#x2F;li&gt;
&lt;li&gt;Matrix c&#x27;est le nom du réseau ;&lt;&#x2F;li&gt;
&lt;li&gt;Vector, c&#x27;est l&#x27;ancien nom d&#x27;Element.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;On parle souvent de façon indifférentiée de Matrix ou Element, c&#x27;est un
abus de langage.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Before: Mark as read.&lt;&#x2F;p&gt;
&lt;p&gt;Now: Mark has read.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Et par pitié, quittez Facebook…&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Announcing the first Java library to run WebAssembly: Wasmer JNI</title>
          <pubDate>Wed, 13 May 2020 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/announcing-the-first-java-library-to-run-webassembly-wasmer-jni/</link>
          <guid>https://mnt.io/articles/announcing-the-first-java-library-to-run-webassembly-wasmer-jni/</guid>
          <description xml:base="https://mnt.io/articles/announcing-the-first-java-library-to-run-webassembly-wasmer-jni/">&lt;p&gt;&lt;em&gt;This is a copy of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;announcing-the-first-java-library-to-run-webassembly-wasmer-jni-89e319d2ac7c&quot;&gt;an article I wrote for
Wasmer&lt;&#x2F;a&gt;.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;&quot;&gt;WebAssembly&lt;&#x2F;a&gt; is a portable binary format.
That means the same file can run anywhere.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;To uphold this bold statement, each language, platform and system must
be able to run WebAssembly — as fast and safely as possible.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;People who are familiar with Wasmer are used to this kind of
announcement! Wasmer is written in Rust, and comes with an additional
native C API. But you can use it in a lot of other languages. After
having announced libraries to use Wasmer, and thus WebAssembly, in:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;php-ext-wasm&quot;&gt;&lt;strong&gt;PHP&lt;&#x2F;strong&gt; with the &lt;code&gt;ext&#x2F;wasm&lt;&#x2F;code&gt;
extension&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;python-ext-wasm&quot;&gt;&lt;strong&gt;Python&lt;&#x2F;strong&gt; with the &lt;code&gt;wasmer&lt;&#x2F;code&gt;
library&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;ruby-ext-wasm&quot;&gt;&lt;strong&gt;Ruby&lt;&#x2F;strong&gt; with the &lt;code&gt;wasmer&lt;&#x2F;code&gt;
library&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&quot;&gt;&lt;strong&gt;Go&lt;&#x2F;strong&gt; with the &lt;code&gt;wasmer&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt;
(see
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;announcing-the-fastest-webassembly-runtime-for-go-wasmer-19832d77c050&quot;&gt;Announcing the fastest WebAssembly runtime for Go: &lt;code&gt;wasmer&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;),
and even&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;postgres-ext-wasm&quot;&gt;&lt;strong&gt;Postgres&lt;&#x2F;strong&gt; with the &lt;code&gt;wasmer&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt;
(see
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;announcing-the-first-postgres-extension-to-run-webassembly-561af2cfcb1&quot;&gt;Announcing the first Postgres extension to run WebAssembly&lt;&#x2F;a&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;and many other contributions in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;migueldeicaza&#x2F;WasmerSharp&quot;&gt;.NET&#x2F;C#&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;dirkschumacher&#x2F;wasmr&quot;&gt;R&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;tessi&#x2F;wasmex&quot;&gt;Elixir&lt;&#x2F;a&gt;…&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;…we are jazzed to announce that &lt;strong&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&quot;&gt;Wasmer has now landed in
Java&lt;&#x2F;a&gt;&lt;&#x2F;strong&gt;!&lt;&#x2F;p&gt;
&lt;p&gt;Let’s discover the Wasmer JNI library together.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;installation&quot;&gt;Installation&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#installation&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The Wasmer JNI (&lt;em&gt;Java Native Interface&lt;&#x2F;em&gt;) library is based on the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;Wasmer
runtime&lt;&#x2F;a&gt;, which is written in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.rust-lang.org&#x2F;&quot;&gt;Rust&lt;&#x2F;a&gt;, and is compiled to a shared library.
For your convenience, we produce one JAR (&lt;em&gt;Java Archive&lt;&#x2F;em&gt;) per
architecture and platform. By now, the following are supported,
consistently tested, and pre-packaged (available in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;bintray.com&#x2F;wasmer&#x2F;wasmer-jni&#x2F;wasmer-jni&quot;&gt;Bintray&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&#x2F;releases&quot;&gt;Github
Releases&lt;&#x2F;a&gt;):&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;amd64-darwin&lt;&#x2F;code&gt; for macOS, x86 64bits,&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;amd64-linux&lt;&#x2F;code&gt; for Linux, x86 64 bits,&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;amd64-windows&lt;&#x2F;code&gt; for Windows, x86 64 bits.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;More architectures and more platforms will be added in the near future.
If you need a specific one, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&#x2F;issues&#x2F;new?assignees=&amp;amp;labels=%F0%9F%8E%89+enhancement&amp;amp;template=---feature-request.md&amp;amp;title=&quot;&gt;feel free to
ask&lt;&#x2F;a&gt;!
However, it is possible to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm#development&quot;&gt;produce your own JAR for your own platform
and
architecture&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The JAR files are named as follows:
&lt;code&gt;wasmer-jni-$(architecture)-$(os)-$(version).jar&lt;&#x2F;code&gt;. Thus, to include
Wasmer JNI as a dependency of your project (assuming you use
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;gradle.org&#x2F;&quot;&gt;Gradle&lt;&#x2F;a&gt;), write for instance:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;dependencies {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    implementation &amp;quot;org.wasmer:wasmer-jni-amd64-linux:0.2.0&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;JAR are hosted on the Bintray&#x2F;JCenter repository under the
&lt;code&gt;[wasmer-jni](https:&#x2F;&#x2F;bintray.com&#x2F;wasmer&#x2F;wasmer-jni&#x2F;wasmer-jni)&lt;&#x2F;code&gt;
project. They are also attached to our &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&#x2F;releases&quot;&gt;Github releases as
assets&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;calling-a-webassembly-function-from-java&quot;&gt;Calling a WebAssembly function from Java&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#calling-a-webassembly-function-from-java&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;As usual, let’s start with a simple Rust program that we will compile to
WebAssembly, and then execute from Java.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;After compilation to WebAssembly, we get a file like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&#x2F;raw&#x2F;master&#x2F;examples&#x2F;simple.wasm&quot;&gt;this
one&lt;&#x2F;a&gt;,
named &lt;code&gt;simple.wasm&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The following Java program executes the &lt;code&gt;sum&lt;&#x2F;code&gt; exported function by
passing &lt;code&gt;5&lt;&#x2F;code&gt; and &lt;code&gt;37&lt;&#x2F;code&gt; as arguments:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;java&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; org&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;wasmer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;io&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;IOException&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;nio&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Files&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;nio&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Paths&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; SimpleExample&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public static&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt; void&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; args&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; throws&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; IOException&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Read the WebAssembly bytes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt;        byte&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; bytes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; Files&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;readAllBytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Paths&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;simple.wasm&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Instantiate the WebAssembly module.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Instance&lt;&#x2F;span&gt;&lt;span&gt;(bytes)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Get the `sum` exported function, call it by passing 5 and 37, and get the result.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Integer&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; (Integer)&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getFunction&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;sum&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;apply&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;5&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 37&lt;&#x2F;span&gt;&lt;span&gt;)[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        assert&lt;&#x2F;span&gt;&lt;span&gt; result &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;==&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 42&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;close&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Great! We have successfully executed a Rust program, compiled to
WebAssembly, in Java. As you can see, it is pretty straightforward. The
API is very similar to the standard JavaScript API, or the other API we
have designed for PHP, Python, Go, Ruby etc.&lt;&#x2F;p&gt;
&lt;p&gt;The assiduous reader might have noticed the &lt;code&gt;[0]&lt;&#x2F;code&gt; in &lt;code&gt;.apply(5, 37)[0]&lt;&#x2F;code&gt;
pattern. A WebAssembly function can return zero to many values, and in
this case, we are reading the first one.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Note: Java values passed to WebAssembly exported functions are
automatically downcasted to WebAssembly values. Types are inferred at
runtime, and casting is done automatically. Thus, a WebAssembly
function acts as any regular Java function.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Technically, an exported function is a &lt;em&gt;functional interface&lt;&#x2F;em&gt; as defined
by the Java Language Specification (i.e. it is a
&lt;code&gt;[FunctionalInterface](https:&#x2F;&#x2F;docs.oracle.com&#x2F;javase&#x2F;8&#x2F;docs&#x2F;api&#x2F;java&#x2F;lang&#x2F;FunctionalInterface.html)&lt;&#x2F;code&gt;).
Thus, it is possible to write the following code where &lt;code&gt;sum&lt;&#x2F;code&gt; is an
actual function (of kind &lt;code&gt;org.wasmer.exports.Function&lt;&#x2F;code&gt;):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;java&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; org&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;wasmer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; org&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;wasmer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Function&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;io&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;IOException&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;nio&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Files&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;nio&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Paths&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; SimpleExample&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public static&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt; void&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; args&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; throws&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; IOException&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Read the WebAssembly bytes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt;        byte&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; bytes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; Files&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;readAllBytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Paths&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;simple.wasm&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Instantiate the WebAssembly module.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Instance&lt;&#x2F;span&gt;&lt;span&gt;(bytes)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Declare the `sum` function, as a regular Java function.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Function&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getFunction&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;sum&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Call `sum`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Integer&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; (Integer)&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;apply&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span&gt;)[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        assert&lt;&#x2F;span&gt;&lt;span&gt; result &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;==&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 3&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;close&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;But a WebAssembly module not only exports functions, it also exports
memory.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;reading-the-memory&quot;&gt;Reading the memory&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#reading-the-memory&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A WebAssembly instance has one or more linear memories, a contiguous and
byte-addressable range of memory spanning from offset 0 and extending up
to a varying memory size, represented by the &lt;code&gt;org.wasmer.Memory&lt;&#x2F;code&gt; class.
Let’s see how to use it. Consider the following Rust program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; return_hello&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    b&amp;quot;Hello, World!&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\0&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_ptr&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;return_hello&lt;&#x2F;code&gt; function returns a pointer to the statically
allocated string. The string exists in the linear memory of the
WebAssembly module. It is then possible to read it in Java:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;java&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; org&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;wasmer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; org&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;wasmer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;io&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;IOException&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;nio&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;ByteBuffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;nio&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Files&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; java&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;nio&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;Paths&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; MemoryExample&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public static&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt; void&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; args&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; throws&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; IOException&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Read the WebAssembly bytes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt;        byte&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; bytes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; Files&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;readAllBytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Paths&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;memory.wasm&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Instantiate the WebAssembly module.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Instance&lt;&#x2F;span&gt;&lt;span&gt;(bytes)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Get a pointer to the statically allocated string returned by `return_hello`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Integer&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; (Integer)&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getFunction&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;return_hello&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;apply&lt;&#x2F;span&gt;&lt;span&gt;()[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Get the exported memory named `memory`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        Memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getMemory&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;memory&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Get a direct byte buffer view of the WebAssembly memory.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        ByteBuffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; memoryBuffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Prepare the byte array that will hold the data.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt;        byte&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; data&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-primitive&quot;&gt; byte&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;13&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Let&amp;#39;s position the cursor, and…&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        memoryBuffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;position&lt;&#x2F;span&gt;&lt;span&gt;(pointer)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; … read!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        memoryBuffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(data)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Let&amp;#39;s encode back to a Java string.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;        String&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; String&lt;&#x2F;span&gt;&lt;span&gt;(data)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Hello!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        assert&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;equals&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Hello, World!&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;close&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;As we can see, the &lt;code&gt;Memory&lt;&#x2F;code&gt; API provides a &lt;code&gt;buffer&lt;&#x2F;code&gt; method. It returns a
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.oracle.com&#x2F;javase&#x2F;8&#x2F;docs&#x2F;api&#x2F;java&#x2F;nio&#x2F;ByteBuffer.html&quot;&gt;&lt;em&gt;direct&lt;&#x2F;em&gt; byte
buffer&lt;&#x2F;a&gt;
(of kind &lt;code&gt;java.nio.ByteBuffer&lt;&#x2F;code&gt;) view of the memory. It’s a standard API
for any Java developer. We think it’s best to not reinvent the wheel and
use standard API as much as possible.&lt;&#x2F;p&gt;
&lt;p&gt;The WebAssembly memory is dissociated from the JVM memory, and thus from
the garbage collector.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;You can read &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&#x2F;blob&#x2F;master&#x2F;examples&#x2F;GreetExample.java&quot;&gt;the Greet
Example&lt;&#x2F;a&gt;
to see a more in-depth usage of the &lt;code&gt;Memory&lt;&#x2F;code&gt; API.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;more-documentation&quot;&gt;More documentation&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#more-documentation&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The project comes with a &lt;code&gt;Makefile&lt;&#x2F;code&gt;. The &lt;code&gt;make javadoc&lt;&#x2F;code&gt; command will
generate a traditional local Javadoc for you, in the
&lt;code&gt;build&#x2F;docs&#x2F;javadoc&#x2F;index.html&lt;&#x2F;code&gt; file.&lt;&#x2F;p&gt;
&lt;p&gt;In addition, the project’s &lt;code&gt;README.md&lt;&#x2F;code&gt; file has an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm#api-of-the-wasmer-library&quot;&gt;API of
the &lt;code&gt;wasmer&lt;&#x2F;code&gt; library
Section&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, the project comes with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&#x2F;tree&#x2F;master&#x2F;examples&quot;&gt;a set of
examples&lt;&#x2F;a&gt;.
Use the &lt;code&gt;make run-example EXAMPLE=Simple&lt;&#x2F;code&gt; to run the
&lt;code&gt;SimpleExample.java&lt;&#x2F;code&gt; example for instance.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;performance&quot;&gt;Performance&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#performance&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;WebAssembly aims at being safe, but also fast. Since Wasmer JNI is the
&lt;em&gt;first&lt;&#x2F;em&gt; Java library to execute WebAssembly, we can’t compare to prior
works in the Java ecosystem. However, you might know that Wasmer comes
with 3 backends: Singlepass, Cranelift and LLVM. We’ve even written an
article about it: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;a-webassembly-compiler-tale-9ef37aa3b537&quot;&gt;A WebAssembly Compiler
tale&lt;&#x2F;a&gt;.
The Wasmer JNI library uses the Cranelift backend for the moment, which
offers the best compromise between compilation-time and execution-time.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;credits&quot;&gt;Credits&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#credits&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Asami (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;d0iasm&quot;&gt;d0iasm&lt;&#x2F;a&gt; on Twitter) has improved
this project during its internship at Wasmer under my guidance. She
finished the internship before the release of the Wasmer JNI project,
but she deserves credits for pushing the project forward! Good work
Asami!&lt;&#x2F;p&gt;
&lt;p&gt;This is an opportunity to remind everyone that we hire anywhere in the
world. Asami was working from Japan while I am working from Switzerland,
and the rest of the team is from US, Spain, China etc. Feel free to
contact me (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;@mnt_io&lt;&#x2F;a&gt; or
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;syrusakbary&quot;&gt;@syrusakbary&lt;&#x2F;a&gt; on Twitter) if you want
to join us on this big adventure!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#conclusion&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Wasmer JNI is a library to execute WebAssembly directly in Java. It
embeds the WebAssembly runtime
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;Wasmer&lt;&#x2F;a&gt;. The first releases provide
the core API with &lt;code&gt;Module&lt;&#x2F;code&gt;, &lt;code&gt;Instance&lt;&#x2F;code&gt;, and &lt;code&gt;Memory&lt;&#x2F;code&gt;. It comes
pre-packaged as a JAR, one per architecture and per platform.&lt;&#x2F;p&gt;
&lt;p&gt;The source code is open and hosted on Github at
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;java-ext-wasm&quot;&gt;wasmerio&#x2F;java-ext-wasm&lt;&#x2F;a&gt;.
We are constantly improving the project, so if you have feedback,
issues, or feature requests please open an issue in the repository, or
reach us on Twitter at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;wasmerio&quot;&gt;@wasmerio&lt;&#x2F;a&gt; or
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;@mnt_io&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;We look forward to see what you build with this!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Announcing the first Postgres extension to run WebAssembly</title>
          <pubDate>Thu, 29 Aug 2019 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/announcing-the-first-postgres-extension-to-run-webassembly/</link>
          <guid>https://mnt.io/articles/announcing-the-first-postgres-extension-to-run-webassembly/</guid>
          <description xml:base="https://mnt.io/articles/announcing-the-first-postgres-extension-to-run-webassembly/">&lt;p&gt;&lt;em&gt;This is a copy of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;announcing-the-first-postgres-extension-to-run-webassembly-561af2cfcb1&quot;&gt;an article I wrote for
Wasmer&lt;&#x2F;a&gt;.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;WebAssembly is a portable binary format. That means the same program can
run anywhere.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;To uphold this bold statement, each language, platform and system must
be able to run WebAssembly — as fast and safely as possible.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Let’s say it again. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;Wasmer&lt;&#x2F;a&gt; is a
WebAssembly runtime. We have successfully embedded the runtime in other
languages:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;In Rust, as it is written in Rust&lt;&#x2F;li&gt;
&lt;li&gt;Using &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;master&#x2F;lib&#x2F;runtime-c-api&quot;&gt;C and C++
bindings&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;In PHP, using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;php-ext-wasm&quot;&gt;&lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;In Python, using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;python-ext-wasm&quot;&gt;&lt;code&gt;python-ext-wasm&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; —
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;pypi.org&#x2F;project&#x2F;wasmer&#x2F;&quot;&gt;wasmer package on PyPI&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;In Ruby, using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;ruby-ext-wasm&quot;&gt;&lt;code&gt;ruby-ext-wasm&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; — &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;rubygems.org&#x2F;gems&#x2F;wasmer&quot;&gt;wasmer
gem on RubyGems&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;In Go, using &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&quot;&gt;&lt;code&gt;go-ext-wasm&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;
— see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;announcing-the-fastest-webassembly-runtime-for-go-wasmer-19832d77c050&quot;&gt;the
announcement&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The community has also embedded Wasmer in awesome projects:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;.NET&#x2F;C#, using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;migueldeicaza&#x2F;WasmerSharp&quot;&gt;WasmerSharp&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;R, using &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;dirkschumacher&#x2F;wasmr&quot;&gt;Wasmr&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;&lt;strong&gt;It is now time to continue the story and to hang around…
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.postgresql.org&#x2F;&quot;&gt;Postgres&lt;&#x2F;a&gt;!&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;p&gt;We are so happy to announce a newcrazy idea: &lt;strong&gt;WebAssembly on
Postgres&lt;&#x2F;strong&gt;. Yes, you read that correctly. On
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;postgres-ext-wasm&quot;&gt;Postgres&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;calling-a-webassembly-function-from-postgres&quot;&gt;Calling a WebAssembly function from Postgres&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#calling-a-webassembly-function-from-postgres&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;As usual, we have to go through the installation process. There is no
package manager for Postgres, so it’s a manual step. The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;postgres-ext-wasm#installation&quot;&gt;Installation
Section of the
documentation&lt;&#x2F;a&gt;
explains the details; here is a summary:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Build the shared library.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; just build&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Install the extension in the Postgres tree.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; just install&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Activate the extension.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;CREATE EXTENSION wasm;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span&gt; \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      psql -h $host -d $database&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Initialize the extension.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;SELECT wasm_init(&amp;#39;$(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt;pwd&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;)&#x2F;target&#x2F;release&#x2F;libpg_ext_wasm.dylib&amp;#39;);&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span&gt; \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      psql -h $host -d $database&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once the extension is installed, activated and initialized, we can start
having fun!&lt;&#x2F;p&gt;
&lt;p&gt;The current API is rather small, however basic features are available.
The goal is to gather a community and to design a pragmatic API
together, discover the expectations, how developers would use this new
technology inside a database engine.&lt;&#x2F;p&gt;
&lt;p&gt;Let’s see how it works. To instantiate a WebAssembly module, we use the
&lt;code&gt;wasm_new_instance&lt;&#x2F;code&gt; function. It takes 2 arguments: The absolute path to
the WebAssembly module, and a prefix for the module exported functions.
Indeed, if a module exports a function named &lt;code&gt;sum&lt;&#x2F;code&gt;, then a Postgres
function named &lt;code&gt;prefix_sum&lt;&#x2F;code&gt; calling the &lt;code&gt;sum&lt;&#x2F;code&gt; function will be created
dynamically.&lt;&#x2F;p&gt;
&lt;p&gt;Let’s see it in action. Let’s start by editing a Rust program that
compiles to WebAssembly:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once this file compiled to &lt;code&gt;simple.wasm&lt;&#x2F;code&gt;, we can instantiate the module,
and call the exported &lt;code&gt;sum&lt;&#x2F;code&gt; function:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- New instance of the `simple.wasm` WebAssembly module.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;span&gt; wasm_new_instance(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;&#x2F;absolute&#x2F;path&#x2F;to&#x2F;simple.wasm&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;ns&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- Call a WebAssembly exported function!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;span&gt; ns_sum(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- ns_sum&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- --------&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- 3&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- (1 row)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;em&gt;Et voilà !&lt;&#x2F;em&gt; The &lt;code&gt;ns_sum&lt;&#x2F;code&gt; function calls the Rust &lt;code&gt;sum&lt;&#x2F;code&gt; function through
WebAssembly! How fun is that 😄?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;inspect-a-webassembly-instance&quot;&gt;Inspect a WebAssembly instance&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#inspect-a-webassembly-instance&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;This section shows how to inspect a WebAssembly instance. At the same
time, it quickly explains how the extension works under the hood.&lt;&#x2F;p&gt;
&lt;p&gt;The extension provides two foreign data wrappers, gathered together in
the &lt;code&gt;wasm&lt;&#x2F;code&gt; foreign schema:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;wasm.instances&lt;&#x2F;code&gt; is a table with the &lt;code&gt;id&lt;&#x2F;code&gt; and &lt;code&gt;wasm_file&lt;&#x2F;code&gt; columns,
respectively for the unique instance ID, and the path of the WebAssembly
module,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;wasm.exported_functions&lt;&#x2F;code&gt; is a table with the &lt;code&gt;instance_id&lt;&#x2F;code&gt;, &lt;code&gt;name&lt;&#x2F;code&gt;,
&lt;code&gt;inputs&lt;&#x2F;code&gt;, and &lt;code&gt;outputs&lt;&#x2F;code&gt; columns, respectively for the instance ID of the
exported function, its name, its input types (already formatted for Postgres),
and its output types (already formatted for Postgres).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let’s see:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- Select all WebAssembly instances.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; FROM&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;instances&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- id                                   |          wasm_file&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- -------------------------------------+-------------------------------&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- 426e17af-c32f-5027-ad73-239e5450dd91 | &#x2F;absolute&#x2F;path&#x2F;to&#x2F;simple.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- (1 row)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- Select all exported functions for a specific instance.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    name&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    inputs,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    outputs&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;FROM&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;exported_functions&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;WHERE&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    instance_id &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;426e17af-c32f-5027-ad73-239e5450dd91&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- name   |     inputs      | outputs&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- -------+-----------------+---------&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- ns_sum | integer,integer | integer&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- (1 row)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Based on these information, the &lt;code&gt;wasm&lt;&#x2F;code&gt; Postgres extension is able to
generate the SQL function to call the WebAssembly exported functions.&lt;&#x2F;p&gt;
&lt;p&gt;It sounds simplistic, and… to be honest, it is! The trick is to use
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;fdwhandler.html&quot;&gt;foreign data
wrappers&lt;&#x2F;a&gt;,
which is an awesome feature of Postgres.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;how-fast-is-it-or-is-it-an-interesting-alternative-to-pl-pgsql&quot;&gt;How fast is it, or: Is it an interesting alternative to PL&#x2F;pgSQL?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#how-fast-is-it-or-is-it-an-interesting-alternative-to-pl-pgsql&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;As we said, the extension API is rather small for now. The idea is to
explore, to experiment, to have fun with WebAssembly inside a database.
It is particularly interesting in two cases:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;To write extensions or procedures with any languages that compile to
WebAssembly in place of
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;10&#x2F;plpgsql.html&quot;&gt;PL&#x2F;pgSQL&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;To remove a potential performance bottleneck where speed is
involved.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Thus we run a basic benchmark. Like most of the benchmarks out there, it
must be taken with a grain of salt.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;The goal is to compare the execution time between WebAssembly and
PL&#x2F;pgSQL, and see how both approaches scale.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;The Postgres WebAssembly extension uses
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.postgresql.org&#x2F;docs&#x2F;current&#x2F;fdwhandler.html&quot;&gt;Wasmer&lt;&#x2F;a&gt; as the
runtime, compiled with the Cranelift backend (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;a-webassembly-compiler-tale-9ef37aa3b537&quot;&gt;learn more about the
different
backends&lt;&#x2F;a&gt;).
We run the benchmark with Postgres 10, on a MacBook Pro 15&quot; from 2016,
2.9Ghz Core i7 with 16Gb of memory.&lt;&#x2F;p&gt;
&lt;p&gt;The methodology is the following:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Load both the &lt;code&gt;plpgsql_fibonacci&lt;&#x2F;code&gt; and the &lt;code&gt;wasm_fibonacci&lt;&#x2F;code&gt; functions,&lt;&#x2F;li&gt;
&lt;li&gt;Run them with a query like
&lt;code&gt;SELECT *_fibonacci(n) FROM generate_series(1, 1000)&lt;&#x2F;code&gt; where &lt;code&gt;n&lt;&#x2F;code&gt; has the
following values: 50, 500, and 5000, so that we can observe how both
approaches scale,&lt;&#x2F;li&gt;
&lt;li&gt;Write the timings down,&lt;&#x2F;li&gt;
&lt;li&gt;Run this methodology multiple times, and compute the median of the
results.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Here come the results. The lower, the better.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;announcing-the-first-postgres-extension-to-run-webassembly&#x2F;.&#x2F;benchmarks.png&quot; alt=&quot;Benchmarks&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Comparing WebAssembly vs. PL&#x2F;pgSQL when computing the Fibonacci sequence
with n=50, 500 and 5000.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;We notice that the Postgres WebAssembly extension is faster to run
numeric computations. The WebAssembly approach scales pretty well
compared to the PL&#x2F;pgSQL approach, &lt;em&gt;in this situation&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;&quot;&gt;When to use the WebAssembly extension?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;So far, the extension only supports integers (on 32- and 64-bits). The
extension doesn’t support strings &lt;em&gt;yet&lt;&#x2F;em&gt;. It also doesn’t support
records, views or other Postgres types. Keep in mind this is the very
first step.&lt;&#x2F;p&gt;
&lt;p&gt;Hence, it is too soon to tell whether WebAssembly can be an alternative
to PL&#x2F;pgSQL. But regarding the benchmark results above, we are sure they
can live side-by-side, WebAssembly has clearly a place in the ecosystem!
And we want to continue to pursue this exploration.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We are already talking with people that are interested in using
WebAssembly inside databases. If you have any particular use cases,
please reach us at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wasmer.io&#x2F;&quot;&gt;wasmer.io&lt;&#x2F;a&gt;, or on Twitter at
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;wasmerio&quot;&gt;@wasmerio&lt;&#x2F;a&gt; directly or me
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;@mnt_io&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Everything is open source, as usual! Happy hacking.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Announcing the fastest WebAssembly runtime for Go: wasmer</title>
          <pubDate>Wed, 29 May 2019 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/announcing-the-fastest-webassembly-runtime-for-go-wasmer/</link>
          <guid>https://mnt.io/articles/announcing-the-fastest-webassembly-runtime-for-go-wasmer/</guid>
          <description xml:base="https://mnt.io/articles/announcing-the-fastest-webassembly-runtime-for-go-wasmer/">&lt;p&gt;&lt;em&gt;This is a copy of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;announcing-the-fastest-webassembly-runtime-for-go-wasmer-19832d77c050&quot;&gt;an article I wrote for
Wasmer&lt;&#x2F;a&gt;.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;WebAssembly is a portable binary format. That means the same file can
run anywhere.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;To uphold this bold statement, each language, platform and system must
be able to run WebAssembly — as fast and safely as possible.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;Wasmer&lt;&#x2F;a&gt; is a WebAssembly runtime
written in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.rust-lang.org&#x2F;&quot;&gt;Rust&lt;&#x2F;a&gt;. It goes without saying
that the runtime can be used in any Rust application. We have also
successfully embedded the runtime in other languages:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Using &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;master&#x2F;lib&#x2F;runtime-c-api&quot;&gt;C and C++
bindings&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;In PHP, using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;php-ext-wasm&quot;&gt;&lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;In Python, using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;python-ext-wasm&quot;&gt;&lt;code&gt;python-ext-wasm&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; —
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;pypi.org&#x2F;project&#x2F;wasmer&#x2F;&quot;&gt;wasmer package on PyPI&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;In Ruby, using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;ruby-ext-wasm&quot;&gt;&lt;code&gt;ruby-ext-wasm&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; — &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;rubygems.org&#x2F;gems&#x2F;wasmer&quot;&gt;wasmer
gem on RubyGems&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;It is now time to hang around &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;golang.org&#x2F;&quot;&gt;Go&lt;&#x2F;a&gt;
🐹!&lt;&#x2F;strong&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;We are super happy to announce &lt;code&gt;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&lt;&#x2F;code&gt;,
a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&quot;&gt;Go library to run WebAssembly binaries,
fast&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;calling-a-webassembly-function-from-go&quot;&gt;Calling a WebAssembly function from Go&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#calling-a-webassembly-function-from-go&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;First, let’s install &lt;code&gt;wasmer&lt;&#x2F;code&gt; in your go environment (&lt;em&gt;with cgo
support&lt;&#x2F;em&gt;).&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; export&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; CGO_ENABLED&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; export&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; CC&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;gcc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; go&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; install github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Let’s jump immediately into some
examples.&lt;code&gt;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&lt;&#x2F;code&gt; is a regular Go
library. The installation is automated with
&lt;code&gt;import &quot;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&quot;&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Let’s get our hands dirty. We will write a program that compiles to
WebAssembly easily, using Rust for instance:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;After compilation to WebAssembly, we get a file like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;blob&#x2F;master&#x2F;wasmer&#x2F;test&#x2F;testdata&#x2F;examples&#x2F;simple.wasm&quot;&gt;this
one&lt;&#x2F;a&gt;,
named &lt;code&gt;simple.wasm&lt;&#x2F;code&gt;.&lt;br &#x2F;&gt;
The following Go program executes the &lt;code&gt;sum&lt;&#x2F;code&gt; function by passing &lt;code&gt;5&lt;&#x2F;code&gt; and
&lt;code&gt;37&lt;&#x2F;code&gt; as arguments:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;go&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;package&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; main&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-import&quot;&gt;fmt&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    wasm&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-import&quot;&gt;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;func&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Reads the WebAssembly module as bytes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    bytes&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ReadBytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;simple.wasm&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Instantiates the WebAssembly module.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    instance&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;NewInstance&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;bytes&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    defer&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Close&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Gets the `sum` exported function from the WebAssembly instance.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    sum&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Exports&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;sum&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Calls that exported function with Go standard values. The WebAssembly&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; types are inferred and values are casted automatically.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    result&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;5&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 37&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    fmt&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Println&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;result&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;&#x2F; 42!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Great! We have successfully executed a WebAssembly file inside Go.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;em&gt;Note: Go values passed to the WebAssembly exported function are
automatically cast to WebAssembly values. Types are inferred and
casting is done automatically. Thus, a WebAssembly function acts as
any regular Go function.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;webassembly-calling-go-funtions&quot;&gt;WebAssembly calling Go funtions&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#webassembly-calling-go-funtions&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A WebAssembly module &lt;em&gt;exports&lt;&#x2F;em&gt; some functions, so that they can be
called from the outside world. This is the entry point to execute
WebAssembly.&lt;&#x2F;p&gt;
&lt;p&gt;Nonetheless, a WebAssembly module can also have &lt;em&gt;imported&lt;&#x2F;em&gt; functions.
Let’s consider the following Rust program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;extern&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; add1&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;span&gt;) }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The exported function &lt;code&gt;add1&lt;&#x2F;code&gt; calls the &lt;code&gt;sum&lt;&#x2F;code&gt; function. Its
implementation is absent, only its signature is defined. This is an
“extern function”, and for WebAssembly, this is an &lt;em&gt;imported&lt;&#x2F;em&gt; function,
because its implementation must be &lt;em&gt;imported&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Let’s implement the &lt;code&gt;sum&lt;&#x2F;code&gt; function in Go! To do so, &lt;em&gt;need&lt;&#x2F;em&gt; to use
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;blog.golang.org&#x2F;c-go-cgo&quot;&gt;cgo&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;The &lt;code&gt;sum&lt;&#x2F;code&gt; function signature is defined in C (see the comment above
&lt;code&gt;import &quot;C&quot;&lt;&#x2F;code&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;The &lt;code&gt;sum&lt;&#x2F;code&gt; implementation is defined in Go. Notice the &lt;code&gt;&#x2F;&#x2F;export&lt;&#x2F;code&gt; which is
the way cgo uses to map Go code to C code,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;NewImports&lt;&#x2F;code&gt; is an API used to create WebAssembly imports. In this code
&lt;code&gt;&quot;sum&quot;&lt;&#x2F;code&gt; is the WebAssembly imported function name, &lt;code&gt;sum&lt;&#x2F;code&gt; is the Go function
pointer, and &lt;code&gt;C.sum&lt;&#x2F;code&gt; is the cgo function pointer,&lt;&#x2F;li&gt;
&lt;li&gt;Finally, &lt;code&gt;NewInstanceWithImports&lt;&#x2F;code&gt; is the constructor to use to instantiate
the WebAssembly module with imports. That’s it.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Let’s see the complete program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;go&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;package&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; main&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; &#x2F;&#x2F; 1️⃣ Declare the `sum` function signature (see cgo).&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; #include &amp;lt;stdlib.h&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; extern int32_t sum(void *context, int32_t x, int32_t y);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-import&quot;&gt;C&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-import&quot;&gt;fmt&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    wasm&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-import&quot;&gt;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-import&quot;&gt;unsafe&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 2️⃣ Write the implementation of the `sum` function, and export it (for cgo).&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;export sum&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;func&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;context&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; unsafe&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Pointer&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; x&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; int32&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; y&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; int32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; int32&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;func&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Reads the WebAssembly module as bytes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    bytes&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ReadBytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;import.wasm&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; 3️⃣ Declares the imported functions for WebAssembly.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    imports&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;NewImports&lt;&#x2F;span&gt;&lt;span&gt;().&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Append&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;sum&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; C&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;sum&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; 4️⃣ Instantiates the WebAssembly module with imports.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    instance&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;NewInstanceWithImports&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;bytes&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; imports&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Close the WebAssembly instance later.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    defer&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Close&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Gets the `add1` exported function from the WebAssembly instance.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    add1&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Exports&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;add1&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Calls that exported function.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    result&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; add1&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    fmt&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Println&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;result&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;   add1(1, 2)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; = sum(1 + 2) + 1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; = 1 + 2 + 1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; = 4&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; QED&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;reading-the-memory&quot;&gt;Reading the memory&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#reading-the-memory&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A WebAssembly instance has a linear memory. Let’s see how to read it.
Consider the following Rust program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; return_hello&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    b&amp;quot;Hello, World!&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\0&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_ptr&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;return_hello&lt;&#x2F;code&gt; function returns a pointer to a string. The string
terminates by a null byte, &lt;em&gt;à la&lt;&#x2F;em&gt; C. Let’s jump on the Go side:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;go&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;bytes&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ReadBytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;memory.wasm&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;instance&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;NewInstance&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;bytes&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;defer&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Close&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Calls the `return_hello` exported function.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; This function returns a pointer to a string.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;result&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Exports&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;return_hello&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Gets the pointer value as an integer.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ToI32&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Reads the memory.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; :=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Memory&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Data&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;fmt&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Println&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;memory&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span&gt; :&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;+&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;13&lt;&#x2F;span&gt;&lt;span&gt;]))&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;&#x2F; Hello, World!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;return_hello&lt;&#x2F;code&gt; function returns a pointer as an &lt;code&gt;i32&lt;&#x2F;code&gt; value. We get
its value by calling &lt;code&gt;ToI32&lt;&#x2F;code&gt;. Then, we fetch the memory data with
&lt;code&gt;instance.Memory.Data()&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This function returns a slice over the WebAssembly instance memory. It
can be used as any regular Go slice.&lt;&#x2F;p&gt;
&lt;p&gt;Fortunately for us, we already know the length of the string we want to
read, so &lt;code&gt;memory[pointer : pointer+13]&lt;&#x2F;code&gt; is enough to read the bytes,
that are then cast to a string. &lt;em&gt;Et voilà !&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;You can read &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;blob&#x2F;6934a0fa06558f77884398a2371de182593e6a6c&#x2F;wasmer&#x2F;test&#x2F;example_greet_test.go&quot;&gt;the Greet
Example&lt;&#x2F;a&gt;
to see a more advanced usage of the memory API.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;h2 id=&quot;benchmarks&quot;&gt;Benchmarks&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#benchmarks&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;So far, &lt;code&gt;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&lt;&#x2F;code&gt; has a nice API, but
…&lt;em&gt;is it fast&lt;&#x2F;em&gt;?&lt;&#x2F;p&gt;
&lt;p&gt;Contrary to PHP or Ruby, there are already existing runtimes in the Go
world to execute WebAssembly. The main candidates are:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;perlin-network&#x2F;life&quot;&gt;Life&lt;&#x2F;a&gt;, from Perlin Network, a
WebAssembly interpreter&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;go-interpreter&#x2F;wagon&quot;&gt;Wagon&lt;&#x2F;a&gt;, from Go Interpreter,
a WebAssembly interpreter and toolkit.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;In &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;php-ext-wasm-migrating-from-wasmi-to-wasmer-4d1014f41c88&quot;&gt;our blog post about the PHP
extension&lt;&#x2F;a&gt;,
we have used &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;benchmarksgame-team.pages.debian.net&#x2F;benchmarksgame&#x2F;description&#x2F;nbody.html&quot;&gt;the n-body
algorithm&lt;&#x2F;a&gt;
to benchmark the performance. Life provides more benchmarks: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Fibonacci_number&quot;&gt;the
Fibonacci algorithm&lt;&#x2F;a&gt;
(the recursive version), &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Pollard%27s_rho_algorithm&quot;&gt;the Pollard’s rho
algorithm&lt;&#x2F;a&gt;, and
the Snappy Compress operation. The latter works successfully with
&lt;code&gt;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer&lt;&#x2F;code&gt; but not with Life or Wagon. We
have removed it from the benchmark suites. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;tree&#x2F;master&#x2F;benchmarks&quot;&gt;Benchmark
sources&lt;&#x2F;a&gt;
are online.&lt;&#x2F;p&gt;
&lt;p&gt;We use Life 20190521143330–57f3819c2df0, and Wagon 0.4.0, i.e. &lt;em&gt;the
latest versions to date&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The benchmark numbers represent the average result for 10 runs each. The
computer that ran these benchmarks is a MacBook Pro 15&quot; from 2016,
2.9Ghz Core i7 with 16Gb of memory.&lt;&#x2F;p&gt;
&lt;p&gt;Results are grouped by benchmark algorithm on the X axis. The Y axis
represents the time used to run the algorithm, expressed in
milliseconds. The lower, the better.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;announcing-the-fastest-webassembly-runtime-for-go-wasmer&#x2F;.&#x2F;benchmarks.png&quot; alt=&quot;Benchmarks&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Speed comparison between Wasmer, Wagon and Life. Benchmark suites are
the n-body, Fibonacci, and Pollard’s rho algorithms. Speed is expressed
in ms. Lower is better.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;While both Life and Wagon provide on average the same speed, Wasmer
(&lt;code&gt;github.com&#x2F;wasmerio&#x2F;go-ext&#x2F;wasmer&lt;&#x2F;code&gt;) is on average &lt;strong&gt;72 times faster&lt;&#x2F;strong&gt;
🎉.&lt;&#x2F;p&gt;
&lt;p&gt;It is important to know that Wasmer comes with 3 backends:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;master&#x2F;lib&#x2F;singlepass-backend&quot;&gt;Singlepass&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;master&#x2F;lib&#x2F;clif-backend&quot;&gt;Cranelift&lt;&#x2F;a&gt;,
and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&#x2F;tree&#x2F;master&#x2F;lib&#x2F;llvm-backend&quot;&gt;LLVM&lt;&#x2F;a&gt;.
The default backend that is used by the Go library is Cranelift (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;CraneStation&#x2F;cranelift&quot;&gt;learn
more about Cranelift&lt;&#x2F;a&gt;). Using
LLVM will provide performance close to native, but we decided to start
with Cranelift as it offers the best tradeoff between compilation-time
and execution-time (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;a-webassembly-compiler-tale-9ef37aa3b537&quot;&gt;learn more about the different
backends&lt;&#x2F;a&gt;,
when to use them, pros and cons etc.).&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;[github.com&#x2F;wasmerio&#x2F;go-ext-wasm&#x2F;wasmer](https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm)&lt;&#x2F;code&gt;
is a new Go library to execute WebAssembly binaries. It embeds the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;Wasmer&lt;&#x2F;a&gt; runtime. The first version
supports all the required API for the most common usages.&lt;&#x2F;p&gt;
&lt;p&gt;The current benchmarks (a mix from our benchmark suites and from Life
suites) show that &lt;strong&gt;Wasmer is — on average — 72 times faster than Life
and Wagon&lt;&#x2F;strong&gt;, the two major existing WebAssembly runtimes in the Go
world.&lt;&#x2F;p&gt;
&lt;p&gt;If you want to follow the development, take a look at
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;wasmerio&quot;&gt;@wasmerio&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;@mnt_io&lt;&#x2F;a&gt; on Twitter, or
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.social&#x2F;@wasmer&quot;&gt;@&lt;a href=&quot;mailto:wasmer@webassembly.social&quot;&gt;wasmer@webassembly.social&lt;&#x2F;a&gt;&lt;&#x2F;a&gt; on
Mastodon.&lt;&#x2F;p&gt;
&lt;p&gt;And of course, everything is open source at
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;go-ext-wasm&quot;&gt;wasmerio&#x2F;go-ext-wasm&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Thank you for your time, we can’t wait to see what you build with us!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>🐘+🦀+🕸 php-ext-wasm: Migrating from wasmi to Wasmer</title>
          <pubDate>Wed, 03 Apr 2019 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/elephant-crab-spider-web-php-ext-wasm-migrating-from-wasmi-to-wasmer/</link>
          <guid>https://mnt.io/articles/elephant-crab-spider-web-php-ext-wasm-migrating-from-wasmi-to-wasmer/</guid>
          <description xml:base="https://mnt.io/articles/elephant-crab-spider-web-php-ext-wasm-migrating-from-wasmi-to-wasmer/">&lt;p&gt;&lt;em&gt;This is a copy of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;php-ext-wasm-migrating-from-wasmi-to-wasmer-4d1014f41c88&quot;&gt;an article I wrote for
Wasmer&lt;&#x2F;a&gt;.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;First as a joke, now as a real product, I started to develop
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;php-ext-wasm&quot;&gt;php-ext-wasm&lt;&#x2F;a&gt;: a
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;php.net&#x2F;&quot;&gt;PHP&lt;&#x2F;a&gt; extension allowing to execute
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;&quot;&gt;WebAssembly&lt;&#x2F;a&gt; binaries.&lt;&#x2F;p&gt;
&lt;p&gt;The PHP virtual machine (VM) is &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-src&#x2F;&quot;&gt;Zend
Engine&lt;&#x2F;a&gt;. To write an extension, one
needs to develop in C or C++. The extension was simple C bindings to a
Rust library I also wrote. At that time, this Rust library was using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;paritytech&#x2F;wasmi&quot;&gt;&lt;code&gt;wasmi&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; for the WebAssembly VM. I
knew that &lt;code&gt;wasmi&lt;&#x2F;code&gt; wasn’t the fastest WebAssembly VM in the game, but the
API is solid, well-tested, it compiles quickly, and is easy to hack. All
the requirements to start a project!&lt;&#x2F;p&gt;
&lt;p&gt;After 6 hours of development, I got something working. I was able to run
the following PHP program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; Wasm&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Instance&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;simple.wasm&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$result&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;&#x2F; int(3)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The API is straightforward: create an instance (here of &lt;code&gt;simple.wasm&lt;&#x2F;code&gt;),
then call functions on it (here &lt;code&gt;sum&lt;&#x2F;code&gt; with 1 and 2 as arguments). PHP
values are transformed into WebAssembly values automatically. For the
record, here is the &lt;code&gt;simple.rs&lt;&#x2F;code&gt; Rust program that is compiled to a
WebAssembly binary:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; sum&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; i32&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; y&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It was great! 6 hours is a relatively small number of hours to go that
far according to me.&lt;&#x2F;p&gt;
&lt;p&gt;However, I quickly noticed that &lt;code&gt;wasmi&lt;&#x2F;code&gt; is… slow. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;&quot;&gt;One of the promise of
WebAssembly&lt;&#x2F;a&gt; is:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;WebAssembly aims to execute at native speed by taking advantage of
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;docs&#x2F;portability&#x2F;#assumptions-for-efficient-execution&quot;&gt;common hardware
capabilities&lt;&#x2F;a&gt;
available on a wide range of platforms.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;And clearly, my extension wasn’t fulfilling this promise. Let’s see a
basic comparison with a benchmark.&lt;&#x2F;p&gt;
&lt;p&gt;I chose &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;benchmarksgame-team.pages.debian.net&#x2F;benchmarksgame&#x2F;description&#x2F;nbody.html&quot;&gt;the &lt;em&gt;n-body&lt;&#x2F;em&gt;
algorithm&lt;&#x2F;a&gt;
from &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;benchmarksgame-team.pages.debian.net&#x2F;benchmarksgame&#x2F;&quot;&gt;the Computer Language Benchmarks
Game&lt;&#x2F;a&gt; from
Debian, mostly because it’s relatively CPU intensive. Also, the
algorithm has a simple interface: based on an integer, it returns a
floating-point number; this API doesn’t involve any advanced instance
memory API, which is perfect to test a proof-of-concept.&lt;&#x2F;p&gt;
&lt;p&gt;As a baseline, I’ve run the &lt;em&gt;n-body&lt;&#x2F;em&gt; algorithm &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;benchmarksgame-team.pages.debian.net&#x2F;benchmarksgame&#x2F;program&#x2F;nbody-rust-7.html&quot;&gt;written in
Rust&lt;&#x2F;a&gt;,
let’s call it &lt;code&gt;rust-baseline&lt;&#x2F;code&gt;. The same algorithm has been &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;benchmarksgame-team.pages.debian.net&#x2F;benchmarksgame&#x2F;program&#x2F;nbody-php-3.html&quot;&gt;written in
PHP&lt;&#x2F;a&gt;,
let’s call it &lt;code&gt;php&lt;&#x2F;code&gt;. Finally, the algorithm has been compiled from Rust
to WebAssembly, and executed with the &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt; extension, let’s
call that case &lt;code&gt;php+wasmi&lt;&#x2F;code&gt;. All results are for &lt;code&gt;nbody(5000000)&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;rust-baseline&lt;&#x2F;code&gt;: 287ms,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;php&lt;&#x2F;code&gt;: 19,761ms,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;php+wasmi&lt;&#x2F;code&gt;: 67,622ms.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;OK, so… &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt; with &lt;code&gt;wasmi&lt;&#x2F;code&gt; is &lt;strong&gt;3.4 times slower&lt;&#x2F;strong&gt; than PHP
itself, it is pointless to use WebAssembly in such conditions!&lt;&#x2F;p&gt;
&lt;p&gt;It confirms my first intuition though: In our case, &lt;code&gt;wasmi&lt;&#x2F;code&gt; is really
great to mock something up, but it’s not fast enough for our
expectations.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;faster-faster-faster&quot;&gt;Faster, faster, faster…&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#faster-faster-faster&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;I wanted to use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;CraneStation&#x2F;cranelift&quot;&gt;Cranelift&lt;&#x2F;a&gt;
since the beginning. It’s a code generator, &lt;em&gt;à la&lt;&#x2F;em&gt;
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;llvm.org&#x2F;&quot;&gt;LLVM&lt;&#x2F;a&gt; (excuse the brutal shortcut, the goal isn’t to
explain what Cranelift is in details, but that’s a really awesome
project!). To quote the project itself:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Cranelift is a low-level retargetable code generator. It translates a
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;cranelift.readthedocs.io&#x2F;en&#x2F;latest&#x2F;ir.html&quot;&gt;target-independent intermediate
representation&lt;&#x2F;a&gt;
into executable machine code.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;It basically means that the Cranelift API can be used to generate
executable code.&lt;&#x2F;p&gt;
&lt;p&gt;It’s perfect! I can replace &lt;code&gt;wasmi&lt;&#x2F;code&gt; by Cranelift, and boom, profit. But…
there is other ways to get even faster code execution — at the cost of a
longer code compilation though.&lt;&#x2F;p&gt;
&lt;p&gt;For instance, LLVM can provide a very fast code execution, almost at
native speed. Or we can generate assembly code dynamically. Well, there
is multiple ways to achieve that. What if a project could provide a
WebAssembly virtual machine with multiple backends?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;enter-wasmer&quot;&gt;Enter Wasmer&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#enter-wasmer&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;And it was at that specific time that I’ve been hired by
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;Wasmer&lt;&#x2F;a&gt;. To be totally honest, I
was looking at Wasmer a few weeks before. It was a surprise and a great
opportunity for me. Well, the universe really wants this rewrite from
&lt;code&gt;wasmi&lt;&#x2F;code&gt; to Wasmer, right 😅?&lt;&#x2F;p&gt;
&lt;p&gt;Wasmer is organized as a set of Rust libraries (called crates). There is
even a &lt;code&gt;wasmer-runtime-c-api&lt;&#x2F;code&gt; crate which is a C and a C++ API on top of
the &lt;code&gt;wasmer-runtime&lt;&#x2F;code&gt; crate and the &lt;code&gt;wasmer-runtime-core&lt;&#x2F;code&gt; crate, i.e. it
allows running the WebAssembly virtual machine as you want, with the
backend of your choice: &lt;em&gt;Cranelift&lt;&#x2F;em&gt;, &lt;em&gt;LLVM&lt;&#x2F;em&gt;, or &lt;em&gt;Dynasm&lt;&#x2F;em&gt; (at the time of
writing). That’s perfect, it removes my Rust library between the PHP
extension and &lt;code&gt;wasmi&lt;&#x2F;code&gt;. Then &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt; is reduced to a PHP extension
without any Rust code, everything goes to &lt;code&gt;wasmer-runtime-c-api&lt;&#x2F;code&gt;. That’s
sad to remove Rust from this project, but it relies on more Rust code!&lt;&#x2F;p&gt;
&lt;p&gt;Counting the time to make some patches on &lt;code&gt;wasmer-runtime-c-api&lt;&#x2F;code&gt;, I’ve
been able to migrate &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt; to Wasmer in 5 days.&lt;&#x2F;p&gt;
&lt;p&gt;By default, &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt; uses Wasmer with the Cranelift backend, it
does a great balance between compilation and execution time. It is
really good. Let’s run the benchmark, with the addition of
&lt;code&gt;php+wasmer(cranelift)&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;rust-baseline&lt;&#x2F;code&gt;: 287ms,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;php&lt;&#x2F;code&gt;: 19,761ms,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;php+wasmi&lt;&#x2F;code&gt;: 67,622ms,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;php+wasmer(cranelift)&lt;&#x2F;code&gt;: 2,365ms 🎉.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Finally, the PHP extension provides a faster execution than PHP itself!
&lt;code&gt;php+wasmer(cranelift)&lt;&#x2F;code&gt; is &lt;strong&gt;8.6 times faster&lt;&#x2F;strong&gt; than &lt;code&gt;php&lt;&#x2F;code&gt; to be exact.
And it is &lt;strong&gt;28.6 times faster&lt;&#x2F;strong&gt; than &lt;code&gt;php+wasmi&lt;&#x2F;code&gt;. Can we reach the
native speed (represented by &lt;code&gt;rust-baseline&lt;&#x2F;code&gt; here)? It’s very likely
with LLVM. That’s for another article. I’m super happy with Cranelift
for the moment. (See &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;medium.com&#x2F;wasmer&#x2F;benchmarking-webassembly-runtimes-18497ce0d76e&quot;&gt;our previous blog post to learn how we benchmark
different backends in Wasmer, and other WebAssembly
runtimes&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;h2 id=&quot;more-optimizations&quot;&gt;More Optimizations&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#more-optimizations&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Wasmer provides more features, like module caching. Those features are
now included in the PHP extension. When booting the &lt;code&gt;nbody.wasm&lt;&#x2F;code&gt; file
(19kb), it took 4.2ms. By booting, I mean: reading the WebAssembly
binary from a file, parsing it, validating it, compiling it to
executable code and a WebAssembly module structure.&lt;&#x2F;p&gt;
&lt;p&gt;PHP execution model is: starts, runs, dies. Memory is freed for each
request. If one wants to use &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt;, you don’t really want to
pay that “&lt;em&gt;booting cost&lt;&#x2F;em&gt;” every time.&lt;&#x2F;p&gt;
&lt;p&gt;Hopefully, &lt;code&gt;wasmer-runtime-c-api&lt;&#x2F;code&gt; now provides a module serialization
API, which is integrated into the PHP extension itself. It saves the
“booting cost”, but it adds a “deserialization cost”. That second cost
is smaller, but still, we need to know it exists.&lt;&#x2F;p&gt;
&lt;p&gt;Hopefully again, Zend Engine has an API to get persistent in-memory data
between PHP executions. &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt; supports that API to get
persistent modules, &lt;em&gt;et voilà&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Now it takes &lt;strong&gt;4.2ms&lt;&#x2F;strong&gt; for the first boot of &lt;code&gt;nbody.wasm&lt;&#x2F;code&gt; and
&lt;strong&gt;0.005ms&lt;&#x2F;strong&gt; for all the next boots. It’s 840 times faster!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#conclusion&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Wasmer is a young — but mature — framework to build WebAssembly runtimes
on top of. The default backend is Cranelift, and it shows its promises:
It brings a correct balance between compilation time and execution time.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;wasmi&lt;&#x2F;code&gt; has been a good companion to develop a &lt;em&gt;Proof-Of-Concept&lt;&#x2F;em&gt;. This
library has its place in other usages though, like very short-living
WebAssembly binaries (I’m thinking of Ethereum contracts that compile to
WebAssembly for instance, which is one of the actual use cases). It’s
important to understand that no runtime is better than another, it
depends on the use case.&lt;&#x2F;p&gt;
&lt;p&gt;The next step is to stabilize &lt;code&gt;php-ext-wasm&lt;&#x2F;code&gt; to release a 1.0.0 version.&lt;&#x2F;p&gt;
&lt;p&gt;See you there!&lt;&#x2F;p&gt;
&lt;p&gt;If you want to follow the development, take a look at
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;wasmerio&quot;&gt;@wasmerio&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;@mnt_io&lt;&#x2F;a&gt; on Twitter.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Bye bye Automattic, hello Wasmer</title>
          <pubDate>Mon, 04 Mar 2019 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/bye-bye-automattic-hello-wasmer/</link>
          <guid>https://mnt.io/articles/bye-bye-automattic-hello-wasmer/</guid>
          <description xml:base="https://mnt.io/articles/bye-bye-automattic-hello-wasmer/">&lt;p&gt;Today is my first day at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wasmer.io&#x2F;&quot;&gt;Wasmer&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;It&#x27;s with a lot of regrets that I leave Automattic. To be clear, I&#x27;m not
leaving because something negative happened, I&#x27;m leaving because I&#x27;ve
received the same job offer, 3 times in 10 days, from Wasmer, Google and
Mozilla. Namely to work with Rust or C++ to build a WebAssembly runtime.
This is an offer I can barely decline. It&#x27;s an opportunity and a dream
for me. And I was lucky enough to get a choice between 3 excellent
companies!&lt;&#x2F;p&gt;
&lt;p&gt;I can only encourage you to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;automattic.com&#x2F;work-with-us&#x2F;&quot;&gt;work with
Automattic&lt;&#x2F;a&gt;. It&#x27;s definitely the
best company I&#x27;ve ever work with; stealing the 1st place to Mozilla.
Automattic is not only about WordPress.com and other services: It&#x27;s a
way of living. The culture, the spirit, the interactions between people,
the mission, everything is &lt;em&gt;exceptional&lt;&#x2F;em&gt;. It has been a super great
experience.&lt;&#x2F;p&gt;
&lt;p&gt;I could write 100 pages about my team. They have all been &lt;em&gt;remarkable&lt;&#x2F;em&gt;
in many ways. I&#x27;m closer to them although they live at 10&#x27;000km, rather
than colleagues I met everyday in person in the past. Congrats to
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;ma.tt&#x2F;about&#x2F;&quot;&gt;Matt&lt;&#x2F;a&gt; for this incredible project.&lt;&#x2F;p&gt;
&lt;p&gt;Now it&#x27;s time to work on &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;wasmerio&#x2F;wasmer&quot;&gt;Wasmer&lt;&#x2F;a&gt;.
It&#x27;s a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;&quot;&gt;WebAssembly&lt;&#x2F;a&gt; runtime written in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.rust-lang.org&#x2F;&quot;&gt;Rust&lt;&#x2F;a&gt;: My two current passions. It&#x27;s
powerful, modular, well-designed, and it comes with great ambitions. I&#x27;m
really exciting. I work with an extraordinary team: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;syrusakbary&quot;&gt;Syrus
Akbary&lt;&#x2F;a&gt; (the author of
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;graphql-python&#x2F;graphene&quot;&gt;Graphene&lt;&#x2F;a&gt;, a GraphQL
framework in Python), &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;lachlansneff&quot;&gt;Lachlan Sneff&lt;&#x2F;a&gt;
(the author of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nebulet&#x2F;nebulet&quot;&gt;Nebulet&lt;&#x2F;a&gt;, a
microkernel that implements a WebAssembly &quot;usermode&quot; that runs in Ring
0), &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;bjfish&quot;&gt;Brandon Fish&lt;&#x2F;a&gt; (a great contributor of
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;oracle&#x2F;truffleruby&quot;&gt;Truffleruby&lt;&#x2F;a&gt;, a high performance
implementation of Ruby with GraalVM), &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;xmclark&quot;&gt;Mackenzie
Clark&lt;&#x2F;a&gt;, and soon more.&lt;&#x2F;p&gt;
&lt;p&gt;My job will consist to work on the runtime of course, and also to
integrate&#x2F;embed the runtime into different languages, such as PHP —like
I did with &lt;code&gt;[php-ext-wasm](https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;php-ext-wasm)&lt;&#x2F;code&gt;, more
to come on this blog—. More secret projects coming. Let&#x27;s turn them into
realities 🎉!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>The PHP galaxy</title>
          <pubDate>Mon, 29 Oct 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/series/from-rust-to-beyond/the-php-galaxy/</link>
          <guid>https://mnt.io/series/from-rust-to-beyond/the-php-galaxy/</guid>
          <description xml:base="https://mnt.io/series/from-rust-to-beyond/the-php-galaxy/">&lt;p&gt;The galaxy we will explore today is the PHP galaxy. This post will
explain what PHP is, how to compile any Rust program to C and then to a
PHP native extension.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-php-and-why&quot;&gt;What is PHP, and why?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-is-php-and-why&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;secure.php.net&#x2F;&quot;&gt;PHP&lt;&#x2F;a&gt; is a:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;popular general-purpose scripting language that is especially suited
to Web development. Fast, flexible, and pragmatic, PHP powers
everything from your blog to the most popular websites in the world.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;PHP has sadly acquired a bad reputation along the years, but recent
releases (since PHP 7.0 mostly) have introduced neat language features,
and many cleanups, which are excessively ignored by haters. PHP is also
a fast scripting language, and is very flexible. PHP now has declared
types, traits, variadic arguments, closures (with explicit scopes!),
generators, and a &lt;em&gt;huge&lt;&#x2F;em&gt; backward compatibility. The development of PHP
is led by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wiki.php.net&#x2F;rfc&quot;&gt;RFCs&lt;&#x2F;a&gt;, which is an open and
democratic process.&lt;&#x2F;p&gt;
&lt;p&gt;The Gutenberg project is a new editor for WordPress. The latter is
written in PHP. This is naturally that we want a native extension for
PHP to parse the Gutenberg post format.&lt;&#x2F;p&gt;
&lt;p&gt;PHP is a language with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-langspec&quot;&gt;a
specification&lt;&#x2F;a&gt;. The most popular
virtual machine is &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;php.net&#x2F;manual&#x2F;en&#x2F;internals2.php&quot;&gt;Zend
Engine&lt;&#x2F;a&gt;. Other virtual machines
exist, like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hhvm.com&#x2F;&quot;&gt;HHVM&lt;&#x2F;a&gt; (but the PHP support has been
dropped recently in favor of their own PHP fork, called Hack),
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.peachpie.io&#x2F;&quot;&gt;Peachpie&lt;&#x2F;a&gt;, or &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;tagua-vm&#x2F;tagua-vm&quot;&gt;Tagua
VM&lt;&#x2F;a&gt; (under development).&lt;&#x2F;p&gt;
&lt;p&gt;In this post, we will create an extension for Zend Engine. This virtual
machine is written in C. Great, we have visited &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-c-galaxy&#x2F;&quot;&gt;the C galaxy in the
previous
episode&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;rust-rocket-c-rocket-php&quot;&gt;Rust 🚀 C 🚀 PHP&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#rust-rocket-c-rocket-php&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-php-galaxy&#x2F;.&#x2F;rust-to-php.png&quot; alt=&quot;Rust to PHP&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;To port our Rust parser into PHP, we first need to port it to C. It&amp;#39;s
been done in the previous episode. Two files result from this port to
C: &lt;code&gt;libgutenberg_post_parser.a&lt;&#x2F;code&gt; and &lt;code&gt;gutenberg_post_parser.h&lt;&#x2F;code&gt;,
respectively a static library, and the header file.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;&quot;&gt;Bootstrap with a skeleton&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;PHP comes with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;php.net&#x2F;manual&#x2F;en&#x2F;internals2.buildsys.skeleton.php&quot;&gt;a script to create an extension
skeleton&lt;&#x2F;a&gt;&#x2F;template,
called
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-src&#x2F;blob&#x2F;master&#x2F;ext&#x2F;ext_skel.php&quot;&gt;&lt;code&gt;ext_skel.php&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.
This script is accessible from the source of the Zend Engine virtual
machine (which we will refer to as &lt;code&gt;php-src&lt;&#x2F;code&gt;). One can invoke the script
like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cd php-src&#x2F;ext&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; .&#x2F;ext_skel.php \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      --ext gutenberg_post_parser \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      --author &amp;#39;Ivan Enderlin&amp;#39; \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      --dir &#x2F;path&#x2F;to&#x2F;extension \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      --onlyunix&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cd &#x2F;path&#x2F;to&#x2F;extension&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; ls gutenberg_post_parser&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;tests&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;.gitignore&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;CREDITS&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;config.m4&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;gutenberg_post_parser.c&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;php_gutenberg_post_parser.h&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;ext_skel.php&lt;&#x2F;code&gt; script recommends to go through the following steps:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Rebuild the configuration of the PHP source (run &lt;code&gt;.&#x2F;buildconf&lt;&#x2F;code&gt; at the
root of the &lt;code&gt;php-src&lt;&#x2F;code&gt; directory),&lt;&#x2F;li&gt;
&lt;li&gt;Reconfigure the build system to enable the extension, like
&lt;code&gt;.&#x2F;configure --enable-gutenberg_post_parser&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;Build with &lt;code&gt;make&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;Done.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;But our extension is very likely to live outside the &lt;code&gt;php-src&lt;&#x2F;code&gt; tree. So
we will use &lt;code&gt;phpize&lt;&#x2F;code&gt; instead. &lt;code&gt;phpize&lt;&#x2F;code&gt; is an executable that comes with
&lt;code&gt;php&lt;&#x2F;code&gt;, &lt;code&gt;php-cgi&lt;&#x2F;code&gt;, &lt;code&gt;phpdbg&lt;&#x2F;code&gt;, &lt;code&gt;php-config&lt;&#x2F;code&gt; etc. It allows to compile
extensions against an already compiled &lt;code&gt;php&lt;&#x2F;code&gt; binary, which is perfect in
our case! We will use it like this :&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cd &#x2F;path&#x2F;to&#x2F;extension&#x2F;gutenberg_post_parser&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Get the bin directory &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;for&lt;&#x2F;span&gt;&lt;span&gt; PHP utilities.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; PHP_PREFIX_BIN&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt;$(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;php-config&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --prefix&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&#x2F;bin&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Clean (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;except&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; if it is the first run&lt;&#x2F;span&gt;&lt;span&gt;).&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $PHP_PREFIX_BIN&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;phpize --clean&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # “phpize” the extension.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $PHP_PREFIX_BIN&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;phpize&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Configure the extension &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;for&lt;&#x2F;span&gt;&lt;span&gt; a particular PHP version.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; .&#x2F;configure&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; --with-php-config&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$PHP_PREFIX_BIN&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&#x2F;php-config&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Compile.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; make install&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In this post, we will not show all the edits we have done, but we will
rather focus on the extension binding. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;tree&#x2F;master&#x2F;bindings&#x2F;php&#x2F;extension&#x2F;gutenberg_post_parser&quot;&gt;All the sources can be found
here&lt;&#x2F;a&gt;.
Shortly, here is the &lt;code&gt;config.m4&lt;&#x2F;code&gt; file:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;PHP_ARG_ENABLE(gutenberg_post_parser, whether to enable gutenberg_post_parser support,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[  --with-gutenberg_post_parser          Include gutenberg_post_parser support], no)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;if  test &amp;quot;$PHP_GUTENBERG_POST_PARSER&amp;quot; != &amp;quot;no&amp;quot;; then&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  PHP_SUBST(GUTENBERG_POST_PARSER_SHARED_LIBADD)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  PHP_ADD_LIBRARY_WITH_PATH(gutenberg_post_parser, ., GUTENBERG_POST_PARSER_SHARED_LIBADD)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  PHP_NEW_EXTENSION(gutenberg_post_parser, gutenberg_post_parser.c, $ext_shared)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;fi&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What it does is basically the following:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Register the &lt;code&gt;--with-gutenberg_post_parser&lt;&#x2F;code&gt; option in the build
system, and&lt;&#x2F;li&gt;
&lt;li&gt;Declare the static library to compile with, and the source of the
extension itself.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;We must add the &lt;code&gt;libgutenberg_post_parser.a&lt;&#x2F;code&gt; and
&lt;code&gt;gutenberg_post_parser.h&lt;&#x2F;code&gt; files in the same directory (a symlink is
perfect), to get a structure such as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; ls gutenberg_post_parser&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;tests&#x2F;                       # from ext_skel&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;.gitignore                   # from ext_skel&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;CREDITS                      # from ext_skel&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;config.m4                    # from ext_skel (edited)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;gutenberg_post_parser.c      # from ext_skel (will be edited)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;gutenberg_post_parser.h      # from Rust&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;libgutenberg_post_parser.a   # from Rust&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;php_gutenberg_post_parser.h  # from ext_skel&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The core of the extension is the &lt;code&gt;gutenberg_post_parser.c&lt;&#x2F;code&gt; file. This
file is responsible to create the module, and to bind our Rust code to
PHP.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-1&quot;&gt;The module, aka the extension&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;As said, we will work in the &lt;code&gt;gutenberg_post_parser.c&lt;&#x2F;code&gt; file. First,
let&amp;#39;s include everything we need:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;php.h&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;ext&#x2F;standard&#x2F;info.h&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;php_gutenberg_post_parser.h&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;gutenberg_post_parser.h&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The last line includes the &lt;code&gt;gutenberg_post_parser.h&lt;&#x2F;code&gt; file generated by
Rust (more precisely, by &lt;code&gt;cbindgen&lt;&#x2F;code&gt;, if you don&amp;#39;t remember, &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-c-galaxy&#x2F;&quot;&gt;take a look
at the previous
episode&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;Then, we have to decide what API we want to expose into PHP? As a
reminder, the Rust parser produces an AST defined as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The C variant of the AST is very similar (with more structures, but the
idea is almost identical). So in PHP, the following structure has been
selected:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Gutenberg_Parser_Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; string&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; string&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; string&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; array&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Gutenberg_Parser_Phrase&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; string&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $content&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; gutenberg_post_parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;string&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $gutenberg_post&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;gutenberg_post_parse&lt;&#x2F;code&gt; function will output an array of objects of
kind &lt;code&gt;Gutenberg_Parser_Block&lt;&#x2F;code&gt; or &lt;code&gt;Gutenberg_Parser_Phrase&lt;&#x2F;code&gt;, i.e. our
AST.&lt;&#x2F;p&gt;
&lt;p&gt;So, let&amp;#39;s declare those classes!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-2&quot;&gt;Declare the classes&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;em&gt;Note: The next 4 code blocks are not the core of the post, it is just
code that needs to be written, you can skip it if you are not about to
write a PHP extension.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;zend_class_entry &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;zend_class_entry &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_phrase_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;zend_object_handlers gutenberg_parser_node_class_entry_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span&gt; _gutenberg_parser_node &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    zend_object zobj&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; gutenberg_parser_node&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A class entry represents a specific class type. A handler is associated
to a class entry. The logic is somewhat complicated. If you need more
details, I recommend to read the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.phpinternalsbook.com&#x2F;&quot;&gt;PHP Internals
Book&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Then, let&amp;#39;s create a function to instanciate those objects:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;static&lt;&#x2F;span&gt;&lt;span&gt; zend_object &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;create_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;zend_class_entry &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    gutenberg_parser_node &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    gutenberg_parser_node_object &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; ecalloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; sizeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; zend_object_properties_size&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zend_object_std_init&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;zobj&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    object_properties_init&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;zobj&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;zobj&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node_class_entry_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;zobj&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then, let&amp;#39;s create a function to free those objects. It works in two
steps: Destruct the object by calling its destructor (in the user-land),
then free it for real (in the VM-land):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;static&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; void&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; destroy_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;zend_object &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zend_objects_destroy_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;static&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; void&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; free_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;zend_object &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zend_object_std_dtor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then, let&amp;#39;s initialize the “module”, i.e. the extension. During the
initialisation, we will create the classes in the user-land, declare
their attributes etc.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;PHP_MINIT_FUNCTION&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_post_parser&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    zend_class_entry class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare Gutenberg_Parser_Block.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    INIT_CLASS_ENTRY&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;Gutenberg_Parser_Block&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; NULL&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    gutenberg_parser_block_class_entry &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; zend_register_internal_class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;class_entry TSRMLS_CC&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare the create handler.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;create_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; create_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; The class is final.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;ce_flags&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |=&lt;&#x2F;span&gt;&lt;span&gt; ZEND_ACC_FINAL&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare the `namespace` public attribute,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; with an empty string for the default value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zend_declare_property_string&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;namespace&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; sizeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;namespace&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; ZEND_ACC_PUBLIC&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare the `name` public attribute,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; with an empty string for the default value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zend_declare_property_string&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;name&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; sizeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;name&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; ZEND_ACC_PUBLIC&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare the `attributes` public attribute,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; with `NULL` for the default value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zend_declare_property_null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;attributes&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; sizeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;attributes&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; ZEND_ACC_PUBLIC&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare the `children` public attribute,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; with `NULL` for the default value.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zend_declare_property_null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;children&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; sizeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;children&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; ZEND_ACC_PUBLIC&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare the Gutenberg_Parser_Block.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    … skip …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Declare Gutenberg parser node object handlers.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    memcpy&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node_class_entry_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; zend_get_std_object_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; sizeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node_class_entry_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    gutenberg_parser_node_class_entry_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; XtOffsetOf&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_parser_node&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; zobj&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    gutenberg_parser_node_class_entry_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;dtor_obj&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; destroy_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    gutenberg_parser_node_class_entry_handlers&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;free_obj&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; free_parser_node_object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span&gt; SUCCESS&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;If you are still reading, first: Thank you, and second: Congrats!&lt;&#x2F;p&gt;
&lt;p&gt;Then, there is a &lt;code&gt;PHP_RINIT_FUNCTION&lt;&#x2F;code&gt; and a &lt;code&gt;PHP_MINFO_FUNCTION&lt;&#x2F;code&gt;
functions that are already generated by the &lt;code&gt;ext_skel.php&lt;&#x2F;code&gt; script. Same
for the module entry definition and other module configuration details.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;gutenberg-post-parse&quot;&gt;The &lt;code&gt;gutenberg_post_parse&lt;&#x2F;code&gt; function&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#gutenberg-post-parse&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;We will now focus on the &lt;code&gt;gutenberg_post_parse&lt;&#x2F;code&gt; PHP function. This
function takes a string as a single argument  and returns either &lt;code&gt;false&lt;&#x2F;code&gt;
if the parsing failed, or an array of objects of kind
&lt;code&gt;Gutenberg_Parser_Block&lt;&#x2F;code&gt; or &lt;code&gt;Gutenberg_Parser_Phrase&lt;&#x2F;code&gt; otherwise. Let&amp;#39;s
write it! Notice that it is declared with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-src&#x2F;blob&#x2F;52d91260df54995a680f420884338dfd9d5a0d49&#x2F;main&#x2F;php.h#L400&quot;&gt;the &lt;code&gt;PHP_FUNCTION&lt;&#x2F;code&gt;
macro&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;PHP_FUNCTION&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;gutenberg_post_parse&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    char&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    size_t&lt;&#x2F;span&gt;&lt;span&gt; input_len&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Read the input as a string.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;zend_parse_parameters&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ZEND_NUM_ARGS&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;()&lt;&#x2F;span&gt;&lt;span&gt; TSRMLS_CC&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;s&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;input_len&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ==&lt;&#x2F;span&gt;&lt;span&gt; FAILURE&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;At this step, the argument has been declared and typed as a string
(&lt;code&gt;&quot;s&quot;&lt;&#x2F;code&gt;). The string value is in &lt;code&gt;input&lt;&#x2F;code&gt; and the string length is in
&lt;code&gt;input_len&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The next step is to parse the &lt;code&gt;input&lt;&#x2F;code&gt;. (The length of the string is not
needed). This is where we are going to call our Rust code! Let&amp;#39;s do
that:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Parse the input.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Result parser_result &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; parse&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; If parsing failed, then return false.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span&gt;parser_result.tag &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; Err&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        RETURN_FALSE&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Else map the Rust AST into a PHP array.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node nodes &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; parse_result.ok._0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;Result&lt;&#x2F;code&gt; type and the &lt;code&gt;parse&lt;&#x2F;code&gt; function come from Rust. If you don&amp;#39;t
remember those types, please &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-c-galaxy&#x2F;&quot;&gt;read the previous episode about the C
galaxy&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Zend Engine has a macro called &lt;code&gt;RETURN_FALSE&lt;&#x2F;code&gt; to return… &lt;code&gt;false&lt;&#x2F;code&gt;! Handy
isn&amp;#39;t it?&lt;&#x2F;p&gt;
&lt;p&gt;Finally, if everything went well, we get back a collection of node as a
&lt;code&gt;Vector_Node&lt;&#x2F;code&gt; type.&lt;&#x2F;p&gt;
&lt;p&gt;The next step is to map those Rust&#x2F;C types into PHP types, i.e. an array
of the Gutenberg classes. Let&amp;#39;s go:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Note: return_value is a “magic” variable that holds the value to be returned.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Allocate an array.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    array_init_size&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;return_value&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; nodes.length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Map the Rust AST.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    into_php_objects&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;return_value&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Done 😁! Oh wait… the &lt;code&gt;into_php_objects&lt;&#x2F;code&gt; function need to be written!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;into-php-objects&quot;&gt;The &lt;code&gt;into_php_objects&lt;&#x2F;code&gt; function&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#into-php-objects&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;This function is not terribly complex: It&amp;#39;s just full of Zend Engine
specific API as expected. We are going to explain how to map a &lt;code&gt;Block&lt;&#x2F;code&gt;
into a &lt;code&gt;Gutenberg_Parser_Block&lt;&#x2F;code&gt; object, and to let the &lt;code&gt;Phrase&lt;&#x2F;code&gt; mapping
to &lt;code&gt;Gutenberg_Parser_Phrase&lt;&#x2F;code&gt; for the assiduous readers. And there we go:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;void&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; into_php_objects&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;zval &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; const&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; uintptr_t&lt;&#x2F;span&gt;&lt;span&gt; number_of_nodes &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span&gt;number_of_nodes &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;==&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Iterate over all nodes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    for&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;uintptr_t&lt;&#x2F;span&gt;&lt;span&gt; nth &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt; nth &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span&gt; number_of_nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ++&lt;&#x2F;span&gt;&lt;span&gt;nth&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span&gt; Node node &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;[nth]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ==&lt;&#x2F;span&gt;&lt;span&gt; Block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; Map Block into Gutenberg_Parser_Block.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;        }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; else if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ==&lt;&#x2F;span&gt;&lt;span&gt; Phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; Map Phrase into Gutenberg_Parser_Phrase.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now let&amp;#39;s map a block. The process is the following:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Allocate PHP strings for the block namespace, and for the block
name,&lt;&#x2F;li&gt;
&lt;li&gt;Allocate an object,&lt;&#x2F;li&gt;
&lt;li&gt;Set the block namespace and the block name to their respective
object properties,&lt;&#x2F;li&gt;
&lt;li&gt;Allocate a PHP string for the block attributes if any,&lt;&#x2F;li&gt;
&lt;li&gt;Set the block attributes to its respective object property,&lt;&#x2F;li&gt;
&lt;li&gt;If any children, initialise a new array, and call &lt;code&gt;into_php_objects&lt;&#x2F;code&gt;
with the child nodes and the new array,&lt;&#x2F;li&gt;
&lt;li&gt;Set the children to its respective object property,&lt;&#x2F;li&gt;
&lt;li&gt;Finally, add the block object inside the array to be returned.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Block_Body block &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; node.block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;zval php_block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; php_block_namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; php_block_name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 1. Prepare the PHP strings.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ZVAL_STRINGL&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block_namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; block.namespace.pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; block.namespace.length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ZVAL_STRINGL&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block_name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; block.name.pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; block.name.length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Do you remember that namespace, name and other similar data are of type
&lt;code&gt;Slice_c_char&lt;&#x2F;code&gt;? It&amp;#39;s just a structure with a pointer and a length. The
pointer points to the original input string, so that there is no copy
(and this is the definition of a slice actually). Well, Zend Engine has
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-src&#x2F;blob&#x2F;52d91260df54995a680f420884338dfd9d5a0d49&#x2F;Zend&#x2F;zend_API.h#L563-L565&quot;&gt;a &lt;code&gt;ZVAL_STRINGL&lt;&#x2F;code&gt;
macro&lt;&#x2F;a&gt;
that allows to create a string from a pointer and a length, great!
Unfortunately for us, Zend Engine does &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-src&#x2F;blob&#x2F;52d91260df54995a680f420884338dfd9d5a0d49&#x2F;Zend&#x2F;zend_string.h#L152-L159&quot;&gt;a copy behind the
scene&lt;&#x2F;a&gt;…
There is no way to keep the pointer and the length only, but it keeps
the number of copies small. I think it is to take the full ownership of
the data, which is required for the garbage collector.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 2. Create the Gutenberg_Parser_Block object.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;object_init_ex&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; gutenberg_parser_block_class_entry&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The object has been instanciated with a class represented by the
&lt;code&gt;gutenberg_parser_block_class_entry&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 3. Set the namespace and the name.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;add_property_zval&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;namespace&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block_namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;add_property_zval&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;name&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block_name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;zval_ptr_dtor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block_namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;zval_ptr_dtor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block_name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;zval_ptr_dtor&lt;&#x2F;code&gt; adds 1 to the reference counter. This is required
for the garbage collector.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 4. Deal with block attributes if some.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span&gt;block.attributes.tag &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; Some&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Slice_c_char attributes &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;some&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    zval php_block_attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    ZVAL_STRINGL&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_block_attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; 5. Set the attributes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    add_property_zval&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;attributes&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_block_attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    zval_ptr_dtor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_block_attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is similar to what has been done for &lt;code&gt;namespace&lt;&#x2F;code&gt; and &lt;code&gt;name&lt;&#x2F;code&gt;. Now
let&amp;#39;s continue with children.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 6. Handle children.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;children &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) (&lt;&#x2F;span&gt;&lt;span&gt;block.children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span&gt;children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;length &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    zval php_children_array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    array_init_size&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_children_array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Recursion.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    into_php_objects&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_children_array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; 7. Set the children.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    add_property_zval&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;children&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;php_children_array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Z_DELREF&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;php_children_array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;free&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;void&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Finally, add the block instance into the array to be returned:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; 8. Insert the object in the collection.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    add_next_index_zval&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;php_array&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;php_block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;php&#x2F;extension&#x2F;gutenberg_post_parser&#x2F;gutenberg_post_parser.c&quot;&gt;The entire code lands
here&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-3&quot;&gt;PHP extension 🚀 PHP userland&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Now the extension is written, we have to compile it. That&amp;#39;s the
repetitive set of commands we have shown above with &lt;code&gt;phpize&lt;&#x2F;code&gt;. Once the
extension is compiled, the generated &lt;code&gt;gutenberg_post_parser.so&lt;&#x2F;code&gt; file
must be located in the extension directory. This directory can be found
with the following command:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php-config --extension-dir&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;For instance, in my computer, the extension directory is
&lt;code&gt;&#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;php&#x2F;7.2.11&#x2F;pecl&#x2F;20170718&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Then, to enable the extension for a given execution, you must write:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php -d&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; extension&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;gutenberg_post_parser&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; -m&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span&gt; \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      grep gutenberg_post_parser&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Or, to enable the extension for all executions, locate the &lt;code&gt;php.ini&lt;&#x2F;code&gt;
file with &lt;code&gt;php --ini&lt;&#x2F;code&gt; and edit it to add:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;extension=gutenberg_post_parser&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Done!&lt;&#x2F;p&gt;
&lt;p&gt;Now, let&amp;#39;s use some reflection to check the extension is correctly
loaded and handled by PHP:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php --re gutenberg_post_parser&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Extension [ &amp;lt;persistent&amp;gt; extension #64 gutenberg_post_parser version 0.1.0 ] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  - Functions {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Function [ &amp;lt;internal:gutenberg_post_parser&amp;gt; function gutenberg_post_parse ] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Parameters [1] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Parameter #0 [ &amp;lt;required&amp;gt; $gutenberg_post_as_string ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  - Classes [2] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Class [ &amp;lt;internal:gutenberg_post_parser&amp;gt; final class Gutenberg_Parser_Block ] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Constants [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Static properties [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Static methods [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Properties [4] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Property [ &amp;lt;default&amp;gt; public $namespace ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Property [ &amp;lt;default&amp;gt; public $name ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Property [ &amp;lt;default&amp;gt; public $attributes ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Property [ &amp;lt;default&amp;gt; public $children ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Methods [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Class [ &amp;lt;internal:gutenberg_post_parser&amp;gt; final class Gutenberg_Parser_Phrase ] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Constants [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Static properties [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Static methods [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Properties [1] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Property [ &amp;lt;default&amp;gt; public $content ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      - Methods [0] {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Everything looks good: There is one function and two classes that are
defined as expected. Now, let&amp;#39;s write some PHP code for the first time
in this blog post!&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    gutenberg_post_parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        &amp;#39;&amp;lt;!-- wp:foo &#x2F;--&amp;gt;bar&amp;lt;!-- wp:baz --&amp;gt;qux&amp;lt;!-- &#x2F;wp:baz --&amp;gt;&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * Will output:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     array(3) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       [0]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       object(Gutenberg_Parser_Block)#1 (4) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;namespace&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         string(4) &amp;quot;core&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;name&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         string(3) &amp;quot;foo&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;attributes&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         NULL&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;children&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         NULL&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       [1]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       object(Gutenberg_Parser_Phrase)#2 (1) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;content&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         string(3) &amp;quot;bar&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       [2]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       object(Gutenberg_Parser_Block)#3 (4) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;namespace&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         string(4) &amp;quot;core&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;name&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         string(3) &amp;quot;baz&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;attributes&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         NULL&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [&amp;quot;children&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         array(1) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *           [0]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *           object(Gutenberg_Parser_Phrase)#4 (1) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *             [&amp;quot;content&amp;quot;]=&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *             string(3) &amp;quot;qux&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *           }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *       }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It works very well!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-4&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-4&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The journey is:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A string written in PHP,&lt;&#x2F;li&gt;
&lt;li&gt;Allocated by the Zend Engine from the Gutenberg extension,&lt;&#x2F;li&gt;
&lt;li&gt;Passed to Rust through FFI (static library + header),&lt;&#x2F;li&gt;
&lt;li&gt;Back to Zend Engine in the Gutenberg extension,&lt;&#x2F;li&gt;
&lt;li&gt;To generate PHP objects,&lt;&#x2F;li&gt;
&lt;li&gt;That are read by PHP.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Rust fits really everywhere!&lt;&#x2F;p&gt;
&lt;p&gt;We have seen in details how to write a real world parser in Rust, how to
bind it to C and compile it to a static library in addition to C
headers, how to create a PHP extension exposing one function and two
objects, how to integrate the C binding into PHP, and how to use this
extension in PHP.&lt;&#x2F;p&gt;
&lt;p&gt;As a reminder, the C binding is about 150 lines of code. The PHP
extension is about 300 lines of code, but substracting “decorations”
(the boilerplate to declare and manage the extension) that are
automatically generated, the PHP extension reduces to about 200 lines of
code. Once again, I find this is a small surface of code to review
considering the fact that the parser is still written in Rust, and
modifying the parser will not impact the bindings (except if the AST is
updated obviously)!&lt;&#x2F;p&gt;
&lt;p&gt;PHP is a language with a garbage collector. It explains why all strings
are copied, so that they are owned by PHP itself. However, the fact that
Rust does not copy any data saves memory allocations and deallocations,
which is the biggest cost most of the time.&lt;&#x2F;p&gt;
&lt;p&gt;Rust also provides safety. This property can be questionned considering
the number of binding we are going through: Rust to C to PHP: Does it
still hold? From the Rust perspective, yes, but everything that happens
inside C or PHP must be considered unsafe. A special care must be put in
the C binding to handle all situations.&lt;&#x2F;p&gt;
&lt;p&gt;Is it still fast? Well, let&amp;#39;s benchmark. I would like to remind that the
first goal of this experiment was to tackle the bad performance of the
original PEG.js parser. On the JavaScript ground, WASM and ASM.js have
shown to be very much faster (see &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;&quot;&gt;the WebAssembly
galaxy&lt;&#x2F;a&gt;,
and &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-asm-js-galaxy&#x2F;&quot;&gt;the ASM.js
galaxy&lt;&#x2F;a&gt;).
For PHP, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nylen&#x2F;phpegjs&quot;&gt;&lt;code&gt;phpegjs&lt;&#x2F;code&gt; is used&lt;&#x2F;a&gt;: It reads
the grammar written for PEG.js and compiles it to PHP. Let&amp;#39;s see how
they compare:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Document&lt;&#x2F;th&gt;&lt;th&gt;PEG PHP parser (ms)&lt;&#x2F;th&gt;&lt;th&gt;Rust parser as a PHP extension (ms)&lt;&#x2F;th&gt;&lt;th&gt;speedup&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;demo-post.html&quot;&gt;&lt;code&gt;demo-post.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;30.409&lt;&#x2F;td&gt;&lt;td&gt;0.0012&lt;&#x2F;td&gt;&lt;td&gt;× 25341&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;shortcode-shortcomings.html&quot;&gt;&lt;code&gt;shortcode-shortcomings.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;76.39&lt;&#x2F;td&gt;&lt;td&gt;0.096&lt;&#x2F;td&gt;&lt;td&gt;× 796&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;redesigning-chrome-desktop.html&quot;&gt;&lt;code&gt;redesigning-chrome-desktop.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;225.824&lt;&#x2F;td&gt;&lt;td&gt;0.399&lt;&#x2F;td&gt;&lt;td&gt;× 566&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;web-at-maximum-fps.html&quot;&gt;&lt;code&gt;web-at-maximum-fps.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;173.495&lt;&#x2F;td&gt;&lt;td&gt;0.275&lt;&#x2F;td&gt;&lt;td&gt;× 631&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;early-adopting-the-future.html&quot;&gt;&lt;code&gt;early-adopting-the-future.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;280.433&lt;&#x2F;td&gt;&lt;td&gt;0.298&lt;&#x2F;td&gt;&lt;td&gt;× 941&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;pygmalian-raw-html.html&quot;&gt;&lt;code&gt;pygmalian-raw-html.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;377.392&lt;&#x2F;td&gt;&lt;td&gt;0.052&lt;&#x2F;td&gt;&lt;td&gt;× 7258&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;moby-dick-parsed.html&quot;&gt;&lt;code&gt;moby-dick-parsed.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;5,437.630&lt;&#x2F;td&gt;&lt;td&gt;5.037&lt;&#x2F;td&gt;&lt;td&gt;× 1080&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmarks between PEG PHP parser and Rust parser as a PHP extension.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The PHP extension of the Rust parser is in average 5230 times faster
than the actual PEG PHP implementation. The median of the speedup is
941.&lt;&#x2F;p&gt;
&lt;p&gt;Another huge issue was that the PEG parser was not able to handle many
Gutenberg documents because of a memory limit. Of course, it is possible
to grow the size of the memory, but it is not ideal. With the Rust
parser as a PHP extension, memory stays constant and close to the size
of the parsed document.&lt;&#x2F;p&gt;
&lt;p&gt;I reckon we can optimise the extension further to generate an iterator
instead of an array. This is something I want to explore and analyse the
impact on the performance. The PHP Internals Book has a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.phpinternalsbook.com&#x2F;classes_objects&#x2F;iterators.html&quot;&gt;chapter about
Iterators&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Thanks for reading!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>The C galaxy</title>
          <pubDate>Tue, 11 Sep 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/series/from-rust-to-beyond/the-c-galaxy/</link>
          <guid>https://mnt.io/series/from-rust-to-beyond/the-c-galaxy/</guid>
          <description xml:base="https://mnt.io/series/from-rust-to-beyond/the-c-galaxy/">&lt;p&gt;The galaxy we will explore today is the C galaxy. This post will explain
what C is (shortly), how to compile any Rust program in C in theory, and
how to do that practically with our Rust parser from the Rust side and
the C side. We will also see how to test such a binding.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-c-and-why&quot;&gt;What is C, and why?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-is-c-and-why&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;C_(programming_language)&quot;&gt;C&lt;&#x2F;a&gt; is probably
the most used and known programming language in the world. Quoting
Wikipedia:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;C […] is a general-purpose, imperative computer programming
language, supporting structured programming, lexical variable scope
and recursion, while a static type system prevents many unintended
operations. By design, C provides constructs that map efficiently to
typical machine instructions, and therefore it has found lasting use
in applications that had formerly been coded in assembly language,
including operating systems, as well as various application software
for computers ranging from supercomputers to embedded systems.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-c-galaxy&#x2F;.&#x2F;dennis-ritchie.png&quot; alt=&quot;Dennis Ritchie&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Dennis Ritchie, the inventor of the C language.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The impact of C is probably without precedent on the progamming language
world. Almost everything is written in C, starting with operating
systems. Today, it is one of the few common denominator between any
programs on any systems on any machines in the world. In other words,
being compatible with C opens a large door to everything. Your program
will be able to talk directly to any program easily.&lt;&#x2F;p&gt;
&lt;p&gt;Because languages like PHP or Python are written in C, in our particular
Gutenberg parser usecase, it means that the parser can be embedded and
used by PHP or Python directly, with almost no overhead. Neat!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;Rust 🚀 C&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-c-galaxy&#x2F;.&#x2F;rust-to-c.png&quot; alt=&quot;Rust to C&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;In order to use Rust from C, one may need 2 elements:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;A static library (&lt;code&gt;.a&lt;&#x2F;code&gt; file),&lt;&#x2F;li&gt;
&lt;li&gt;A header file (&lt;code&gt;.h&lt;&#x2F;code&gt; file).&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;h3 id=&quot;-1&quot;&gt;The theory&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;To compile a Rust project into a static library, the &lt;code&gt;crate-type&lt;&#x2F;code&gt;
property must contain the &lt;code&gt;staticlib&lt;&#x2F;code&gt; value. Let&amp;#39;s edit the &lt;code&gt;Cargo.toml&lt;&#x2F;code&gt;
file such as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;toml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;lib&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;gutenberg_post_parser&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;crate-type&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;staticlib&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Once &lt;code&gt;cargo build --release&lt;&#x2F;code&gt; is run, a &lt;code&gt;libgutenberg_post_parser.a&lt;&#x2F;code&gt; file
is created in &lt;code&gt;target&#x2F;release&#x2F;&lt;&#x2F;code&gt;. Done. &lt;code&gt;cargo&lt;&#x2F;code&gt; and &lt;code&gt;rustc&lt;&#x2F;code&gt; make this
step really a doddle.&lt;&#x2F;p&gt;
&lt;p&gt;Now the header file. It can be written manually, but it&amp;#39;s tedious and it
gets easily outdated. The goal is to &lt;em&gt;automatically&lt;&#x2F;em&gt; generate it. Enter
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;eqrion&#x2F;cbindgen&#x2F;&quot;&gt;&lt;code&gt;cbindgen&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;cbindgen&lt;&#x2F;code&gt; can be used to generate C bindings for Rust code. It is
currently being developed to support creating bindings for
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;servo&#x2F;webrender&#x2F;&quot;&gt;WebRender&lt;&#x2F;a&gt;, but has been
designed to support any project.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;To install &lt;code&gt;cbindgen&lt;&#x2F;code&gt;, edit your &lt;code&gt;Cargo.toml&lt;&#x2F;code&gt; file, such as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;toml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;package&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;build&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;build.rs&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;build-dependencies&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;cbindgen&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;^0.6.0&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Actually, &lt;code&gt;cbindgen&lt;&#x2F;code&gt; comes in 2 flavors: CLI executable, or a library. I
prefer to use the library approach, which makes installation easier.&lt;&#x2F;p&gt;
&lt;p&gt;Note that Cargo has been instructed to use the &lt;code&gt;build.rs&lt;&#x2F;code&gt; file to build
the project. This file is an appropriate place to generate the C headers
file with &lt;code&gt;cbindgen&lt;&#x2F;code&gt;. Let&amp;#39;s write it!&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; crate&lt;&#x2F;span&gt;&lt;span&gt; cbindgen;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; crate_dir&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; std&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;env&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;var&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;CARGO_MANIFEST_DIR&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    cbindgen&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;generate&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;crate_dir&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;expect&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Unable to generate C bindings.&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;write_to_file&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;dist&#x2F;gutenberg_post_parser.h&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With those information, &lt;code&gt;cbindgen&lt;&#x2F;code&gt; will scan the source code of the
project and will generate C headers automatically in the
&lt;code&gt;dist&#x2F;gutenberg_post_parser.h&lt;&#x2F;code&gt; header file. Scanning will be detailed in
a moment, but before that, let&amp;#39;s quickly see how to control the content
of the header file. With the code snippet above, &lt;code&gt;cbindgen&lt;&#x2F;code&gt; will look
for a &lt;code&gt;cbindgen.toml&lt;&#x2F;code&gt; configuration file in the &lt;code&gt;CARGO_MANIFEST_DIR&lt;&#x2F;code&gt;
directory, i.e. the root of your crate. Mine looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;toml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;header&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&amp;quot;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;&#x2F;*&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;Gutengerg Post Parser, the C bindings.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;Warning, this file is autogenerated by `cbindgen`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;Do not modify this manually.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;*&#x2F;&amp;quot;&amp;quot;&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;tab_width&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 4&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;language&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;C&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It describes itself quite easily. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;eqrion&#x2F;cbindgen&#x2F;#configuration&quot;&gt;The documentation details the
configuration&lt;&#x2F;a&gt; very
well.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;cbindgen&lt;&#x2F;code&gt; will scan the code and will stop on &lt;code&gt;struct&lt;&#x2F;code&gt;s or &lt;code&gt;enum&lt;&#x2F;code&gt;s that
have the decorator &lt;code&gt;#[repr(C)]&lt;&#x2F;code&gt;, &lt;code&gt;#[repr(_size_)]&lt;&#x2F;code&gt; or
&lt;code&gt;#[repr(transparent)]&lt;&#x2F;code&gt;, or functions that are marked as &lt;code&gt;extern &quot;C&quot;&lt;&#x2F;code&gt; and
are public. So when one writes:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Slice&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_char&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Slice&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    None&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;C&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_char&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_void&lt;&#x2F;span&gt;&lt;span&gt; { … }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then &lt;code&gt;cbindgen&lt;&#x2F;code&gt; will generate this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; … header comment …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; char&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    uintptr_t&lt;&#x2F;span&gt;&lt;span&gt; length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Slice&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Some&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    None&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Option_Tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Slice _0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Some_Body&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Option_Tag tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    union&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Some_Body some&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Option&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;void&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; parse&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; char&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It works; Great!&lt;&#x2F;p&gt;
&lt;p&gt;Note the &lt;code&gt;#[no_mangle]&lt;&#x2F;code&gt; that decorates the Rust &lt;code&gt;parse&lt;&#x2F;code&gt; function. It
instructs the compiler to not rename the function, so that the function
has the same name from the perspective of C.&lt;&#x2F;p&gt;
&lt;p&gt;OK, that&amp;#39;s all for the theory. Let&amp;#39;s practise now, we have a parser to
bind to C!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-2&quot;&gt;Practise&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;We want to bind a function named &lt;code&gt;parse&lt;&#x2F;code&gt;. The function outputs an AST
representing the language being analysed. &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;prelude&#x2F;&quot;&gt;For the
recall&lt;&#x2F;a&gt;, the
original AST looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Phase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This AST is defined in the Rust parser. The Rust binding to C will
transform this AST into another set of structs and enums for C. It is
mandatory only for types that are directly exposed to C, not internal
types that Rust uses. Let&amp;#39;s start by defining &lt;code&gt;Node&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Slice_c_char&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Slice_c_char&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option_c_char&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_void&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Slice_c_char&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Some immediate thoughts:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The structure &lt;code&gt;Slice_c_char&lt;&#x2F;code&gt; emulates Rust slices (see below),&lt;&#x2F;li&gt;
&lt;li&gt;The enum &lt;code&gt;Option_c_char&lt;&#x2F;code&gt; emulates &lt;code&gt;Option&lt;&#x2F;code&gt; (see below),&lt;&#x2F;li&gt;
&lt;li&gt;The field &lt;code&gt;children&lt;&#x2F;code&gt; has type &lt;code&gt;*const c_void&lt;&#x2F;code&gt;. It should be
&lt;code&gt;*const Vector_Node&lt;&#x2F;code&gt; (our definition of &lt;code&gt;Vector&lt;&#x2F;code&gt;), but the definition
of &lt;code&gt;Node&lt;&#x2F;code&gt; is based on &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; and vice versa. This &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;eqrion&#x2F;cbindgen&#x2F;issues&#x2F;43&quot;&gt;cyclical
definition case is unsupported by &lt;code&gt;cbindgen&lt;&#x2F;code&gt; so
far&lt;&#x2F;a&gt;. So… yes, it is
defined as a &lt;code&gt;void&lt;&#x2F;code&gt; pointer, and will be casted later in C,&lt;&#x2F;li&gt;
&lt;li&gt;The fields &lt;code&gt;namespace&lt;&#x2F;code&gt; and &lt;code&gt;name&lt;&#x2F;code&gt; are originally a tuple in Rust.
Tuples have no equivalent in C with &lt;code&gt;cbindgen&lt;&#x2F;code&gt;, so two fields are used
instead.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let&amp;#39;s define &lt;code&gt;Slice_c_char&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Slice_c_char&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_char&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This definition borrows the semantics of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;primitive.slice.html&quot;&gt;Rust&amp;#39;
slices&lt;&#x2F;a&gt;. The major
benefit is that there is no copy when binding a Rust slice to this
structure.&lt;&#x2F;p&gt;
&lt;p&gt;Let&amp;#39;s define &lt;code&gt;Option_c_char&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option_c_char&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Slice_c_char&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    None&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Finally, we need to define &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; and our own &lt;code&gt;Result&lt;&#x2F;code&gt; for C.
They mimic the Rust semantics closely:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vector_Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Ok&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Vector_Node&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Err&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Alright, all types are declared! It&amp;#39;s time to write the &lt;code&gt;parse&lt;&#x2F;code&gt;
function:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;C&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_char&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The function takes a pointer from C. It means that the data to analyse
(i.e. the Gutenberg blog post) is allocated and owned by C: The memory
is allocated on the C side, and Rust is only responsible of the parsing.
This is where Rust shines: No copy, no clone, no memory mess, only
pointers to this data will be returned to C as slices and vectors.&lt;&#x2F;p&gt;
&lt;p&gt;The workflow will be the following:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;First thing to do when we deal with C: Check that the pointer is not
null,&lt;&#x2F;li&gt;
&lt;li&gt;Reconstitute an input from the pointer with
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;ffi&#x2F;struct.CStr.html&quot;&gt;&lt;code&gt;CStr&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. This
standard API is useful to abstract C strings from the Rust point of
view. The difference is that a C string terminates by a &lt;code&gt;NULL&lt;&#x2F;code&gt; byte
and has no length, while in Rust a string has a length and does not
terminate with a &lt;code&gt;NULL&lt;&#x2F;code&gt; byte,&lt;&#x2F;li&gt;
&lt;li&gt;Run the parser, then transform the AST into the “C AST”.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let&amp;#39;s do that!&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;C&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_char&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_null&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Err&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; CStr&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;from_ptr&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;to_bytes&lt;&#x2F;span&gt;&lt;span&gt;() };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; let&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ok&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_remaining&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; gutenberg_post_parser&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            nodes&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;into_iter&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; into_c&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;collect&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; vector_node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vector_Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_slice&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_ptr&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        mem&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;forget&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;output&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Ok&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;vector_node&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; else&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Err&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Only pointers are used in &lt;code&gt;Vector_Node&lt;&#x2F;code&gt;: Pointer to the output, and the
length of the output. The conversion is light.&lt;&#x2F;p&gt;
&lt;p&gt;Now let&amp;#39;s see the &lt;code&gt;into_c&lt;&#x2F;code&gt; function. Some parts will not be detailed;
Not because they are difficult but because they are repetitive. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;c&#x2F;src&#x2F;lib.rs&quot;&gt;The
entire code lands
here&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; into_c&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    match&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; ref&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;            Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; …,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; …,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; …,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;            Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Phrase&lt;&#x2F;span&gt;&lt;span&gt;(…)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I want to show &lt;code&gt;namespace&lt;&#x2F;code&gt; for the warm-up (&lt;code&gt;name&lt;&#x2F;code&gt;, &lt;code&gt;attributes&lt;&#x2F;code&gt; and
&lt;code&gt;Phrase&lt;&#x2F;code&gt; are very similar), and &lt;code&gt;children&lt;&#x2F;code&gt; because it deals with &lt;code&gt;void&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Let&amp;#39;s convert &lt;code&gt;ast::Node::Block.name.0&lt;&#x2F;code&gt; into &lt;code&gt;Node::Block.namespace&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span&gt;, …, … }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Slice_c_char&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_ptr&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_char&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Pretty straightforward so far. &lt;code&gt;namespace&lt;&#x2F;code&gt; is a &lt;code&gt;Slice_c_char&lt;&#x2F;code&gt;. The
&lt;code&gt;pointer&lt;&#x2F;code&gt; is the pointer of the &lt;code&gt;name.0&lt;&#x2F;code&gt; slice, and the &lt;code&gt;length&lt;&#x2F;code&gt; is the
length of the same &lt;code&gt;name.0&lt;&#x2F;code&gt;. This is the same process for other Rust
slices.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;children&lt;&#x2F;code&gt; is different though. It works in three steps:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Collect all children as C AST nodes in a Rust vector,&lt;&#x2F;li&gt;
&lt;li&gt;Transform the Rust vector into a valid &lt;code&gt;Vector_Node&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;Transform the &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; into a &lt;code&gt;*const c_void&lt;&#x2F;code&gt; pointer.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; { …, …,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; ref&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; 1. Collect all children as C AST nodes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                children&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;into_iter&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; into_c&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;collect&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; 2. Transform the vector into a Vector_Node.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; vector_node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; if&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_empty&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                    Vector_Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                        buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ptr&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;null&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                        length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; else&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                    Vector_Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                        buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_slice&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_ptr&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                        length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; 3. Transform Vector_Node into a *const c_void pointer.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; vector_node_pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;into_raw&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;vector_node&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_void&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;            mem&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;forget&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;output&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            vector_node_pointer&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Step 1 is straightforward.&lt;&#x2F;p&gt;
&lt;p&gt;Step 2 defines what is the behavior when there is no node. In other
words, it defines what an empty &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; is. The &lt;code&gt;buffer&lt;&#x2F;code&gt; must
contain a &lt;code&gt;NULL&lt;&#x2F;code&gt; raw pointer, and the length is obviously 0. Without
this behavior I got various segmentation fault in my code, even if I
checked the &lt;code&gt;length&lt;&#x2F;code&gt; before the &lt;code&gt;buffer&lt;&#x2F;code&gt;. Note that &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; is
allocated on the heap with &lt;code&gt;Box::new&lt;&#x2F;code&gt; so that the pointer can be easily
shared with C.&lt;&#x2F;p&gt;
&lt;p&gt;Step 3 uses &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;boxed&#x2F;struct.Box.html#method.into_raw&quot;&gt;the  &lt;code&gt;Box::into_raw&lt;&#x2F;code&gt;
function&lt;&#x2F;a&gt;
to consume the box and to return the wrapped raw pointer of the data it
owns. Rust will not free anything here, it&amp;#39;s our responsability (or the
responsability of C to be pedantic). Then the &lt;code&gt;*mut Vector_Node&lt;&#x2F;code&gt;
returned by &lt;code&gt;Box::into_raw&lt;&#x2F;code&gt; can be freely casted into &lt;code&gt;*const c_void&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, we instruct the compiler to not drop &lt;code&gt;output&lt;&#x2F;code&gt; when it goes out
of scope with &lt;code&gt;mem::forget&lt;&#x2F;code&gt; (at this step of the series, you are very
likely to know what it does).&lt;&#x2F;p&gt;
&lt;p&gt;Personally, I spent few hours to understand why my pointers got random
addresses, or were pointing to a &lt;code&gt;NULL&lt;&#x2F;code&gt; data. The resulting code is
simple and kind of clear to read, but it wasn&amp;#39;t obvious for me what to
do beforehand.&lt;&#x2F;p&gt;
&lt;p&gt;And that&amp;#39;s all for the Rust part! The next section will present the C
code that calls Rust, and how to compile everything all together.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-3&quot;&gt;C 🚀 executable&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-c-galaxy&#x2F;.&#x2F;c-to-executable.png&quot; alt=&quot;Rust to C to executable&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Now the Rust part is ready, the C part must be written to call it.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-4&quot;&gt;Minimal Working Example&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-4&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Let&amp;#39;s do something very quick to see if it links and compiles:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;lt;stdlib.h&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;lt;stdio.h&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;lt;string.h&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#include&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;gutenberg_post_parser.h&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;int&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; main&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;int&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; argc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; char&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; **&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;argv&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    FILE&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt; file &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; fopen&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;argv&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;rb&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    fseek&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; SEEK_END&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    long&lt;&#x2F;span&gt;&lt;span&gt; file_size &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; ftell&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    rewind&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    char&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt; file_content &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;char&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; malloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file_size &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;* sizeof&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;char&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    fread&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file_content&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; file_size&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Let&amp;#39;s call Rust!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Result output &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; parse&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file_content&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;output&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ==&lt;&#x2F;span&gt;&lt;span&gt; Err&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        printf&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;Error while parsing.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node nodes &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;ok&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Do something with nodes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    free&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file_content&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    fclose&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;span&gt;file&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To keep the code concise, I left all the error handlers out of the
example. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;c&#x2F;bin&#x2F;gutenberg_post_parser.c&quot;&gt;The entire code lands
here&lt;&#x2F;a&gt;
if you&amp;#39;re curious.&lt;&#x2F;p&gt;
&lt;p&gt;What happens in this code? The first thing to notice is
&lt;code&gt;#include &quot;gutenberg_post_parser.h&quot;&lt;&#x2F;code&gt; which is the header file that is
automatically generated by &lt;code&gt;cbindgen&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Then a filename from &lt;code&gt;argv[1]&lt;&#x2F;code&gt; is used to read a blog post to parse. The
&lt;code&gt;parse&lt;&#x2F;code&gt; function is from Rust, just like the &lt;code&gt;Result&lt;&#x2F;code&gt; and &lt;code&gt;Vector_Node&lt;&#x2F;code&gt;
types.&lt;&#x2F;p&gt;
&lt;p&gt;The Rust &lt;code&gt;enum Result { Ok(Vector_Node), Err }&lt;&#x2F;code&gt; is compiled to C as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Ok&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Err&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Result_Tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Vector_Node _0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Ok_Body&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Result_Tag tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    union&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Ok_Body ok&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Result&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;No need to say that the Rust version is easier and more compact to read,
but this isn&amp;#39;t the point. To check if &lt;code&gt;Result&lt;&#x2F;code&gt; contains an &lt;code&gt;Ok&lt;&#x2F;code&gt; value or
an &lt;code&gt;Err&lt;&#x2F;code&gt;or, one has to check the &lt;code&gt;tag&lt;&#x2F;code&gt; field, like we did with
&lt;code&gt;output.tag == Err&lt;&#x2F;code&gt;. To get the content of the &lt;code&gt;Ok&lt;&#x2F;code&gt;, we did
&lt;code&gt;output.ok._0&lt;&#x2F;code&gt; (&lt;code&gt;_0&lt;&#x2F;code&gt; is a field from &lt;code&gt;Ok_Body&lt;&#x2F;code&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;Let&amp;#39;s compile this with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;clang.llvm.org&quot;&gt;&lt;code&gt;clang&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;! We assume that
this code above is located in the same directory than the
&lt;code&gt;gutenberg_post_parser.h&lt;&#x2F;code&gt; file, i.e. in a &lt;code&gt;dist&#x2F;&lt;&#x2F;code&gt; directory. Thus:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; cd dist&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; clang \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      # Enable all warnings. \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -Wall \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      # Output executable name. \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -o gutenberg-post-parser \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      # Input source file. \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      gutenberg_post_parser.c \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      # Directory where to find the static library (*.a). \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -L ..&#x2F;target&#x2F;release&#x2F; \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      # Link with the gutenberg_post_parser.h file. \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -l gutenberg_post_parser \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      # Other libraries to link with.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -l System \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -l pthread \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -l c \&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;      -l m&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And that&amp;#39;s all! We end up with a &lt;code&gt;gutenberg-post-parser&lt;&#x2F;code&gt; executable that
runs C and Rust.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-5&quot;&gt;More details&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-5&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;c&#x2F;bin&#x2F;gutenberg_post_parser.c&quot;&gt;In the original source
code&lt;&#x2F;a&gt;,
a recursive function that prints the entire AST on &lt;code&gt;stdout&lt;&#x2F;code&gt; can be
found, namely &lt;code&gt;print&lt;&#x2F;code&gt; (original, isn&amp;#39;t it?). Here is some side-by-side
comparisons between Rust syntax and C syntax.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; struct in Rust:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vector_Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; struct in C:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span&gt; Node &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    uintptr_t&lt;&#x2F;span&gt;&lt;span&gt; length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So to respectivelly read the number of nodes (length of the vector) and
the nodes in C, one has to write:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; uintptr_t&lt;&#x2F;span&gt;&lt;span&gt; number_of_nodes &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;for&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;uintptr_t&lt;&#x2F;span&gt;&lt;span&gt; nth &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt; nth &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span&gt; number_of_nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ++&lt;&#x2F;span&gt;&lt;span&gt;nth&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span&gt; Node node &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;[nth]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is almost idiomatic C code!&lt;&#x2F;p&gt;
&lt;p&gt;A &lt;code&gt;Node&lt;&#x2F;code&gt; is defined in C as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Node_Tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Slice_c_char namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Slice_c_char name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Option_c_char attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; void&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt; children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Block_Body&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Slice_c_char _0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Phrase_Body&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;typedef&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    Node_Tag tag&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    union&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Block_Body block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Phrase_Body phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt; Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So once a node is fetched, one can write the following code to detect
its kind:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span&gt;node.tag &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; Block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; else if&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span&gt;node.tag &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; Phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Let&amp;#39;s focus on &lt;code&gt;Block&lt;&#x2F;code&gt; for a second, and let&amp;#39;s print the namespace and
the name of the block separated by a slash (&lt;code&gt;&#x2F;&lt;&#x2F;code&gt;):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Block_Body block &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; node.block&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Slice_c_char namespace &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; block.namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Slice_c_char name &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; block.name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;printf&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;%.*s&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other z-constant z-character&quot;&gt;%.s\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;int&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt; namespace.length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; namespace.pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;int&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span&gt; name.length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; name.pointer&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The special &lt;code&gt;%.*s&lt;&#x2F;code&gt; form in &lt;code&gt;printf&lt;&#x2F;code&gt; allows to print a string based on
its length and its pointer.&lt;&#x2F;p&gt;
&lt;p&gt;I think it is interesting to see the cast from void to &lt;code&gt;Vector_Node&lt;&#x2F;code&gt; for
&lt;code&gt;children&lt;&#x2F;code&gt;. It&amp;#39;s a single line:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt; children &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; Vector_Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;) (&lt;&#x2F;span&gt;&lt;span&gt;block.children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I think that&amp;#39;s all for the details!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-6&quot;&gt;Testing&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-6&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;I reckon it is also interesting to see how to unit test C bindings
directly with Rust. To emulate a C binding, first, the inputs must be in
“C form”, so strings must be C strings. I prefer to write a macro for
that:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;macro_rules! str_to_c_char&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    (&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;expr&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            ::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;std&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ffi&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;CString&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And second, the opposite: The &lt;code&gt;parse&lt;&#x2F;code&gt; function returns data for C, so
they need to be “converted back” to Rust. Again, I prefer to write a
macro for that:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;macro_rules! slice_c_char_to_str&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    (&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;ident&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            ::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;std&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ffi&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;CStr&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;from_bytes_with_nul_unchecked&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                ::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;std&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;slice&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;from_raw_parts&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                    $&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;pointer &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                    $&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;length &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;+&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                )&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;to_str&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;All right! The final step is to write a unit test. As an example, a
&lt;code&gt;Phrase&lt;&#x2F;code&gt; will be tested; The idea remains the same for &lt;code&gt;Block&lt;&#x2F;code&gt; but the
code is more concise for the former.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[test]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; test_root_with_a_phrase&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; str_to_c_char!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;foo&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_ptr&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    match&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Ok&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;result&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; match&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;            Vector_Node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; length&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; if&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ==&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                match unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt; } {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                    Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;                        assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;slice_c_char_to_str!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;foo&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                    _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; assert!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt;false&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; assert!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt;false&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; assert!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt;false&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What happens here? The &lt;code&gt;input&lt;&#x2F;code&gt; and &lt;code&gt;output&lt;&#x2F;code&gt; have been prepared. The
former is the C string &lt;code&gt;&quot;foo&quot;&lt;&#x2F;code&gt;. The latter is the result of &lt;code&gt;parse&lt;&#x2F;code&gt;.
Then there is a &lt;code&gt;match&lt;&#x2F;code&gt; to validate the form of the AST. Rust is very
expressive, and this test is a good illustration. The &lt;code&gt;Vector_Node&lt;&#x2F;code&gt;
branch is activated if and only if the length of the vector is 1, which
is expressed with the guard &lt;code&gt;if length == 1&lt;&#x2F;code&gt;. Then the content of the
phrase is transformed into a Rust string and compared with a regular
&lt;code&gt;assert_eq!&lt;&#x2F;code&gt; macro.&lt;&#x2F;p&gt;
&lt;p&gt;Note that —in this case— &lt;code&gt;buffer&lt;&#x2F;code&gt; is of type &lt;code&gt;*const Node&lt;&#x2F;code&gt;, so it
represents the first element of the vector. If we want to access the
next elements, we would need to use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;vec&#x2F;struct.Vec.html#method.from_raw_parts&quot;&gt;the &lt;code&gt;Vec::from_raw_parts&lt;&#x2F;code&gt;
function&lt;&#x2F;a&gt;
to get a proper Rust API to manipulate this vector.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-7&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-7&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We have seen that Rust can be embedded in C very easily. In this
example, Rust has been compiled to a static library, and a header file;
the former is native with Rust tooling, the latter is automatically
generated with &lt;code&gt;cbindgen&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The parser written in Rust manipulates a string allocated and owned by
C. Rust only returns pointers (as slices) to this string back to C. Then
C has no difficulties to read those pointers. The only tricky part is
that Rust allocates some data (like vectors of nodes) on the heap that C
must free. The “free” part has been omitted from the article though: It
does not represent a big challenge, and a C developer is likely to be
used to this kind of situation.&lt;&#x2F;p&gt;
&lt;p&gt;The fact that Rust does not use a garbage collector makes it a perfect
candidate for these usecases. The story behind these bindings is
actually all about memory: Who allocates what, and What is the form of
the data in memory. Rust has a &lt;code&gt;#[repr(C)]&lt;&#x2F;code&gt; decorator to instruct the
compiler to use a C memory layout, which makes C bindings extremely
simple for the developer.&lt;&#x2F;p&gt;
&lt;p&gt;We have also seen that the C bindings can be unit tested within Rust
itself, and run with &lt;code&gt;cargo test&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;cbindgen&lt;&#x2F;code&gt; is a precious companion in this adventure, by automating the
header file generation, it reduces the update and the maintenance of the
code to a &lt;code&gt;build.rs&lt;&#x2F;code&gt; script.&lt;&#x2F;p&gt;
&lt;p&gt;In terms of performance, C should have similar results than Rust, i.e.
extremely fast. I didn&amp;#39;t run a benchmark to verify this statement, it&amp;#39;s
purely theoretical. It can be a subject for a next post!&lt;&#x2F;p&gt;
&lt;p&gt;Now that we have successfully embedded Rust in C, a whole new world
opens up to us! The next episode will push Rust in the PHP world as a
native extension (written in C). Let&amp;#39;s go!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>The ASM.js galaxy</title>
          <pubDate>Tue, 28 Aug 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/series/from-rust-to-beyond/the-asm-js-galaxy/</link>
          <guid>https://mnt.io/series/from-rust-to-beyond/the-asm-js-galaxy/</guid>
          <description xml:base="https://mnt.io/series/from-rust-to-beyond/the-asm-js-galaxy/">&lt;p&gt;The second galaxy that our Rust parser will explore is the ASM.js
galaxy. This post will explain what ASM.js is, how to compile the parser
into ASM.js, and how to use the ASM.js module with Javascript in a
browser. The goal is to use ASM.js as a fallback to WebAssembly when it
is not available. I highly recommend to read &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;&quot;&gt;the previous
episode&lt;&#x2F;a&gt;
about WebAssembly since they have a lot in common.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-asm-js-and-why&quot;&gt;What is ASM.js, and why?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-is-asm-js-and-why&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The main programming language on the Web is Javascript. Applications
that want to exist on the Web had to compile to Javascript, like for
example games. But a problem occurs: The resulting file is heavy (hence
WebAssembly) and Javascript virtual machines have difficulties to
optimise this particular code, resulting in slow or inefficient
executions (considering the example of games). Also —in this context—
Javascript is a compilation target, and as such, some language
constructions are useless (like &lt;code&gt;eval&lt;&#x2F;code&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;So what if a “new” language can be a compilation target and still be
executed by Javascript virtual machines? This is WebAssembly today, but
in 2013, the solution was &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;asmjs.org&#x2F;&quot;&gt;ASM.js&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;asm.js&lt;&#x2F;strong&gt;, a strict subset of Javascript that can be used as a
low-level, efficient target language for compilers. This sublanguage
effectively describes a sandboxed virtual machine for memory-unsafe
languages like C or C++. A combination of static and dynamic
validation allows Javascript engines to employ an ahead-of-time (AOT)
optimizing compilation strategy for valid asm.js code.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;So an ASM.js program is a regular Javascript program. It is not a new
language but a subset of it. It can be executed by any Javascript
virtual machines. However, the specific usage of the magic statement
&lt;code&gt;&#x27;use asm&#x27;;&lt;&#x2F;code&gt; instructs the virtual machine to optimise the program with
an ASM.js “engine”.&lt;&#x2F;p&gt;
&lt;p&gt;ASM.js introduces types by using arithmetical operators as an annotation
system. For instance, &lt;code&gt;x | 0&lt;&#x2F;code&gt; annotes &lt;code&gt;x&lt;&#x2F;code&gt; to be an integer, &lt;code&gt;+x&lt;&#x2F;code&gt;
annotates &lt;code&gt;x&lt;&#x2F;code&gt; to be a double, and &lt;code&gt;fround(x)&lt;&#x2F;code&gt; annotates &lt;code&gt;x&lt;&#x2F;code&gt; to be a
float. The following example declares a function
&lt;code&gt;fn increment(x: u32) -&amp;gt; u32&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; increment&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;x&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Another important difference is that ASM.js works by module in order to
isolate them from Javascript. A module is a function that takes 3
arguments:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;stdlib&lt;&#x2F;code&gt;, an object with references to standard library APIs,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;foreign&lt;&#x2F;code&gt;, an object with user-defined functionalities (such as
sending something over a WebSocket),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;heap&lt;&#x2F;code&gt;, an array buffer representing the memory (because memory is
manually managed).&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;But it&#x27;s still Javascript. So the good news is that if your virtual
machine has no specific optimisations for ASM.js, it is executed as any
regular Javascript program. And if it does, then you get a pleasant
boost.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-asm-js-galaxy&#x2F;.&#x2F;asm-benchmarks.png&quot; alt=&quot;Graph&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;A graph showing 3 benchmarks running against different Javascript engines:
Firefox, Firefox + asm.js, Google, and native.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Remember that ASM.js has been designed to be a compilation target. So
normally you don&amp;#39;t have to care about that because it is the role of the
compiler. The typical compilation and execution pipeline from C or C++
to the Web looks like this:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-asm-js-galaxy&#x2F;.&#x2F;asm-pipeline.png&quot; alt=&quot;Pipeline&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Classical ASM.js compilation and execution pipeline from C or C++ to the Web.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;kripken.github.io&#x2F;emscripten-site&#x2F;&quot;&gt;Emscripten&lt;&#x2F;a&gt;, as seen in the
schema above, is a very important project in this whole evolution of the
Web platform. Emscripten is:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;a toolchain for compiling to asm.js and WebAssembly, built using LLVM,
that lets you run C and C++ on the web at near-native speed without
plugins.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;You are very likely to see this name one day or another if you work with
ASM.js or WebAssembly.&lt;&#x2F;p&gt;
&lt;p&gt;I will not explain deeply what ASM.js is with a lot of examples. I
recommend instead to read &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;johnresig.com&#x2F;blog&#x2F;asmjs-javascript-compile-target&#x2F;&quot;&gt;Asm.js: The Javascript Compile
Target&lt;&#x2F;a&gt; by
John Resig, or &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;kripken.github.io&#x2F;mloc_emscripten_talk&#x2F;&quot;&gt;Big Web app? Compile
it!&lt;&#x2F;a&gt; by Alon Zakai.&lt;&#x2F;p&gt;
&lt;p&gt;Our process will be different though. We will not compile our Rust code
directly to ASM.js, but instead, we will compile it to WebAssembly,
which in turn will be compiled into ASM.js.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;Rust 🚀 ASM.js&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-asm-js-galaxy&#x2F;.&#x2F;rust-to-asm-js.png&quot; alt=&quot;Rust to ASM.js&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;This episode will be very short, and somehow the most easiest one. To
compile Rust to ASM.js, you need to first compile it to WebAssembly
(&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;&quot;&gt;see the previous
episode&lt;&#x2F;a&gt;),
and then compile the WebAssembly binary into ASM.js.&lt;&#x2F;p&gt;
&lt;p&gt;Actually, ASM.js is mostly required when the browser does not support
WebAssembly, like Internet Explorer. It is essentially a fallback to run
our program on the Web.&lt;&#x2F;p&gt;
&lt;p&gt;The workflow is the following:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Compile your Rust project into WebAssembly,&lt;&#x2F;li&gt;
&lt;li&gt;Compile your WebAssembly binary into an ASM.js module,&lt;&#x2F;li&gt;
&lt;li&gt;Optimise and shrink the ASM.js module.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;binaryen&quot;&gt;The wasm2js tool&lt;&#x2F;a&gt; will be your
best companion to compile the WebAssembly binary into an ASM.js module.
It is part of Binaryen project. Then, assuming we have the WebAssembly
binary of our program, all we have to do is:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; wasm2js --pedantic --output gutenberg_post_parser.asm.js gutenberg_post_parser.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;At this step, the &lt;code&gt;gutenberg_post_parser.asm.js&lt;&#x2F;code&gt; weights 212kb. The file
contains ECMAScript 6 code. And remember that old browsers are
considered, like Internet Explorer, so the code needs to be transformed
a little bit. To optimise and shrink the ASM.js module, we will use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mishoo&#x2F;UglifyJS2&#x2F;tree&#x2F;harmony&quot;&gt;the
&lt;code&gt;uglify-es&lt;&#x2F;code&gt; tool&lt;&#x2F;a&gt;,
like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Transform code, and embed in a&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; sed -i &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;&amp;#39; &amp;#39;1s&#x2F;^&#x2F;function GUTENBERG_POST_PARSER_ASM_MODULE() {&#x2F;; s&#x2F;export &#x2F;&#x2F;&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; gutenberg_post_parser.asm.js&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;return { root, alloc, dealloc, memory }; }&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; gutenberg_post_parser.asm.js&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Shrink the code.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; uglifyjs --compress --mangle --output .temp.asm.js gutenberg_post_parser.asm.js&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; mv .temp.asm.js gutenberg_post_parser.asm.js&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Just like we did for the WebAssembly binary, we can compress the
resulting files with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.gzip.org&#x2F;&quot;&gt;&lt;code&gt;gzip&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;google&#x2F;brotli&quot;&gt;&lt;code&gt;brotli&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Compress.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; gzip --best --stdout gutenberg_post_parser.asm.js &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; gutenberg_post_parser.asm.js.gz&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; brotli --best --stdout&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; --lgwin&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;24&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; gutenberg_post_parser.asm.js&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; gutenberg_post_parser.asm.js.br&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We end up with the following file sizes:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.asm.js&lt;&#x2F;code&gt;: 54kb,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;.asm.js.gz&lt;&#x2F;code&gt;: 13kb,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;.asm.js.br&lt;&#x2F;code&gt;: 11kb.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;That&amp;#39;s again pretty small!&lt;&#x2F;p&gt;
&lt;p&gt;When you think about it, this is a lot of transformations: From Rust to
WebAssembly to Javascript&#x2F;ASM.js… The amount of tools is rather small
compared to the amount of work. It shows a well-designed pipeline and a
collaboration between many groups of people.&lt;&#x2F;p&gt;
&lt;p&gt;Aside: If you are reading this post, I assume you are developers. And as
such, I&amp;#39;m sure you can spend hours looking at a source code like if it
is a master painting. Did you ever wonder what a Rust program looks like
once compiled to Javascript? See bellow:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-asm-js-galaxy&#x2F;.&#x2F;rust-as-asm-js.png&quot; alt=&quot;Rust as ASM.js&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;A Rust program compiled as WebAssembly compiled as ASM.js.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;I like it probably too much.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;ASM.js 🚀 Javascript&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The resulting &lt;code&gt;gutenberg_post_parser.asm.js&lt;&#x2F;code&gt; file contains a single
function named &lt;code&gt;GUTENBERG_POST_PARSER_ASM_MODULE&lt;&#x2F;code&gt; which returns an
object pointing to 4 private functions:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;root&lt;&#x2F;code&gt;, the axiom of our grammar,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;alloc&lt;&#x2F;code&gt;, to allocate memory,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;dealloc&lt;&#x2F;code&gt;, to deallocate memory, and&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;memory&lt;&#x2F;code&gt;, the memory buffer.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;It sounds familiar if you have read &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;&quot;&gt;the previous episode with
WebAssembly&lt;&#x2F;a&gt;.
Don&amp;#39;t expect &lt;code&gt;root&lt;&#x2F;code&gt; to return a full AST: It will return a pointer to
the memory, and the data need to be encoded and decoded, and to write
into and to read from the memory the same way. Yes, the same way. &lt;em&gt;The
exact same way&lt;&#x2F;em&gt;. So the code of the boundary layer is strictly the same.
Do you remember the &lt;code&gt;Module&lt;&#x2F;code&gt; object in our WebAssembly Javascript
boundary? This is exactly what the &lt;code&gt;GUTENBERG_POST_PARSER_ASM_MODULE&lt;&#x2F;code&gt;
function returns. You can replace &lt;code&gt;Module&lt;&#x2F;code&gt; by the returned object, &lt;em&gt;et
voilà&lt;&#x2F;em&gt;!&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;asmjs&#x2F;bin&#x2F;gutenberg_post_parser.asm.mjs&quot;&gt;The entired code lands
here&lt;&#x2F;a&gt;.
It completely reuses the Javascript boundary layer for WebAssembly. It
just sets the &lt;code&gt;Module&lt;&#x2F;code&gt; differently, and it does not load the WebAssembly
binary. Consequently, the ASM.js boundary layer is made of 34 lines of
code, only 🙃. It compresses to 218 bytes.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-2&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We have seen that ASM.js can be fallback to WebAssembly in environments
that only support Javascript (like Internet Explorer), with or without
ASM.js optimisations.&lt;&#x2F;p&gt;
&lt;p&gt;The resulting ASM.js file and its boundary layer are quite small. By
design, the ASM.js boundary layer reuses almost the entire WebAssembly
boundary layer. Therefore there is again a tiny surface of code to
review and to maintain, which is helpful.&lt;&#x2F;p&gt;
&lt;p&gt;We have seen in the previous episode that Rust is very fast. We have
been able to observe the same statement for WebAssembly compared to the
actual Javascript parser for the Gutenberg project. However, is it still
true for the ASM.js module? In this case, ASM.js is a fallback, and like
all fallbacks, they are notably slower than the targeted
implementations. Let&amp;#39;s run the same benchmark but use the Rust parser as
an ASM.js module:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Document&lt;&#x2F;th&gt;&lt;th&gt;Javascript parser (ms)&lt;&#x2F;th&gt;&lt;th&gt;Rust parser as an ASM.js module (ms)&lt;&#x2F;th&gt;&lt;th&gt;speedup&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;demo-post.html&quot;&gt;&lt;code&gt;demo-post.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;15.368&lt;&#x2F;td&gt;&lt;td&gt;2.718&lt;&#x2F;td&gt;&lt;td&gt;× 6&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;shortcode-shortcomings.html&quot;&gt;&lt;code&gt;shortcode-shortcomings.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;31.022&lt;&#x2F;td&gt;&lt;td&gt;8.004&lt;&#x2F;td&gt;&lt;td&gt;× 4&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;redesigning-chrome-desktop.html&quot;&gt;&lt;code&gt;redesigning-chrome-desktop.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;106.416&lt;&#x2F;td&gt;&lt;td&gt;19.223&lt;&#x2F;td&gt;&lt;td&gt;× 6&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;web-at-maximum-fps.html&quot;&gt;&lt;code&gt;web-at-maximum-fps.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;82.92&lt;&#x2F;td&gt;&lt;td&gt;27.197&lt;&#x2F;td&gt;&lt;td&gt;× 3&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;early-adopting-the-future.html&quot;&gt;&lt;code&gt;early-adopting-the-future.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;119.880&lt;&#x2F;td&gt;&lt;td&gt;38.321&lt;&#x2F;td&gt;&lt;td&gt;× 3&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;pygmalian-raw-html.html&quot;&gt;&lt;code&gt;pygmalian-raw-html.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;349.075&lt;&#x2F;td&gt;&lt;td&gt;23.656&lt;&#x2F;td&gt;&lt;td&gt;× 15&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;moby-dick-parsed.html&quot;&gt;&lt;code&gt;moby-dick-parsed.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;2,543.75&lt;&#x2F;td&gt;&lt;td&gt;361.423&lt;&#x2F;td&gt;&lt;td&gt;× 7&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark between Javascript parser and Rust parser as an ASM.js module.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The ASM.js module of the Rust parser is in average 6 times faster than
the actual Javascript implementation. The median speedup is 6. That&amp;#39;s
far from the WebAssembly results, but this is a fallback, and in
average, it is 6 times faster, which is really great!&lt;&#x2F;p&gt;
&lt;p&gt;So not only the whole pipeline is safer because it starts from Rust, but
it ends to be faster than Javascript.&lt;&#x2F;p&gt;
&lt;p&gt;We will see in the next episodes of this series that Rust can reach a
lot of galaxies, and the more it travels, the more it gets interesting.&lt;&#x2F;p&gt;
&lt;p&gt;Thanks for reading!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>The WebAssembly galaxy</title>
          <pubDate>Wed, 22 Aug 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/series/from-rust-to-beyond/the-webassembly-galaxy/</link>
          <guid>https://mnt.io/series/from-rust-to-beyond/the-webassembly-galaxy/</guid>
          <description xml:base="https://mnt.io/series/from-rust-to-beyond/the-webassembly-galaxy/">&lt;p&gt;The first galaxy that our Rust parser will explore is the WebAssembly
(Wasm) galaxy. This post will explain what WebAssembly is, how to
compile the parser into WebAssembly, and how to use the WebAssembly
binary with Javascript in a browser and with NodeJS.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-webassembly-and-why&quot;&gt;What is WebAssembly, and why?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-is-webassembly-and-why&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;If you already know WebAssembly, you can skip this section.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;&quot;&gt;WebAssembly&lt;&#x2F;a&gt; defines itself as:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;WebAssembly (abbreviated &lt;em&gt;Wasm&lt;&#x2F;em&gt;) is a binary instruction format for a
stack-based virtual machine. Wasm is designed as a portable target for
compilation of high-level languages like C&#x2F;C++&#x2F;Rust, enabling
deployment on the web for client and server applications.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Should I say more? Probably, yes…&lt;&#x2F;p&gt;
&lt;p&gt;WebAssembly is a &lt;em&gt;new portable binary format&lt;&#x2F;em&gt;. Languages like C, C++, or
Rust already compiles to this target. It is the spirit successor of
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;asmjs.org&#x2F;&quot;&gt;ASM.js&lt;&#x2F;a&gt;. By spirit successor, I mean it is the same
people trying to extend the Web platform and to make the Web fast that
are working on both technologies. They share some design concepts too,
but that&#x27;s not really important right now.&lt;&#x2F;p&gt;
&lt;p&gt;Before WebAssembly, programs had to compile to Javascript in order to
run on the Web platform. The resulting files were most of the time
large. And because the Web is a network, the files had to be downloaded,
and it took time. WebAssembly is designed to be encoded in a size- and
load-time efficient &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;docs&#x2F;binary-encoding&#x2F;&quot;&gt;binary
format&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;WebAssembly is also faster than Javascript for many reasons. Despites
all the crazy optimisations engineers put in the Javascript virtual
machines, Javascript is a weakly and dynamically typed language, which
requires to be interpreted. WebAssembly aims to execute at native speed
by taking advantage of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;docs&#x2F;portability&#x2F;#assumptions-for-efficient-execution&quot;&gt;common hardware
capabilities&lt;&#x2F;a&gt;.
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hacks.mozilla.org&#x2F;2018&#x2F;01&#x2F;making-webassembly-even-faster-firefoxs-new-streaming-and-tiering-compiler&#x2F;&quot;&gt;WebAssembly also loads faster than
Javascript&lt;&#x2F;a&gt;
because parsing and compiling happen while the binary is streamed from
the network. So once the binary is entirely fetched, it is ready to run:
No need to wait on the parser and the compiler before running the
program.&lt;&#x2F;p&gt;
&lt;p&gt;Today, and our blog series is a perfect example of that, it is possible
to write a Rust program, and to compile it to run on the Web platform.
Why? Because WebAssembly is implemented by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;caniuse.com&#x2F;#search=wasm&quot;&gt;all major
browsers&lt;&#x2F;a&gt;, and because it has been
designed for the Web: To live and run on the Web platform (like a
browser). But its portable aspect and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;webassembly.org&#x2F;docs&#x2F;semantics&#x2F;#linear-memory&quot;&gt;its safe and sandboxed memory
design&lt;&#x2F;a&gt; make it a
good candidate to run outside of the Web platform (see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;geal&#x2F;serverless-wasm&quot;&gt;a serverless
Wasm framework&lt;&#x2F;a&gt;, or &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;losfair&#x2F;IceCore&quot;&gt;an
application container built for
Wasm&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;I think it is important to remind that WebAssembly is not here to
replace Javascript. It is just another technology which solves many
problems we can meet today, like load-time, safety, or speed.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;rust-rocket-webassembly&quot;&gt;Rust 🚀 WebAssembly&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#rust-rocket-webassembly&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;.&#x2F;rust-to-wasm.png&quot; alt=&quot;Rust to Wasm&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rustwasm&#x2F;team&quot;&gt;The Rust Wasm team&lt;&#x2F;a&gt; is a group of
people leading the effort of pushing Rust into WebAssembly with a set of
tools and integrations. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;rustwasm.github.io&#x2F;book&#x2F;&quot;&gt;There is a
book&lt;&#x2F;a&gt; explaining how to write a
WebAssembly program with Rust.&lt;&#x2F;p&gt;
&lt;p&gt;With the Gutenberg Rust parser, I didn&amp;#39;t use tools like
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rustwasm&#x2F;wasm-bindgen&#x2F;&quot;&gt;&lt;code&gt;wasm-bindgen&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; (which is a
pure gem) when I started the project few months ago because I hit some
limitations. Note that some of them have been addressed since then!
Anyway, we will do most of the work by hand, and I think this is an
excellent way to understand how things work in the background. When you
are familiar with WebAssembly interactions, then &lt;code&gt;wasm-bindgen&lt;&#x2F;code&gt; is an
excellent tool to have within easy reach, because it abstracts all the
interactions and let you focus on your code logic instead.&lt;&#x2F;p&gt;
&lt;p&gt;I would like to remind the reader that the Gutenberg Rust parser exposes
one AST, and one &lt;code&gt;root&lt;&#x2F;code&gt; function (the axiom of the grammar),
respectively defined as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;and&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Input&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nom&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Err&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Knowing that, let&amp;#39;s go!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;&quot;&gt;General design&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Here is our general design or workflow:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Javascript (for instance) writes the blog post to parse into the WebAssembly
module memory,&lt;&#x2F;li&gt;
&lt;li&gt;Javascript runs the &lt;code&gt;root&lt;&#x2F;code&gt; function by passing a pointer to the memory, and
the length of the blog post,&lt;&#x2F;li&gt;
&lt;li&gt;Rust reads the blog post from the memory, runs the Gutenberg parser, compiles
the resulting AST into a sequence of bytes, and returns the pointer to this
sequence of bytes to Javascript,&lt;&#x2F;li&gt;
&lt;li&gt;Javascript reads the memory from the received pointer, and decodes the
sequence of bytes as Javascript objects in order to recreate an AST with a
friendly API.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Why a sequence of bytes? Because WebAssembly only supports integers and
floats, not strings or vectors, and also because our Rust parser takes a
slice of bytes as input, so this is handy.&lt;&#x2F;p&gt;
&lt;p&gt;We use the term &lt;em&gt;boundary layer&lt;&#x2F;em&gt; to refer to this Javascript piece of
code responsible to read from and write into the WebAssembly module
memory, and responsible of exposing a friendly API.&lt;&#x2F;p&gt;
&lt;p&gt;Now, we will focus on the Rust code. It consists of only 4 functions:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;alloc&lt;&#x2F;code&gt; to allocate memory (exported),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;dealloc&lt;&#x2F;code&gt; to deallocate memory (exported),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;root&lt;&#x2F;code&gt; to run the parser (exported),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;into_bytes&lt;&#x2F;code&gt; to transform the AST into a sequence of bytes.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;wasm&#x2F;src&#x2F;lib.rs&quot;&gt;The entire code lands
here&lt;&#x2F;a&gt;.
It is approximately 150 lines of code. We explain it.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-1&quot;&gt;Memory allocation&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Let&amp;#39;s start by the memory allocator. I choose to use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rustwasm&#x2F;wee_alloc&quot;&gt;&lt;code&gt;wee_alloc&lt;&#x2F;code&gt; for
the memory allocator&lt;&#x2F;a&gt;. It is
specifically designed for WebAssembly by being very small (less than a
kilobyte) and efficient.&lt;&#x2F;p&gt;
&lt;p&gt;The following piece of code describes the memory allocator setup and the
“prelude” for our code (enabling some compiler features, like &lt;code&gt;alloc&lt;&#x2F;code&gt;,
declaring external crates, some aliases, and declaring required function
like &lt;code&gt;panic&lt;&#x2F;code&gt;, &lt;code&gt;oom&lt;&#x2F;code&gt; etc.). This can be considered as a boilerplate:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#![no_std]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#![feature(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    alloc,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    alloc_error_handler,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    core_intrinsics,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    lang_items&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; crate&lt;&#x2F;span&gt;&lt;span&gt; gutenberg_post_parser;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; crate&lt;&#x2F;span&gt;&lt;span&gt; wee_alloc;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[macro_use]&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; crate&lt;&#x2F;span&gt;&lt;span&gt; alloc;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; gutenberg_post_parser&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; alloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;vec&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Vec&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; core&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{mem, slice};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[global_allocator]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;static&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; ALLOC&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; wee_alloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;WeeAlloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; wee_alloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;WeeAlloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;INIT&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[panic_handler]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; panic&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;core&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;panic&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PanicInfo&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt; !&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; core&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;intrinsics&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;abort&lt;&#x2F;span&gt;&lt;span&gt;(); }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[alloc_error_handler]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; oom&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; core&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;alloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Layout&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt; !&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; core&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;intrinsics&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;abort&lt;&#x2F;span&gt;&lt;span&gt;(); }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; This is the definition of `std::ffi::c_void`, but Wasm runs without std in our case.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[repr(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u8&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[allow(non_camel_case_types)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_void&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    #[doc(hidden)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    __variant1&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    #[doc(hidden)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    __variant2&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The Rust memory is the WebAssembly memory. Rust will allocate and
deallocate memory on its own, but Javascript for instance needs to
allocate and deallocate WebAssembly memory in order to
communicate&#x2F;exchange data. So we need to export one function to allocate
memory and one function to deallocate memory.&lt;&#x2F;p&gt;
&lt;p&gt;Once again, this is almost a boilerplate. The &lt;code&gt;alloc&lt;&#x2F;code&gt; function creates
an empty vector of a specific capacity (because it is a linear segment
of memory), and returns a pointer to this empty vector:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;C&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; alloc&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;capacity&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_void&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;with_capacity&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;capacity&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_mut_ptr&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    mem&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;forget&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_void&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Note the &lt;code&gt;#[no_mangle]&lt;&#x2F;code&gt; attribute that instructs the Rust compiler to
not mangle the function name, i.e. to not rename it. And &lt;code&gt;extern &quot;C&quot;&lt;&#x2F;code&gt; to
export the function in the WebAssembly module, so it is “public” from
outside the WebAssembly binary.&lt;&#x2F;p&gt;
&lt;p&gt;The code is pretty straightforward and matches what we announced
earlier: A &lt;code&gt;Vec&lt;&#x2F;code&gt; is allocated with a specific capacity, and the pointer
to this vector is returned. The important part is &lt;code&gt;mem::forget(buffer)&lt;&#x2F;code&gt;.
It is required so that Rust will &lt;em&gt;not&lt;&#x2F;em&gt; deallocate the vector once it
goes out of scope. Indeed, Rust enforces &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Resource_acquisition_is_initialization&quot;&gt;Resource Acquisition Is
Initialization
(RAII)&lt;&#x2F;a&gt;,
so whenever an object goes out of scope, its destructor is called and
its owned resources are freed. This behavior shields against resource
leaks bugs, and this is why we will never have to manually free memory
or worry about memory leaks in Rust (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;rust-by-example&#x2F;scope&#x2F;raii.html&quot;&gt;see some RAII
examples&lt;&#x2F;a&gt;).
In this case, we want to allocate and keep the allocation after the
function execution, hence &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;mem&#x2F;fn.forget.html&quot;&gt;the &lt;code&gt;mem::forget&lt;&#x2F;code&gt;
call&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Let&amp;#39;s jump on the &lt;code&gt;dealloc&lt;&#x2F;code&gt; function. The goal is to recreate a vector
based on a pointer and a capacity, and to let Rust drops it:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;C&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; dealloc&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; c_void&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; capacity&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;from_raw_parts&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; capacity&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;vec&#x2F;struct.Vec.html#method.from_raw_parts&quot;&gt;The &lt;code&gt;Vec::from_raw_parts&lt;&#x2F;code&gt;
function&lt;&#x2F;a&gt;
is marked as unsafe, so we need to delimit it in an &lt;code&gt;unsafe&lt;&#x2F;code&gt; block so
that the &lt;code&gt;dealloc&lt;&#x2F;code&gt; function is considered as safe.&lt;&#x2F;p&gt;
&lt;p&gt;The variable &lt;code&gt;_&lt;&#x2F;code&gt; contains our data to deallocate, and it goes out of
scope immediately, so Rust drops it.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-2&quot;&gt;From input to a flat AST&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Now the core of the binding! The &lt;code&gt;root&lt;&#x2F;code&gt; function reads the blog post to
parse based on a pointer and a length, then it parses it. If the result
is OK, it serializes the AST into a sequence of bytes, i.e. it flatten
it, otherwise it returns an empty sequence of bytes.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;.&#x2F;flatten-ast.png&quot; alt=&quot;Flatten AST&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;The image illustrates the flow of the data: first off there is a blog post;
second there is the AST of the blog post; finally there is a linear byte-encoded
representation of the AST of the blog post.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The logic flow of the parser: The input on the left is parsed into an
AST, which is serialized into a flat sequence of bytes on the right.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[no_mangle]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extern&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;C&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; unsafe&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; slice&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;from_raw_parts&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; length&lt;&#x2F;span&gt;&lt;span&gt;) };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; vec!&lt;&#x2F;span&gt;&lt;span&gt;[];&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; let&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ok&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_remaining&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; gutenberg_post_parser&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Compile the AST (nodes) into a sequence of bytes.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;as_mut_ptr&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    mem&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;forget&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;output&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    pointer&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The variable &lt;code&gt;input&lt;&#x2F;code&gt; contains the blog post. It is fetched from memory
with a pointer and a length. The variable &lt;code&gt;output&lt;&#x2F;code&gt; is the sequence of
bytes the function will return. &lt;code&gt;gutenberg_post_parser::root(input)&lt;&#x2F;code&gt;
runs the parser. If parsing is OK, then the &lt;code&gt;nodes&lt;&#x2F;code&gt; are compiled into a
sequence of bytes (omitted for now). Then the pointer to the sequence of
bytes is grabbed, the Rust compiler is instructed to not drop it, and
finally the pointer is returned. The logic is again pretty
straightforward.&lt;&#x2F;p&gt;
&lt;p&gt;Now, let&amp;#39;s focus on the AST to the sequence of bytes (&lt;code&gt;u8&lt;&#x2F;code&gt;) compilation.
All data the AST hold are already bytes, which makes the process easier.
The goal is only to flatten the AST:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The first 4 bytes represent the number of nodes at the first level (4
× &lt;code&gt;u8&lt;&#x2F;code&gt; represents &lt;code&gt;u32&lt;&#x2F;code&gt;) ,&lt;&#x2F;li&gt;
&lt;li&gt;Next, if the node is &lt;code&gt;Block&lt;&#x2F;code&gt;:
&lt;ul&gt;
&lt;li&gt;The first byte is the node type: &lt;code&gt;1u8&lt;&#x2F;code&gt; for a block,&lt;&#x2F;li&gt;
&lt;li&gt;The second byte is the size of the block name,&lt;&#x2F;li&gt;
&lt;li&gt;The third to the sixth bytes are the size of the attributes,&lt;&#x2F;li&gt;
&lt;li&gt;The seventh byte is the number of node children the block has,&lt;&#x2F;li&gt;
&lt;li&gt;Next bytes are the block name,&lt;&#x2F;li&gt;
&lt;li&gt;Next bytes are the attributes (&lt;code&gt;&amp;amp;b&quot;null&quot;[..]&lt;&#x2F;code&gt; if none),&lt;&#x2F;li&gt;
&lt;li&gt;Next bytes are node children as a sequence of bytes,&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Next, if the node is &lt;code&gt;Phrase&lt;&#x2F;code&gt;:
&lt;ul&gt;
&lt;li&gt;The first byte is the node type: &lt;code&gt;2u8&lt;&#x2F;code&gt; for a phrase,&lt;&#x2F;li&gt;
&lt;li&gt;The second to the fifth bytes are the size of the phrase,&lt;&#x2F;li&gt;
&lt;li&gt;Next bytes are the phrase.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Here is the missing part of the &lt;code&gt;root&lt;&#x2F;code&gt; function:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;if&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; let&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ok&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_remaining&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; gutenberg_post_parser&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u32_to_u8s&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u32&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;nodes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;nodes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;nodes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;nodes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    for&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; in&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        into_bytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And here is the &lt;code&gt;into_bytes&lt;&#x2F;code&gt; function:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; into_bytes&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u8&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    match&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; ref&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; node_type&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u8&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; match&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                None&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 4&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u32_to_u8s&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u32&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node_type&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;name_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;number_of_children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;extend&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;b&amp;#39;&#x2F;&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;extend&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            if&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; let&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;extend&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; else&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;extend&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;b&amp;quot;null&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;..&lt;&#x2F;span&gt;&lt;span&gt;]);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            for&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; child&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; in&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;                into_bytes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;child&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; node_type&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u8&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;node_type&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u32_to_u8s&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u32&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase_length_as_u8s&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;extend&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What I find interesting with this code is it reads just like the bullet
list above the code.&lt;&#x2F;p&gt;
&lt;p&gt;For the most curious, here is the &lt;code&gt;u32_to_u8s&lt;&#x2F;code&gt; function:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u32_to_u8s&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u32&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ((&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 24&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0xff&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ((&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 16&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0xff&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ((&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 8&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0xff&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0xff&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u8&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here we are. &lt;code&gt;alloc&lt;&#x2F;code&gt;, &lt;code&gt;dealloc&lt;&#x2F;code&gt;, &lt;code&gt;root&lt;&#x2F;code&gt;, and &lt;code&gt;into_bytes&lt;&#x2F;code&gt;. Four
functions, and everything is done.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-3&quot;&gt;Producing and optimising the WebAssembly binary&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;To get a WebAssembly binary, the project has to be compiled to the
&lt;code&gt;wasm32-unknown-unknown&lt;&#x2F;code&gt; target. For now (and it will change in a near
future), the nightly toolchain is needed to compile the project, so make
sure you have the latest nightly version of &lt;code&gt;rustc&lt;&#x2F;code&gt; &amp;amp; co. installed with
&lt;code&gt;rustup update nightly&lt;&#x2F;code&gt;. Let&amp;#39;s run &lt;code&gt;cargo&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; RUSTFLAGS&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;-g&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; cargo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; +nightly build&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --target&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; wasm32-unknown-unknown&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --release&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The WebAssembly binary weights 22kb. Our goal is to reduce the file
size. For that, the following tools will be required:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;alexcrichton&#x2F;wasm-gc&quot;&gt;&lt;code&gt;wasm-gc&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; to garbage-collect unused
imports, internal functions, types etc.,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rustwasm&#x2F;wasm-snip&quot;&gt;&lt;code&gt;wasm-snip&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; to mark some functions as
unreachable, this is useful when the binary includes unused code that the
linker were not able to remove,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;wasm-opt&lt;&#x2F;code&gt; from the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;binaryen&quot;&gt;Binaryen
project&lt;&#x2F;a&gt;, to optimise the
binary,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.gzip.org&#x2F;&quot;&gt;&lt;code&gt;gzip&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;google&#x2F;brotli&quot;&gt;&lt;code&gt;brotli&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; to compress the binary.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Basically, what we do is the following:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Garbage-collect unused data.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; wasm-gc gutenberg_post_parser.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Mark fmt and panicking as unreachable.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; wasm-snip --snip-rust-fmt-code --snip-rust-panicking-code gutenberg_post_parser.wasm -o gutenberg_post_parser_snipped.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; mv gutenberg_post_parser_snipped.wasm gutenberg_post_parser.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Garbage-collect unreachable data.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; wasm-gc gutenberg_post_parser.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Optimise &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;for&lt;&#x2F;span&gt;&lt;span&gt; small size.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; wasm-opt -Oz -o gutenberg_post_parser_opt.wasm gutenberg_post_parser.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; mv gutenberg_post_parser_opt.wasm gutenberg_post_parser.wasm&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; # Compress.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; gzip --best --stdout gutenberg_post_parser.wasm &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; gutenberg_post_parser.wasm.gz&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; brotli --best --stdout&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; --lgwin&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;24&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; gutenberg_post_parser.wasm&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; gutenberg_post_parser.wasm.br&lt;&#x2F;span&gt;&lt;span&gt; &lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We end up with the following file sizes:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.wasm&lt;&#x2F;code&gt;: 16kb,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;.wasm.gz&lt;&#x2F;code&gt;: 7.3kb,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;.wasm.br&lt;&#x2F;code&gt;: 6.2kb.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Neat! &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;caniuse.com&#x2F;#search=brotli&quot;&gt;Brotli is implemented by most
browsers&lt;&#x2F;a&gt;, so when the client sends
&lt;code&gt;Accept-Encoding: br&lt;&#x2F;code&gt;, the server can response with the &lt;code&gt;.wasm.br&lt;&#x2F;code&gt; file.&lt;&#x2F;p&gt;
&lt;p&gt;To give you a feeling of what 6.2kb represent, the following image also
weights 6.2kb:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;.&#x2F;image-example.png&quot; alt=&quot;The WordPress&amp;#39;s logo&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;An image that is as weight as our compressed WebAssembly module.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The WebAssembly binary is ready to run!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-4&quot;&gt;WebAssembly 🚀 Javascript&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-4&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;.&#x2F;wasm-to-js.png&quot; alt=&quot;Wasm to JS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;In this section, we assume Javascript runs in a browser. Thus, what we
need to do is the following:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Load&#x2F;stream and instanciate the WebAssembly binary,&lt;&#x2F;li&gt;
&lt;li&gt;Write the blog post to parse in the WebAssembly module memory,&lt;&#x2F;li&gt;
&lt;li&gt;Call the &lt;code&gt;root&lt;&#x2F;code&gt; function on the parser,&lt;&#x2F;li&gt;
&lt;li&gt;Read the WebAssembly module memory to load the flat AST (a sequence of bytes)
and decode it to build a “Javascript AST” (with our own objects).&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;wasm&#x2F;bin&#x2F;gutenberg_post_parser.mjs&quot;&gt;The entire code lands
here&lt;&#x2F;a&gt;.
It is approximately 150 lines of code too. I won&amp;#39;t explain the whole
code since some parts of it is the “friendly API” that is exposed to the
user. So I will rather explain the major pieces.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-5&quot;&gt;Loading&#x2F;streaming and instanciating&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-5&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;JavaScript&#x2F;Reference&#x2F;Global_Objects&#x2F;WebAssembly&quot;&gt;The &lt;code&gt;WebAssembly&lt;&#x2F;code&gt;
API&lt;&#x2F;a&gt;
exposes multiple ways to load a WebAssembly binary. The best you can use
is &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;JavaScript&#x2F;Reference&#x2F;Global_Objects&#x2F;WebAssembly&#x2F;instantiateStreaming&quot;&gt;the &lt;code&gt;WebAssembly.instanciateStreaming&lt;&#x2F;code&gt;
function&lt;&#x2F;a&gt;:
It streams the binary and compiles it in the same time, nothing is
blocking. This API relies on &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;API&#x2F;Fetch_API&quot;&gt;the &lt;code&gt;Fetch&lt;&#x2F;code&gt;
API&lt;&#x2F;a&gt;. You
might have guessed it: It is asynchronous (it returns a promise).
WebAssembly itself is not asynchronous (except if you use thread), but
the instanciation step is. It is possible to avoid that, but this is
tricky, and Google Chrome has a strong limit of 4kb for the binary size
which will make you give up quickly.&lt;&#x2F;p&gt;
&lt;p&gt;To be able to stream the WebAssembly binary, the server must send the
&lt;code&gt;application&#x2F;wasm&lt;&#x2F;code&gt; MIME type (with the &lt;code&gt;Content-Type&lt;&#x2F;code&gt; header).&lt;&#x2F;p&gt;
&lt;p&gt;Let&amp;#39;s instanciate our WebAssembly:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; url&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;&#x2F;gutenberg_post_parser.wasm&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; wasm&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    WebAssembly&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        instantiateStreaming&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;fetch&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;url&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {})&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        then&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;object&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; object&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;instance&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        then&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* step 2 *&#x2F;&lt;&#x2F;span&gt;&lt;span&gt; })&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The WebAssembly binary has been instanciated! Now we can move to the
next step.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-6&quot;&gt;Last polish before running the parser&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-6&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Remember that the WebAssembly binary exports 3 functions: &lt;code&gt;alloc&lt;&#x2F;code&gt;,
&lt;code&gt;dealloc&lt;&#x2F;code&gt;, and &lt;code&gt;root&lt;&#x2F;code&gt;. They can be found on the &lt;code&gt;exports&lt;&#x2F;code&gt; property,
along with the memory. Let&amp;#39;s write that:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        then&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                alloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;alloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                dealloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;dealloc&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                root&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;root&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; instance&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;exports&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;memory&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;            runParser&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;&amp;lt;!-- wp:foo &#x2F;--&amp;gt;xyz&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        })&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Great, everything is ready to write the &lt;code&gt;runParser&lt;&#x2F;code&gt; function!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-7&quot;&gt;The parser runner&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-7&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;As a reminder, this function has to: Write the &lt;code&gt;input&lt;&#x2F;code&gt; (the blog post to
parse) in the WebAssembly module memory (&lt;code&gt;Module.memory&lt;&#x2F;code&gt;), to call the
&lt;code&gt;root&lt;&#x2F;code&gt; function (&lt;code&gt;Module.root&lt;&#x2F;code&gt;), and to read the result from the
WebAssembly module memory. Let&amp;#39;s do that:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; runParser&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; raw_input&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; TextEncoder&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;encode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;raw_input&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input_pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; writeBuffer&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output_pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input_pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;length)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; readNodes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output_pointer&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;dealloc&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input_pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;length)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; result&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In details:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;raw_input&lt;&#x2F;code&gt; is encoded into a sequence of bytes with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;API&#x2F;TextEncoder&quot;&gt;the
&lt;code&gt;TextEncoder&lt;&#x2F;code&gt;API&lt;&#x2F;a&gt;,
in &lt;code&gt;input&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;The input is written into the WebAssembly memory module with
&lt;code&gt;writeBuffer&lt;&#x2F;code&gt; and its pointer is returned,&lt;&#x2F;li&gt;
&lt;li&gt;Then the &lt;code&gt;root&lt;&#x2F;code&gt; function is called with the pointer to the input and
the length of the input as expected, and the pointer to the output is
returned,&lt;&#x2F;li&gt;
&lt;li&gt;Then the output is decoded,&lt;&#x2F;li&gt;
&lt;li&gt;And finally, the input is deallocated. The output of the parser will
be deallocated in the &lt;code&gt;readNodes&lt;&#x2F;code&gt; function because its length is
unknown at this step.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Great! So we have 2 functions to write right now: &lt;code&gt;writeBuffer&lt;&#x2F;code&gt;​ and
&lt;code&gt;readNodes&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-8&quot;&gt;Writing the data in memory&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-8&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Let&amp;#39;s go with the first one, &lt;code&gt;writeBuffer&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; writeBuffer&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;alloc&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer_length&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Uint8Array&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    for&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ++&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;i&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        memory&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; i&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;i&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In details:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The length of the buffer is read in &lt;code&gt;buffer_length&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;A space in memory is allocated to write the buffer,&lt;&#x2F;li&gt;
&lt;li&gt;Then a &lt;code&gt;uint8&lt;&#x2F;code&gt; view of the buffer is instanciated, which means that
the buffer will be viewed as a sequence of &lt;code&gt;u8&lt;&#x2F;code&gt;, exactly what Rust
expects,&lt;&#x2F;li&gt;
&lt;li&gt;Finally the buffer is copied into the memory with a loop, that&amp;#39;s very
basic, and return the pointer.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Note that, unlike C strings, adding a &lt;code&gt;NUL&lt;&#x2F;code&gt; byte at the end is not
mandatory. This is just the raw data (on the Rust side, we read it with
&lt;code&gt;slice::from_raw_parts&lt;&#x2F;code&gt;, slice is a very simple structure).&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-9&quot;&gt;Reading the output of the parser&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-9&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;So at this step, the input has been written in memory, and the &lt;code&gt;root&lt;&#x2F;code&gt;
function has been called so it means the parser has run. It has returned
a pointer to the output (the result) and we now have to read it and
decode it.&lt;&#x2F;p&gt;
&lt;p&gt;Remind that the first 4 bytes encodes the number of nodes we have to
read. Let&amp;#39;s go!&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; readNodes&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; start_pointer&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Uint8Array&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;memory&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;slice&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;start_pointer&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u8s_to_u32&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;])&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_nodes&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; []&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 4&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; end_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    for&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ++&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;i&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; last_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; readNode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; end_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; last_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    Module&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;dealloc&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;start_pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; start_pointer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; end_offset&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In details:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A &lt;code&gt;uint8&lt;&#x2F;code&gt; view of the memory is instanciated… more precisely: A slice
of the memory starting at &lt;code&gt;start_pointer&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;The number of nodes is read, then all nodes are read,&lt;&#x2F;li&gt;
&lt;li&gt;And finally, the output of the parser is deallocated.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;For the record, here is the &lt;code&gt;u8s_to_u32&lt;&#x2F;code&gt; function, this is the exact
opposite of &lt;code&gt;u32_to_u8s&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u8s_to_u32&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; p&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; q&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; r&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;o&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 24&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 16&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;q&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 8&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; r&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And I will also share the &lt;code&gt;readNode&lt;&#x2F;code&gt; function, but I won&amp;#39;t explain the
details. This is just the decoding part of the output from the parser.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; readNode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; nodes&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; node_type&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Block.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    if&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ===&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; node_type&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u8s_to_u32&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 3&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 4&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 5&lt;&#x2F;span&gt;&lt;span&gt;])&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 6&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 7&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; next_payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; TextDecoder&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;decode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;slice&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; next_payload_offset&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; next_payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        next_payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; JSON&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; TextDecoder&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;decode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;slice&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; next_payload_offset&lt;&#x2F;span&gt;&lt;span&gt;)))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; next_payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; end_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; []&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        for&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ++&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;i&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; last_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; readNode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            payload_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; end_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; last_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Block&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; end_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Phrase.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    else if&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ===&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; node_type&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; u8s_to_u32&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 3&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; buffer&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 4&lt;&#x2F;span&gt;&lt;span&gt;])&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 5&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        const&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; TextDecoder&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;decode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;buffer&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;slice&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_length&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        nodes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_offset&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; +&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase_length&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; else&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;unknown node type&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; node_type&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Note that this code is pretty simple and easy to optimise by the
Javascript virtual machine. It is almost important to note that this is
not the original code. The original version is a little more optimised
here and there, but they are very close.&lt;&#x2F;p&gt;
&lt;p&gt;And that&amp;#39;s all! We have successfully read and decoded the output of the
parser! We just need to write the &lt;code&gt;Block&lt;&#x2F;code&gt; and &lt;code&gt;Phrase&lt;&#x2F;code&gt; classes like
this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    constructor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt; children&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; name&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; children&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Phrase&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    constructor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;phrase&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The final output will be an array of those objects. Easy!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-10&quot;&gt;WebAssembly 🚀 NodeJS&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-10&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;the-webassembly-galaxy&#x2F;.&#x2F;wasm-to-nodejs.png&quot; alt=&quot;Wasm to NodeJS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The differences between the Javascript version and the NodeJS version
are few:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;Fetch&lt;&#x2F;code&gt; API does not exist in NodeJS, so the WebAssembly binary
has to be instanciated with a buffer directly, like this:
&lt;code&gt;WebAssembly.instantiate(fs.readFileSync(url), {})&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;The &lt;code&gt;TextEncoder&lt;&#x2F;code&gt; and &lt;code&gt;TextDecoder&lt;&#x2F;code&gt; objects do not exist as global
objects, they are in &lt;code&gt;util.TextEncoder&lt;&#x2F;code&gt; and &lt;code&gt;util.TextDecoder&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;In order to share the code between both environments, it is possible to
write the boundary layer (the Javascript code we wrote) in a &lt;code&gt;.mjs&lt;&#x2F;code&gt;
file, aka ECMAScript Module. It allows to write something like
&lt;code&gt;import { Gutenberg_Post_Parser } from &#x27;.&#x2F;gutenberg_post_parser.mjs&#x27;&lt;&#x2F;code&gt;
for example (considering the whole code we wrote before is a class). On
the browser side, the script must be loaded
with&lt;code&gt;&amp;lt;script type=&quot;module&quot; src=&quot;…&quot; &#x2F;&amp;gt;&lt;&#x2F;code&gt;, and on the NodeJS side, &lt;code&gt;node&lt;&#x2F;code&gt;
must run with the &lt;code&gt;--experimental-modules&lt;&#x2F;code&gt; flag. I can recommend you
this talk &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=35ZMoH8T-gc&amp;amp;index=4&amp;amp;list=PLOkMRkzDhWGX_4YWI4ZYGbwFPqKnDRudf&amp;amp;t=0s&quot;&gt;&lt;em&gt;Please wait… loading: a tale of two loaders&lt;&#x2F;em&gt; by Myles
Borins&lt;&#x2F;a&gt;
at the JSConf EU 2018 to understand all the story about that.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&#x2F;blob&#x2F;master&#x2F;bindings&#x2F;wasm&#x2F;bin&#x2F;index.mjs&quot;&gt;The entire code lands
here&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-11&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-11&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We have seen in details how to write a real world parser in Rust, how to
compile it into a WebAssembly binary, and how to use it with Javascript
and with NodeJS.&lt;&#x2F;p&gt;
&lt;p&gt;The parser can be used in a browser with regular Javascript code, or as
a CLI with NodeJS, or on any platforms NodeJS supports.&lt;&#x2F;p&gt;
&lt;p&gt;The Rust part for WebAssembly plus the Javascript part totals 313 lines
of code. This is a tiny surface of code to review and to maintain
compared to writing a Javascript parser from scratch.&lt;&#x2F;p&gt;
&lt;p&gt;Another argument is the safety and performance. Rust is memory safe, we
know that. It is also performant, but is it still true for the
WebAssembly target? The following table shows the benchmark results of
the actual Javascript parser for the Gutenberg project (implemented with
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;pegjs.org&#x2F;&quot;&gt;PEG.js&lt;&#x2F;a&gt;), against this project: The Rust parser as
a WebAssembly binary.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Document&lt;&#x2F;th&gt;&lt;th&gt;Javascript parser (ms)&lt;&#x2F;th&gt;&lt;th&gt;Rust parser as a WebAssembly binary (ms)&lt;&#x2F;th&gt;&lt;th&gt;speedup&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;demo-post.html&quot;&gt;&lt;code&gt;demo-post.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;13.167&lt;&#x2F;td&gt;&lt;td&gt;0.252&lt;&#x2F;td&gt;&lt;td&gt;× 52&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;shortcode-shortcomings.html&quot;&gt;&lt;code&gt;shortcode-shortcomings.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;26.784&lt;&#x2F;td&gt;&lt;td&gt;0.271&lt;&#x2F;td&gt;&lt;td&gt;× 98&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;redesigning-chrome-desktop.html&quot;&gt;&lt;code&gt;redesigning-chrome-desktop.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;75.500&lt;&#x2F;td&gt;&lt;td&gt;0.918&lt;&#x2F;td&gt;&lt;td&gt;× 82&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;web-at-maximum-fps.html&quot;&gt;&lt;code&gt;web-at-maximum-fps.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;88.118&lt;&#x2F;td&gt;&lt;td&gt;0.901&lt;&#x2F;td&gt;&lt;td&gt;× 98&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;early-adopting-the-future.html&quot;&gt;&lt;code&gt;early-adopting-the-future.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;201.011&lt;&#x2F;td&gt;&lt;td&gt;3.329&lt;&#x2F;td&gt;&lt;td&gt;× 60&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;pygmalian-raw-html.html&quot;&gt;&lt;code&gt;pygmalian-raw-html.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;311.416&lt;&#x2F;td&gt;&lt;td&gt;2.692&lt;&#x2F;td&gt;&lt;td&gt;× 116&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;dmsnell&#x2F;gutenberg-document-library&#x2F;master&#x2F;library&#x2F;moby-dick-parsed.html&quot;&gt;&lt;code&gt;moby-dick-parsed.html&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&lt;td&gt;2,466.533&lt;&#x2F;td&gt;&lt;td&gt;25.14&lt;&#x2F;td&gt;&lt;td&gt;× 98&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmarks between Javascript parser and Rust parser as a WebAssembly binary.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The WebAssembly binary is in average 86 times faster than the actual
Javascript implementation. The median of the speedup is 98. Some edge
cases are very interesting, like &lt;code&gt;moby-dick-parsed.html&lt;&#x2F;code&gt; where it takes
2.5s with the Javascript parser against 25ms with WebAssembly.&lt;&#x2F;p&gt;
&lt;p&gt;So not only it is safer, but it is faster than Javascript in this case.
And it is only 300 lines of code.&lt;&#x2F;p&gt;
&lt;p&gt;Note that WebAssembly does not support SIMD yet: It is still &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;WebAssembly&#x2F;simd&#x2F;blob&#x2F;master&#x2F;proposals&#x2F;simd&#x2F;SIMD.md&quot;&gt;a
proposal&lt;&#x2F;a&gt;.
Rust is gently supporting it (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rust-lang-nursery&#x2F;stdsimd&#x2F;pull&#x2F;549&quot;&gt;example with PR
#549&lt;&#x2F;a&gt;). It will
dramatically improve the performances!&lt;&#x2F;p&gt;
&lt;p&gt;We will see in the next episodes of this series that Rust can reach a
lot of galaxies, and the more it travels, the more it gets interesting.&lt;&#x2F;p&gt;
&lt;p&gt;Thanks for reading!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Prelude</title>
          <pubDate>Tue, 21 Aug 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/series/from-rust-to-beyond/prelude/</link>
          <guid>https://mnt.io/series/from-rust-to-beyond/prelude/</guid>
          <description xml:base="https://mnt.io/series/from-rust-to-beyond/prelude/">&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;automattic.com&#x2F;&quot;&gt;At my work&lt;&#x2F;a&gt;, I had an opportunity to start an
experiment: Writing a single parser implementation in Rust for &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;WordPress&#x2F;gutenberg&quot;&gt;the new
Gutenberg post format&lt;&#x2F;a&gt;, bound to
many platforms and environments.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;prelude&#x2F;.&#x2F;gutenberg.png&quot; alt=&quot;Gutenberg&amp;#39;s logo&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Gutenberg&amp;#39;s logo.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;This series of posts is about those bindings, and explains how to send
Rust beyond earth, into many different galaxies.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;The Gutenberg post format&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Let&amp;#39;s introduce quickly what Gutenberg is, and why a new post format. If
you want an in-depth presentation, I highly recommend to read &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;lamda.blog&#x2F;2018&#x2F;04&#x2F;22&#x2F;the-language-of-gutenberg&#x2F;&quot;&gt;The
Language of
Gutenberg&lt;&#x2F;a&gt;.
Note that this is &lt;em&gt;not&lt;&#x2F;em&gt; required for the reader to understand the
Gutenberg post format.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;WordPress&#x2F;gutenberg&quot;&gt;Gutenberg&lt;&#x2F;a&gt; is the next
WordPress editor. It is a little revolution on its own. The features it
unlocks are very powerful.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;The editor will create a new page- and post-building experience that
makes writing rich posts effortless, and has “blocks” to make it easy
what today might take shortcodes, custom HTML, or “mystery meat” embed
discovery. — Matt Mullenweg&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;The format of a blog post was HTML. And it continues to be. However,
another semantics layer is added through annotations. Annotations are
written in comments and borrow the XML syntax, e.g.:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;xml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&amp;lt;!-- wp:ns&#x2F;block-name {&amp;quot;attributes&amp;quot;: &amp;quot;as JSON&amp;quot;} --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;  &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;phrase&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&amp;lt;!-- &#x2F;wp:ns&#x2F;block-name --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The Gutenberg format provides 2 constructions: Block, and Phrase. The
example above contains both: There is a block wrapping a phrase. A
phrase is basically anything that is not a block. Let&amp;#39;s describe the
example:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;It starts with an annotation (&lt;code&gt;&amp;lt;!-- … --&amp;gt;&lt;&#x2F;code&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;The &lt;code&gt;wp:&lt;&#x2F;code&gt; is mandatory to represent a Gutenberg block,&lt;&#x2F;li&gt;
&lt;li&gt;It is followed by a fully qualified block name, which is a pair of an optional
namespace (here sets to &lt;code&gt;ns&lt;&#x2F;code&gt; , defaults to &lt;code&gt;core&lt;&#x2F;code&gt;) and a block name (here
sets to &lt;code&gt;block-name&lt;&#x2F;code&gt;), separated by a slash,&lt;&#x2F;li&gt;
&lt;li&gt;A block has optional attributes encoded as a JSON object (see
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc7159&quot;&gt;RFC 7159, Section 4, Objects&lt;&#x2F;a&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;Finally, a block has optional children, i.e. a heterogeneous collection of
blocks or phrases. In the example above, there is one child that is the phrase
&lt;code&gt;&amp;lt;p&amp;gt;phrase&amp;lt;&#x2F;p&amp;gt;&lt;&#x2F;code&gt;. And the following example below shows a block with no child:&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;xml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&amp;lt;!-- wp:ns&#x2F;block-name {&amp;quot;attributes&amp;quot;: &amp;quot;as JSON&amp;quot;} &#x2F;--&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The complete grammar can be found in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hywan.github.io&#x2F;gutenberg-parser-rs&#x2F;gutenberg_post_parser&#x2F;parser&#x2F;index.html&quot;&gt;the parser&amp;#39;s
documentation&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, the parser is used on the &lt;em&gt;editor&lt;&#x2F;em&gt; side, not on the &lt;em&gt;rendering&lt;&#x2F;em&gt;
side. Once rendered, the blog post is a regular HTML file. Some blocks
are dynamics though, but this is another topic.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;prelude&#x2F;.&#x2F;block-logic-flow.png&quot; alt=&quot;Block logic flow&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;The logic flow of the editor (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;make.wordpress.org&#x2F;core&#x2F;2017&#x2F;05&#x2F;05&#x2F;editor-how-little-blocks-work&#x2F;&quot;&gt;How Little Blocks
Work&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The grammar is relatively small. The challenges are however to be as
much performant and memory efficient as possible on many platforms. Some
posts can reach megabytes, and we don&amp;#39;t want the parser to be the
bottleneck. Even if it is used when creating the post state (cf. the
schema above), we have measured several seconds to load some posts. Time
during which the user is blocked, and waits, or see an error. In other
scenarii, we have hit memory limit of the language&amp;#39;s virtual machines.&lt;&#x2F;p&gt;
&lt;p&gt;Hence this experimental project! The current parsers are written in
JavaScript (with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;pegjs.org&#x2F;&quot;&gt;PEG.js&lt;&#x2F;a&gt;) and in PHP (with
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;nylen&#x2F;phpegjs&quot;&gt;&lt;code&gt;phpegjs&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;). This Rust project
proposes a parser written in Rust, that can run in the JavaScript and in
the PHP virtual machines, and on many other platforms. Let&amp;#39;s try to be
very performant and memory efficient!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;Why Rust?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;That&amp;#39;s an excellent question! Thanks for asking. I can summarize my
choice with a bullet list:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;It is fast, and we need speed,&lt;&#x2F;li&gt;
&lt;li&gt;It is memory safe, and also memory efficient,&lt;&#x2F;li&gt;
&lt;li&gt;No garbage collector, which simplifies memory management across
environments,&lt;&#x2F;li&gt;
&lt;li&gt;It can expose a C API (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;ffi&#x2F;index.html&quot;&gt;with Foreign Function Interface,
FFI&lt;&#x2F;a&gt;), which eases the
integration into multiple environments,&lt;&#x2F;li&gt;
&lt;li&gt;It compiles to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;nightly&#x2F;rustc&#x2F;platform-support.html&quot;&gt;many
targets&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;Because I love it.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;One of the goal of the experimentation is to maintain a single
implementation (maybe the future reference implementation) with multiple
bindings.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-2&quot;&gt;The parser&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The parser is written in Rust. It relies on the fabulous &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Geal&#x2F;nom&#x2F;&quot;&gt;nom
library&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;prelude&#x2F;.&#x2F;nom.png&quot; alt=&quot;nom&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;&lt;em&gt;nom will happily take a byte out of your files&lt;&#x2F;em&gt; 🙂&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The source code is available in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;gutenberg-parser-rs&quot;&gt;the &lt;code&gt;src&#x2F;&lt;&#x2F;code&gt; directory in the
repository&lt;&#x2F;a&gt;. It is very
small and fun to read.&lt;&#x2F;p&gt;
&lt;p&gt;The parser produces an Abstract Syntax Tree (AST) of the grammar, where
nodes of the tree are defined as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Phrase&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;a&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That&amp;#39;s all! We find again the block name, the attributes and the
children, and the phrase. Block children are defined as a collection of
node, this is recursive. &lt;code&gt;Input&amp;lt;&#x27;a&amp;gt;&lt;&#x2F;code&gt; is defined as &lt;code&gt;&amp;amp;&#x27;a [u8]&lt;&#x2F;code&gt;, i.e. a
slice of bytes.&lt;&#x2F;p&gt;
&lt;p&gt;The main parser entry is &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hywan.github.io&#x2F;gutenberg-parser-rs&#x2F;gutenberg_post_parser&#x2F;fn.root.html&quot;&gt;the &lt;code&gt;root&lt;&#x2F;code&gt;
function&lt;&#x2F;a&gt;.
It represents the axiom of the grammar, and is defined as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Input&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; nom&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Err&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Input&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So the parser returns a collection of nodes in the best case. Here is an
simple example:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; gutenberg_post_parser&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{root,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; input&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;b&amp;quot;&amp;lt;!-- wp:foo {&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;bar&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;: true} &#x2F;--&amp;gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;..&lt;&#x2F;span&gt;&lt;span&gt;];&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ok&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; The remaining data.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;b&amp;quot;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;..&lt;&#x2F;span&gt;&lt;span&gt;],&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; The Abstract Syntax Tree.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;        vec!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;            Node&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Block&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;b&amp;quot;core&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;..&lt;&#x2F;span&gt;&lt;span&gt;],&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;b&amp;quot;foo&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;..&lt;&#x2F;span&gt;&lt;span&gt;]),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                attributes&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;b&amp;quot;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;bar&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;: true}&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;..&lt;&#x2F;span&gt;&lt;span&gt;]),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                children&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; vec!&lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;root&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;input&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; output&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;root&lt;&#x2F;code&gt; function and the AST will be the items we are going to use
and manipulate in the bindings. The internal items of the parser will
stay private.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-3&quot;&gt;Bindings&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;from-rust-to-beyond&#x2F;prelude&#x2F;.&#x2F;rust-to.png&quot; alt=&quot;Rust to&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;From now, our goal is to expose the &lt;code&gt;root&lt;&#x2F;code&gt; function and the &lt;code&gt;Node&lt;&#x2F;code&gt; enum
in different platforms or environments. Ready?&lt;&#x2F;p&gt;
&lt;p&gt;3… 2… 1… lift-off!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>How Automattic (WordPress.com &amp; co.) partly moved away from PHPUnit to atoum?</title>
          <pubDate>Mon, 26 Feb 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/how-automattic-partly-moved-away-from-phpunit-to-atoum/</link>
          <guid>https://mnt.io/articles/how-automattic-partly-moved-away-from-phpunit-to-atoum/</guid>
          <description xml:base="https://mnt.io/articles/how-automattic-partly-moved-away-from-phpunit-to-atoum/">&lt;p&gt;Hello fellow developers and testers,&lt;&#x2F;p&gt;
&lt;p&gt;Few months ago at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;automattic.com&#x2F;&quot;&gt;Automattic&lt;&#x2F;a&gt;, my team and I
started a new project: &lt;strong&gt;Having better tests for the payment system&lt;&#x2F;strong&gt;.
The payment system is used by all the services at Automattic, i.e.
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wordpress.com&#x2F;&quot;&gt;WordPress&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;vaultpress.com&#x2F;&quot;&gt;VaultPress&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;jetpack.com&#x2F;&quot;&gt;Jetpack&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;akismet.com&#x2F;&quot;&gt;Akismet&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;polldaddy.com&#x2F;&quot;&gt;PollDaddy&lt;&#x2F;a&gt; etc.
It&#x27;s a big challenge! Cherry on the cake: Our experiment could define
the future of the testing practices for the entire company. No pressure.&lt;&#x2F;p&gt;
&lt;p&gt;This post is a summary about what have been accomplished so far, the
achievements, the failures, and the future, focused around manual tests.
As the title of this post suggests, we are going to talk about
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;phpunit.de&#x2F;&quot;&gt;PHPUnit&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;atoum.org&#x2F;&quot;&gt;atoum&lt;&#x2F;a&gt;, which are
two PHP test frameworks. This is not a PHPUnit vs. atoum fight. These
are observations made for our software, in our context, with our
requirements, and our expectations. I think the discussion can be useful
for many projects outside Automattic. I would like to apologize in
advance if some parts sound too abstract, I hope you understand I can&#x27;t
reveal any details about the payment system for obvious reasons.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;where-we-were-and-where-to-go&quot;&gt;Where we were, and where to go&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#where-we-were-and-where-to-go&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;For historical reasons, WordPress, VaultPress, Jetpack &amp;amp; siblings use
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;phpunit.de&#x2F;&quot;&gt;PHPUnit&lt;&#x2F;a&gt; for server-side manual tests. There are
unit, integration, and system manual tests. There are also end-to-end
tests or benchmarks, but we are not interested in them now. When those
products were built, PHPUnit was the main test framework in town. Since
then, the test landscape has considerably changed in PHP. New
competitors, like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;atoum.org&#x2F;&quot;&gt;atoum&lt;&#x2F;a&gt; or
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;behat.org&#x2F;&quot;&gt;Behat&lt;&#x2F;a&gt;, have a good position in the game.&lt;&#x2F;p&gt;
&lt;p&gt;Those tests exist for many years. Some of them grew organically. PHPUnit
does not require any form of structure, which is —despite being
questionable according to me— a reason for its success. It is a
requirement that the code does not need to be well-designed to be
tested, &lt;em&gt;but&lt;&#x2F;em&gt; too much freedom on the test side comes with a cost in the
long term if there is not enough attention.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Our situation is the following&lt;&#x2F;strong&gt;. The code is complex for justified
reasons, and the &lt;em&gt;testability&lt;&#x2F;em&gt; is sometimes lessened. Testing across
many services is indubitably difficult. Some parts of the code are
really old, mixed with others that are new, shiny, and well-done. In
this context, it is really difficult to change something, especially
moving to another test framework. The amount of work it represents is
colossal. Any new test framework does not worth the price for this huge
refactoring. But maybe the new test frameworks can help us to better
test our code?&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;graphs&#x2F;contributors&quot;&gt;long term contributor of
atoum&lt;&#x2F;a&gt; (top 3
contributors). And at the time of writing, I&#x27;m a core member. You have
to believe me when I say that, at each step of the discussions or the
processes, I have been neutral, arguing in favor or against atoum. The
idea to switch to atoum partly came from me actually, but my knowledge
about atoum is definitively a plus. I am in a good position to know the
pros and the cons of the tool, and I&#x27;m perfectly aware of how it could
solve issues we have.&lt;&#x2F;p&gt;
&lt;p&gt;So after many debates and discussions, we decided to &lt;em&gt;try&lt;&#x2F;em&gt; to move to
atoum. A survey and a meeting were scheduled 2 months later to decide
whether we should continue or not. Spoiler: We will partly continue with
it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;our-needs-and-requirements&quot;&gt;Our needs and requirements&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#our-needs-and-requirements&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Our code is difficult to test. In other words, the testability is low
for some parts of the code. atoum has features to help increase the
testability. I will try to summarize those features in the following
short sections.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;atoum-phpunit-extension&quot;&gt;&lt;code&gt;atoum&#x2F;phpunit-extension&lt;&#x2F;code&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#atoum-phpunit-extension&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;As I said, it&#x27;s not possible to rewrite&#x2F;migrate all the existing tests.
This is a colossal effort with a non-neglieable cost. Then, enter
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;phpunit-extension&quot;&gt;&lt;code&gt;atoum&#x2F;phpunit-extension&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;As far as I know, atoum is the only PHP framework that is able to run
tests that have been written for another framework. The
&lt;code&gt;atoum&#x2F;phpunit-extension&lt;&#x2F;code&gt; does exactly that. It runs tests written with
the PHPUnit API with the atoum engines. This is &lt;em&gt;fabulous&lt;&#x2F;em&gt;! PHPUnit is
not required at all. With this extension, we have been able to run our
“legacy” (aka PHPUnit) tests with atoum. The following scenarios can be
fulfilled:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Existing test suites written with the PHPUnit API can be run seamlessly by
atoum, no need to rewrite them,&lt;&#x2F;li&gt;
&lt;li&gt;Of course, new test suites are written with the atoum API,&lt;&#x2F;li&gt;
&lt;li&gt;In case of a test suite migration from PHPUnit to atoum, there are two
solutions:
&lt;ol&gt;
&lt;li&gt;Rewrite the test suite entirely from scratch by logically using the atoum
API, or&lt;&#x2F;li&gt;
&lt;li&gt;Only change the parent class from &lt;code&gt;PHPUnit\Framework\TestCase&lt;&#x2F;code&gt; to
&lt;code&gt;atoum\phpunit\test&lt;&#x2F;code&gt;, and suddenly it is possible to use both API at the
same time (and thus migrate one test case after the other for instance).&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is a very valuable tool for an adventure like ours.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;atoum&#x2F;phpunit-extension&lt;&#x2F;code&gt; is not perfect though. Some PHPUnit APIs are
missing. And while the test verdict is strictly the same, error messages
can be different, some PHPUnit extensions may not work properly etc.
Fortunately, our usage of PHPUnit is pretty raw: No extensions except
home-made ones, few hacks… Everything went well. We also have been able
to contribute easily to the extension.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;mock-engines-plural&quot;&gt;Mock engines (plural)&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#mock-engines-plural&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;atoum comes with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;docs.atoum.org&#x2F;en&#x2F;latest&#x2F;mocking_systems.html&quot;&gt;3 mock
engines&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Class-like mock engine for classes and interfaces,&lt;&#x2F;li&gt;
&lt;li&gt;Function mock engine,&lt;&#x2F;li&gt;
&lt;li&gt;Constant mock engine.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Being able to mock global functions or global constants is an important
feature for us. It suddenly increases the testability of our code! The
following example is fictional, but it&#x27;s a good illustration. WordPress
is full of global functions, but it is possible to mock them with atoum
like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; test_foo&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;get_userdata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;object&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        &amp;#39;user_login&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; …&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        &amp;#39;user_pass&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; …&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;        …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    ]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In one line of code, it was possible to mock the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;codex.wordpress.org&#x2F;Function_Reference&#x2F;get_userdata&quot;&gt;&lt;code&gt;get_userdata&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;
function.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;runner-engines&quot;&gt;Runner engines&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#runner-engines&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Being able to isolate test execution is a necessity to avoid flakey
tests, and to increase the trust we put in the test verdicts. atoum
comes with &lt;em&gt;de facto&lt;&#x2F;em&gt; 3 runner engines:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Inline&lt;&#x2F;em&gt;, one test case after another in the same process,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;em&gt;Isolate&lt;&#x2F;em&gt;, one test case after another but each time in a new process (full
isolation),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;em&gt;Concurrent&lt;&#x2F;em&gt;, like &lt;em&gt;isolate&lt;&#x2F;em&gt; but tests run concurrently (“at the same
time”).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I&#x27;m not saying PHPUnit doesn&#x27;t have those features. It is possible to
run tests in a different process each time —with the &lt;em&gt;isolate&lt;&#x2F;em&gt; engine—,
but test execution time blows up, and the isolation is not strict. We
don&#x27;t use it. The &lt;em&gt;concurrent&lt;&#x2F;em&gt; runner engine in atoum tends to reduce
the execution time to be close to the &lt;em&gt;inline&lt;&#x2F;em&gt; engine, while still
ensuring a strict isolation.&lt;&#x2F;p&gt;
&lt;p&gt;Fun fact: By using atoum and the &lt;code&gt;atoum&#x2F;phpunit-extension&lt;&#x2F;code&gt;, we are able
to run PHPUnit tests concurrently with a strict isolation!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;code-coverage-reports&quot;&gt;Code coverage reports&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#code-coverage-reports&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;At the time of writing, PHPUnit is not able to generate code coverage
reports containing the Branch- or Path Coverage Criteria data. atoum
supports them natively with the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;reports-extension&quot;&gt;&lt;code&gt;atoum&#x2F;reports-extension&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;
(including nice graphs, see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;atoum.org&#x2F;reports-extension&#x2F;&quot;&gt;the
demonstration&lt;&#x2F;a&gt;). And we need those
data.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-difficulties&quot;&gt;The difficulties&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-difficulties&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;On paper, most of the pain points sound addressable. It was time to
experiment.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;integration-to-the-continuous-integration-server&quot;&gt;Integration to the Continuous Integration server&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#integration-to-the-continuous-integration-server&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Our CI does not natively support standard test execution report formats.
Thus we had to create the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;atoum-teamcity-extension&#x2F;&quot;&gt;&lt;code&gt;atoum&#x2F;teamcity-extension&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;atoum-supports-teamcity&#x2F;&quot;&gt;Learn more&lt;&#x2F;a&gt; by
reading a blog post I wrote recently. The TeamCity support is native
inside PHPUnit (see the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;phpunit.readthedocs.io&#x2F;en&#x2F;latest&#x2F;textui.html?highlight=--log-teamcity&quot;&gt;&lt;code&gt;--log-teamcity&lt;&#x2F;code&gt;
option&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;h3 id=&quot;bootstrap-test-environments&quot;&gt;Bootstrap test environments&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#bootstrap-test-environments&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Our bootstrap files are… challenging. It&#x27;s expected though. Setting up a
functional test environment for a software like WordPress.com is not a
task one can accomplish in 2 minutes. Fortunately, we have been able to
re-use most of the PHPUnit parts.&lt;&#x2F;p&gt;
&lt;p&gt;Today, our unit tests run in complete isolation and concurrently. Our
integration tests, and system tests run in complete isolation but not
concurrently, due to MySQL limitations. We have solutions, but time
needs to be invested.&lt;&#x2F;p&gt;
&lt;p&gt;Generally, even if it works now, it took time to re-organize the
bootstrap so that some parts can be shared between the test runners
(because we didn&#x27;t switch the whole company to atoum yet, it was an
experiment).&lt;&#x2F;p&gt;
&lt;h3 id=&quot;documentation-and-help&quot;&gt;Documentation and help&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#documentation-and-help&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Here is an interesting paradox. The majority of the team recognized that
atoum&#x27;s documentation is better than PHPUnit&#x27;s, even if some parts must
be rewritten or reworked. &lt;em&gt;But&lt;&#x2F;em&gt; developers already know PHPUnit, so they
don&#x27;t look at the documentation. If they have to, they will instead find
their answers on StackOverflow, or by talking to someone else in the
company, but not by checking the official documentation. atoum does not
have many StackOverflow threads, and few people are atoum users within
the company.&lt;&#x2F;p&gt;
&lt;p&gt;What we have also observed is that when people create a new test, it&#x27;s a
copy-paste from an existing one. Let&#x27;s admit this is a common and
natural practice. When a difficulty is met, it&#x27;s legit to look at
somewhere else in the test repository to check if a similar situation
has been resolved. In our context, that information lacked a little bit.
We tried to write more and more tests, but not fast enough. It should
not be an issue if you have time to try, but in our context, we
unfortunately didn&#x27;t have this time. The team faced many challenges in
the same period, and the tests we are building are not simple _Hello,
World!_s as you might think, so it increases the effort.&lt;&#x2F;p&gt;
&lt;p&gt;To be honest, this was not the biggest difficulty, but still, it is
important to notice.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;concurrent-integration-test-executions&quot;&gt;Concurrent integration test executions&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#concurrent-integration-test-executions&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Due to some MySQL limitations combined with the complexity of our code,
we are not able to run integration (and system) tests concurrently yet.
Therefore it takes time to run them, probably too much in our
development environments. Even if atoum has friendly options to reduce
the debug loop (e.g. see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;docs.atoum.org&#x2F;en&#x2F;latest&#x2F;mode-loop.html&quot;&gt;the &lt;code&gt;--loop&lt;&#x2F;code&gt;
option&lt;&#x2F;a&gt;), the execution
is still slow. The problem can be solved but it requires time, and deep
modifications of our code.&lt;&#x2F;p&gt;
&lt;p&gt;Note that with our PHPUnit tests, no isolation is used. This is wrong.
And thus we have a smaller trust in the test verdict than with atoum.
Almost everyone in the team prefers to have slow test execution but
isolation, rather than fast test execution but no confidence in the test
verdict. So that&#x27;s partly a difficulty. It&#x27;s a mix of a positive feature
and a needle in the foot, and a needle we can live with. atoum is not
responsible of this latency: The state of our code is.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-results&quot;&gt;The results&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-results&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;First, let&#x27;s start by the positive impacts:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;In 2 months, we have observed that the testability of our code has been
increased by using atoum,&lt;&#x2F;li&gt;
&lt;li&gt;We have been able to find bugs in our code that were not detected by PHPUnit,
mostly because atoum checks the type of the data,&lt;&#x2F;li&gt;
&lt;li&gt;We have been able to migrate “legacy tests” (aka PHPUnit tests) to atoum by
just moving the files from one directory to another: What a smooth migration!&lt;&#x2F;li&gt;
&lt;li&gt;The &lt;em&gt;trust&lt;&#x2F;em&gt; we put in our test verdict has increased thanks to a strict test
execution isolation.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Now, the negative impacts:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Even if the testability has been increased, it&#x27;s not enough. Right now, we are
looking at refactoring our code. Introducing atoum right now was probably too
early. Let&#x27;s refactor first, then use a better test toolchain later when
things will be cleaner,&lt;&#x2F;li&gt;
&lt;li&gt;Moving the whole company at once is hard. There are thousands of manual tests.
The &lt;code&gt;atoum&#x2F;phpunit-extension&lt;&#x2F;code&gt; is not magical. We have to come with more solid
results, stuff to blow minds. It is necessary to set the institutional inertia
in motion. For instance, not being able to run integration and system tests
concurrently slows down the builds on the CI; it increases the trust we put in
the test verdict, but this latency is not acceptable at the company scale,&lt;&#x2F;li&gt;
&lt;li&gt;All the issues we faced can be addressed, but it needs time. The experiment
time frame was 2 months. We need 1 or 2 other months to solve the majority of
the remaining issues. Note that I was kind of in-charge of this project, but
not full time.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;We stop using atoum for &lt;em&gt;manual tests&lt;&#x2F;em&gt;. It&#x27;s likely to be a pause
though. The experiment has shown we need to refactor and clean our code,
then there will be a good chance for atoum to come back. The experiment
has also shown how to increase the testability of our code: Not
everything can be addressed by using another test framework even if it
largely participates. We can focus on those points specifically, because
we know where they are now. Finally, I reckon it has participated in
moving the test infrastructure inside Automattic by showing that
something else exists, and that we can go further.&lt;&#x2F;p&gt;
&lt;p&gt;I said we stopped using atoum “for manual tests”. Yes. Because we also
have &lt;em&gt;automatically generated tests&lt;&#x2F;em&gt;. The experiment was not only about
switching to atoum. Many other aspects of the experiment are still
running! For instance, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Kitab&quot;&gt;Kitab&lt;&#x2F;a&gt; is
used for our code documentation. Kitab is able to (i) &lt;em&gt;render&lt;&#x2F;em&gt; the
documentation, and (ii) &lt;em&gt;test&lt;&#x2F;em&gt; the examples written inside the
documentation. That way the documentation is ensured to be always
up-to-date and working. Kitab generates tests for- and executes tests
with atoum. It was easy to set up: We just had to use the existing test
bootstraps designed for atoum. We also have another tool to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;atoum-apiblueprint-extension&quot;&gt;compile
HTTP API Blueprint specifications into executable
tests&lt;&#x2F;a&gt;. So far,
everyone is happy with those tools, no need to go back, everything is
automat(t)ic. Other tools are likely to be introduced in the future to
automatically generate tests. I want to detail this particular topic in
another blog post.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#conclusion&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Moving to another test framework is a huge decision with many factors.
The fact atoum has &lt;code&gt;atoum&#x2F;phpunit-extension&lt;&#x2F;code&gt; is a time saver.
Nonetheless a new test framework does not mean it will fix all the
testability issues of the code. The benefits of the new test framework
must largely overtake the costs. In our current context, it was not the
case. &lt;em&gt;atoum solves issues that are not our priorities&lt;&#x2F;em&gt;. So yes, atoum
can help us to solve important issues, but since these issues are not
priorities, then the move to atoum was too early. During the project, we
gained new automatic test tools, like
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Kitab&quot;&gt;Kitab&lt;&#x2F;a&gt;. The experiment is not a
failure. Will we retry atoum? It&#x27;s very likely. When? I hope in a year.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>One conference per day, for one year (2017)</title>
          <pubDate>Thu, 25 Jan 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/one-conference-per-day-for-one-year-2017/</link>
          <guid>https://mnt.io/articles/one-conference-per-day-for-one-year-2017/</guid>
          <description xml:base="https://mnt.io/articles/one-conference-per-day-for-one-year-2017/">&lt;p&gt;My self-assigned challenge for 2017 was to watch at least one conference
per day, for one year. That&#x27;s the first time I try this challenge. Let&#x27;s
dive in for a recap.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;267-conferences&quot;&gt;267 conferences&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#267-conferences&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;In some way, I failed the challenge because I&#x27;ve been able to watch only
267 conferences. With an average of 34 minutes per conference, I&#x27;ve
watched 9078 minutes, or 151 hours of &lt;em&gt;freely available&lt;&#x2F;em&gt; conferences
online. Why did I fail to watch 365 of them? Because my first kid was
1.5 years in January 2017, a new little lady came in December 2017, I
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;bye-bye-liip-hello-automattic&#x2F;&quot;&gt;got a new
job&lt;&#x2F;a&gt;, I
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;automattic-grand-meetup-2017&#x2F;&quot;&gt;travelled for my
job&lt;&#x2F;a&gt;, I &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=Ymy8qAEe0kQ&quot;&gt;gave
talks&lt;&#x2F;a&gt;, I maintain
important open source projects requiring lot of time, I&#x27;m building my
own self-sufficient ecological house, the vegetable garden requires many
hours, I watch other videos, and because I&#x27;m lazy sometimes. Most of the
time, I was able to watch 2 or 3 conferences in a row.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;where-to-find-the-resources&quot;&gt;Where to find the resources?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#where-to-find-the-resources&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;All these conferences are freely available online, on YouTube, or on
Vimeo, for most of them. The channel I mostly watch are the following:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCaYhcUwRBNscFNUKTjgPFiA&quot;&gt;Rust&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;user&#x2F;Confreaks&quot;&gt;Confreaks&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCCBVCTuk6uJrN3iFV_3vurg&quot;&gt;Devoxx&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCOpGiN9AkczVjlpGDaBwQrQ&quot;&gt;elm-conf&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;user&#x2F;BoostCon&quot;&gt;BoostCon&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;user&#x2F;jsconfeu&quot;&gt;JSConf&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UCv2_41bSAa5Y_8BacJUZfjQ&quot;&gt;LLVM&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;user&#x2F;CppCon&quot;&gt;CppCon&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;channel&#x2F;UC_QIfHvN9auy2CoOdSfMWDw&quot;&gt;Strange
Loop&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;It&#x27;s very Computer Science centric as you might have noticed, and it
targets Rust, C++, Elm, LLVM, or Web technologies (JS, CSS…), but not
only, you can find Haskell or Clojure sometimes.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;my-best-of-list&quot;&gt;My best-of list&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#my-best-of-list&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;In March 2017, more and more people were questionning me, and asked for
sharing. I then decided to start a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;playlist?list=PLOkMRkzDhWGX_4YWI4ZYGbwFPqKnDRudf&quot;&gt;playlist of my “best-of”
conferences&lt;&#x2F;a&gt;.
I&#x27;ve added 78 conferences in 2017, and 3 new conferences have been added
since then.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;iframe class=&quot;youtube-player&quot; width=&quot;560&quot; height=&quot;315&quot; src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;videoseries?si=9Q6Qf-EOE4nyFgrn&amp;amp;list=PLOkMRkzDhWGX_4YWI4ZYGbwFPqKnDRudf&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot; referrerpolicy=&quot;strict-origin-when-cross-origin&quot; allowfullscreen&gt;&lt;&#x2F;iframe&gt;
  &lt;figcaption&gt;
&lt;p&gt;My best-of talks playlist.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;h2 id=&quot;thoughts-and-conclusion&quot;&gt;Thoughts and conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#thoughts-and-conclusion&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The challenge was sometimes easy and relaxing, or it was very hard to
understand everything especially at 2am after a long day (looking at you
CppCon). But it has been a very enjoyable way to learn a lot in a very
short period of time. Many speakers are talented, and listening to them
is a real pleasure. Some others are just… let&#x27;s say unprepared, and it&#x27;s
good to stop and jump onto another talk. It&#x27;s also a good way to get
inspired by technologies you don&#x27;t necessarily know (for instance, I&#x27;m
not a big fan of Clojure, but some projects are really inspiring, like
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=buPPGxOnBnk&amp;amp;index=81&amp;amp;list=PLOkMRkzDhWGX_4YWI4ZYGbwFPqKnDRudf&quot;&gt;Proto
REPL&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;Sometimes &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;mnt_io&quot;&gt;I tweeted&lt;&#x2F;a&gt; about the talk I
watched, and it was quite appreciated too. I reckon because it&#x27;s a fun
and an easy way to learn, especially with the help of video platforms
like Youtube.&lt;&#x2F;p&gt;
&lt;p&gt;Am I going to continue this challenge in 2018? Yes! But maybe not at
this frequency. It&#x27;s now part of my routine to watch conferences many
times per week. I like it. I don&#x27;t want to stop.&lt;&#x2F;p&gt;
&lt;p&gt;As a closing note, I would like to &lt;em&gt;thank&lt;&#x2F;em&gt; every speakers, and more
importantly, every conference organizer. You are doing an amazing job:
From the program, to the event, to the final sharing on Internet with
everyone. Most of you are volunteers. I know the work it represents. You
are producing &lt;em&gt;extremely valuable resources&lt;&#x2F;em&gt;. Thank you!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Random thoughts about `::class` in PHP</title>
          <pubDate>Wed, 24 Jan 2018 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/random-thoughts-about-class-in-php/</link>
          <guid>https://mnt.io/articles/random-thoughts-about-class-in-php/</guid>
          <description xml:base="https://mnt.io/articles/random-thoughts-about-class-in-php/">&lt;blockquote&gt;
&lt;p&gt;The special &lt;strong&gt;&lt;code&gt;::class&lt;&#x2F;code&gt;&lt;&#x2F;strong&gt; constant allows for fully qualified class
name resolution at compile, this is useful for namespaced classes.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;I&#x27;m quoting &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;php.net&#x2F;manual&#x2F;en&#x2F;language.oop5.constants.php&quot;&gt;the PHP
manual&lt;&#x2F;a&gt;. But
things can be funny sometimes. Let&#x27;s go through some examples.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; A&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;B&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span&gt; C&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$_&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; C&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;``` &amp;lt;!-- rumdl-disable-line MD031 --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;resolves to `&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;A&lt;&#x2F;span&gt;&lt;span&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;B&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;`, which is perfect 🙂&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; C&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; f&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $_&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;resolves to &lt;code&gt;C&lt;&#x2F;code&gt;, which is perfect 😀&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; C&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; D&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; C&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; f&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $_&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; parent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;``` &amp;lt;!-- rumdl-disable-line MD031 --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;resolves to `&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;C&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;`, which is perfect 😄&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; C&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public static&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; f&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $_&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; static&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; D&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; C&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-class&quot;&gt;D&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;f&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;resolves to &lt;code&gt;D&lt;&#x2F;code&gt;, which is perfect 😍&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;foo&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;``` &amp;lt;!-- rumdl-disable-line MD031 --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;resolves to `&amp;#39;foo&amp;#39;`, which is… huh? 🤨&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;foo&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;resolves to &lt;code&gt;&#x27;foo&#x27;&lt;&#x2F;code&gt;, which is… expected somehow 😕&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$a&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;oo&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;f{&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$a&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;}&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;``` &amp;lt;!-- rumdl-disable-line MD031 --&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;generates a parse error 🙃&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-class&quot;&gt;PHP_VERSION&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;resolves to &lt;code&gt;&#x27;PHP_VERSION&#x27;&lt;&#x2F;code&gt;, which is… strange: It resolves to the
fully qualified name of the constant, not the &lt;em&gt;class&lt;&#x2F;em&gt; 🤐&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;&lt;code&gt;::class&lt;&#x2F;code&gt; is very useful to get rid of of the &lt;code&gt;get_class&lt;&#x2F;code&gt; or the
&lt;code&gt;get_called_class&lt;&#x2F;code&gt; functions, or even the &lt;code&gt;get_class($this)&lt;&#x2F;code&gt; trick. This
is something truly useful in PHP where entities are referenced as
strings, not as symbols. &lt;code&gt;::class&lt;&#x2F;code&gt; on constants makes sense, but the
name is no longer relevant. And finally, &lt;code&gt;::class&lt;&#x2F;code&gt; on single quote
strings is absolutely useless; on double quotes strings it is a source
of error because the value can be dynamic (and remember, &lt;code&gt;::class&lt;&#x2F;code&gt; is
resolved at compile time, not at run time).&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Automattic, Grand Meetup 2017</title>
          <pubDate>Sun, 26 Nov 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/automattic-grand-meetup-2017/</link>
          <guid>https://mnt.io/articles/automattic-grand-meetup-2017/</guid>
          <description xml:base="https://mnt.io/articles/automattic-grand-meetup-2017/">&lt;p&gt;Awesome company, awesome teams, awesome people. Thanks everyone for this
moment!&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;automattic-grand-meetup-2017&#x2F;.&#x2F;gm.jpg&quot; alt=&quot;All the people&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;All the people!&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
</description>
      </item>
      <item>
          <title>atoum supports TeamCity</title>
          <pubDate>Mon, 06 Nov 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/atoum-supports-teamcity/</link>
          <guid>https://mnt.io/articles/atoum-supports-teamcity/</guid>
          <description xml:base="https://mnt.io/articles/atoum-supports-teamcity/">&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;atoum.org&#x2F;&quot;&gt;atoum&lt;&#x2F;a&gt; is a popular PHP test framework.
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.jetbrains.com&#x2F;teamcity&#x2F;&quot;&gt;TeamCity&lt;&#x2F;a&gt; is a Continuous
Integration and Continuous Delivery software developed by Jetbrains.
Despites &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;atoum.org&#x2F;features.html#reports&quot;&gt;atoum supports many industry
standards&lt;&#x2F;a&gt; to report test
execution verdicts, TeamCity uses &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;confluence.jetbrains.com&#x2F;display&#x2F;TCD8&#x2F;Build+Script+Interaction+with+TeamCity&quot;&gt;its own non-standard
report&lt;&#x2F;a&gt;,
and thus atoum is not compatible with TeamCity… until now.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;atoum&#x2F;teamcity-extension&lt;&#x2F;code&gt; provides TeamCity support inside atoum.
When executing tests, the reported verdicts are understandable by
TeamCity, and activate all its UI features.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;install&quot;&gt;Install&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#install&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;If you have Composer, just run:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; composer require atoum&#x2F;teamcity-extension &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;~1.0&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;From this point, you need to enable the extension in your &lt;code&gt;.atoum.php&lt;&#x2F;code&gt;
configuration file. The following example forces to enable the extension
for every test execution:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$extension&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; atoum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;teamcity&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;extension&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$script&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$extension&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;addToRunner&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$runner&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The following example enables the extension &lt;strong&gt;only within&lt;&#x2F;strong&gt; a TeamCity
environment:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$extension&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; atoum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;teamcity&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;extension&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$script&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$extension&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;addToRunnerWithinTeamCityEnvironment&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$runner&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This latter installation is recommended. That&#x27;s it 🙂.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;glance&quot;&gt;Glance&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#glance&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The default CLI report looks like this:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;atoum-supports-teamcity&#x2F;.&#x2F;cli.png&quot; alt=&quot;Default atoum CLI report&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;The default CLI report is the default one from atoum.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The TeamCity report looks like this in your terminal (note the
&lt;code&gt;TEAMCITY_VERSION&lt;&#x2F;code&gt; variable as a way to emulate a TeamCity environment):&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;atoum-supports-teamcity&#x2F;.&#x2F;cli-teamcity.png&quot; alt=&quot;TeamCity report inside the terminal&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;The TeamCity report is text-based, but it is aimed at being consumed by a
formatter to produce HTML.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Which is less easy to read. However, when it comes into TeamCity UI, we
will have the following result:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;atoum-supports-teamcity&#x2F;.&#x2F;teamcity.png&quot; alt=&quot;TeamCity running atoum&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;The final rendering, at an HTML document inside TeamCity itself.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;We are using it at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;automattic.com&#x2F;&quot;&gt;Automattic&lt;&#x2F;a&gt;. Hope it is
useful for someone else!&lt;&#x2F;p&gt;
&lt;p&gt;If you find any bugs, or would like any other features, please use
Github at the following repository:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;atoum-teamcity-extension&#x2F;&quot;&gt;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;atoum-teamcity-extension&#x2F;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Export functions in PHP à la Javascript</title>
          <pubDate>Mon, 30 Oct 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/export-functions-in-php-a-la-javascript/</link>
          <guid>https://mnt.io/articles/export-functions-in-php-a-la-javascript/</guid>
          <description xml:base="https://mnt.io/articles/export-functions-in-php-a-la-javascript/">&lt;p&gt;Warning: This post is totally useless. It is the result of a fun private
company thread.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;export-functions-in-javascript&quot;&gt;Export functions in Javascript&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#export-functions-in-javascript&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;In Javascript, a file can export functions like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;export&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; times2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;x&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And then we can import this function in another file like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;javascript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;import&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;times2&lt;&#x2F;span&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; from&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;foo&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-accessor&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;log&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;times2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;21&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;&#x2F; 42&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Is it possible with PHP?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;export-functions-in-php&quot;&gt;Export functions in PHP&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#export-functions-in-php&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Every entity is public in PHP: Constant, function, class, interface, or
trait. They can live in a namespace. So exporting functions in PHP is
absolutely useless, but just for the fun, let&#x27;s keep going.&lt;&#x2F;p&gt;
&lt;p&gt;A PHP file can return an integer, a real, an array, an anonymous
function, anything. Let&#x27;s try this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;return&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;int&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $x&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; int&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And then in another file:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$times2&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; require&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;foo.php&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$times2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;21&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;&#x2F; int(42)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Great, it works.&lt;&#x2F;p&gt;
&lt;p&gt;What if our file returns more than one function? Let&#x27;s use an array
(which has most hashmap properties):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;return&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;#39;times2&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;int&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $x&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; int&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; *&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;#39;answer&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span&gt; ()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; int&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 42&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To choose what to import, let&#x27;s use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;php&#x2F;php-langspec&#x2F;blob&#x2F;master&#x2F;spec&#x2F;10-expressions.md#list-intrinsic&quot;&gt;the &lt;code&gt;list&lt;&#x2F;code&gt;
intrinsic&lt;&#x2F;a&gt;.
It has several forms: With or without key matching, long (&lt;code&gt;list(…)&lt;&#x2F;code&gt;) and
short syntax (&lt;code&gt;[…]&lt;&#x2F;code&gt;). Because we are modern, we will use the short
syntax with key matching to selectively import functions:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;times2&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $mul&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; require&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;foo.php&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$mul&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;21&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;&#x2F; int(42)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Notice that &lt;code&gt;times2&lt;&#x2F;code&gt; has been aliased to &lt;code&gt;$mul&lt;&#x2F;code&gt;. What a feature!&lt;&#x2F;p&gt;
&lt;p&gt;Is it useful? Absolutely not. Is it fun? For me it is.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Finite-State Machine as a Type System illustrated with a store product</title>
          <pubDate>Wed, 09 Aug 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/finite-state-machine-as-a-type-system-illustrated-with-a-store-product/</link>
          <guid>https://mnt.io/articles/finite-state-machine-as-a-type-system-illustrated-with-a-store-product/</guid>
          <description xml:base="https://mnt.io/articles/finite-state-machine-as-a-type-system-illustrated-with-a-store-product/">&lt;p&gt;Hello fellow coders!&lt;&#x2F;p&gt;
&lt;p&gt;In this article, I would like to talk about how to implement a
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Finite-state_machine&quot;&gt;Finite-State
Machine&lt;&#x2F;a&gt; (FSM) with
the PHP type system. The example is a store product (in an e-commerce
solution for instance), something we are likely to meet once in our
lifetime. Our goal is to simply &lt;strong&gt;avoid impossible states and
transitions&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I am in deep love with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Type_theory&quot;&gt;Type
theory&lt;&#x2F;a&gt;, however I will try
to keep the formulas away from this article to focus on the code.
Moreover, you might be aware that the PHP &lt;em&gt;runtime&lt;&#x2F;em&gt; type system is
somewhat very permissive and “poor” (this is not a formal definition),
hopefully some tricks can help us to express nice constraints.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-product-fsm&quot;&gt;The Product FSM&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-product-fsm&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A product in a store might have the following states:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Active: Can be purchased,&lt;&#x2F;li&gt;
&lt;li&gt;Inactive: Has been cancelled or discontinued (a discontinued product can no
longer be purchased),&lt;&#x2F;li&gt;
&lt;li&gt;Purchased and renewable,&lt;&#x2F;li&gt;
&lt;li&gt;Purchased and not renewable,&lt;&#x2F;li&gt;
&lt;li&gt;Purchased and cancellable.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The transitions between these states can be viewed as a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Finite-state_machine&quot;&gt;Finite-State
Machine&lt;&#x2F;a&gt; (FSM).&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;finite-state-machine-as-a-type-system-illustrated-with-a-store-product&#x2F;.&#x2F;schema1.png&quot; alt=&quot;First schema&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;We read this graph as: A product is in the state &lt;code&gt;A&lt;&#x2F;code&gt;. If the &lt;code&gt;purchase&lt;&#x2F;code&gt;
action is called, then it transitions to the state &lt;code&gt;B&lt;&#x2F;code&gt;. If the &lt;code&gt;once-off    purchase&lt;&#x2F;code&gt; action is called, then it transitions to the state &lt;code&gt;C&lt;&#x2F;code&gt;. From the
state &lt;code&gt;B&lt;&#x2F;code&gt;, if the &lt;code&gt;renew&lt;&#x2F;code&gt; action is called, it remains in the same state. If
the &lt;code&gt;cancel&lt;&#x2F;code&gt; action is called, it transitions to the &lt;code&gt;D&lt;&#x2F;code&gt; state. Same for the
&lt;code&gt;C&lt;&#x2F;code&gt; to &lt;code&gt;D&lt;&#x2F;code&gt; states.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Our goal is to respect this FSM. Invalid actions must be impossible to
do.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;Finite-State Machine as a Type System&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Having a FSM is a good thing to define the states and the transitions
between them: It is formal and clear. However, it is tested at runtime,
not at compile-time, i.e. &lt;code&gt;if&lt;&#x2F;code&gt; statements are required to test if the
state of a product can transition into another state, or else throw an
exception, and this is decided at runtime. Note that PHP does not really
have a compile-time because it is an online compiler (learn more by
reading &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;speakerdeck.com&#x2F;hywan&#x2F;tagua-vm-a-safe-php-virtual-machine&quot;&gt;Tagua VM, a safe PHP virtual
machine&lt;&#x2F;a&gt;,
at slide 29). Our goal is to prevent illegal&#x2F;invalid states at
parse-&#x2F;compile-time so that the PHP virtual machine, IDE or static
analysis tools can prove the state of a product without executing PHP
code.&lt;&#x2F;p&gt;
&lt;p&gt;Why is this important? Imagine that we decide to change a product to be
once-off purchasable instead of purchasable, then we can no longer renew
it. We replace an interface on this product, and boom, the IDE tells us
that the code is broken in &lt;em&gt;x&lt;&#x2F;em&gt; places. It &lt;strong&gt;detects impossible scenarios
ahead of code execution&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;No more talking. Here is the code.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-1&quot;&gt;The mighty product&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * A product.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;interface&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A product is a class implementing the &lt;code&gt;Product&lt;&#x2F;code&gt; interface. It allows to
type a generic product, with no regards about its state.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-2&quot;&gt;Active and inactive&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * A product that is active.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;interface&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * A product that has been cancelled, or not in stock.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;interface&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;Active&lt;&#x2F;code&gt; and &lt;code&gt;Inactive&lt;&#x2F;code&gt; interfaces are useful to create constraints
such as:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;A product can be purchased only if it is active, and&lt;&#x2F;li&gt;
&lt;li&gt;A product is inactive if and only if it has been cancelled,&lt;&#x2F;li&gt;
&lt;li&gt;To finally conclude that an inactive product can no longer be purchased, nor
renewed, nor cancelled.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Basically, it defines the axiom (initial state) and the final states of
our FSM.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;getProduct(): self&lt;&#x2F;code&gt; trick will make sense later. It helps to
express the following constraint: “A valid product cannot be invalid,
and vice-versa”, i.e. both interfaces cannot be implemented by the same
value.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-3&quot;&gt;Purchase, renew, and cancel&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * A product that can be purchased.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;interface&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Purchasable&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Only an active product can be purchased. The action is &lt;code&gt;purchase&lt;&#x2F;code&gt; and it
generates a product that is renewable. &lt;code&gt;purchase&lt;&#x2F;code&gt; transitions from the
state &lt;code&gt;A&lt;&#x2F;code&gt; to &lt;code&gt;B&lt;&#x2F;code&gt; (regarding the graph above).&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * A product that can be cancelled.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;interface&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Cancellable&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Only an active product can be cancelled. The action is &lt;code&gt;cancel&lt;&#x2F;code&gt; and it
generates an inactive product, so it transitions from the state &lt;code&gt;B&lt;&#x2F;code&gt; to
&lt;code&gt;D&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * A product that can be renewed.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;interface&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Cancellable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A renewable product is also cancellable. The action is &lt;code&gt;renew&lt;&#x2F;code&gt; and this
is a reflexive transition from the state &lt;code&gt;B&lt;&#x2F;code&gt; to &lt;code&gt;B&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * A product that can be once-off purchased, i.e. it can be purchased but not&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * renewed.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;interface&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; PurchasableOnce&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Cancellable&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Finally, a once-off purchasable product has one action: &lt;code&gt;purchase&lt;&#x2F;code&gt; that
produces a &lt;code&gt;Cancellable&lt;&#x2F;code&gt; product, and it transitions from the state &lt;code&gt;A&lt;&#x2F;code&gt;
to &lt;code&gt;C&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-4&quot;&gt;Take a breath&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-4&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;figure role=&quot;presentation&quot;&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;finite-state-machine-as-a-type-system-illustrated-with-a-store-product&#x2F;.&#x2F;schema2.png&quot; alt=&quot;Second schema&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;So far we have defined interfaces, but the FSM is not implemented yet.
&lt;strong&gt;Interfaces only define constraints&lt;&#x2F;strong&gt; in our type system. An interface
provides a constraint but also &lt;strong&gt;defines type capabilities&lt;&#x2F;strong&gt;: &lt;strong&gt;What
operations can be performed on a value implementing a particular
interface&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-5&quot;&gt;SecretProduct&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-5&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Let&amp;#39;s consider the &lt;code&gt;SecretProduct&lt;&#x2F;code&gt; as a new super secret product that
will revolutionise our store:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * The `SecretProduct` class is:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *   * A product,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *   * Active,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *   * Purchasable.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * Note that in this implementation, the `SecretProduct` instance is mutable: Every&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * action happens on the same `SecretProduct` instance. It makes sense because&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * having 2 instances of the same product with different states might be error-prone&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * in most scenarios.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Purchasable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;     * Purchase the product will return an active product that is renewable,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;     * and also cancellable.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;     *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; class&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            protected&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; __construct&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;SecretProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;                $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Do the purchase.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Do the renew.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                return new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; class&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;                    protected&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;                    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; __construct&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;SecretProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;                        $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                        &#x2F;&#x2F; Do the cancel.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;                    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The &lt;code&gt;SecretProduct&lt;&#x2F;code&gt; is a product that is active and purchasable. PHP
verifies that the &lt;code&gt;Active::getProduct&lt;&#x2F;code&gt; method is implemented, and that
the &lt;code&gt;Purchasable::purchase&lt;&#x2F;code&gt; method is implemented too.&lt;&#x2F;p&gt;
&lt;p&gt;When this latter is called, it returns an object implementing the
&lt;code&gt;Renewable&lt;&#x2F;code&gt; interface (which is also a cancellable active product). The
object in this context is an instance of an anonymous class implementing
the &lt;code&gt;Renewable&lt;&#x2F;code&gt; interface. So the &lt;code&gt;Active::getProduct&lt;&#x2F;code&gt;,
&lt;code&gt;Renewable::renew&lt;&#x2F;code&gt;, and &lt;code&gt;Cancellable::cancel&lt;&#x2F;code&gt; methods must be
implemented.&lt;&#x2F;p&gt;
&lt;p&gt;Having an anonymous class is not required at all, this is just simpler
for the example. A named class may even be better from the testing point
of view.&lt;&#x2F;p&gt;
&lt;p&gt;Note that:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The real purchase action is performed in the constructor of the anonymous
class: This is not a hard rule, this is just convenient; it can be done in the
method before returning the new instance,&lt;&#x2F;li&gt;
&lt;li&gt;The real renew action is performed in the &lt;code&gt;renew&lt;&#x2F;code&gt; method before returning
&lt;code&gt;$this&lt;&#x2F;code&gt; ,&lt;&#x2F;li&gt;
&lt;li&gt;And the real cancel action is performed in… we have to dig a little bit more
(the principle is exactly the same though):
&lt;ul&gt;
&lt;li&gt;The &lt;code&gt;Cancellable::cancel&lt;&#x2F;code&gt; method must return an object implementing the
&lt;code&gt;Inactive&lt;&#x2F;code&gt; interface.&lt;&#x2F;li&gt;
&lt;li&gt;It generates an instance of an anonymous class implementing the &lt;code&gt;Inactive&lt;&#x2F;code&gt;
interface, and the real cancel action is done in the constructor.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;-6&quot;&gt;Assert possible and impossible actions&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-6&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Let&amp;#39;s try some valid and invalid actions. Those followings are
&lt;strong&gt;possible actions&lt;&#x2F;strong&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                             instanceof&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                    instanceof&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                   instanceof&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; instanceof&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is possible to purchase a product, then renew it zero or many times,
and finally to cancel it. It matches the FSM!&lt;&#x2F;p&gt;
&lt;p&gt;Those followings are &lt;strong&gt;impossible actions&lt;&#x2F;strong&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is impossible:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;To renew or to cancel a product that has not been purchased,&lt;&#x2F;li&gt;
&lt;li&gt;To purchase or renew a product that has been cancelled,&lt;&#x2F;li&gt;
&lt;li&gt;To purchase a product more than once,&lt;&#x2F;li&gt;
&lt;li&gt;To cancel a product more than once.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Those followings are &lt;strong&gt;impossible implementations&lt;&#x2F;strong&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Purchasable&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; PurchasableOnce&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A product cannot be purchasable and once-off purchasable at the same
time, because &lt;code&gt;Purchasable::purchase&lt;&#x2F;code&gt; is not compatible with
&lt;code&gt;PurchasableOnce::purchase&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; SecretProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Cancellable&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;An inactive product cannot be purchased nor renewed nor cancelled
because &lt;code&gt;Active::getProduct&lt;&#x2F;code&gt; and &lt;code&gt;Inactive::getProduct&lt;&#x2F;code&gt; are not
compatible.&lt;&#x2F;p&gt;
&lt;p&gt;Wow, that&amp;#39;s great garantees isn&amp;#39;t it? &lt;strong&gt;PHP will raise fatal errors for
impossible actions or impossible states&lt;&#x2F;strong&gt;. No warnings or notices: Fatal
errors. Most of them are correctly inferred by IDE, so… follow the red
crosses in your IDE.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-7&quot;&gt;Restoring a product&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-7&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;One major thing is missing: The state of a product is stored in the
database. When loading the product, we must be able to get an instance
of a product at its previous state. To avoid repeating code, we will use
traits. Rebuilding the state of a product is “just” (it really is) a
composition of traits.&lt;&#x2F;p&gt;
&lt;p&gt;Note: In these examples, we are using anonymous classes and traits. It
is possible to achieve the same behavior with final named classes. Also
we are using a repository, which is convenient for this article, but not
necessarily the best solution.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-8&quot;&gt;Repository&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-8&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;The following &lt;code&gt;ProductRepository\load&lt;&#x2F;code&gt; function is just here to give you
an idea of how it works.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;namespace&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ProductRepository&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; load&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;int&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $id&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; string&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $state&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Load the product from the database with `$id`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; The states can be `Renewable`, `Cancellable`, or `Inactive` (check&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; the FSM to double-check). Products that have not been purchased&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; are not in the database.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Fake minimal active product.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; class implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    switch&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$state&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; State B.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        case&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            return new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; class&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                use&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; ActiveProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                use&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; RenewableProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                use&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; CancellableProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; State C.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        case&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Cancellable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            return new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; class&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Cancellable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                use&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; ActiveProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                use&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; CancellableProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; State D.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        case&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            return new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; class&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                use&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; InactiveProduct&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Invalid state.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        default&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            throw new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; RuntimeException&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;Invalid product state.&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h3 id=&quot;-9&quot;&gt;Traits&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-9&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;The code must look familiar because this is just a split from the
&lt;code&gt;SecretProduct&lt;&#x2F;code&gt; implementation.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;trait&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ActiveProduct&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    protected&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; __construct&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Product&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Active&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;trait&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RenewableProduct&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Do the renew.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;trait&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; CancellableProduct&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return new&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; class&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getProduct&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            protected&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; __construct&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Product&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;                $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Do the cancel.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;trait&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; InactiveProduct&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    protected&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; __construct&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Product&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; getProduct&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Inactive&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;product&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h3 id=&quot;-10&quot;&gt;Assert possible and impossible actions&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-10&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;The &lt;strong&gt;possible actions&lt;&#x2F;strong&gt; are:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; ProductRepository&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;load&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;42&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;           instanceof&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;renew&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  instanceof&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;assert&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; instanceof&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Product&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Product 42 is assumed to be in the state &lt;code&gt;B&lt;&#x2F;code&gt; (&lt;code&gt;Renewable::class&lt;&#x2F;code&gt;), so we
can renew and cancel it.&lt;&#x2F;p&gt;
&lt;p&gt;Those followings are &lt;strong&gt;impossible actions&lt;&#x2F;strong&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; ProductRepository&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;load&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;42&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; Renewable&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;class&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;purchase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$product&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cancel&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is impossible to purchase the product 42 because it is in state &lt;code&gt;B&lt;&#x2F;code&gt;,
so it has already been purchased. It is impossible to cancel a product
twice.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Same garantees apply here&lt;&#x2F;strong&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-11&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-11&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;It is possible to re-implement &lt;code&gt;SecretProduct&lt;&#x2F;code&gt; with the traits we have
defined for the &lt;code&gt;ProductRepository&lt;&#x2F;code&gt;, or to use named classes. I let this
as an easy wrap up exercise for the reader.&lt;&#x2F;p&gt;
&lt;p&gt;The real conclusion is that we have &lt;strong&gt;successfully implemented the
Finite-State Machine of a product with a Type System&lt;&#x2F;strong&gt;. It is impossible
to have an invalid implementation that violates the constraints, such as
an inactive renewable product. PHP detects it immediately at runtime.
Invalid actions are also impossible, such as purchasing a product twice,
or renewing a once-off purchased product. It is also detected by PHP.&lt;&#x2F;p&gt;
&lt;p&gt;All violations take the form of PHP fatal errors.&lt;&#x2F;p&gt;
&lt;p&gt;The product repository is an example of how to restore a product at a
particular state, with the help of the defined interfaces, and new small
and simple traits.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-12&quot;&gt;One more thing&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-12&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;It is possible to integrate product categories in this type system (like
bundles). It is more complex, but possible.&lt;&#x2F;p&gt;
&lt;p&gt;I would highly recommend these following readings:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;blogs.perl.org&#x2F;users&#x2F;ovid&#x2F;2010&#x2F;08&#x2F;what-to-know-before-debating-type-systems.html&quot;&gt;What to know before debating type systems&lt;&#x2F;a&gt;
to have an overview of different systems,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sdleffler.github.io&#x2F;RustTypeSystemTuringComplete&#x2F;&quot;&gt;Rust&amp;#39;s Type System is Turing-Complete&lt;&#x2F;a&gt;
to see how powerful a type system can be,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;speakerdeck.com&#x2F;willroth&#x2F;fear-not-the-machine-of-state&quot;&gt;Fear Not the Machine of State!&lt;&#x2F;a&gt;
to see how to integrate an FSM into an object without using a type system.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I would like to particularly emphasize a paragraph from the first
article:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;So what is a type? The only true definition is this: a type is a
&lt;strong&gt;label&lt;&#x2F;strong&gt; used by a type system to &lt;strong&gt;prove&lt;&#x2F;strong&gt; some property of the
&lt;strong&gt;program&amp;#39;s behavior&lt;&#x2F;strong&gt;. If the type checker can assign types to the
whole program, then it succeeds in its proof; otherwise it fails and
points out why it failed.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Seeing types as labels is a very smart way of approaching them.&lt;&#x2F;p&gt;
&lt;p&gt;I would like to thanks &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;ocramius.github.io&#x2F;&quot;&gt;Marco Pivetta&lt;&#x2F;a&gt; for
the reviews!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Tagua VM, a safe PHP virtual machine</title>
          <pubDate>Mon, 19 Jun 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/tagua-vm-a-safe-php-virtual-machine/</link>
          <guid>https://mnt.io/articles/tagua-vm-a-safe-php-virtual-machine/</guid>
          <description xml:base="https://mnt.io/articles/tagua-vm-a-safe-php-virtual-machine/">&lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;Ymy8qAEe0kQ?si=_7IlrTO1VzOriUKW&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot; referrerpolicy=&quot;strict-origin-when-cross-origin&quot; allowfullscreen&gt;
&lt;&#x2F;iframe&gt;
&lt;p&gt;PHPTour Nantes 2017 (in French):&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;PHP est un langage extrêment populaire. En 2015, PHP était utilisé par
plus de 80% de tous les sites Web. Cependant, 500 vulnérabilités
sévères sont répertoriées. Bien qu&#x27;inhérent à tous langages
populaires, cela reste très dangereux. L&#x27;objectif du projet Tagua VM
est de fournir une VM PHP qui garantie un haut niveau de sûreté et de
qualité en supprimant des larges classes de vulnérabilités, grâce à
des outils appropriés comme Rust et LLVM. Rust est un langage
remarquable qui apporte des garanties fortes à propos de la sûreté de
la mémoire. C&#x27;est aussi un langage très rapide qui rivalise avec C.
LLVM est une infrastructure de compilateur célèbre qui apporte de la
modernité, des algorithmes à la pointe, des performances, une suite
d&#x27;outils pour développeur etc. Ce projet va résoudre trois problèmes
en une fois :&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Fournir un niveau haut niveau de sûreté et de qualité en
supprimant des larges classes de vulnérabilité, et ainsi éviter
des coûts de bugs dramatiques ;&lt;&#x2F;li&gt;
&lt;li&gt;Fournir de la modernité, une nouvelle expérience développeur et
des algorithmes à la pointe de la recherche, donc des performances ;&lt;&#x2F;li&gt;
&lt;li&gt;Fournir un ensemble de bibliothèques qui vont composer la VM et
qui pourront être réutiliser en dehors du projet (comme le
parseur, les analyseurs, les extensions etc.).&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Durant cette conférence, nous présenterons les objectifs de ce projet,
ainsi que son avancement. Nous expliquerons pourquoi il est crucial et
pourquoi il reçoit le soutient d&#x27;une communauté grandissante et de
développeurs notables (avec un rôle important dans le développement de
PHP).&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;speakerdeck.com&#x2F;hywan&#x2F;tagua-vm-a-safe-php-virtual-machine&quot;&gt;View
slides&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Faster find algorithms in nom</title>
          <pubDate>Tue, 23 May 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/faster-find-algorithms-in-nom/</link>
          <guid>https://mnt.io/articles/faster-find-algorithms-in-nom/</guid>
          <description xml:base="https://mnt.io/articles/faster-find-algorithms-in-nom/">&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;tagua-vm&#x2F;&quot;&gt;Tagua VM&lt;&#x2F;a&gt; is an experimental PHP virtual
machine written in Rust and LLVM. It is composed as a set of libraries.
One of them that keeps me busy these days is
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;tagua-vm&#x2F;parser&quot;&gt;&lt;code&gt;tagua-parser&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. It contains the
lexical and syntactic analysers for the PHP language, in addition to the
AST (Abstract Syntax Tree). If you would like to know more about this
project, you can see this conference I gave at the PHPTour last week:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;speakerdeck.com&#x2F;hywan&#x2F;tagua-vm-a-safe-php-virtual-machine&quot;&gt;Tagua VM, a safe PHP virtual
machine&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The library &lt;code&gt;tagua-parser&lt;&#x2F;code&gt; is built with parser combinators. Instead of
having a classical grammar, compiled to a parser, we write pure
functions acting as small parsers. We then combine them together. This
post does not explain why this is a sane approach in our context, but
keep in mind this is much easier to test, to maintain, and to optimise.&lt;&#x2F;p&gt;
&lt;p&gt;Because this project is complex enought, we are delegating the parser
combinator implementation to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Geal&#x2F;nom&#x2F;&quot;&gt;nom&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;nom is a parser combinators library written in Rust. Its goal is to
provide tools to build safe parsers without compromising the speed or
memory consumption. To that end, it uses extensively Rust&#x27;s &lt;em&gt;strong
typing&lt;&#x2F;em&gt;, &lt;em&gt;zero copy&lt;&#x2F;em&gt; parsing, &lt;em&gt;push streaming&lt;&#x2F;em&gt;, &lt;em&gt;pull streaming&lt;&#x2F;em&gt;, and
provides macros and traits to abstract most of the error prone
plumbing.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Recently, I have been working on optimisations in the &lt;code&gt;FindToken&lt;&#x2F;code&gt; and
&lt;code&gt;FindSubstring&lt;&#x2F;code&gt; traits from nom itself. These traits provide methods to
find a token (i.e. a lexeme), and to find a substring, crazy naming.
However, this is not totally valid: &lt;code&gt;FindToken&lt;&#x2F;code&gt; expects to find a single
item (if implemented for &lt;code&gt;u8&lt;&#x2F;code&gt;, it will look for a &lt;code&gt;u8&lt;&#x2F;code&gt; in a &lt;code&gt;&amp;amp;[u8]&lt;&#x2F;code&gt;),
and &lt;code&gt;FindSubstring&lt;&#x2F;code&gt; really is about finding a substring, so a token of
any length.&lt;&#x2F;p&gt;
&lt;p&gt;It appeared that these methods can be optimised in some cases. Both
default implementations are using Rust iterators: Regular iterator for
&lt;code&gt;FindToken&lt;&#x2F;code&gt;, and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;slice&#x2F;struct.Windows.html&quot;&gt;window
iterator&lt;&#x2F;a&gt; for
&lt;code&gt;FindSubstring&lt;&#x2F;code&gt;, i.e. an iterator over overlapping subslices of a given
length. We have benchmarked big PHP comments, which are analysed by
parsers actively using these two trait implementations.&lt;&#x2F;p&gt;
&lt;p&gt;Here are the result, before and after our optimisations:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;test …::bench_span ... bench:      73,433 ns&#x2F;iter (+&#x2F;- 3,869)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;test …::bench_span ... bench:      15,986 ns&#x2F;iter (+&#x2F;- 3,068)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;A boost of 78%! Nice!&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Geal&#x2F;nom&#x2F;pull&#x2F;507&quot;&gt;pull request has been merged&lt;&#x2F;a&gt;
today, thank you Geoffroy Couprie! The new algorithms heavily rely on
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;BurntSushi&#x2F;rust-memchr&quot;&gt;the &lt;code&gt;memchr&lt;&#x2F;code&gt; crate&lt;&#x2F;a&gt;. So all
the credits should really go to Andrew Gallant! This crate provides a
safe interface &lt;code&gt;libc&lt;&#x2F;code&gt;&#x27;s &lt;code&gt;memchr&lt;&#x2F;code&gt; and &lt;code&gt;memrchr&lt;&#x2F;code&gt;. It also provides
fallback implementations when either function is unavailable.&lt;&#x2F;p&gt;
&lt;p&gt;The new algorithms are only implemented for &lt;code&gt;&amp;amp;[u8]&lt;&#x2F;code&gt; though. Fortunately,
the implementation for &lt;code&gt;&amp;amp;str&lt;&#x2F;code&gt; fallbacks to the former.&lt;&#x2F;p&gt;
&lt;p&gt;This is small contribution, but it brings a very nice boost. Hope it
will benefit to other projects!&lt;&#x2F;p&gt;
&lt;p&gt;I am also blowing the dust off of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.amazon.com&#x2F;Algorithms-Strings-Maxime-Crochemore&#x2F;dp&#x2F;0521848997&quot;&gt;Algorithms on
Strings&lt;&#x2F;a&gt;,
by M. Crochemore, C. Hancart, and T. Lecroq. I am pretty sure it should
be useful for nom and &lt;code&gt;tagua-parser&lt;&#x2F;code&gt;. If you haven&#x27;t read this book yet,
I can only encourage you to do so!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Welcome to Chaos</title>
          <pubDate>Mon, 24 Apr 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/welcome-to-chaos/</link>
          <guid>https://mnt.io/articles/welcome-to-chaos/</guid>
          <description xml:base="https://mnt.io/articles/welcome-to-chaos/">&lt;p&gt;Recently, &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;bye-bye-liip-hello-automattic&#x2F;&quot;&gt;I joined
Automattic&lt;&#x2F;a&gt;.
This is a world-wide distributed company. The first three weeks you
incarn a Happiness Engineer. This is part of the Happiness Rotation
duty. This article explains why I loved it, and why I reckon you should
do it too.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;happiness-engineer-really&quot;&gt;Happiness Engineer, really?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#happiness-engineer-really&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Does it sound mad as a Cheshire cat? Pretentious maybe? Actually, it&#x27;s
not at all.&lt;&#x2F;p&gt;
&lt;p&gt;As a Happiness Engineer, I had to make the support. This is part of the
Happiness Rotation: Once a year, almost everyone swaps its position to
help our users. I will go back on this later.&lt;&#x2F;p&gt;
&lt;p&gt;My role was to make our users happy. To achieve that, I had to:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Meet our users, understand who they are, what they want to achieve,&lt;&#x2F;li&gt;
&lt;li&gt;Listen to and understand their issues,&lt;&#x2F;li&gt;
&lt;li&gt;Find a way to fix the issues.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;meet-the-users&quot;&gt;Meet the users&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#meet-the-users&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;I need motivations in my job. Learning who our users are, and what they
want to achieve, is a great motivation. After these three weeks, I know
what my contributions will serve. It gives a meaning to each
contribution, to each day I wake up.&lt;&#x2F;p&gt;
&lt;p&gt;Especially in a distributed company on Internet, our users are
world-wide, they speak almost all the languages on Earth, they are
present on all continents. Their needs vary a lot, they use our
software in ways I was not able to foresee.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;listen-to-understand-and-fix-their-issues&quot;&gt;Listen to, understand, and fix their issues&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#listen-to-understand-and-fix-their-issues&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;When you are chatting with a “support guy”, you cannot imagine this is a
real engineer. This is not a random person filling a pre-defined vague
form somewhere where it is cheap to hire her. You will chat with someone
very competent. Someone that has no superior. Someone that has all the
tools to make you happy.&lt;&#x2F;p&gt;
&lt;p&gt;Personally, when I started, it was the first time I was using WordPress.
I was more novice than the user I was talking to. So how to fix it on my
end? I had to:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Ask help to the right persons,&lt;&#x2F;li&gt;
&lt;li&gt;Therefore, meet Automatticians (people working with Automattic),&lt;&#x2F;li&gt;
&lt;li&gt;Discover all the interactions between them,&lt;&#x2F;li&gt;
&lt;li&gt;Understand the structure of the company,&lt;&#x2F;li&gt;
&lt;li&gt;How to ask help, how to formulate my questions, how to reformulate the issues
of the users…&lt;&#x2F;li&gt;
&lt;li&gt;Discover all the internal tools,&lt;&#x2F;li&gt;
&lt;li&gt;Therefore, learn how the software work internally and together,&lt;&#x2F;li&gt;
&lt;li&gt;Discover the giant internal and public documentations,&lt;&#x2F;li&gt;
&lt;li&gt;When needed, create bug reports or feature requests to the
appropriated teams,&lt;&#x2F;li&gt;
&lt;li&gt;Learn the culture of the company.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This is why it is called &lt;em&gt;Welcome to Chaos&lt;&#x2F;em&gt;. Yes, you have to learn a
lot in three weeks, but it is extremely educative. This is like a speed
training.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;happiness&quot;&gt;Happiness&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#happiness&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;I can ensure that when a user is grateful after you fixed its issue, the
term Happiness Engineer makes a lot of sense. Automattic provides a lot
of freedom to their Happiness Engineers to make people really happy,
both in term of tooling or financial.&lt;&#x2F;p&gt;
&lt;p&gt;This is the first time I see a company that is that much generous with
its customers.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;thanks-buddy&quot;&gt;Thanks buddy&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#thanks-buddy&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Of course, when embracing the chaos, you are not alone. Everyone is here
to help you, and to answer your questions. After all, this is part of
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;automattic.com&#x2F;creed&#x2F;&quot;&gt;the Automattic&#x27;s creed&lt;&#x2F;a&gt; (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;ma.tt&#x2F;2011&#x2F;09&#x2F;automattic-creed&#x2F;&quot;&gt;story of the
creed&lt;&#x2F;a&gt;):&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;I will never stop learning. I won’t just work on things that are
assigned to me. I know there’s no such thing as a status quo. I will
build our business sustainably through passionate and loyal customers.
&lt;strong&gt;I will never pass up an opportunity to help out a colleague&lt;&#x2F;strong&gt;, and
&lt;strong&gt;I’ll remember the days before I knew everything&lt;&#x2F;strong&gt;. I am more
motivated by impact than money, and I know that Open Source is one of
the most powerful ideas of our generation. I will communicate as much
as possible, because it’s the oxygen of a distributed company. I am in
a marathon, not a sprint, and no matter how far away the goal is, the
only way to get there is by putting one foot in front of another every
day. Given time, there is no problem that’s insurmountable.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;In addition to everyone willing to help, a buddy was assigned to me. A
person that helps and teaches you every time. This is very helpful. Thank
you Hannah!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;happiness-rotation&quot;&gt;Happiness Rotation&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#happiness-rotation&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;This experience is great. But after some time, you might forget it. So
as a reminder, once a year, you incarn a Happiness Engineer again. This
is part of the happiness rotation. As far as I understand, it implies
almost everyone in the company.&lt;&#x2F;p&gt;
&lt;p&gt;Note: Obviously, there is permanent happiness engineers.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#conclusion&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;I deeply think this approach has many advantages. Some of them are
listed above. It helps to understand the company, and more importantly
the users. The happiness rotation stresses the fact that users are
central to Automattic, probably like any companies, but not with this
care. Remember the creed: I will build our business sustainably through
passionate and loyal customers. To have passionate and loyal users, you
need to know them.&lt;&#x2F;p&gt;
&lt;p&gt;For me, it was a great experience. It was chaotic at first, but it is
worth it.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Bye bye Liip, hello Automattic</title>
          <pubDate>Tue, 18 Apr 2017 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/bye-bye-liip-hello-automattic/</link>
          <guid>https://mnt.io/articles/bye-bye-liip-hello-automattic/</guid>
          <description xml:base="https://mnt.io/articles/bye-bye-liip-hello-automattic/">&lt;p&gt;Since April 2017, I have left &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.liip.ch&#x2F;&quot;&gt;Liip&lt;&#x2F;a&gt; to join
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;automattic.com&#x2F;&quot;&gt;Automattic&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;bye-bye-liip&quot;&gt;Bye bye Liip&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#bye-bye-liip&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;After almost 20 months at Liip, I am leaving. Liip was a great
experience. It was my first industrial non-remote job. It was also my
first job in the country I am currently living in. And I have discovered
a new way of working.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;first-industrial-non-remote-job&quot;&gt;First industrial non-remote job&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#first-industrial-non-remote-job&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Before working for Liip, I was working for &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;fruux.com&#x2F;&quot;&gt;fruux&lt;&#x2F;a&gt;.
My situation was the following: A french citizen, living as a foreigner
in Switzerland, working for a German company, with employees from
Germany, Holland, and Canada. Everything happened on chat, mail, and
Skype. When my son was born, I had to change my work to simplify my
life. It was not the only reason, but one of them.&lt;&#x2F;p&gt;
&lt;p&gt;And before fruux, I was working for &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.inria.fr&#x2F;en&#x2F;&quot;&gt;INRIA&lt;&#x2F;a&gt;, a
research institute in France. It was partially a remote job.&lt;&#x2F;p&gt;
&lt;p&gt;Liip has several offices. I was based in Lausanne.&lt;&#x2F;p&gt;
&lt;p&gt;So, yes, Liip was my first industrial non-remote job. And I liked it.
Working in the train on the morning, walking in Lausanne, seeing real
people, everything in my local language. Because yes, it was my first
job in my native language too.&lt;&#x2F;p&gt;
&lt;p&gt;Everything was simpler. And when you have your first baby, anything else
that is simpler saves your life.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;introducing-holacracy&quot;&gt;Introducing Holacracy&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#introducing-holacracy&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Giant discussions were happening to remove any form of hierarchy in
Liip. Then we discovered
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Holacracy&quot;&gt;Holacracy&lt;&#x2F;a&gt;, and we started
moving to this system. This is a new governance system. If you are
familiar with distributed network topologies in Computer Science, or
data structures, it really looks like a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hal.archives-ouvertes.fr&#x2F;hal-00560821&#x2F;document&quot;&gt;Distributed Spanning
Tree&lt;&#x2F;a&gt;
[&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;dblp.org&#x2F;rec&#x2F;html&#x2F;journals&#x2F;tpds&#x2F;DahanPN09&quot;&gt;DahanPN09&lt;&#x2F;a&gt;]. Note:
I am sure that the authors of Holacracy are not aware of DST, but, eh.&lt;&#x2F;p&gt;
&lt;p&gt;So nothing new from a research point of view, but it is cool to see this
algorithm coming alive in real life. And it worked: Less meetings, more
self-organisation, more shared responsabilities, no more “boss” etc.
This is not a tool for all companies, but I am sure that if you are
reading my blog, then your company should give it a try.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;open-source-projects&quot;&gt;Open source projects&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#open-source-projects&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Liip has been very generous with me regarding my open source
engagements. I was involved in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hoa-project.net&#x2F;&quot;&gt;Hoa&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;atoum.org&#x2F;&quot;&gt;atoum&lt;&#x2F;a&gt;, and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;FriendsOfPHP&#x2F;pickle&quot;&gt;Pickle&lt;&#x2F;a&gt; when joining the
company. Liip gave me a 5% budget, so roughly 1 hour per day to work on
Hoa. Thank you for that!&lt;&#x2F;p&gt;
&lt;p&gt;After that, I have started a new big project, called &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;tagua-vm&#x2F;tagua-vm&quot;&gt;Tagua
VM&lt;&#x2F;a&gt;. They gave me an additional 5%
budget. So I got 2 hours per day to work on Hoa and Tagua VM. Again, thank
you for that!&lt;&#x2F;p&gt;
&lt;p&gt;Finally, I have started an in-house open project called &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;liip&#x2F;TheA11yMachine&quot;&gt;The A11y
Machine&lt;&#x2F;a&gt; (a11ym for short). I
have written a case study for this tool on the Liip&#x27;s blog:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;blog.liip.ch&#x2F;archive&#x2F;2016&#x2F;12&#x2F;06&#x2F;accessibility-with-a11ym.html&quot;&gt;Accessibility: make your website barrier-free with
a11ym!&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;The goal of a11ym is to automate the accessibility testing of any site
by crawling and testing each page. A sweet report is generated, showing
all errors, warnings, and notices, with all information needed by the
developer to fix the issues as fast as possible.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;bye-bye-liip-hello-automattic&#x2F;.&#x2F;dashboard.jpg&quot; alt=&quot;Dashboard&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Dashboard of a11ym, showing the evolution of the accessibility of a site
in time&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;bye-bye-liip-hello-automattic&#x2F;.&#x2F;report.png&quot; alt=&quot;Report&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;A typical a11ym report listing all errors, warnings, and notices for a
given URL&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;This project has received really good feedbacks from the accessibility
community. It has been downloaded 7000 times so far, which is not bad
considering the niche it targets.&lt;&#x2F;p&gt;
&lt;p&gt;A new SaaS platform is being build around this software. I enjoyed
working on it, and it was really tangible.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;&quot;&gt;Main customer, huge project&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Liip is a Web agency, so you have dozens of customers at the same time.
However, I was in a special team for an important customer. The site is
a luxury watches and jewellery e-commerce platform, located in several
countries, in 10 languages, accessible from 16 domains, shared in 2
datacenters. This is not a casual site.&lt;&#x2F;p&gt;
&lt;p&gt;I learned a lot about all the complexity such a site brings: Checkout
rules (oh damned…), product catalogs in different formats for different
countries with different references, all the business logic inherent to
each country, different payment providers, crazy front end
compatibilities etc.&lt;&#x2F;p&gt;
&lt;p&gt;I have a hundred of crazy anecdotes to tell. This was clearly not a job
for me at first glance: I am a researcher, I have an open source culture
background, I am not tailored for this kind of project. But at the end
of the story, I learned a lot. Really a lot. I have a better overview of
the crazy things any customer can ask, or has to deal with, and the
infrastructure craziness that can be set up. I learned how to make
better things: How to transform a really crappy software into something
understandable by everyone, how to not break a 10+ years old progam with
no test etc. And it requires skills. I learned it the hard way, but I
learned it.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-1&quot;&gt;Why leaving?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Because even if I learned during my time at Liip, the Web agency model
was definitively not for me. I am very thankful to every Liiper, I had a
great time, I love the Web, but not in an agency.&lt;&#x2F;p&gt;
&lt;p&gt;My son is now 21 months old, and I need fresh air. I can take new
challenges.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-2&quot;&gt;Welcome Automattic&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;automattic.com&#x2F;&quot;&gt;Automattic&lt;&#x2F;a&gt; is the company behind
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wordpress.com&#x2F;&quot;&gt;WordPress.com&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;woocommerce.com&#x2F;&quot;&gt;WooCommerce&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;akismet.com&#x2F;&quot;&gt;Akismet&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;simplenote.com&#x2F;&quot;&gt;Simplenote&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;cloudup.com&#x2F;&quot;&gt;Cloudup&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;simperium.com&quot;&gt;Simperium&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;en.gravatar.com&#x2F;&quot;&gt;Gravatar&lt;&#x2F;a&gt; and other giant services.&lt;&#x2F;p&gt;
&lt;p&gt;I came to Automattic by coincidence. I was looking for a sponsor for
Tagua VM, and someone pointed me out Automattic. After some researches
about the company, it appears that it could be a really great place
where to work. So I applied.&lt;&#x2F;p&gt;
&lt;p&gt;The hiring process was 4 months long. It was exhausting because it
happened at the same time than a big sprint at Liip (remember the SaaS
platform for The A11y Machine?). But after 4 months, it appears I
succeeded, and I am very glad of that fact!&lt;&#x2F;p&gt;
&lt;p&gt;I am just starting my job at Automattic. I don&amp;#39;t have anything strong
and finite to say now, apart that everything is just awesome so far. In
few weeks, I am likely to write about my start at Automattic I did, see
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;welcome-to-chaos&#x2F;&quot;&gt;Welcome to Chaos&lt;&#x2F;a&gt;. They
have a very interesting way to get you on board.&lt;&#x2F;p&gt;
&lt;p&gt;Time for a new adventure!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>DuckDuckGo in a Shell</title>
          <pubDate>Wed, 05 Aug 2015 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/duckduckgo-in-a-shell/</link>
          <guid>https://mnt.io/articles/duckduckgo-in-a-shell/</guid>
          <description xml:base="https://mnt.io/articles/duckduckgo-in-a-shell/">&lt;h2 id=&quot;the-tip&quot;&gt;The tip&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-tip&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;When I go outside my terminal, I am kind of lost. I control everything
from my terminal and I hate clicking. That&#x27;s why I found a small tip
today to open a search on DuckDuckGo directly from the terminal. It
redirects me to my default browser in the background, which is the
expected behavior.&lt;&#x2F;p&gt;
&lt;p&gt;First, I create a function called &lt;code&gt;duckduckgo&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellscript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt;function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; duckduckgo&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    query&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;`&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;php&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; -r&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;echo urlencode($argv[1]);&amp;#39; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-parameter&quot;&gt;$1&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    open&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;https:&#x2F;&#x2F;duckduckgo.com&#x2F;?q=&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$query&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Note how I (avoid to) deal with quotes in &lt;code&gt;$1&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Then, I just have to create an alias called &lt;code&gt;?&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellscript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;alias&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;?&amp;#39;=&amp;#39;duckduckgo&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And here we (duckduck) go!&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ?&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;foo bar&amp;#39;s baz&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You can &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;Hywan&#x2F;Dotfiles&#x2F;commit&#x2F;fab6d98448240a787eb0e34ab836c5c43d50379c&quot;&gt;see the
commit&lt;&#x2F;a&gt;
that adds this to my “shell home framework”.&lt;&#x2F;p&gt;
&lt;p&gt;Oh, and to open the default browser, I use
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;library&#x2F;mac&#x2F;documentation&#x2F;Darwin&#x2F;Reference&#x2F;ManPages&#x2F;man1&#x2F;open.1.html&quot;&gt;&lt;code&gt;open (1)&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,
like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellscript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;alias&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; open&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;open -g&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Hope it helps!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>sabre&#x2F;katana</title>
          <pubDate>Mon, 13 Jul 2015 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/sabre-katana-a-contact-calendar-task-list-and-file-server/</link>
          <guid>https://mnt.io/articles/sabre-katana-a-contact-calendar-task-list-and-file-server/</guid>
          <description xml:base="https://mnt.io/articles/sabre-katana-a-contact-calendar-task-list-and-file-server/">&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;logo-katana.png&quot; alt=&quot;sabre&#x2F;katana&amp;#39;s logo&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Project&amp;#39;s logo.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;h2 id=&quot;&quot;&gt;What is it?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; is a contact, calendar, task list and file server. What
does it mean? Assuming nowadays you have multiple devices (PC, phones,
tablets, TVs…). If you would like to get your address books, calendars,
task lists and files synced between all these devices from everywhere,
you need a server. All your devices are then considered as clients.&lt;&#x2F;p&gt;
&lt;p&gt;But there is an issue with the server. Most of the time, you might
choose &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;google.com&#x2F;&quot;&gt;Google&lt;&#x2F;a&gt; or maybe
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;apple.com&#x2F;&quot;&gt;Apple&lt;&#x2F;a&gt;, but one may wonder: Can we trust these
servers? Can we give them our private data, like all our contacts, our
calendars, all our photos…? What if you are a company or an association
and you have sensitive data that are really private or strategic? So,
can you still trust them? Where the data are stored? Who can look at
these data? More and more, there is a huge need for “personal” server.&lt;&#x2F;p&gt;
&lt;p&gt;Moreover, servers like Google or Apple are often closed: You reach your
data with specific clients and they are not available in all platforms.
This is for strategic reasons of course. But with &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt;, you
are not limited. See the above schema: Firefox OS can talk to iOS or
Android at the same time.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; is this kind of server. You can install it on your
machine and manage users in a minute. Each user will have a collection
of address books, calendars, task lists and files. This server can talk
to a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;fruux.com&#x2F;supported-devices&#x2F;&quot;&gt;loong list of devices&lt;&#x2F;a&gt;,
mainly thanks to a scrupulous respect of industrial standards:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;macOS:
&lt;ul&gt;
&lt;li&gt;OS X 10.10 (Yosemite),&lt;&#x2F;li&gt;
&lt;li&gt;OS X 10.9 (Mavericks),&lt;&#x2F;li&gt;
&lt;li&gt;OS X 10.8 (Mountain Lion),&lt;&#x2F;li&gt;
&lt;li&gt;OS X 10.7 (Lion),&lt;&#x2F;li&gt;
&lt;li&gt;OS X 10.6 (Snow Leopard),&lt;&#x2F;li&gt;
&lt;li&gt;OS X 10.5 (Leopard),&lt;&#x2F;li&gt;
&lt;li&gt;BusyCal,&lt;&#x2F;li&gt;
&lt;li&gt;BusyContacts,&lt;&#x2F;li&gt;
&lt;li&gt;Fantastical,&lt;&#x2F;li&gt;
&lt;li&gt;Rainlendar,&lt;&#x2F;li&gt;
&lt;li&gt;ReminderFox,&lt;&#x2F;li&gt;
&lt;li&gt;SoHo Organizer,&lt;&#x2F;li&gt;
&lt;li&gt;Spotlife,&lt;&#x2F;li&gt;
&lt;li&gt;Thunderbird ,&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Windows:
&lt;ul&gt;
&lt;li&gt;eM Client,&lt;&#x2F;li&gt;
&lt;li&gt;Microsoft Outlook 2013,&lt;&#x2F;li&gt;
&lt;li&gt;Microsoft Outlook 2010,&lt;&#x2F;li&gt;
&lt;li&gt;Microsoft Outlook 2007,&lt;&#x2F;li&gt;
&lt;li&gt;Microsoft Outlook with Bynari WebDAV Collaborator,&lt;&#x2F;li&gt;
&lt;li&gt;Microsoft Outlook with iCal4OL,&lt;&#x2F;li&gt;
&lt;li&gt;Rainlendar,&lt;&#x2F;li&gt;
&lt;li&gt;ReminderFox,&lt;&#x2F;li&gt;
&lt;li&gt;Thunderbird,&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Linux:
&lt;ul&gt;
&lt;li&gt;Evolution,&lt;&#x2F;li&gt;
&lt;li&gt;Rainlendar,&lt;&#x2F;li&gt;
&lt;li&gt;ReminderFox,&lt;&#x2F;li&gt;
&lt;li&gt;Thunderbird,&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Mobile:
&lt;ul&gt;
&lt;li&gt;Android,&lt;&#x2F;li&gt;
&lt;li&gt;BlackBerry 10,&lt;&#x2F;li&gt;
&lt;li&gt;BlackBerry PlayBook,&lt;&#x2F;li&gt;
&lt;li&gt;Firefox OS,&lt;&#x2F;li&gt;
&lt;li&gt;iOS 8,&lt;&#x2F;li&gt;
&lt;li&gt;iOS 7,&lt;&#x2F;li&gt;
&lt;li&gt;iOS 6,&lt;&#x2F;li&gt;
&lt;li&gt;iOS 5,&lt;&#x2F;li&gt;
&lt;li&gt;iOS 4,&lt;&#x2F;li&gt;
&lt;li&gt;iOS 3,&lt;&#x2F;li&gt;
&lt;li&gt;Nokia N9,&lt;&#x2F;li&gt;
&lt;li&gt;Sailfish.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Did you find your device in this list? Probably yes 😉.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; sits in the middle of all your devices and synced all
your data. Of course, it is &lt;strong&gt;free&lt;&#x2F;strong&gt; and &lt;strong&gt;open source&lt;&#x2F;strong&gt;. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-katana&#x2F;&quot;&gt;Go check the
source&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;List of features&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Here is a non-exhaustive list of features supported by &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt;.
Depending whether you are a user or a developer, the features that might
interest you are radically not the same. I decided to show you a list
from the user point of view. If you would like to get a list from the
developer point of view, please see this &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;sabre.io&#x2F;dav&#x2F;standards-support&#x2F;&quot;&gt;exhaustive list of supported
RFC&lt;&#x2F;a&gt; for more details.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-2&quot;&gt;Contacts&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;All usual fields are supported, like phone numbers, email addresses,
URLs, birthday, ringtone, texttone, related names, postal addresses,
notes, HD photos etc. Of course, groups of cards are also supported.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;card-inside-macos-client.png&quot; alt=&quot;My card on macOS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;My card inside the native Contact application of macOS.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;card-inside-firefox-os-client.png&quot; alt=&quot;My card on Firefox OS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;My card inside the native Contact application of Firefox OS.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;My photo is not in HD, I really have to update it!&lt;&#x2F;p&gt;
&lt;p&gt;Cards can be encoded into several formats. The most usual format is VCF.
&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; allows you to download the whole address book of a user
as a single VCF file. You can also create, update and delete address
books.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-3&quot;&gt;Calendars&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;A calendar is just a set of events. Each event has several properties,
such as a title, a location, a date start, a date end, some notes, URLs,
alarms etc. &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; also support recurring events (“each last
Monday of the month, at 11am…”), in addition to scheduling (see bellow).&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;calendars-inside-macos-client.png&quot; alt=&quot;My calendars on macOS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;My calendars inside the native Calendar application of macOS.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;calendars-inside-firefox-os-client.png&quot; alt=&quot;My calendars on Firefox OS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;My calendars inside the native Calendar application of Firefox OS.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Few words about calendar scheduling. Let&amp;#39;s say you are organizing an
event, like New release (we always enjoy release day!). You would like
to invite several people but you don&amp;#39;t know if they could be present or
not. In your event, all you have to do is to add attendees. How are they
going to be notified about this event? Two situations:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Either attendees are registered on your &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; server and they will
receive an invite inside their calendar application (we call this iTIP),&lt;&#x2F;li&gt;
&lt;li&gt;Or they are not registered on your server and they will receive an email with
the event as an attached file (we call this iMIP). All they have to do is to
open this event in their calendar application.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;invite-by-email.png&quot; alt=&quot;Typical mail to invite an attendee to an event&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Invite an attendee by email because she is not registered on your
&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; server.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Notice the gorgeous map embedded inside the email!&lt;&#x2F;p&gt;
&lt;p&gt;Once they received the event, they can accept, decline or “don&amp;#39;t know”
(they will try to be present at) the event.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;respond-to-invite.png&quot; alt=&quot;Receive an invite to an event&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Receive an invite to an event. Here: Gordon is inviting Hywan. Three
choices for Hywan:&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;accepted-event.png&quot; alt=&quot;Status of all attendees&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Hywan has accepted the event. Here is what the event looks like. Hywan
can see the response of each attendees.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;notification.png&quot; alt=&quot;Notification from attendees&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Gordon is even notified that Hywan has accepted the event.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Of course, attendees will be notified too if the event has been moved,
canceled, refreshed etc.&lt;&#x2F;p&gt;
&lt;p&gt;Calendars can be encoded into several formats. The most usal format is
ICS. &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; allows you to download the whole calendar of a user
as a single ICS file. You can also create, update and delete calendars.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-4&quot;&gt;Task lists&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-4&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;A task list is exactly like a calendar (from a programmatically point of
view). Instead of containg event objects, it contains todo objects.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; supports group of tasks, reminder, progression etc.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;tasks.png&quot; alt=&quot;My task lists on macOS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;My task lists inside the native Reminder application of macOS.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Just like calendars, task lists can be encoded into several formats,
whose ICS. &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; allows you to download the whole task list of
a user as a single ICS file. You can also create, update and delete task
lists.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;-5&quot;&gt;Files&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-5&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Finally, &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; creates a home collection per user: A personal
directory that can contain files and directories and… synced between all
your devices (as usual 😄).&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; also creates a special directory called &lt;code&gt;public&#x2F;&lt;&#x2F;code&gt; which
is a public directory. Every files and directories stored inside this
directory are accessible to anyone that has the correct link. No listing
is prompted to protect your public data.&lt;&#x2F;p&gt;
&lt;p&gt;Just like contact, calendar and task list applications, you need a
client application to connect to your home collection on &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;connect-to-dav.png&quot; alt=&quot;Connect to a server in macOS&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Connect to a server with the Finder application of macOS.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Then, your public directory on &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; will be a regular
directory as every other.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;sabre-katana-a-contact-calendar-task-list-and-file-server&#x2F;.&#x2F;files.png&quot; alt=&quot;List of my files&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;List of my files, right here in the Finder application of macOS.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; is able to store any kind of files. Yes, any kinds. It&amp;#39;s
just files. However, it white-lists the kind of files that can be showed
in the browser. Only images, audios, videos, texts, PDF and some vendor
formats (like Microsoft Office) are considered as safe (for the server).
This way, associations can share musics, videos or images, companies can
share PDF or Microsoft Word documents etc. Maybe in the future
&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; might white-list more formats. If a format is not
white-listed, the file will be forced to download.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sabre-katana&quot;&gt;How is &lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; built?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#sabre-katana&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; is based on two big and solid projects:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;sabre.io&#x2F;&quot;&gt;&lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;&quot;&gt;Hoa&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt; is one of the most powerful
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CardDAV&quot;&gt;CardDAV&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CalDAV&quot;&gt;CalDAV&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;WebDAV&quot;&gt;WebDAV&lt;&#x2F;a&gt; framework in the planet.
Trusted by the likes of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.atmail.com&#x2F;&quot;&gt;Atmail&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.box.com&#x2F;blog&#x2F;in-search-of-an-open-source-webdav-solution&#x2F;&quot;&gt;Box&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;fruux.com&#x2F;&quot;&gt;fruux&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;owncloud.org&#x2F;&quot;&gt;ownCloud&lt;&#x2F;a&gt;, it
powers millions of users world-wide! It is written in PHP and is open
source.&lt;&#x2F;p&gt;
&lt;p&gt;Hoa is a modular, extensible and structured set of PHP libraries. Fun
fact: Also open source, this project is also trusted by
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;owncloud.org&#x2F;&quot;&gt;ownCloud&lt;&#x2F;a&gt;, in addition to
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;mozilla.org&#x2F;&quot;&gt;Mozilla&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;jolicode.com&#x2F;&quot;&gt;joliCode&lt;&#x2F;a&gt; etc.
Recently, this project has recorded more than 600,000 downloads and the
community is about to reach 1000 people.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; is then a program based on &lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt; for the DAV part
and Hoa for everything else, like the logic code inside the
&lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt;&amp;#39;s plugins. The result is a ready-to-use server with a nice
interface for the administration.&lt;&#x2F;p&gt;
&lt;p&gt;To ensure code quality, we use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;atoum.org&#x2F;&quot;&gt;atoum&lt;&#x2F;a&gt;, a popular and
modern test framework for PHP. So far, &lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt; has more than
1000 assertions.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-6&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-6&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;katana&lt;&#x2F;code&gt; is a server for contacts, calendars, task lists and
files. Everything is synced, everytime and everywhere. It perfectly
connects to a lot of devices on the market. Several features we need and
use daily have been presented. This is the easiest and a secure way to
host your own private data.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-katana&quot;&gt;Go download it&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>RFCs should provide executable test suites</title>
          <pubDate>Fri, 27 Feb 2015 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/rfcs-should-provide-executable-test-suites/</link>
          <guid>https://mnt.io/articles/rfcs-should-provide-executable-test-suites/</guid>
          <description xml:base="https://mnt.io/articles/rfcs-should-provide-executable-test-suites/">&lt;p&gt;Recently, I implemented xCal and xCard formats inside the &lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt; libraries.
While testing the different RFCs against my implementation, several errata have
been found. This article, first, quickly list them and, second, ask questions
about how such errors can be present and how they can be easily revealed. If
reading my dry humor about RFC errata is boring, the next sections are more
interesting. The whole idea is: Why RFCs do not provide executable test suites?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-xcal-and-xcard&quot;&gt;What is xCal and xCard?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-is-xcal-and-xcard&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The Web is a read-only media. It is based on the HTTP protocol. However,
there is the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;WebDAV&quot;&gt;WebDAV&lt;&#x2F;a&gt; protocol,
standing for Web Distributed Authoring and Versioning. This is an
extension to HTTP. &lt;em&gt;Et voilà !&lt;&#x2F;em&gt; The Web is a read and write media.
WebDAV is standardized in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc2518&quot;&gt;RFC2518&lt;&#x2F;a&gt;
and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc4918&quot;&gt;RFC4918&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Based on WebDAV, we have &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CalDAV&quot;&gt;CalDAV&lt;&#x2F;a&gt;
and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CardDAV&quot;&gt;CardDAV&lt;&#x2F;a&gt;, respectively for
reading and writing calendars and addressbooks. They are standardized in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc4791&quot;&gt;RFC4791&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc6638&quot;&gt;RFC6638&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc6352&quot;&gt;RFC6352&lt;&#x2F;a&gt;. Good! But these
protocols only explain how to read and write, not how to represent a
real calendar or an addressbook. So let&#x27;s leave protocols for formats.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;ICalendar&quot;&gt;iCalendar&lt;&#x2F;a&gt; format
represents calendar events, like events (&lt;code&gt;VEVENT&lt;&#x2F;code&gt;), tasks (&lt;code&gt;VTODO&lt;&#x2F;code&gt;),
journal entry (&lt;code&gt;VJOURNAL&lt;&#x2F;code&gt;, very rare…), free&#x2F;busy time (&lt;code&gt;VFREEBUSY&lt;&#x2F;code&gt;)
etc. The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;VCard&quot;&gt;vCard&lt;&#x2F;a&gt; format represents
cards. The formats are very similar and share a common ancestry: This is
a &lt;strong&gt;horrible&lt;&#x2F;strong&gt; line-, colon- and semicolon-, randomly-escaped based
format. For instance:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;BEGIN:VCALENDAR&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;VERSION:2.0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;CALSCALE:GREGORIAN&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;PRODID:-&#x2F;&#x2F;Example Inc.&#x2F;&#x2F;Example Calendar&#x2F;&#x2F;EN&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;BEGIN:VEVENT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;DTSTAMP:20080205T191224Z&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;DTSTART;VALUE=DATE:20081006&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;SUMMARY:Planning meeting&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;UID:4088E990AD89CB3DBB484909&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;END:VEVENT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;END:VCALENDAR&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Horrible, yes. You were warned. These formats are standardized in
several RFCs, to list some of them:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc5545&quot;&gt;RFC5545&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc2426&quot;&gt;RFC2426&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc6350&quot;&gt;RFC6350&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This format is impossible to read, even for a computer. That&#x27;s why we
have jCal and jCard, which are respectively another representation of
iCalendar and vCard but in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;json.org&#x2F;&quot;&gt;JSON&lt;&#x2F;a&gt;. JSON is quite
popular in the Web today, especially because it eases the manipulation
and exchange of data in Javascript. This is just a very simple, and
—from my point of view— human readable, serialization format. jCal and
jCard are respectively standardized in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc7265&quot;&gt;RFC7265&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc7095&quot;&gt;RFC7095&lt;&#x2F;a&gt;. Thus, the equivalent of
the previous iCalendar example in jCal is:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;json&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;vcalendar&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;version&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;text&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;2.0&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;calscale&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;text&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;GREGORIAN&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;prodid&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;text&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;-&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\&#x2F;\&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;Example Inc.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\&#x2F;\&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;Example Calendar&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\&#x2F;\&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;EN&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    ]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            &amp;quot;vevent&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;dtstamp&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;date-time&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;2008-02-05T19:12:24Z&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;dtstart&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;date&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;2008-10-06&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;summary&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;text&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;Planning meeting&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                [&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;uid&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;text&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;4088E990AD89CB3DBB484909&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Much better. But this is JSON, which is a rather loose format, so we
also have xCal and xCard another representation of iCalendar and vCard
but in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;XML&quot;&gt;XML&lt;&#x2F;a&gt;. They are standardized
in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc6321&quot;&gt;RFC6321&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc6351&quot;&gt;RFC6351&lt;&#x2F;a&gt;. The same example in xCal
looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;xml&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;icalendar&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-attribute-name&quot;&gt; xmlns&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;urn:ietf:params:xml:ns:icalendar-2.0&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;  &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;vcalendar&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;properties&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;version&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;2.0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;version&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;calscale&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;GREGORIAN&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;calscale&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;prodid&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;-&#x2F;&#x2F;Example Inc.&#x2F;&#x2F;Example Calendar&#x2F;&#x2F;EN&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;prodid&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;    &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;properties&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;components&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;vevent&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;        &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;properties&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;dtstamp&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;            &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;date-time&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;2008-02-05T19:12:24Z&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;date-time&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;dtstamp&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;dtstart&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;            &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;date&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;2008-10-06&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;date&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;dtstart&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;summary&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;            &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;Planning meeting&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;summary&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;uid&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;            &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;4088E990AD89CB3DBB484909&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;text&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;          &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;uid&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;        &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;properties&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;      &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;vevent&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;    &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;components&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;  &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;vcalendar&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-tag&quot;&gt;icalendar&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-definition z-tag&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;More semantics, more meaning, easier to read (from my point of view),
namespaces… It is very easy to &lt;strong&gt;embed&lt;&#x2F;strong&gt; xCal and xCard inside other XML
formats.&lt;&#x2F;p&gt;
&lt;p&gt;Managing all these formats is an extremely laborious task. I suggest you
to take a look at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;sabre.io&#x2F;vobject&#x2F;&quot;&gt;&lt;code&gt;sabre&#x2F;vobject&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; (see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-vobject&#x2F;&quot;&gt;the
Github repository of
&lt;code&gt;sabre&#x2F;vobject&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;). This is a
PHP library to manage all the weird formats. The following example shows
how to read from iCalendar and write to jCal and xCal:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Read iCalendar.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$document&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; Sabre&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;VObject&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Reader&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$icalendar&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Write jCal.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span&gt; Sabre&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;VObject&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Writer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;writeJson&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$document&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Write xCal.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span&gt; Sabre&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;VObject&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Writer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;writeXml&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$document&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Magic when you know the complexity of these formats (in both term of
parsing and validation)!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;list-of-errata&quot;&gt;List of errata&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#list-of-errata&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Now, let&#x27;s talk about all the errata I submited recently:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.rfc-editor.org&#x2F;errata_search.php?eid=4241&quot;&gt;4241, in
RFC6351&lt;&#x2F;a&gt;
(xCard),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.rfc-editor.org&#x2F;errata_search.php?eid=4243&quot;&gt;4243, in
RFC6351&lt;&#x2F;a&gt;
(xCard),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.rfc-editor.org&#x2F;errata_search.php?eid=4246&quot;&gt;4246, in
RFC6350&lt;&#x2F;a&gt;
(vCard),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.rfc-editor.org&#x2F;errata_search.php?eid=4247&quot;&gt;4247, in
RFC6351&lt;&#x2F;a&gt;
(xCard),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.rfc-editor.org&#x2F;errata_search.php?eid=4245&quot;&gt;4245, in
RFC6350&lt;&#x2F;a&gt;
(vCard),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.rfc-editor.org&#x2F;errata_search.php?eid=4261&quot;&gt;4261, in
RFC6350&lt;&#x2F;a&gt;
(vCard).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The 2 last ones are reported, not yet verified.&lt;&#x2F;p&gt;
&lt;p&gt;4241, 4243 and 4246 are just typos in examples. “&lt;em&gt;just&lt;&#x2F;em&gt;” is a bit of an
under-statement when you are reading RFCs for days straight, you have 10
of them opened in your browser and trying to figure out how everything
fits together and if you are doing everything correctly. Finding typos
at that point in your process can be very confusing…&lt;&#x2F;p&gt;
&lt;p&gt;4247 is more subtle. The RFC about xCard comes with an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;XML_Schema_%28W3C%29&quot;&gt;XML
Schema&lt;&#x2F;a&gt;. That&#x27;s
great! It will help us to test our documents and see if they are valid
or not! No? No.&lt;&#x2F;p&gt;
&lt;p&gt;Most of the time, I try to relax and deal with the incoming problems.
But the date and time format in iCalendar, vCard, jCal, jCard, xCal and
xCard can make my blood boil in a second. In what world, exactly, &lt;code&gt;--10&lt;&#x2F;code&gt;
or &lt;code&gt;---28&lt;&#x2F;code&gt; is a conceivable date and time format? How long did I sleep?
“Well” — was I saying to myself, “do not make a drama, we have the XML
Schema!”. No. Because there is an error in the schema. More precisely,
in a regular expression:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;value-time = element time {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    xsd:string { pattern = &amp;quot;(\d\d(\d\d(\d\d)?)?|-\d\d(\d\d?)|--\d\d)&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                         ~ &amp;quot;(Z|[+\-]\d\d(\d\d)?)?&amp;quot; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Did you find the error? &lt;code&gt;(\d\d?)&lt;&#x2F;code&gt; is invalid, this is &lt;code&gt;(\d\d)?&lt;&#x2F;code&gt;. Don&#x27;t
get me wrong: Everyone makes mistakes, but not this kind of error. I
will explain why in the next section.&lt;&#x2F;p&gt;
&lt;p&gt;4245 is not an editorial error but a technical one, under review.&lt;&#x2F;p&gt;
&lt;p&gt;4261 is crazy. It deserves a whole sub-section.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;welcome-in-the-crazy-world-of-date-and-time-formats&quot;&gt;Welcome in the crazy world of date and time formats&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#welcome-in-the-crazy-world-of-date-and-time-formats&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;There are two major popular date and time format:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc2822&quot;&gt;RFC2822&lt;&#x2F;a&gt; and ISO.8601. Examples:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Fri, 27 Feb 2015 16:06:58 +0100&lt;&#x2F;code&gt; and&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;2015-02-27T16:07:16+01:00&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The second one is a good candidate for a computer representation: no
locale, only digits, all information are present…&lt;&#x2F;p&gt;
&lt;p&gt;Maybe you noticed there is no link on ISO.8601. Why? Because ISO
standards are not free and I don&#x27;t want &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.iso.org&#x2F;iso&#x2F;catalogue_detail?csnumber=40874&quot;&gt;to pay
140€&lt;&#x2F;a&gt; to buy a
standard…&lt;&#x2F;p&gt;
&lt;p&gt;The date and time format adopted by iCalendar and vCard (and the rest of
the family) is ISO.8601.2004. I cannot read it. However, since we said
in xCard we have an XML Schema; we can read this (after having applied
erratum 4247):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;# 4.3.1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;value-date = element date {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    xsd:string { pattern = &amp;quot;\d{8}|\d{4}-\d\d|--\d\d(\d\d)?|---\d\d&amp;quot; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;# 4.3.2&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;value-time = element time {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    xsd:string { pattern = &amp;quot;(\d\d(\d\d(\d\d)?)?|-\d\d(\d\d)?|--\d\d)&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                         ~ &amp;quot;(Z|[+\-]\d\d(\d\d)?)?&amp;quot; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;# 4.3.3&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;value-date-time = element date-time {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    xsd:string { pattern = &amp;quot;(\d{8}|--\d{4}|---\d\d)T\d\d(\d\d(\d\d)?)?&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                         ~ &amp;quot;(Z|[+\-]\d\d(\d\d)?)?&amp;quot; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;# 4.3.4&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;value-date-and-or-time = value-date | value-date-time | value-time&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Question: &lt;strong&gt;&lt;code&gt;--10&lt;&#x2F;code&gt; is October or 10 seconds&lt;&#x2F;strong&gt;?&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;--10&lt;&#x2F;code&gt; can fit into &lt;code&gt;value-date&lt;&#x2F;code&gt; and &lt;code&gt;value-time&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;From &lt;code&gt;value-date&lt;&#x2F;code&gt;, the 3rd element in the disjunction is &lt;code&gt;--\d\d(\d\d)?&lt;&#x2F;code&gt;, so
it matches &lt;code&gt;--10&lt;&#x2F;code&gt; ,&lt;&#x2F;li&gt;
&lt;li&gt;From &lt;code&gt;value-time&lt;&#x2F;code&gt;, the last element in the first disjunction is &lt;code&gt;--\d\d&lt;&#x2F;code&gt;, so
it matches &lt;code&gt;--10&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;If we have a date-and-or-time value, &lt;code&gt;value-date&lt;&#x2F;code&gt; comes first, so &lt;code&gt;--10&lt;&#x2F;code&gt;
is always October. Nevertheless, if we have a time value, &lt;code&gt;--10&lt;&#x2F;code&gt; is
10 seconds. Crazy now?&lt;&#x2F;p&gt;
&lt;p&gt;Oh, and XML has its own date and time format, which is well-defined and
standardized. Why should we drag this crazy format along?&lt;&#x2F;p&gt;
&lt;p&gt;Oh, and I assume every format depending on ISO.8601.2004 has this bug.
But I am not sure because ISO standards are not free.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;how-can-rfcs-have-such-errors&quot;&gt;How can RFCs have such errors?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#how-can-rfcs-have-such-errors&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;So far, RFCs are textual standards. Great. But they are just text.
Written by humans, and thus they are subject to errors or failures. It
is even error-prone. I do not understand: Why an RFC does not come with
an &lt;strong&gt;executable test suite&lt;&#x2F;strong&gt;? I am pretty sure every reader of an RFC
will try to create a test suite on its own.&lt;&#x2F;p&gt;
&lt;p&gt;I assume xCal and xCard formats are not yet very popular. Consequently,
few people read the RFC and tried to write an implementation. This is my
guess. However, it does not avoid the fact an executable test suite
should (must?) be provided.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;how-did-i-find-them&quot;&gt;How did I find them?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#how-did-i-find-them&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;This is how I found these errors. I wrote &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-vobject&#x2F;blob&#x2F;master&#x2F;tests&#x2F;VObject&#x2F;Parser&#x2F;XmlTest.php&quot;&gt;a test suite for xCal and
xCard in
&lt;code&gt;sabre&#x2F;vobject&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.
I would love to write a test suite agnostic of the implementation, but I
ran out of time. This is basically format transformation: R:x→y where R
can be a reflexive operator or not (depending of the versions of
iCalendar and vCard we consider).&lt;&#x2F;p&gt;
&lt;p&gt;For “simple“ errata, I found the errors by testing it manually. For errata 4247
and 4261 (with the regular expressions), I found the error by applying the
algorithms presented in
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;generate-strings-based-on-regular-expressions&#x2F;&quot;&gt;Generate strings based on regular expressions&lt;&#x2F;a&gt;
.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#conclusion&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;sabre&#x2F;vobject&lt;&#x2F;code&gt; supports xCal and xCard.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Control the terminal, the right way</title>
          <pubDate>Sun, 04 Jan 2015 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/control-the-terminal-the-right-way/</link>
          <guid>https://mnt.io/articles/control-the-terminal-the-right-way/</guid>
          <description xml:base="https://mnt.io/articles/control-the-terminal-the-right-way/">&lt;p&gt;Nowadays, there are plenty of terminal emulators in the wild. Each one has
a specific way to handle controls. How many colours does it support? How to
control the style of a character? How to control more than style, like the
cursor or the window? In this article, we are going to explain and show in
action the right ways to control your terminal with a portable and an easy
to maintain API. We are going to talk about &lt;code&gt;stat&lt;&#x2F;code&gt;, &lt;code&gt;tput&lt;&#x2F;code&gt;, &lt;code&gt;terminfo&lt;&#x2F;code&gt;, &lt;code&gt;hoa&#x2F; console&lt;&#x2F;code&gt;… but do not be afraid, it&#x27;s easy and fun!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#introduction&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Terminals. They are the ancient interfaces, still not old fashioned yet.
They are fast, efficient, work remotely with a low bandwidth, secured
and very simple to use.&lt;&#x2F;p&gt;
&lt;p&gt;A terminal is a canvas composed of columns and lines. Only one character
fits at a position. According to the terminal, we have some features
enabled; for instance, a character might be stylized with a colour, a
decoration, a weight etc. Let&#x27;s consider the former. A colour belongs to
a palette, which contains either 2, 8, 256 or more colours. One may
wonder:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;How many colours does a terminal support?&lt;&#x2F;li&gt;
&lt;li&gt;How to control the style of a character?&lt;&#x2F;li&gt;
&lt;li&gt;How to control more than style, like the cursor or the window?&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Well, this article is going to explain how a terminal works and how we
interact with it. We are going to talk about terminal capabilities,
terminal information (stored in database) and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Console&quot;&gt;&lt;code&gt;Hoa\Console&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,
a PHP library that provides advanced terminal controls.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-basis-of-a-terminal&quot;&gt;The basis of a terminal&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-basis-of-a-terminal&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A terminal, or a console, is an interface that allows to interact with
the computer. This interface is textual. Like a graphical interface,
there are inputs: The keyboard and the mouse, and ouputs: The screen or
a file (a real file, a socket, a FIFO, something else…).&lt;&#x2F;p&gt;
&lt;p&gt;There is a ton of terminals. The most famous ones are:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;invisible-island.net&#x2F;xterm&#x2F;xterm.html&quot;&gt;xterm&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;iterm2.com&#x2F;&quot;&gt;iTerm2&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;software.schmorp.de&#x2F;pkg&#x2F;rxvt-unicode.html&quot;&gt;urxvt&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;ttssh2.sourceforge.jp&#x2F;&quot;&gt;TeraTerm&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Whatever the terminal you use, inputs are handled by programs (or
processus) and outputs are produced by these latters. We said outputs
can be the screen or a file. Actually, everything is a file, so the
screen is also a file. However, the user is able to use
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;gnu.org&#x2F;software&#x2F;bash&#x2F;manual&#x2F;bashref.html#Redirections&quot;&gt;redirections&lt;&#x2F;a&gt;
to choose where the ouputs must go.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s consider the &lt;code&gt;echo&lt;&#x2F;code&gt; program that prints all its options&#x2F;arguments
on its output. Thus, in the following example, &lt;code&gt;foobar&lt;&#x2F;code&gt; is printed on
the screen:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;foobar&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And in the following example, &lt;code&gt;foobar&lt;&#x2F;code&gt; is redirected to a file called
&lt;code&gt;log&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; log&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We are also able to redirect the output to another program, like &lt;code&gt;wc&lt;&#x2F;code&gt;
that counts stuff:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; wc&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; -c&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;7&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now we know there are 7 characters in &lt;code&gt;foobar&lt;&#x2F;code&gt;… no! &lt;code&gt;echo&lt;&#x2F;code&gt; automatically
adds a new-line (&lt;code&gt;\n&lt;&#x2F;code&gt;) after each line; so:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo -n &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; wc&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; -c&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;6&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is more correct!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;detecting-type-of-pipes&quot;&gt;Detecting type of pipes&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#detecting-type-of-pipes&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Inputs and outputs are called &lt;strong&gt;pipes&lt;&#x2F;strong&gt;. Yes, trivial, this is nothing
more than basic pipes!&lt;&#x2F;p&gt;
&lt;p&gt;There are 3 standard pipes:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;STDIN&lt;&#x2F;code&gt;, standing for the standard input pipe,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;STDOUT&lt;&#x2F;code&gt;, standing for the standard output pipe and&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;STDERR&lt;&#x2F;code&gt;, standing for the standard error pipe (also an output one).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;If the output is attached to the screen, we say this is a “direct
output”. Why is it important? Because if we stylize a text, this is
&lt;strong&gt;only for the screen&lt;&#x2F;strong&gt;, not for a file. A file should receive regular
text, not all the decorations and styles.&lt;&#x2F;p&gt;
&lt;p&gt;Hopefully, the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Console&#x2F;blob&#x2F;master&#x2F;Source&#x2F;Console.php&quot;&gt;&lt;code&gt;Hoa\Console\Console&lt;&#x2F;code&gt;
class&lt;&#x2F;a&gt;
provides the &lt;code&gt;isDirect&lt;&#x2F;code&gt;, &lt;code&gt;isPipe&lt;&#x2F;code&gt; and &lt;code&gt;isRedirection&lt;&#x2F;code&gt; static methods to
know whether the pipe is respectively direct, a pipe or a redirection
(damn naming…!). Thus, let &lt;code&gt;Type.php&lt;&#x2F;code&gt; be the following program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;is direct:      &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;isDirect&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-constant&quot;&gt;STDOUT&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;is pipe:        &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;isPipe&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-constant&quot;&gt;STDOUT&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;is redirection: &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;isRedirection&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-constant&quot;&gt;STDOUT&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, let&#x27;s test our program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php Type.php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is direct:      bool(true)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is pipe:        bool(false)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is redirection: bool(false)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php Type.php &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; xargs&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; -I@&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; echo @&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is direct:      bool(false)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is pipe:        bool(true)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is redirection: bool(false)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php Type.php &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; &#x2F;tmp&#x2F;foo&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; cat&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; !!&lt;&#x2F;span&gt;&lt;span&gt;$&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is direct:      bool(false)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is pipe:        bool(false)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;is redirection: bool(true)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The first execution is very classic. &lt;code&gt;STDOUT&lt;&#x2F;code&gt;, the standard output, is
direct. The second execution redirects the output to another program,
then &lt;code&gt;STDOUT&lt;&#x2F;code&gt; is of kind pipe. Finally, the last execution redirects the
output to a file called &lt;code&gt;&#x2F;tmp&#x2F;foo&lt;&#x2F;code&gt;, so &lt;code&gt;STDOUT&lt;&#x2F;code&gt; is a redirection.&lt;&#x2F;p&gt;
&lt;p&gt;How does it work? We use &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;php.net&#x2F;fstat&quot;&gt;&lt;code&gt;fstat&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; to read the
&lt;code&gt;mode&lt;&#x2F;code&gt; of the file. The underlying &lt;code&gt;fstat&lt;&#x2F;code&gt; implementation is defined in
C, so let&#x27;s take a look at the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;man.cx&#x2F;fstat%282%29&quot;&gt;documentation of
&lt;code&gt;fstat(2)&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. &lt;code&gt;stat&lt;&#x2F;code&gt; is a C structure that
looks like:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span&gt; stat &lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    dev_t&lt;&#x2F;span&gt;&lt;span&gt;    st_dev&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;              &#x2F;* device inode resides on             *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    ino_t&lt;&#x2F;span&gt;&lt;span&gt;    st_ino&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;              &#x2F;* inode&amp;#39;s number                      *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    mode_t&lt;&#x2F;span&gt;&lt;span&gt;   st_mode&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;             &#x2F;* inode protection mode               *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    nlink_t&lt;&#x2F;span&gt;&lt;span&gt;  st_nlink&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;* number of hard links to the file    *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    uid_t&lt;&#x2F;span&gt;&lt;span&gt;    st_uid&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;              &#x2F;* user-id of owner                    *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    gid_t&lt;&#x2F;span&gt;&lt;span&gt;    st_gid&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;              &#x2F;* group-id of owner                   *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    dev_t&lt;&#x2F;span&gt;&lt;span&gt;    st_rdev&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;             &#x2F;* device type, for special file inode *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    struct&lt;&#x2F;span&gt;&lt;span&gt; timespec st_atimespec&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* time of last access                 *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    struct&lt;&#x2F;span&gt;&lt;span&gt; timespec st_mtimespec&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* time of last data modification      *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    struct&lt;&#x2F;span&gt;&lt;span&gt; timespec st_ctimespec&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* time of last file status change     *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    off_t&lt;&#x2F;span&gt;&lt;span&gt;    st_size&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;             &#x2F;* file size, in bytes                 *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    quad_t&lt;&#x2F;span&gt;&lt;span&gt;   st_blocks&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;           &#x2F;* blocks allocated for file           *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    u_long&lt;&#x2F;span&gt;&lt;span&gt;   st_blksize&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;          &#x2F;* optimal file sys I&#x2F;O ops blocksize  *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    u_long&lt;&#x2F;span&gt;&lt;span&gt;   st_flags&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;* user defined flags for file         *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage z-type&quot;&gt;    u_long&lt;&#x2F;span&gt;&lt;span&gt;   st_gen&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;              &#x2F;* file generation number              *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The value of &lt;code&gt;mode&lt;&#x2F;code&gt; returned by the PHP &lt;code&gt;fstat&lt;&#x2F;code&gt; function is equal to
&lt;code&gt;st_mode&lt;&#x2F;code&gt; in this structure. And &lt;code&gt;st_mode&lt;&#x2F;code&gt; has the following bits:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;c&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFMT&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;   0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;170000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* type of file mask                *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFIFO&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;010000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* named pipe (fifo)                *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFCHR&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;020000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* character special                *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFDIR&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;040000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* directory                        *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFBLK&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;060000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* block special                    *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFREG&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;100000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* regular                          *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFLNK&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;120000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* symbolic link                    *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFSOCK&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;140000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* socket                           *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IFWHT&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;160000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* whiteout                         *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_ISUID&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;004000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* set user id on execution         *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_ISGID&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;002000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* set group id on execution        *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_ISVTX&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;001000&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* save swapped text even after use *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IRWXU&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000700&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* RWX mask for owner               *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IRUSR&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000400&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* read permission, owner           *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IWUSR&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000200&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* write permission, owner          *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IXUSR&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000100&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* execute&#x2F;search permission, owner *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IRWXG&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000070&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* RWX mask for group               *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IRGRP&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000040&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* read permission, group           *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IWGRP&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000020&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* write permission, group          *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IXGRP&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000010&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* execute&#x2F;search permission, group *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IRWXO&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000007&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* RWX mask for other               *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IROTH&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000004&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* read permission, other           *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IWOTH&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000002&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* write permission, other          *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;#define&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; S_IXOTH&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;  0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;000001&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt; &#x2F;* execute&#x2F;search permission, other *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Awesome, we have everything we need! We mask &lt;code&gt;mode&lt;&#x2F;code&gt; with &lt;code&gt;S_IFMT&lt;&#x2F;code&gt; to get
the file data. Then we just have to check whether it is a named pipe
&lt;code&gt;S_IFIFO&lt;&#x2F;code&gt;, a character special &lt;code&gt;S_IFCHR&lt;&#x2F;code&gt; etc. Concretly:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;isDirect&lt;&#x2F;code&gt; checks that the mode is equal to &lt;code&gt;S_IFCHR&lt;&#x2F;code&gt;, it means it is
attached to the screen (in our case),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;isPipe&lt;&#x2F;code&gt; checks that the mode is equal to &lt;code&gt;S_IFIFO&lt;&#x2F;code&gt;: This is a special file
that behaves like a FIFO stack (see the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=mkfifo&amp;amp;sektion=1&quot;&gt;documentation of &lt;code&gt;mkfifo(1)&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;), everything which is written is
directly read just after and the reading order is defined by the writing order
(first-in, first-out!),&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;isRedirection&lt;&#x2F;code&gt; checks that the mode is equal to &lt;code&gt;S_IFREG&lt;&#x2F;code&gt; , &lt;code&gt;S_IFDIR&lt;&#x2F;code&gt; ,
&lt;code&gt;S_IFLNK&lt;&#x2F;code&gt; , &lt;code&gt;S_IFSOCK&lt;&#x2F;code&gt; or &lt;code&gt;S_IFBLK&lt;&#x2F;code&gt; , in other words: All kind of files on
which we can apply a redirection. Why? Because the &lt;code&gt;STDOUT&lt;&#x2F;code&gt; (or another
&lt;code&gt;STD_*_&lt;&#x2F;code&gt; pipe) of the current processus is defined as a file pointer to the
redirection destination and it can be only a file, a directory, a link, a
socket or a block file.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I encourage you to read the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Console&#x2F;blob&#x2F;master&#x2F;Source&#x2F;Console.php&quot;&gt;implementation of the
&lt;code&gt;Hoa\Console\Console::getMode&lt;&#x2F;code&gt;
method&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;So yes, this is useful to enable styles on text but also to define the
default verbosity level. For instance, if a program outputs the result
of a computation with some explanations around, the highest verbosity
level would output everything (the result and the explanations) while
the lowest level would output only the result. Let&#x27;s try with the
&lt;code&gt;toUpperCase.php&lt;&#x2F;code&gt; program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$verbose&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;isDirect&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-constant&quot;&gt;STDOUT&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$string&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $argv&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$result&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;String&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$string&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;toUpperCase&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt;true&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ===&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $verbose&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;    echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $string&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39; becomes &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $result&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39; in upper case!&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; else&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;    echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $result&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then, let&#x27;s execute this program:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php toUpperCase.php &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;Hello world!&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Hello world! becomes HELLO WORLD! in upper case!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And now, let&#x27;s execute this program with a pipe:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; php toUpperCase.php &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;Hello world!&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; xargs&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; -I@&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; echo @&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;HELLO WORLD!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Useful and very simple, isn&#x27;t it?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;terminal-capabilities&quot;&gt;Terminal capabilities&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#terminal-capabilities&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We can control the terminal with the inputs, like the keyboard, but we
can also control the outputs. How? With the text itself. Actually, an
output does not contain only the text but it includes &lt;strong&gt;control
functions&lt;&#x2F;strong&gt;. It&#x27;s like HTML: Around a text, you can have an element,
specifying that the text is a link. It&#x27;s exactly the same for terminals!
To specify that a text must be in red, we must add a control function
around it.&lt;&#x2F;p&gt;
&lt;p&gt;Hopefully, these control functions have been standardized in the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.ecma-international.org&#x2F;publications&#x2F;files&#x2F;ECMA-ST&#x2F;Ecma-048.pdf&quot;&gt;ECMA-48&lt;&#x2F;a&gt;
document: Control Functions for Coded Character Set. However, not all
terminals implement all this standard, and for historical reasons, some
terminals use slightly different control functions. Moreover, some
information do not belong to this standard (because this is out of its
scope), like: How many colours does the terminal support? or does the
terminal support the meta key?&lt;&#x2F;p&gt;
&lt;p&gt;Consequently, each terminal has a list of &lt;strong&gt;capabilities&lt;&#x2F;strong&gt;. This list is
splitted in &lt;strong&gt;3 categories&lt;&#x2F;strong&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;boolean capabilities,&lt;&#x2F;li&gt;
&lt;li&gt;number capabilities,&lt;&#x2F;li&gt;
&lt;li&gt;string capabilities.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;For instance:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;the “does the terminal support the meta key” is a boolean capability called
&lt;code&gt;meta_key&lt;&#x2F;code&gt; where its value is &lt;code&gt;true&lt;&#x2F;code&gt; or &lt;code&gt;false&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;the “number of colours supported by the terminal” is a… number capability
called &lt;code&gt;max_colors&lt;&#x2F;code&gt; where its value can be &lt;code&gt;2&lt;&#x2F;code&gt;, &lt;code&gt;8&lt;&#x2F;code&gt;, &lt;code&gt;256&lt;&#x2F;code&gt; or more,&lt;&#x2F;li&gt;
&lt;li&gt;the “clear screen control function” is a string capability called
&lt;code&gt;clear_screen&lt;&#x2F;code&gt; where its value might be &lt;code&gt;\e[H\e[2J&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;the “move the cursor one column to the right” is also a string capability
called &lt;code&gt;cursor_right&lt;&#x2F;code&gt; where its value might be &lt;code&gt;\e[C&lt;&#x2F;code&gt; .&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;All the capabilities can be found in the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=terminfo&amp;amp;sektion=5&quot;&gt;documentation of
&lt;code&gt;terminfo(5)&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;
or in the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;pubs.opengroup.org&#x2F;onlinepubs&#x2F;7908799&#x2F;xcurses&#x2F;terminfo.html&quot;&gt;documentation of
xcurses&lt;&#x2F;a&gt;.
I encourage you to follow these links and see how rich the terminal
capabilities are!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;terminal-information&quot;&gt;Terminal information&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#terminal-information&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Terminal capabilities are stored as &lt;strong&gt;information&lt;&#x2F;strong&gt; in &lt;strong&gt;databases&lt;&#x2F;strong&gt;.
Where are these databases located? In files with a binary format.
Favorite locations are:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;&#x2F;usr&#x2F;share&#x2F;terminfo&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;usr&#x2F;share&#x2F;lib&#x2F;terminfo&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;lib&#x2F;terminfo&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;usr&#x2F;lib&#x2F;terminfo&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;usr&#x2F;local&#x2F;share&#x2F;terminfo&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;&#x2F;usr&#x2F;local&#x2F;share&#x2F;lib&#x2F;terminfo&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;etc.&lt;&#x2F;li&gt;
&lt;li&gt;or the &lt;code&gt;TERMINFO&lt;&#x2F;code&gt; or &lt;code&gt;TERMINFO_DIRS&lt;&#x2F;code&gt; environment variables.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Inside these directories, we have a tree of the form: &lt;code&gt;_xx_&#x2F;_name_&lt;&#x2F;code&gt;,
where &lt;code&gt;_xx_&lt;&#x2F;code&gt; is the ASCII value in hexadecimal of the first letter of
the terminal name &lt;code&gt;_name_&lt;&#x2F;code&gt;, or &lt;code&gt;_n_&#x2F;_name_&lt;&#x2F;code&gt; where &lt;code&gt;_n_&lt;&#x2F;code&gt; is the first
letter of the terminal name. The terminal name is stored in the &lt;code&gt;TERM&lt;&#x2F;code&gt;
environment variable. For instance, on my computer:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$TERM&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;xterm-256color&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; file &#x2F;usr&#x2F;share&#x2F;terminfo&#x2F;78&#x2F;xterm-256color&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;&#x2F;usr&#x2F;share&#x2F;terminfo&#x2F;78&#x2F;xterm-256color: Compiled terminfo entry&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We can use the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Console&#x2F;blob&#x2F;master&#x2F;Source&#x2F;Tput.php&quot;&gt;&lt;code&gt;Hoa\Console\Tput&lt;&#x2F;code&gt;
class&lt;&#x2F;a&gt;
to retrieve these information. The &lt;code&gt;getTerminfo&lt;&#x2F;code&gt; static method allows to
get the path of the terminal information file. The &lt;code&gt;getTerm&lt;&#x2F;code&gt; static
method allows to get the terminal name. Finally, the whole class allows
to parse a terminal information database (it will use the file returned
by &lt;code&gt;getTerminfo&lt;&#x2F;code&gt; by default). For instance:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$tput&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Tput&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$tput&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;count&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;max_colors&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * Will output:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     int(256)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;On my computer, with &lt;code&gt;xterm-256color&lt;&#x2F;code&gt;, I have 256 colours, as expected.
If we parse the information of &lt;code&gt;xterm&lt;&#x2F;code&gt; and not &lt;code&gt;xterm-256color&lt;&#x2F;code&gt;, we will
have:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$tput&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Tput&lt;&#x2F;span&gt;&lt;span&gt;(Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Tput&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getTerminfo&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;xterm&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$tput&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;count&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;max_colors&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * Will output:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     int(8)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;the-power-in-your-hand-control-the-cursor&quot;&gt;The power in your hand: Control the cursor&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-power-in-your-hand-control-the-cursor&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s summarize. We are able to parse and know all the terminal
capabilities of a specific terminal (including the one of the current
user). If we would like a powerful terminal API, we need to control the
basis, like the cursor.&lt;&#x2F;p&gt;
&lt;p&gt;Remember. We said that the terminal is a canvas of columns and lines.
The cursor is like a pen. We can move it and write something. We are
going to (partly) see how the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Console&#x2F;blob&#x2F;master&#x2F;Source&#x2F;Cursor.php&quot;&gt;&lt;code&gt;Hoa\Console\Cursor&lt;&#x2F;code&gt;
class&lt;&#x2F;a&gt;
works.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;i-like-to-move-it&quot;&gt;I like to move it!&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#i-like-to-move-it&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;The &lt;code&gt;moveTo&lt;&#x2F;code&gt; static method allows to move the cursor to an absolute
position. For example:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;moveTo&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$x&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $y&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The control function we use is &lt;code&gt;cursor_address&lt;&#x2F;code&gt;. So all we need to do is
to use the &lt;code&gt;Hoa\Console\Tput&lt;&#x2F;code&gt; class and call the &lt;code&gt;get&lt;&#x2F;code&gt; method on it to
get the value of this string capability. This is a parameterized one: On
&lt;code&gt;xterm-256color&lt;&#x2F;code&gt;, its value is &lt;code&gt;e[%i%p1%d;%p2%dH&lt;&#x2F;code&gt;. We replace the
parameters by &lt;code&gt;$x&lt;&#x2F;code&gt; and &lt;code&gt;$y&lt;&#x2F;code&gt; and we output the result. That&#x27;s all! We are
able to move the cursor on an absolute position on &lt;strong&gt;all terminals&lt;&#x2F;strong&gt;!
This is the right way to do.&lt;&#x2F;p&gt;
&lt;p&gt;We use the same strategy for the &lt;code&gt;move&lt;&#x2F;code&gt; static method that moves the
cursor relatively to its current position. For example:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;move&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;right up&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We split the steps and for each step we read the appropriated string
capability using the &lt;code&gt;Hoa\Console\Tput&lt;&#x2F;code&gt; class. For &lt;code&gt;right&lt;&#x2F;code&gt;, we read the
&lt;code&gt;parm_right_cursor&lt;&#x2F;code&gt; string capability, for &lt;code&gt;up&lt;&#x2F;code&gt;, we read
&lt;code&gt;parm_up_cursor&lt;&#x2F;code&gt; etc. Note that &lt;code&gt;parm_right_cursor&lt;&#x2F;code&gt; is different of
&lt;code&gt;cursor_right&lt;&#x2F;code&gt;: The first one is used to move the cursor a certain
number of times while the second one is used to move the cursor only one
time. With performances in mind, we should use the first one if we have
to move the cursor several times.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;getPosition&lt;&#x2F;code&gt; static method returns the position of the cursor. This
way to interact is a little bit different. We must write a control
function on the output, and then, the terminal replies on the input.
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Console&#x2F;blob&#x2F;master&#x2F;Source&#x2F;Cursor.php&quot;&gt;See the implementation by
yourself&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;print_r&lt;&#x2F;span&gt;&lt;span&gt;(Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getPosition&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * Will output:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     Array&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [x] =&amp;gt; 7&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *         [y] =&amp;gt; 42&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In the same way, we have the &lt;code&gt;save&lt;&#x2F;code&gt; and &lt;code&gt;restore&lt;&#x2F;code&gt; static methods that
save the current position of the cursor and restore it. This is very
useful. We use the &lt;code&gt;save_cursor&lt;&#x2F;code&gt; and &lt;code&gt;restore_cursor&lt;&#x2F;code&gt; string
capabilities.&lt;&#x2F;p&gt;
&lt;p&gt;Also, the &lt;code&gt;clear&lt;&#x2F;code&gt; static method splits some parts to clear. For each
part (direction or way), we read from &lt;code&gt;Hoa\Console\Tput&lt;&#x2F;code&gt; the
appropriated string capabilities: &lt;code&gt;clear_screen&lt;&#x2F;code&gt; to clear all the
screen, &lt;code&gt;clr_eol&lt;&#x2F;code&gt; to clear everything on the right of the cursor,
&lt;code&gt;clr_eos&lt;&#x2F;code&gt; to clear everything bellow the cursor etc.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;clear&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;left&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;See what we learnt in action:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;Foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;     &amp;#39;Foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;     &amp;#39;Foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;     &amp;#39;Foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;     &amp;#39;Foobar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;           Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;save&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;move&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;LEFT&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;move&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;↑&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;move&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;↑&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;move&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;↑&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;clear&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;↔&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt;  echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;Hahaha!&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;restore&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;Bye!&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The result is presented in the following figure.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;control-the-terminal-the-right-way&#x2F;.&#x2F;cursor_move.gif&quot; alt=&quot;Moving a cursor in the terminal&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Saving, moving, clearing and restoring the cursor with &lt;code&gt;Hoa\Console&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The resulting API is portable, clean, simple to read and very easy to
maintain! This is the right way to do.&lt;&#x2F;p&gt;
&lt;p&gt;To get more information, please &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; title=&quot;Documentation of Hoa\Console\Cursor&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;Literature&#x2F;Hack&#x2F;Console.html#Cursor&quot;&gt;read the
documentation&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;&quot;&gt;Colours and decorations&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Now: Colours. This is mainly the reason why I decided to write this
article. We see the same and the same libraries, again and again, doing
only colours in the terminal, but unfortunately not in the right way 😞.&lt;&#x2F;p&gt;
&lt;p&gt;A terminal has a palette of colours. Each colour is indexed by an
integer, from 0 to potentially +∞ . The size of the palette is described
by the &lt;code&gt;max_colors&lt;&#x2F;code&gt; number capability. Usually, a palette contains 1, 2,
8, 256 or 16 million colours.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;control-the-terminal-the-right-way&#x2F;.&#x2F;xterm_256color_chart.svg&quot; alt=&quot;&lt;code&gt;xterm-256color&lt;&#x2F;code&gt; palette&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;The &lt;code&gt;xterm-256color&lt;&#x2F;code&gt; palette (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; title=&quot;Source of the `xterm-256color` palette&quot; href=&quot;https:&#x2F;&#x2F;commons.wikimedia.org&#x2F;wiki&#x2F;File:Xterm_256color_chart.svg&quot;&gt;source&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;So first thing to do is to check whether we have more than 1 colour. If
not, we must not colorize the given text. Next, if we have less than
256 colours, we have to convert the style into a palette containing
8 colours. Same with less than 16 million colours, we have to convert
into 256 colours.&lt;&#x2F;p&gt;
&lt;p&gt;Moreover, we can define the style of the foreground or of the background
with respectively the &lt;code&gt;set_a_foreground&lt;&#x2F;code&gt; and &lt;code&gt;set_a_background&lt;&#x2F;code&gt; string
capabilities. Finally, in addition to colours, we can define other
decorations like bold, underline, blink or even inverse the foreground
and the background colours.&lt;&#x2F;p&gt;
&lt;p&gt;One thing to remember is: With this capability, we only define the style
at a given “pixel” and it will apply on the following text. In this
case, it is not exactly like HTML where we have a beginning and an end.
Here we only have a beginning. Let&amp;#39;s try!&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;colorize&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;underlined foreground(yellow) background(#932e2e)&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;foo&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Cursor&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;colorize&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;!underlined background(normal)&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;bar&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The API is pretty simple: We start to underline the text, we set the
foreground to yellow and we set the background to &lt;code&gt;#932e2e&lt;&#x2F;code&gt;  . Then we
output something. We continue with cancelling the underline decoration
in addition to resetting the background. Finally we output something
else. Here is the result:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;control-the-terminal-the-right-way&#x2F;.&#x2F;colour.png&quot; alt=&quot;A styled text in the terminal&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Fun with &lt;code&gt;Hoa\Console\Cursor::colorize&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;What do we observe? My terminal does not support more than 256 colours.
Thus, &lt;code&gt;#932e2e&lt;&#x2F;code&gt; is &lt;strong&gt;automatically converted into the closest colour&lt;&#x2F;strong&gt;
in my actual palette! This is the right way to do.&lt;&#x2F;p&gt;
&lt;p&gt;For fun, you can change the colours in the palette with the
&lt;code&gt;Hoa\Console\Cursor::changeColor&lt;&#x2F;code&gt; static method. You can also change the
style of the cursor, like &lt;code&gt;▋&lt;&#x2F;code&gt;, &lt;code&gt;_&lt;&#x2F;code&gt; or &lt;code&gt;|&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;To get more information, please &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; title=&quot;Documentation of Hoa\Console\Cursor&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;Fr&#x2F;Literature&#x2F;Hack&#x2F;Console.html#Content&quot;&gt;read the
documentation&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;The power in your hand: Readline&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A more complete usage of &lt;code&gt;Hoa\Console\Cursor&lt;&#x2F;code&gt; and even
&lt;code&gt;Hoa\Console\Window&lt;&#x2F;code&gt; is the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;central.hoa-project.net&#x2F;Resource&#x2F;Library&#x2F;Console&#x2F;Readline&#x2F;Readline.php&quot;&gt;&lt;code&gt;Hoa\Console\Readline&lt;&#x2F;code&gt;
class&lt;&#x2F;a&gt;
that is a powerful readline. More than autocompleters, history, key
bindings etc., it has an advanced use of cursors. See this in action:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;control-the-terminal-the-right-way&#x2F;.&#x2F;readline_autocompleters.gif&quot; alt=&quot;Play with autocompleters&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;An autocompletion menu, made with &lt;code&gt;Hoa\Console\Cursor&lt;&#x2F;code&gt; and
&lt;code&gt;Hoa\Console\Window&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;We use &lt;code&gt;Hoa\Console\Cursor&lt;&#x2F;code&gt; to move the cursor or change the colours and
&lt;code&gt;Hoa\Console\Window&lt;&#x2F;code&gt; to get the dimensions of the window, scroll some
text in it etc. I encourage you to read the implementation.&lt;&#x2F;p&gt;
&lt;p&gt;To get more information, please &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; title=&quot;Documentation of Hoa\Console\Readline&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;Literature&#x2F;Hack&#x2F;Console.html#Readline&quot;&gt;read the
documentation&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-2&quot;&gt;The power in your hand: Sound 🎵&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Yes, even sound is defined by terminal capabilities. The famous bip is
given by the &lt;code&gt;bell&lt;&#x2F;code&gt; string capability. You would like to make a bip?
Easy:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$tput&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Tput&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $tput&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;bell&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That&amp;#39;s it!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-3&quot;&gt;Bonus: Window&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;As a bonus, a quick demo of &lt;code&gt;Hoa\Console\Window&lt;&#x2F;code&gt; because it&amp;#39;s fun.&lt;&#x2F;p&gt;
&lt;p&gt;The video shows the execution of the following code:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Window&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;setSize&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;80&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 35&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;var_dump&lt;&#x2F;span&gt;&lt;span&gt;(Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Window&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getPosition&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;foreach&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    [&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;        [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;100&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 100&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;150&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 150&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;200&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 100&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;200&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 80&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;        [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;200&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;  60&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;200&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 100&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;    ]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    as&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; list&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$x&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $y&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;    sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Window&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;moveTo&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$x&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $y&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Window&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;minimize&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Window&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;restore&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Window&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;lower&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;sleep&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span&gt;  Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Console&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Window&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;raise&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We resize the window, we get its position, we move the window on the
screen, we minimize and restore it, and finally we put it behind all
other windows just before raising it.&lt;&#x2F;p&gt;
&lt;iframe src=&quot;https:&#x2F;&#x2F;player.vimeo.com&#x2F;video&#x2F;115901611?title=0&amp;amp;byline=0&amp;amp;portrait=0&amp;amp;badge=0&amp;amp;autopause=0&amp;amp;player_id=0&amp;amp;app_id=58479&quot; frameborder=&quot;0&quot; allow=&quot;autoplay; fullscreen; picture-in-picture; clipboard-write&quot; style=&quot;aspect-ratio: 16&#x2F;9; width: 100%;&quot; title=&quot;Hoa\Console\Window in action&quot;&gt;
&lt;&#x2F;iframe&gt;
&lt;p&gt;To get more information, please &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; title=&quot;Documentation of Hoa\Console\Window&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;Literature&#x2F;Hack&#x2F;Console.html#Window&quot;&gt;read the
documentation&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-4&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-4&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;In this article, we saw how to control the terminal by: Firstly,
detecting the type of pipes, and secondly, reading and using the
terminal capabilities. We know where these capabilities are stored and
we saw few of them in action.&lt;&#x2F;p&gt;
&lt;p&gt;This approach ensures your code will be &lt;strong&gt;portable&lt;&#x2F;strong&gt;, easy to maintain
and &lt;strong&gt;easy to use&lt;&#x2F;strong&gt;. The portability is very important because, like
browsers and user devices, we have a lot of terminal emulators released
in the wild. We have to care about them.&lt;&#x2F;p&gt;
&lt;p&gt;I encourage you to take a look at the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Console&quot;&gt;&lt;code&gt;Hoa\Console&lt;&#x2F;code&gt;
library&lt;&#x2F;a&gt; and to contribute to make
it even more awesome 😄.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>atoum has two release managers</title>
          <pubDate>Fri, 28 Nov 2014 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/atoum-has-two-release-managers/</link>
          <guid>https://mnt.io/articles/atoum-has-two-release-managers/</guid>
          <description xml:base="https://mnt.io/articles/atoum-has-two-release-managers/">&lt;h2 id=&quot;what-is-atoum&quot;&gt;What is atoum?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-is-atoum&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Short introduction: atoum is a simple, modern and intuitive unit testing
framework for PHP. Originally created by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;blog.mageekbox.net&#x2F;&quot;&gt;Frédéric
Hardy&lt;&#x2F;a&gt;, a good friend, it has grown thanks
to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;graphs&#x2F;contributors&quot;&gt;many
contributors&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;atoum-has-two-release-managers&#x2F;.&#x2F;atoum-logo.png&quot; alt=&quot;atoum&amp;#39;s logo&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
  atoum&#x27;s logo.
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;No one can say that atoum is not simple or intuitive. The framework
offers several awesome features and is more like a meta unit testing
framework. Indeed, the “user-land” of atoum, I mean all the assertions
API (“this is an integer and it is equal to…”) is based on a very
flexible mechanism, handled or embedded in runners, reporters etc. Thus,
the framework is very extensible. You can find more informations in the
&lt;code&gt;README.md&lt;&#x2F;code&gt; of the project: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum#why-atoum&quot;&gt;Why
atoum?&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Several important projects or companies use atoum. For instance,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;FriendsOfPHP&#x2F;pickle&#x2F;&quot;&gt;Pickle&lt;&#x2F;a&gt;, the PHP Extension
installer, created by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;PierreJoye&quot;&gt;Pierre Joye&lt;&#x2F;a&gt;,
another friend (the world is very small 😉) use atoum for its unit
tests. Another example with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;M6Web&quot;&gt;M6Web&lt;&#x2F;a&gt;, the geeks
working at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;M6_%28TV_channel%29&quot;&gt;M6&lt;&#x2F;a&gt;, the
most profitable private national French TV channel, also use atoum.
Another example, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;mozilla.org&#x2F;&quot;&gt;Mozilla&lt;&#x2F;a&gt; is using atoum to test
some of their applications.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;Where is the cap&amp;#39;tain?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Since the beginning, Frédéric has been a great leader for the project.
He has inspired many people, users and contributors. In real life, on
stage, on IRC… its personality and charisma were helpful in all aspects.
However, leading such a project is a challenging and nerve-wracking
daily work. I know what I am talking about with
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;&quot;&gt;Hoa&lt;&#x2F;a&gt;. Hopefully for Frédéric, some
contributors were here to help.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;Where to go cap&amp;#39;tain?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;However, having contributors do not create a community. A community is a
group of people that share something together. A project needs a
community with strong connections. They do no need to all look at the
same direction, but they have to share something. In the case of atoum,
I would say the project has been &lt;strong&gt;victim of its own success&lt;&#x2F;strong&gt;. We have
seen the number of users increasing very quickly and the project was not
yet ready for such a massive use. The documentation was not ready, a lot
of features were not finalized, there were few contributors and the
absence of a real community did not help. Put all these things together,
blend them together and you obtain a bomb 😄. The project leaders were
under a terrible pressure.&lt;&#x2F;p&gt;
&lt;p&gt;In these conditions, this is not easy to work. Especially when users ask
for new features. The needs to have a roadmap and people taking
decisions were very strong.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-2&quot;&gt;When the community acts&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-2&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;After a couple of months under the sea, we have decided that we need to
create a structure around the project. An organization. Frédéric is not
able to do everything by himself. That&amp;#39;s why &lt;strong&gt;2 release managers have
been elected&lt;&#x2F;strong&gt;: Mikaël Randy and I. Thank you to &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;jubianchi.fr&#x2F;&quot;&gt;Julien
Bianchi&lt;&#x2F;a&gt;, another friend 😉, for having organized
these elections and being one of the most active contributor of atoum!&lt;&#x2F;p&gt;
&lt;p&gt;Our goal is to define the roadmap of atoum:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;what will be included in the next version and what will not,&lt;&#x2F;li&gt;
&lt;li&gt;what features need work,&lt;&#x2F;li&gt;
&lt;li&gt;what bugs or issues need to be solved,&lt;&#x2F;li&gt;
&lt;li&gt;etc.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Well, a release manager is a pretty common job.&lt;&#x2F;p&gt;
&lt;p&gt;Why 2? To avoid the bus effect and delegate. We all have a family,
friends, jobs and side projects. With 2 release managers, we have
2 times more time to organize this project, and it deserves such an
amount of time.&lt;&#x2F;p&gt;
&lt;p&gt;The goal is also to organize the community if it is possible. New great
features are coming and they will allow more people to contribute and
build their “own atoum”. See below.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-3&quot;&gt;Features to port!&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-3&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Everything is not defined at 100% but here is an overview of what is
coming.&lt;&#x2F;p&gt;
&lt;p&gt;First of all, you will find the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;milestones&#x2F;1.0.0&quot;&gt;latest issues and
bugs&lt;&#x2F;a&gt; we have to close
before the first release.&lt;&#x2F;p&gt;
&lt;p&gt;Second, you will notice the version number… 1.0.0. Yes! atoum will have
tags! After several discussions
(&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;issues&#x2F;261&quot;&gt;#261&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;issues&#x2F;300&quot;&gt;#300&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;issues&#x2F;342&quot;&gt;#342&lt;&#x2F;a&gt;,
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;issues&#x2F;349&quot;&gt;#349&lt;&#x2F;a&gt;…), even if atoum is
rolling-released, it will have tags. And with the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;semver.org&#x2F;&quot;&gt;semver
format&lt;&#x2F;a&gt;. More informations on the blog of Julien
Bianchi: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;jubianchi.fr&#x2F;atoum-release.htm&quot;&gt;atoum embraces semver&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, a big feature is the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;atoum&#x2F;pull&#x2F;330&quot;&gt;Extension
API&lt;&#x2F;a&gt;, that allows to write
extension, such as:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;visibility-extension&quot;&gt;&lt;code&gt;atoum&#x2F;visibility-extension&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, allows to override methods visibility;
example:&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Foo&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    protected&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; bar&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$arg&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $arg&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; and…&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Foo&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span&gt; atoum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt;test&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; testBaz&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$sut&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; \&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Foo&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;and&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$arg&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;bar&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;then&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;variable&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;invoke&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$sut&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;bar&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$arg&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;isEqualTo&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$arg&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now you will be able to test your protected and private methods!&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;bdd-extension&quot;&gt;&lt;code&gt;atoum&#x2F;bdd-extension&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, allows to write tests with the behavior-driven
development style and vocabulary; example:&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Formatter&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span&gt; atoum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt;spec&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; should_format_underscore_separated_method_name&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;given&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$formatter&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; testedClass&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;then&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;invoking&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;format&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt;__FUNCTION__&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;on&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$formatter&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                    -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;shouldReturn&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;should format underscore separated method name&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Even the output looks familiar:&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;atoum-has-two-release-managers&#x2F;output.png&quot; alt=&quot;Example of a terminal output&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
  Possible output with the `atoum&#x2F;bdd-extension`.
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;atoum&#x2F;json-schema-extension&quot;&gt;&lt;code&gt;atoum&#x2F;json-schema-extension&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, allows to validate JSON payloads against a
schema; example:&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Foo&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span&gt; atoum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt;test&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; testIsJson&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;given&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$string&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;{&amp;quot;foo&amp;quot;: &amp;quot;bar&amp;quot;}&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;then&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;json&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$string&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; testValidatesSchema&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;given&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$string&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;[&amp;quot;foo&amp;quot;, &amp;quot;bar&amp;quot;]&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;then&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;json&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$string&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;validates&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;{&amp;quot;title&amp;quot;: &amp;quot;test&amp;quot;, &amp;quot;type&amp;quot;: &amp;quot;array&amp;quot;}&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;json&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$string&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;validates&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;&#x2F;path&#x2F;to&#x2F;json.schema&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Contributions-Atoum-PraspelExtension&quot;&gt;&lt;code&gt;atoum&#x2F;praspel-extension&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, allows to use
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Praspel&quot;&gt;Praspel&lt;&#x2F;a&gt; inside atoum: automatically
generate and validate advanced test data and unit tests; example:&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Foo&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; extends&lt;&#x2F;span&gt;&lt;span&gt; atoum&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt;test&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; testFoo&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$regex&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;realdom&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;regex&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp&quot;&gt;&amp;#39;&#x2F;[\w\-_]&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;+&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp z-constant z-character&quot;&gt;(\.[\w\-\_]&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;+&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp z-constant z-character&quot;&gt;@\w\.(net|org)&#x2F;&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;and&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$email&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sample&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$regex&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;then&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;                …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here, we have generated a string based on its regular expression. Reminder, you
might have seen this on this blog:
&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;generate-strings-based-on-regular-expressions&#x2F;&quot;&gt;Generate strings based on regular expressions&lt;&#x2F;a&gt;
.&lt;&#x2F;p&gt;
&lt;p&gt;Fun fact: the &lt;code&gt;atoum&#x2F;json-schema-extension&lt;&#x2F;code&gt; is tested with atoum
obviously and… &lt;code&gt;atoum&#x2F;praspel-extension&lt;&#x2F;code&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-4&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-4&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;atoum has a bright future with exciting features! We sincerely hope this
new direction will gather existing and new contributors 😄.&lt;&#x2F;p&gt;
&lt;p&gt;❤️ open-source!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Hello fruux!</title>
          <pubDate>Mon, 24 Nov 2014 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/hello-fruux/</link>
          <guid>https://mnt.io/articles/hello-fruux/</guid>
          <description xml:base="https://mnt.io/articles/hello-fruux/">&lt;h2 id=&quot;leaving-the-research-world&quot;&gt;Leaving the research world&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#leaving-the-research-world&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;I have really enjoyed my time at INRIA and Femto-ST, 2 research
institutes in France. But after 8 years at the university and a hard PhD
thesis (but with great results by the way!), I would like to see other
things.&lt;&#x2F;p&gt;
&lt;p&gt;My time as an intern at Mozilla and my work in the open-source world
have been very &lt;em&gt;seductive&lt;&#x2F;em&gt;. Open-source contrasts a lot with the
research world, where privacy and secrecy are first-citizens of every
project. All the work I have made and all the algorithms I have
developed during my PhD thesis have been implemented under an
open-source license, and I ran into some issues because of such decision
(patents are sometimes better, sometimes not… long story).&lt;&#x2F;p&gt;
&lt;p&gt;So, I like research but I also like to hack and share everything. And
right now, I have to get a change of air! So I asked on Twitter:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;I (Ivan Enderlin, a fresh PhD, creator of Hoa) am looking for a job.
Here is my CV:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;t.co&#x2F;dAdLm35RUu&quot;&gt;http:&#x2F;&#x2F;t.co&#x2F;dAdLm35RUu&lt;&#x2F;a&gt;.
Please, contact me!
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;hashtag&#x2F;hoajob?src=hash&quot;&gt;#hoajob&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;— Hoa project (@hoaproject) &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;twitter.com&#x2F;hoaproject&#x2F;status&#x2F;492382581271572480&quot;&gt;July 24th,
2014&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;And what a surprise! A &lt;strong&gt;lot&lt;&#x2F;strong&gt; of companies answered to my tweet (most
of them in private of course), but the most interesting one at my eyes
was… fruux 😉.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;fruux&quot;&gt;fruux&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#fruux&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;fruux defines itself as: “A unified contacts&#x2F;calendaring system that
works across &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;fruux.com&#x2F;supported-devices&#x2F;&quot;&gt;platforms and
devices&lt;&#x2F;a&gt;. We are behind
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;fruux.com&#x2F;opensource&quot;&gt;&lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, which is the most popular
open-source implementation of the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CardDAV&quot;&gt;CardDAV&lt;&#x2F;a&gt; and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CardDAV&quot;&gt;CalDAV&lt;&#x2F;a&gt; standards. Besides us,
developers and companies around the globe use our &lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt; technology
to deliver sync functionality to millions of users”.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;hello-fruux&#x2F;.&#x2F;fruux-logo.png&quot; alt=&quot;Fruux&amp;#39;s logo&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
  fruux&#x27;s logo.
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Several things attract me at fruux:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;low-layers are open-source,&lt;&#x2F;li&gt;
&lt;li&gt;viable ecosystem based on open-source,&lt;&#x2F;li&gt;
&lt;li&gt;accepts remote working,&lt;&#x2F;li&gt;
&lt;li&gt;close timezone to mine,&lt;&#x2F;li&gt;
&lt;li&gt;touching millions of people,&lt;&#x2F;li&gt;
&lt;li&gt;standards in minds.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;The first point is the most important for me. I don&amp;#39;t want to make a
company richer without any benefits for the rest of the world. I want my
work to be beneficial to the rest of the world, to share my work, I want
my work to be reused, hacked, criticized, updated and shared again. This
is the spirit of the open-source and the hackability paradigms. And
fortunately for me, fruux&amp;#39;s low-layers are 100% open-source, namely
&lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt; &amp;amp; co.&lt;&#x2F;p&gt;
&lt;p&gt;However, being able to eat at the end of the month with open-source is
not that simple. Fortunately for me, fruux has a stable economic model,
based on open-source. Obviously, I have to work on closed projects,
obviously, I have to work for some specific customers, but I can go back
to open-source goodnesses all the time 😉.&lt;&#x2F;p&gt;
&lt;p&gt;In addition, I am currently living in Switzerland and fruux is located
in Germany. Fortunately for me, fruux&amp;#39;s team is kind of dispatched all
around Europe and the world. Naturally, they accept me to work remotely.
Whilst it can be inconvenient for some people, I enjoy to have my own
hours, to organize myself as I would like etc. Periodical meetings and
phone-calls help to stay focused. And I like to think that people are
more productive this way. After 4 years at home because of my Master
thesis and PhD thesis, I know how to organize myself and exchange with a
decentralized team. This is a big advantage. Moreover, Germany is in the
same timezone as Switzerland! Compared to companies located at, for
instance, California, this is simpler for my family.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, working on an open-source project that is used by millions of
users is very motivating. You know that your contributions will touch a
lot of people and it gives meaning to my work on a daily basis. Also,
the last thing I love at fruux is this desire to respect standards, RFC,
recommandations etc. They are involved in these processes, consortiums
and groups (for instance
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;calconnect.org&#x2F;mbrlist.shtml&quot;&gt;CalConnect&lt;&#x2F;a&gt;). I love standards and
specifications, and this methodology reminds me the scientific approach
I had with my PhD thesis. I consider that a standard without an
implementation has no meaning, and a well-designed standard is a piece
of a delicious cake, especially when everyone respects this standard 😄.&lt;&#x2F;p&gt;
&lt;p&gt;(… but the cake is a lie!)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;sabre&quot;&gt;&lt;code&gt;sabre&#x2F;*&lt;&#x2F;code&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#sabre&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;fruux has mostly hired me because of my experience on
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;&quot;&gt;Hoa&lt;&#x2F;a&gt;. One of my main public job is to work on
all the &lt;code&gt;sabre&#x2F;*&lt;&#x2F;code&gt; libraries, which include:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-dav&quot;&gt;&lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-davclient&quot;&gt;&lt;code&gt;sabre&#x2F;davclient&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-event&quot;&gt;&lt;code&gt;sabre&#x2F;event&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-http&quot;&gt;&lt;code&gt;sabre&#x2F;http&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-proxy&quot;&gt;&lt;code&gt;sabre&#x2F;proxy&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-tzserver&quot;&gt;&lt;code&gt;sabre&#x2F;tzserver&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-vobject&quot;&gt;&lt;code&gt;sabre&#x2F;vobject&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;fruux&#x2F;sabre-xml&quot;&gt;&lt;code&gt;sabre&#x2F;xml&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;You will find the documentations and the news on
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;sabre.io&#x2F;&quot;&gt;sabre.io&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;All these libraries serve the first one: &lt;code&gt;sabre&#x2F;dav&lt;&#x2F;code&gt;, which is an
implementation of the WebDAV technology, including extensions for
CalDAV, and CardDAV, respectively for calendars, tasks and address
books. For the one who does not know what is WebDAV, in few words: The
Web is mostly a read-only media, but WebDAV extends HTTP in order to be
able to write and collaborate on documents. The way WebDAV is defined is
fascinating, and even more, the way it can be extended.&lt;&#x2F;p&gt;
&lt;p&gt;Most of the work is already done by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;evertpot.com&#x2F;&quot;&gt;Evert&lt;&#x2F;a&gt; and
many contributors, but we can go deeper! More extensions, more
standards, better code, better algorithms etc.!&lt;&#x2F;p&gt;
&lt;p&gt;If you are interested in the work I am doing on &lt;code&gt;sabre&#x2F;*&lt;&#x2F;code&gt;, you can
check this &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;search?q=user%3Afruux+author%3Ahywan&amp;amp;type=Issues&quot;&gt;search result on
Github&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;Future of Hoa&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Certain people have asked me about the future of Hoa: Whether I am going
to stop it or not since I have a job now.&lt;&#x2F;p&gt;
&lt;p&gt;Firstly, a PhD thesis is exhausting, and believe me, it requires more
energy than a regular job, even if you are passionate about your job and
you did not count working hours. With a PhD thesis, you have no weekend,
no holidays, you are always out of time, you always have a ton (sic) of
articles and documents to read… there is no break, no end. In these
conditions, I was able to maintain Hoa and to grow the project though,
thanks to a very helpful and present community!&lt;&#x2F;p&gt;
&lt;p&gt;Secondly, fruux is planning to use Hoa. I don&amp;#39;t know how or when, but if
at a certain moment, using Hoa makes sense, they will. What does it
imply for Hoa and me? It means that I will be paid to work on Hoa at a
little percentage. I don&amp;#39;t know how much, it will depend of the moments,
but this is a big step forward for the project. Moreover, a project like
fruux using Hoa is a big chance! I hope to see the fruux&amp;#39;s logo very
soon on the homepage of the Hoa&amp;#39;s website.&lt;&#x2F;p&gt;
&lt;p&gt;Thus, to conclude, I will have more time (on evenings, weekends,
holidays and sometimes during the day) to work on Hoa. Do not be afraid,
the future is bright 😄.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;Conclusion&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;em&gt;Bref&lt;&#x2F;em&gt;, I am working at fruux!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Generate strings based on regular expressions</title>
          <pubDate>Tue, 30 Sep 2014 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/generate-strings-based-on-regular-expressions/</link>
          <guid>https://mnt.io/articles/generate-strings-based-on-regular-expressions/</guid>
          <description xml:base="https://mnt.io/articles/generate-strings-based-on-regular-expressions/">&lt;p&gt;During my PhD thesis, I have partly worked on the problem of the automatic
accurate test data generation. In order to be complete and self-contained, I
have addressed all kinds of data types, including strings. This article aims at
showing how to generate accurate and relevant strings under several constraints.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;what-is-a-regular-expression&quot;&gt;What is a regular expression?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#what-is-a-regular-expression&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We are talking about formal language theory here. In the known world,
there are four kinds of languages. More formally, in 1956, the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Chomsky_hierarchy&quot;&gt;Chomsky
hierarchy&lt;&#x2F;a&gt; has been
formulated, classifying grammars (which define languages) in four
levels:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;unrestricted grammars, matching langages known as Turing languages, no
restriction,&lt;&#x2F;li&gt;
&lt;li&gt;context-sensitive grammars, matching contextual languages,&lt;&#x2F;li&gt;
&lt;li&gt;context-free grammars, matching algebraic languages, based on stacked
automata,&lt;&#x2F;li&gt;
&lt;li&gt;regular grammars, matching regular languages.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Each level includes the next level. The last level is the “weaker”,
which must not sound negative here. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Regular_expression&quot;&gt;Regular
expressions&lt;&#x2F;a&gt; are used
often because of their simplicity and also because they solve most
problems we encounter daily.&lt;&#x2F;p&gt;
&lt;p&gt;A regular expression is a small language with very few operators and,
most of the time, a simple semantics. For instance &lt;code&gt;ab(c|d)&lt;&#x2F;code&gt; means: a
word (a data) starting by &lt;code&gt;ab&lt;&#x2F;code&gt; and followed by &lt;code&gt;c&lt;&#x2F;code&gt; or &lt;code&gt;d&lt;&#x2F;code&gt;. We also have
quantification operators (also known as repetition operators), such as
&lt;code&gt;?&lt;&#x2F;code&gt;, &lt;code&gt;*&lt;&#x2F;code&gt; and &lt;code&gt;+&lt;&#x2F;code&gt;. We also have &lt;code&gt;{_x_,_y_}&lt;&#x2F;code&gt; to define a repetition
between &lt;code&gt;_x_&lt;&#x2F;code&gt; and &lt;code&gt;_y_&lt;&#x2F;code&gt;. Thus, &lt;code&gt;? &lt;&#x2F;code&gt; is equivalent to &lt;code&gt;{0,1}&lt;&#x2F;code&gt;, &lt;code&gt;*&lt;&#x2F;code&gt; to
&lt;code&gt;{0,}&lt;&#x2F;code&gt; and &lt;code&gt;+&lt;&#x2F;code&gt; to &lt;code&gt;{1,}&lt;&#x2F;code&gt;. When &lt;code&gt;_y_&lt;&#x2F;code&gt; is missing, it means +∞, so
unbounded (or more exactly, bounded by the limits of the machine). So,
for instance &lt;code&gt;ab(c|d){2,4}e?&lt;&#x2F;code&gt; means: a word starting by &lt;code&gt;ab&lt;&#x2F;code&gt;, followed
2, 3 or 4 times by &lt;code&gt;c&lt;&#x2F;code&gt; or &lt;code&gt;d&lt;&#x2F;code&gt; (so &lt;code&gt;cc&lt;&#x2F;code&gt;, &lt;code&gt;cd&lt;&#x2F;code&gt;, &lt;code&gt;dc&lt;&#x2F;code&gt;, &lt;code&gt;ccc&lt;&#x2F;code&gt;, &lt;code&gt;ccd&lt;&#x2F;code&gt;, &lt;code&gt;cdc&lt;&#x2F;code&gt;
and so on) and potentially followed by &lt;code&gt;e&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The goal here is not to teach you regular expressions but this is kind
of a tiny reminder. There are plenty of regular languages. You might
know &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;www.unix.com&#x2F;man-page&#x2F;Linux&#x2F;7&#x2F;regex&#x2F;&quot;&gt;POSIX regular
expression&lt;&#x2F;a&gt; or &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;pcre.org&#x2F;&quot;&gt;Perl
Compatible Regular Expressions (PCRE)&lt;&#x2F;a&gt;. Forget the
first one, please. The syntax and the semantics are too much limited.
PCRE is the regular language I recommend all the time.&lt;&#x2F;p&gt;
&lt;p&gt;Behind every formal language there is a graph. A regular expression is compiled
into a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;&quot;&gt;Finite State Machine (FSM)&lt;&#x2F;a&gt;. I am not
going to draw and explain them, but it is interesting to know that behind a
regular expression there is a basic automaton. No magic.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;why-focussing-regular-expressions&quot;&gt;Why focussing regular expressions?&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#why-focussing-regular-expressions&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;This article focuses on regular languages instead of other kind of
languages because we use them very often (even daily). I am going to
address context-free languages in another article, be patient young
padawan. The needs and constraints with other kind of languages are not
the same and more complex algorithms must be involved. So we are going
easy for the first step.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;understanding-pcre-lex-and-parse-them&quot;&gt;Understanding PCRE: lex and parse them&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#understanding-pcre-lex-and-parse-them&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Compiler&quot;&gt;&lt;code&gt;Hoa\Compiler&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt; provides
both LL(1) LL(k) compiler-compilers. The
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;Literature&#x2F;Hack&#x2F;Compiler.html&quot;&gt;documentation&lt;&#x2F;a&gt;
describes how to use it. We discover that the LL(k)
compiler comes with a grammar description language called PP. What does
it mean? It means for instance that the grammar of the PCRE can be
written with the PP language and that &lt;code&gt;Hoa\Compiler\Llk&lt;&#x2F;code&gt; will transform
this grammar into a compiler. That&#x27;s why we call them “compiler of
compilers”.&lt;&#x2F;p&gt;
&lt;p&gt;Fortunately, the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Regex&quot;&gt;&lt;code&gt;Hoa\Regex&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt;
provides the grammar of the PCRE language in the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Regex&#x2F;blob&#x2F;master&#x2F;Source&#x2F;Grammar.pp&quot;&gt;&lt;code&gt;hoa:&#x2F;&#x2F;Library&#x2F;Regex&#x2F;Grammar.pp&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;
file. Consequently, we are able to analyze regular expressions written
in the PCRE language! Let&#x27;s try in a shell at first with the
&lt;code&gt;hoa compiler:pp&lt;&#x2F;code&gt; tool:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;ab(c|d){2,4}e?&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; compiler:pp hoa:&#x2F;&#x2F;Library&#x2F;Regex&#x2F;Grammar.pp&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; dump&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  #expression&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;  #concatenation&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  token(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;literal,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; a&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  token(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;literal,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; b&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;  #quantification&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;  #alternation&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  token(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;literal,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; c&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  token(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;literal,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; d&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  token(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;n_to_m,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; {2,4}&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-comment&quot;&gt;  #quantification&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  token(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;literal,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; e&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  &amp;gt;  &amp;gt;  &amp;gt;&lt;&#x2F;span&gt;&lt;span&gt;  token(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;zero_or_one,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; ?&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We read that the whole expression is composed of a single concatenation
of two tokens: &lt;code&gt;a&lt;&#x2F;code&gt; and &lt;code&gt;b&lt;&#x2F;code&gt;, followed by a quantification, followed by
another quantification. The first quantification is an alternation of (a
choice betwen) two tokens: &lt;code&gt;c&lt;&#x2F;code&gt; and &lt;code&gt;d&lt;&#x2F;code&gt;, between 2 to 4 times. The second
quantification is the &lt;code&gt;e&lt;&#x2F;code&gt; token that can appear zero or one time. Pretty
simple.&lt;&#x2F;p&gt;
&lt;p&gt;The final output of the &lt;code&gt;Hoa\Compiler\Llk\Parser&lt;&#x2F;code&gt; class is an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Abstract_syntax_tree&quot;&gt;Abstract
Syntax Tree (AST)&lt;&#x2F;a&gt;.
The documentation of &lt;code&gt;Hoa\Compiler&lt;&#x2F;code&gt; explains all that stuff, you should read
it. The LL(k) compiler is cut out into very distinct layers in order to improve
hackability. Again, the documentation teach us we have &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;Literature&#x2F;Hack&#x2F;Compiler.html#Compilation_process&quot;&gt;four levels in the
compilation
process&lt;&#x2F;a&gt;:
lexical analyzer, syntactic analyzer, trace and AST. The lexical analyzer (also
known as lexer) transforms the textual data being analyzed into a sequence of
tokens (formally known as lexemes). It checks whether the data is composed of
the good pieces. Then, the syntactic analyzer (also known as parser) checks that
the order of tokens in this sequence is correct (formally we say that it derives
the sequence, see the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;Literature&#x2F;Hack&#x2F;Compiler.html#Matching_words&quot;&gt;Matching words
section&lt;&#x2F;a&gt;
to learn more).&lt;&#x2F;p&gt;
&lt;p&gt;Still in the shell, we can get the result of the lexical analyzer by
using the &lt;code&gt;--token-sequence&lt;&#x2F;code&gt; option; thus:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; echo &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;ab(c|d){2,4}e?&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; compiler:pp hoa:&#x2F;&#x2F;Library&#x2F;Regex&#x2F;Grammar.pp&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --token-sequence&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  #  …  token name   token value  offset&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;-----------------------------------------&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  0  …  literal      a                 0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  1  …  literal      b                 1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  2  …  capturing_   (                 2&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  3  …  literal      c                 3&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  4  …  alternation  |                 4&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  5  …  literal      d                 5&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  6  …  _capturing   )                 6&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  7  …  n_to_m       {2,4}             7&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  8  …  literal      e                12&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  9  …  zero_or_one  ?                13&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt; 10  …  EOF                           15&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is the sequence of tokens produced by the lexical analyzer. The
tree is not yet built because this is the first step of the compilation
process. However this is always interesting to understand these
different steps and see how it works.&lt;&#x2F;p&gt;
&lt;p&gt;Now we are able to analyze any regular expressions in the PCRE format!
The result of this analysis is a tree. You know what is fun with trees?
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Visitor_pattern&quot;&gt;Visiting them&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;visiting-the-ast&quot;&gt;Visiting the AST&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#visiting-the-ast&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Unsurprisingly, each node of the AST can be visited thanks to the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Visitor&quot;&gt;&lt;code&gt;Hoa\Visitor&lt;&#x2F;code&gt;
library&lt;&#x2F;a&gt;. Here is an example with the
“dump” visitor:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;File&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 1. Load grammar.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; Compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Llk&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Llk&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;load&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    new&lt;&#x2F;span&gt;&lt;span&gt; File&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Read&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;hoa:&#x2F;&#x2F;Library&#x2F;Regex&#x2F;Grammar.pp&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 2. Parse a data.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;ab(c|d){2,4}e?&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; 3. Dump the AST.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$dump&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; Compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Dump&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $dump&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;visit&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This program will print the same AST dump we have previously seen in the
shell.&lt;&#x2F;p&gt;
&lt;p&gt;How to write our own visitor? A visitor is a class with a single &lt;code&gt;visit&lt;&#x2F;code&gt;
method. Let&#x27;s try a visitor that pretty print a regular expression, i.e.
transform:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;ab(c|d){2,4}e?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;into:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;plain&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;a&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;b&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    c&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    d&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;){2,4}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;e?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Why a pretty printer? First, it shows how to visit a tree. Second, it
shows the structure of the visitor: we filter by node ID (&lt;code&gt;#expression&lt;&#x2F;code&gt;,
&lt;code&gt;#quantification&lt;&#x2F;code&gt;, &lt;code&gt;token&lt;&#x2F;code&gt; etc.) and we apply respective computations. A
pretty printer is often a good way for being familiarized with the
structure of an AST.&lt;&#x2F;p&gt;
&lt;p&gt;Here is the class. It catches only useful constructions for the given
example:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; PrettyPrinter&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span&gt; Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt;Visit&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; visit&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Element&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $eldnah&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    ) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        static&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $_indent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $nodeId&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getId&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        switch&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$nodeId&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; Reset indentation and…&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#expression&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                $_indent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; … visit all the children.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#quantification&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                foreach&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChildren&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                    $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;accept&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $eldnah&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;              break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; One new line between each children of the concatenation.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#concatenation&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                foreach&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChildren&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                    $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;accept&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $eldnah&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;              break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; Add parenthesis and increase indentation.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#alternation&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                $oout&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt; []&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                $pIndent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; str_repeat&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;    &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $_indent&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                ++&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$_indent&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                $cIndent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; str_repeat&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;    &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $_indent&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                foreach&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChildren&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                    $oout&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;[]&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $cIndent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;accept&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $eldnah&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                --&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$_indent&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $pIndent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;(&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;                        implode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $cIndent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;|&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $oout&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                        $pIndent&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;)&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;              break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; Print token value verbatim.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;token&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                $tokenId&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getValueToken&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                $tokenValue&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getValueValue&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                switch&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$tokenId&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                    case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;literal&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                    case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;n_to_m&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                    case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;zero_or_one&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;                        $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $tokenValue&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                       break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                    default&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                        throw new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; RuntimeException&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;                            &amp;#39;Token ID &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $tokenId&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39; is not well-handled.&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                        )&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;              break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            default&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;                throw new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; RuntimeException&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;                    &amp;#39;Node ID &amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $nodeId&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39; is not well-handled.&amp;#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;                )&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And finally, we apply the pretty printer on the AST like previously
seen:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; Compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Llk&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Llk&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;load&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    new&lt;&#x2F;span&gt;&lt;span&gt; File&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Read&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;hoa:&#x2F;&#x2F;Library&#x2F;Regex&#x2F;Grammar.pp&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;ab(c|d){2,4}e?&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$prettyprint&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; PrettyPrinter&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $prettyprint&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;visit&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;em&gt;Et voilà !&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Now, put all that stuff together!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;isotropic-generation&quot;&gt;Isotropic generation&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#isotropic-generation&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;We can use &lt;code&gt;Hoa\Regex&lt;&#x2F;code&gt; and &lt;code&gt;Hoa\Compiler&lt;&#x2F;code&gt; to get the AST of any regular
expressions written in the PCRE format. We can use &lt;code&gt;Hoa\Visitor&lt;&#x2F;code&gt; to
traverse the AST and apply computations according to the type of nodes.
Our goal is to generate strings based on regular expressions. What kind
of generation are we going to use? There are plenty of them: uniform
random, smallest, coverage based…&lt;&#x2F;p&gt;
&lt;p&gt;The simplest is isotropic generation, also known as random generation.
But random says nothing: what is the repartition, or do we have any
uniformity? Isotropic means each choice will be solved randomly and
uniformly. Uniformity has to be defined: does it include the whole set
of nodes or just the immediate children of the node? Isotropic means we
consider only immediate children. For instance, a node &lt;code&gt;#alternation&lt;&#x2F;code&gt;
has &lt;em&gt;c&lt;&#x2F;em&gt; immediate children, the probability &lt;em&gt;C&lt;&#x2F;em&gt; to choose one child is:&lt;&#x2F;p&gt;
&lt;math xmlns=&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1998&#x2F;Math&#x2F;MathML&quot;&gt;
  &lt;semantics&gt;
    &lt;mrow&gt;
      &lt;mi&gt;P&lt;&#x2F;mi&gt;
      &lt;mo stretchy=&quot;false&quot;&gt;(&lt;&#x2F;mo&gt;&lt;mi&gt;C&lt;&#x2F;mi&gt;&lt;mo stretchy=&quot;false&quot;&gt;)&lt;&#x2F;mo&gt;
      &lt;mo&gt;=&lt;&#x2F;mo&gt;
      &lt;mfrac&gt;
        &lt;mn&gt;1&lt;&#x2F;mn&gt;
        &lt;mi&gt;c&lt;&#x2F;mi&gt;
      &lt;&#x2F;mfrac&gt;
    &lt;&#x2F;mrow&gt;
    &lt;annotation encoding=&quot;application&#x2F;x-tex&quot;&gt;P(C) = \frac{1}{c}&lt;&#x2F;annotation&gt;
  &lt;&#x2F;semantics&gt;
&lt;&#x2F;math&gt;
&lt;p&gt;Yes, simple as that!&lt;&#x2F;p&gt;
&lt;p&gt;We can use the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Math&quot;&gt;&lt;code&gt;Hoa\Math&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt; that
provides the &lt;code&gt;Hoa\Math\Sampler\Random&lt;&#x2F;code&gt; class to sample uniform random integers
and floats. Ready?&lt;&#x2F;p&gt;
&lt;h3 id=&quot;structure-of-the-visitor&quot;&gt;Structure of the visitor&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#structure-of-the-visitor&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;The structure of the visitor is the following:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Math&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;class&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; IsotropicSampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; implements&lt;&#x2F;span&gt;&lt;span&gt; Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-other z-inherited-class&quot;&gt;Visit&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    protected&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $_sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; __construct&lt;&#x2F;span&gt;&lt;span&gt;(Math&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $sampler&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        return&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; visit&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Element&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $eldnah&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    ) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        switch&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getId&lt;&#x2F;span&gt;&lt;span&gt;()) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;            &#x2F;&#x2F; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We set a sampler and we start visiting and filtering nodes by their node
ID. The following code will generate a string based on the regular
expression contained in the &lt;code&gt;$expression&lt;&#x2F;code&gt; variable:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$expression&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;…&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $compiler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;parse&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$expression&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$generator&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt; IsotropicSampler&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt; Math&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Random&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $generator&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;visit&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We are going to change the value of &lt;code&gt;$expression&lt;&#x2F;code&gt; step by step until
having &lt;code&gt;ab(c|d){2,4}e?&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;case-of-expression&quot;&gt;Case of &lt;code&gt;#expression&lt;&#x2F;code&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#case-of-expression&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;A node of type &lt;code&gt;#expression&lt;&#x2F;code&gt; has only one child. Thus, we simply return
the computation of this node:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#expression&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChild&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;accept&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $eldnah&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;  break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h3 id=&quot;case-of-token&quot;&gt;Case of &lt;code&gt;token&lt;&#x2F;code&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#case-of-token&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;We consider only one type of token for now: &lt;code&gt;literal&lt;&#x2F;code&gt;. A literal can
contain an escaped character, can be a single character or can be &lt;code&gt;.&lt;&#x2F;code&gt;
(which means everything). We consider only a single character for this
example (spoil: the whole visitor already exists). Thus:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;token&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getValueValue&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;  break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here, with &lt;code&gt;$expression = &#x27;a&#x27;;&lt;&#x2F;code&gt; we get the string &lt;code&gt;a&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;case-of-concatenation&quot;&gt;Case of &lt;code&gt;#concatenation&lt;&#x2F;code&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#case-of-concatenation&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;A concatenation is just the computation of all children joined in a
single piece of string. Thus:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#concatenation&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    foreach&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChildren&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $child&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;accept&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $eldnah&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;  break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;At this step, with &lt;code&gt;$expression = &#x27;ab&#x27;;&lt;&#x2F;code&gt; we get the string &lt;code&gt;ab&lt;&#x2F;code&gt;. Totally
crazy.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;case-of-alternation&quot;&gt;Case of &lt;code&gt;#alternation&lt;&#x2F;code&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#case-of-alternation&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;An alternation is a choice between several children. All we have to do
is to select a child based on the probability given above. The number of
children for the current node can be known thanks to the
&lt;code&gt;getChildrenNumber&lt;&#x2F;code&gt; method. We are also going to use the sampler of
integers. Thus:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#alternation&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    $childIndex&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getInteger&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;        0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChildrenNumber&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChild&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$childIndex&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                   -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;accept&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $eldnah&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;  break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now, with &lt;code&gt;$expression = &#x27;ab(c|d)&#x27;;&lt;&#x2F;code&gt; we get the strings &lt;code&gt;abc&lt;&#x2F;code&gt; or &lt;code&gt;abd&lt;&#x2F;code&gt;
at random. Try several times to see by yourself.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;case-of-quantification&quot;&gt;Case of &lt;code&gt;#quantification&lt;&#x2F;code&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#case-of-quantification&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;A quantification is an alternation of concatenations. Indeed, &lt;code&gt;e{2,4}&lt;&#x2F;code&gt;
is strictly equivalent to &lt;code&gt;ee|eee|eeee&lt;&#x2F;code&gt;. We have only two
quantifications in our example: &lt;code&gt;?&lt;&#x2F;code&gt; and &lt;code&gt;{_x_,_y_}&lt;&#x2F;code&gt;. We are going to
find the value for &lt;code&gt;_x_&lt;&#x2F;code&gt; and &lt;code&gt;_y_&lt;&#x2F;code&gt; and then choose at random between
these bounds. Let&#x27;s go:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;#quantification&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-language&quot;&gt; null&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    $x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    $y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Filter the type of quantification.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    switch&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChild&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getValueToken&lt;&#x2F;span&gt;&lt;span&gt;()) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;zero_or_one&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            $y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;          break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; {x,y}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        case&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;n_to_m&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            $xy&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; explode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;                &amp;#39;,&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;                trim&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChild&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getValueValue&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;{}&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            )&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            $x&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;int&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; trim&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$xy&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            $y&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;int&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; trim&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$xy&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-section&quot;&gt;]&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;          break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Choose the number of repetitions.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    $max&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getInteger&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$x&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $y&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Concatenate.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    for&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $max&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ++&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$i&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; .=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $element&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;getChild&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;accept&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;$this&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $handle&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $eldnah&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    return&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $out&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;  break&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Finally, with &lt;code&gt;$expression = &#x27;ab(c|d){2,4}e?&#x27;;&lt;&#x2F;code&gt; we can have the
following strings: &lt;code&gt;abdcce&lt;&#x2F;code&gt;, &lt;code&gt;abdc&lt;&#x2F;code&gt;, &lt;code&gt;abddcd&lt;&#x2F;code&gt;, &lt;code&gt;abcde&lt;&#x2F;code&gt; etc. Nice isn&#x27;t
it? Want more?&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;for&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $i&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 42&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; ++&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$i&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;    echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $generator&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;visit&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-character&quot;&gt;\n&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;**&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; * Could output:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abdce&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abdcc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcdde&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcdcd&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcde&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abddcde&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abddcce&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcde&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abdcce&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcde&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abdce&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abdd&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcdce&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abccd&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abdcdd&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcdcce&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abcce&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *     abddc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt; *&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;&lt;h2 id=&quot;performance&quot;&gt;Performance&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#performance&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;This is difficult to give numbers because it depends of a lot of parameters:
your machine configuration, the PHP VM, if other programs run etc. But I have
generated 1 million strings in less than 25 seconds on my machine (an old
MacBook Pro), which is pretty reasonable.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion-and-surprise&quot;&gt;Conclusion and surprise&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#conclusion-and-surprise&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;So, yes, now we know how to generate strings based on regular
expressions! Supporting all the PCRE format is difficult. That&#x27;s why the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Regex&quot;&gt;&lt;code&gt;Hoa\Regex&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt; provides
the &lt;code&gt;Hoa\Regex\Visitor\Isotropic&lt;&#x2F;code&gt; class that is a more advanced visitor.
This latter supports classes, negative classes, ranges, all
quantifications, all kinds of literals (characters, escaped characters,
types of characters —&lt;code&gt;\w&lt;&#x2F;code&gt;, &lt;code&gt;\d&lt;&#x2F;code&gt;, &lt;code&gt;\h&lt;&#x2F;code&gt;…—) etc. Consequently, all you have
to do is:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; Hoa&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Regex&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$generator&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span&gt; Regex&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Visitor&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Isotropic&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt; Math&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span&gt;Sampler&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Random&lt;&#x2F;span&gt;&lt;span&gt;())&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;echo&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; $generator&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;visit&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$ast&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This algorithm is used in
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Praspel&quot;&gt;Praspel&lt;&#x2F;a&gt;, a
specification language I have designed during my PhD thesis. More
specifically, this algorithm is used inside realistic domains. I am not
going to explain it today but it allows me to introduce the “surprise”.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;generate-strings-based-on-regular-expressions-in-atoum&quot;&gt;Generate strings based on regular expressions in atoum&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#generate-strings-based-on-regular-expressions-in-atoum&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;atoum.org&#x2F;&quot;&gt;atoum&lt;&#x2F;a&gt; is an awesome unit test framework. You can
use the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;hoaproject&#x2F;Contributions-Atoum-PraspelExtension&quot;&gt;&lt;code&gt;Atoum\PraspelExtension&lt;&#x2F;code&gt;
extension&lt;&#x2F;a&gt;
to use Praspel and therefore realistic domains inside atoum. You can use
realistic domains to validate &lt;strong&gt;and&lt;&#x2F;strong&gt; to generate data, they are
designed for that. Obviously, we can use the &lt;code&gt;Regex&lt;&#x2F;code&gt; realistic domain.
This extension provides several features including &lt;code&gt;sample&lt;&#x2F;code&gt;,
&lt;code&gt;sampleMany&lt;&#x2F;code&gt; and &lt;code&gt;predicate&lt;&#x2F;code&gt; to respectively generate one datum,
generate many data and validate a datum based on a realistic domain. To
declare a regular expression, we must write:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$regex&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;realdom&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;regex&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp&quot;&gt;&amp;#39;&#x2F;ab(c|d){2,4}e?&#x2F;&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And to generate a datum, all we have to do is:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;$datum&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sample&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$regex&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-terminator&quot;&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;For instance, imagine you are writing a test called &lt;code&gt;test_mail&lt;&#x2F;code&gt; and you
need an email address:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;php&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;lt;?&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;php&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;public&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage z-type z-function&quot;&gt; function&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; test_mail&lt;&#x2F;span&gt;&lt;span&gt;() {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    $this&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;given&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            $regex&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;   =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;realdom&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;regex&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp&quot;&gt;&amp;#39;&#x2F;[\w\-_]&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;+&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp z-constant z-character&quot;&gt;(\.[\w\-\_]&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;+&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp&quot;&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;*&lt;&#x2F;span&gt;&lt;span class=&quot;z-string z-regexp z-constant z-character&quot;&gt;@\w\.(net|org)&#x2F;&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            $address&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; $this&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sample&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$regex&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            $mailer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;  =&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; new&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt; \&lt;&#x2F;span&gt;&lt;span&gt;Mock&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;\&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-class&quot;&gt;Mailer&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;…&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;when&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$mailer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;-&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sendTo&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;$address&lt;&#x2F;span&gt;&lt;span&gt;))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;then&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;…&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Easy to read, fast to execute and help to focus on the logic of the test
instead of test data (also known as fixtures). Note that most of the
time the regular expressions are already in the code (maybe as
constants). It is therefore easier to write and to maintain the tests.&lt;&#x2F;p&gt;
&lt;p&gt;I hope you enjoyed this first part of the series :-)! This work has been
published in the International Conference on Software Testing,
Verification and Validation: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;hal.science&#x2F;hal-00931662&#x2F;file&#x2F;EDGB12.pdf&quot;&gt;Grammar-Based Testing using Realistic
Domains in PHP&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Rüsh Release</title>
          <pubDate>Mon, 15 Sep 2014 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/rush-release/</link>
          <guid>https://mnt.io/articles/rush-release/</guid>
          <description xml:base="https://mnt.io/articles/rush-release/">&lt;p&gt;Since 2 years, at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;hoa-project.net&#x2F;&quot;&gt;Hoa&lt;&#x2F;a&gt;, we are looking for the
perfect release process. Today, we have finalized the last thing related
to this new process: we have found a name. It is called &lt;strong&gt;Rüsh
Release&lt;&#x2F;strong&gt;, standing for &lt;em&gt;Rolling Ünd ScHeduled Release&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The following explanations are useful from the user point of view, not
from the developer point of view. It means that we do not explain all
the branches and the workflow between all of them. We will settle for
the user final impact.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;rolling-release&quot;&gt;Rolling Release&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#rolling-release&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;On one hand, Hoa is not and will never be finished. We will never reach
the “Holy 1.0 Grail”. So, one might reckon that Hoa is rolling-released?
Let&#x27;s dive into this direction. There are plenty &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Rolling_release&quot;&gt;rolling release
types&lt;&#x2F;a&gt; out there, such
as:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;partially rolling,&lt;&#x2F;li&gt;
&lt;li&gt;fully rolling,&lt;&#x2F;li&gt;
&lt;li&gt;truly rolling,&lt;&#x2F;li&gt;
&lt;li&gt;pseudo-rolling,&lt;&#x2F;li&gt;
&lt;li&gt;optionally rolling,&lt;&#x2F;li&gt;
&lt;li&gt;cyclically rolling,&lt;&#x2F;li&gt;
&lt;li&gt;and synonyms…&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;I am not going to explain all of them. All you need to know is that Hoa
is partly and truly rolling released, or &lt;em&gt;part-&lt;&#x2F;em&gt; and &lt;em&gt;true-&lt;&#x2F;em&gt; rolling
released for short. Why? Firstly, “Part-rolling project has a subset of
software packages that are not rolling”. If we look at Hoa only, it is
fully rolling but Hoa depends on PHP virtual machines to be executed,
which are not rolling released (for the most popular ones at least).
Thus, Hoa is partly rolling released. Secondly, “True-rolling
[project] are developed solely using a rolling release software
development model”, which is the case of Hoa. Consequently and finally,
the &lt;code&gt;master&lt;&#x2F;code&gt; branch is the final public branch, it means that it
&lt;strong&gt;always&lt;&#x2F;strong&gt; contains the latest version, and users constantly fetch
updates from it.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;versioning&quot;&gt;Versioning&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#versioning&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Sounds good. On the other hand, the majority of programs that are using
Hoa use tools called dependency managers. The most popular in PHP is
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;getcomposer.org&#x2F;&quot;&gt;Composer&lt;&#x2F;a&gt;. This is a fantastic tool but with a
little spine that hurts us a lot: it does not support rolling release!
Most of the time, dependency managers work with version numbers, mainly
of the form &lt;code&gt;_x_._y_._z_&lt;&#x2F;code&gt;, with a specific semantics for &lt;code&gt;_x_&lt;&#x2F;code&gt;, &lt;code&gt;_y_&lt;&#x2F;code&gt;
and &lt;code&gt;_z_&lt;&#x2F;code&gt;. For instance, some people have agreed about
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;http:&#x2F;&#x2F;semver.org&#x2F;&quot;&gt;semver&lt;&#x2F;a&gt;, standing for &lt;em&gt;Semantic Versioning&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Also, we are not extremist. We understand the challenges and the needs
behind versioning. So, how to mix both: rolling release and versioning?
Before answering this question, let&#x27;s progress a little step forward and
learn more about an alternative versioning approach.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;scheduled-based-release&quot;&gt;Scheduled-based release&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#scheduled-based-release&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h3&gt;
&lt;p&gt;Scheduled-based, also known as date-based, release allows to define
releases at regular periods of time. This approach is widely adopted for
projects that progress quickly, such as Firefox or PHP (see the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;wiki.php.net&#x2F;rfc&#x2F;releaseprocess&quot;&gt;PHP
RFC: Release Process&lt;&#x2F;a&gt; for
example). For Firefox, every 6 weeks, a new version is released. Note
that we should say &lt;em&gt;a new update&lt;&#x2F;em&gt; to be honest: the term &lt;em&gt;version&lt;&#x2F;em&gt; has
an unclear meaning here.&lt;&#x2F;p&gt;
&lt;p&gt;The scheduled-based release seems a good candidate to be mixed with
rolling release, isn&#x27;t it?&lt;&#x2F;p&gt;
&lt;h2 id=&quot;rush-release&quot;&gt;Rüsh Release&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#rush-release&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Rüsh Release is a mix between part- and true-rolling release and
scheduled-based release. The &lt;code&gt;master&lt;&#x2F;code&gt; branch is part- and true-rolling
release, but with a semi-automatically versioning:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;each 6 weeks, if at least one new patch has been merged into the &lt;code&gt;master&lt;&#x2F;code&gt;, a
new version is created,&lt;&#x2F;li&gt;
&lt;li&gt;before 6 weeks, if several critical or significant patches have been applied,
a new version is created.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;What is the version format then? We have proposed &lt;code&gt;_YY_{2,4}._mm_._dd_&lt;&#x2F;code&gt;,
starting from 2000, our “Rüsh Epoch”.&lt;&#x2F;p&gt;
&lt;p&gt;Nevertheless, we are not &lt;strong&gt;infallible&lt;&#x2F;strong&gt; and we can potentially break
backward compatibility. It never happened but we have to face it. This
is a problem because neither the part- and true-rolling release nor the
scheduled-based release holds the information that the backward
compatibility has been broken. Therefore, the &lt;code&gt;master&lt;&#x2F;code&gt; branch must have
a &lt;strong&gt;compatibility number&lt;&#x2F;strong&gt; &lt;code&gt;_x_&lt;&#x2F;code&gt;, starting from 1 with step of 1.
Consequently, the new and last version format is
&lt;code&gt;_x_._Y_{2,4}._mm_._dd_&lt;&#x2F;code&gt;. For today for instance, it is &lt;code&gt;1.14.09.15&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;With the Rüsh Release process, we can freely rolling release our
libraries while ensuring the safety and embracing the pros of
versioning.&lt;&#x2F;p&gt;
&lt;p&gt;So, now, you will be able to change your &lt;code&gt;composer.json&lt;&#x2F;code&gt; files from:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;json&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-type z-property-name&quot;&gt;  &amp;quot;require&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-type z-property-name&quot;&gt;    &amp;quot;hoa&#x2F;websocket&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;dev-master&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;  }&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-type z-property-name&quot;&gt;  &amp;quot;minimum-stability&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;dev&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;to (&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;getcomposer.org&#x2F;doc&#x2F;01-basic-usage.md#next-significant-release-tilde-operator-&quot;&gt;learn more about the tilde
operator&lt;&#x2F;a&gt;):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;json&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-type z-property-name&quot;&gt;    &amp;quot;require&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-type z-property-name&quot;&gt;        &amp;quot;hoa&#x2F;websocket&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;quot;~1.0&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;\o&#x2F;&lt;&#x2F;p&gt;
</description>
      </item>
    </channel>
</rss>
