<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="content-security-policy" content="default-src 'self'; child-src 'self' https://www.youtube-nocookie.com; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:">
  <meta name="viewport" content="width=device-width, minimum-scale=1">

  <title>Announcing the first Postgres extension to run WebAssembly</title>

  <link rel="stylesheet" href="https://mnt.io/style/min/main.css?h=6c0cd873f06c67453a4b">
  <link rel="stylesheet" href="https://mnt.io/style/min/syntax-theme.css?h=ef9797b0398b3ffe9058">
  <link rel="stylesheet" href="https://mnt.io/style/min/search.css" fetchpriority="low">

  <meta name="author" content="Ivan Enderlin">
  <meta name="description" content="This article presents `wasmer-postgres`: the first Postgres extension to run WebAssembly. The article explores some possibilities. This is super experimental!">
  <meta name="keywords" content="rust, webassembly, postgres, runtime, binding">
  <meta property="og:title" content="Announcing the first Postgres extension to run WebAssembly">
  <meta property="og:site_name" content="mnt.io">
  <meta property="og:locale" content="en_GB">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://mnt.io/articles/announcing-the-first-postgres-extension-to-run-webassembly/">
  <meta property="og:image" content="https://mnt.io/image/site-poster.jpg">
  <meta name="fediverse:creator" content="@hywan@floss.social">

  <script defer src="https://mnt.io/search/pagefind-ui.js" fetchpriority="low"></script>
</head>
<body class="content-grid">

<nav id="menu" class="full-width content-grid">
  <ul>
    <li><a href="/" accesskey="h">Home</a></li>
    <li><a href="https://mnt.io/articles/" accesskey="a">Articles</a></li>
    <li><a href="https://mnt.io/series/" accesskey="s">Series</a></li>
    <li><a href="https://matrix.to/#/&#x23;mnt_io:matrix.org" title="Public Matrix room to discuss about this blog's content" target="_blank" accesskey="d">Discuss</a></li>
    <li>
      <a href="javascript:document.getElementById('search').showModal()" accesskey="k">
        <svg viewBox="0 0 500 500" class="icon">
          <description>Search</description>
          <circle r="180" cx="210" cy="210" fill="none" stroke="currentColor" stroke-width="40" />
          <line x1="340" y1="340" x2="480" y2="480" stroke="currentColor" stroke-width="40" stroke-linecap="round" />
        </svg>
      </a>
    </li>
  </ul>
</nav>

<dialog id="search" tabindex="-1" closedby="any"></dialog>

<main vocab="https://schema.org">

  <article class="article" typeof="Article" data-pagefind-body>
    <header>
      <h1 property="name" style="view-transition-name: article-title-announcing-the-first-postgres-extension-to-run-webassembly">Announcing the first Postgres extension to run WebAssembly</h1>

      
  <div class="metadata" data-pagefind-ignore="all">
    <time title="Published date" datetime="2019-08-29" property="datePublished">August 29, 2019</time>
    <span title="Reading time" property="timeRequired" content="PT6M">6 minutes read</span>
    
    <span title="Keywords" property="keywords" content="rust, webassembly, postgres, runtime, binding">
      Keywords:&nbsp;<a href="/keywords/rust">rust</a>, <a href="/keywords/webassembly">webassembly</a>, <a href="/keywords/postgres">postgres</a>, <a href="/keywords/runtime">runtime</a>, <a href="/keywords/binding">binding</a></span>
    
      <span><a href="https://github.com/Hywan/mnt.io/edit/main/content/articles&#x2F;2019-08-29-announcing-the-first-postgres-extension-to-run-webassembly&#x2F;index.md" title="Submit a patch for this page">Edit</a> this page</span>
      
      <meta property="description" content="This article presents `wasmer-postgres`: the first Postgres extension to run WebAssembly. The article explores some possibilities. This is super experimental!" />
      
    
  </div>

    </header>

    <p><em>This is a copy of <a rel="noopener external" target="_blank" href="https://medium.com/wasmer/announcing-the-first-postgres-extension-to-run-webassembly-561af2cfcb1">an article I wrote for
Wasmer</a>.</em></p>
<hr />
<p>WebAssembly is a portable binary format. That means the same program can
run anywhere.</p>
<blockquote>
<p>To uphold this bold statement, each language, platform and system must
be able to run WebAssembly ‚Äî as fast and safely as possible.</p>
</blockquote>
<p>Let‚Äôs say it again. <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/wasmer">Wasmer</a> is a
WebAssembly runtime. We have successfully embedded the runtime in other
languages:</p>
<ul>
<li>In Rust, as it is written in Rust</li>
<li>Using <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/wasmer/tree/master/lib/runtime-c-api">C and C++
bindings</a></li>
<li>In PHP, using
<a rel="noopener external" target="_blank" href="https://github.com/wasmerio/php-ext-wasm"><code>php-ext-wasm</code></a></li>
<li>In Python, using
<a rel="noopener external" target="_blank" href="https://github.com/wasmerio/python-ext-wasm"><code>python-ext-wasm</code></a> ‚Äî
<a rel="noopener external" target="_blank" href="https://pypi.org/project/wasmer/">wasmer package on PyPI</a></li>
<li>In Ruby, using
<a rel="noopener external" target="_blank" href="https://github.com/wasmerio/ruby-ext-wasm"><code>ruby-ext-wasm</code></a> ‚Äî <a rel="noopener external" target="_blank" href="https://rubygems.org/gems/wasmer">wasmer
gem on RubyGems</a></li>
<li>In Go, using <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/go-ext-wasm"><code>go-ext-wasm</code></a>
‚Äî see <a rel="noopener external" target="_blank" href="https://medium.com/wasmer/announcing-the-fastest-webassembly-runtime-for-go-wasmer-19832d77c050">the
announcement</a>.</li>
</ul>
<p>The community has also embedded Wasmer in awesome projects:</p>
<ul>
<li>.NET/C#, using
<a rel="noopener external" target="_blank" href="https://github.com/migueldeicaza/WasmerSharp">WasmerSharp</a></li>
<li>R, using <a rel="noopener external" target="_blank" href="https://github.com/dirkschumacher/wasmr">Wasmr</a>.</li>
</ul>
<p><strong>It is now time to continue the story and to hang around‚Ä¶
<a rel="noopener external" target="_blank" href="https://www.postgresql.org/">Postgres</a>!</strong></p>
<p>We are so happy to announce a newcrazy idea: <strong>WebAssembly on
Postgres</strong>. Yes, you read that correctly. On
<a rel="noopener external" target="_blank" href="https://github.com/wasmerio/postgres-ext-wasm">Postgres</a>.</p>
<h2 id="calling-a-webassembly-function-from-postgres">Calling a WebAssembly function from Postgres<a role="presentation" class="anchor" href="#calling-a-webassembly-function-from-postgres" title="Anchor link to this header">#</a>
</h2>
<p>As usual, we have to go through the installation process. There is no
package manager for Postgres, so it‚Äôs a manual step. The <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/postgres-ext-wasm#installation">Installation
Section of the
documentation</a>
explains the details; here is a summary:</p>
<pre class="giallo z-code"><code data-lang="shellsession"><span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> # Build the shared library.</span></span>
<span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> just build</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> # Install the extension in the Postgres tree.</span></span>
<span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> just install</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> # Activate the extension.</span></span>
<span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> echo </span><span class="z-string">&#39;CREATE EXTENSION wasm;&#39;</span><span class="z-keyword z-operator"> |</span><span> \</span></span>
<span class="giallo-l"><span>      psql -h $host -d $database</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> # Initialize the extension.</span></span>
<span class="giallo-l"><span class="z-punctuation z-separator">$</span><span> echo </span><span class="z-string">&quot;SELECT wasm_init(&#39;$(</span><span class="z-support z-function">pwd</span><span class="z-string">)/target/release/libpg_ext_wasm.dylib&#39;);&quot;</span><span class="z-keyword z-operator"> |</span><span> \</span></span>
<span class="giallo-l"><span>      psql -h $host -d $database</span></span></code></pre>
<p>Once the extension is installed, activated and initialized, we can start
having fun!</p>
<p>The current API is rather small, however basic features are available.
The goal is to gather a community and to design a pragmatic API
together, discover the expectations, how developers would use this new
technology inside a database engine.</p>
<p>Let‚Äôs see how it works. To instantiate a WebAssembly module, we use the
<code>wasm_new_instance</code> function. It takes 2 arguments: The absolute path to
the WebAssembly module, and a prefix for the module exported functions.
Indeed, if a module exports a function named <code>sum</code>, then a Postgres
function named <code>prefix_sum</code> calling the <code>sum</code> function will be created
dynamically.</p>
<p>Let‚Äôs see it in action. Let‚Äôs start by editing a Rust program that
compiles to WebAssembly:</p>
<pre class="giallo z-code"><code data-lang="rust"><span class="giallo-l"><span>#[no_mangle]</span></span>
<span class="giallo-l"><span class="z-keyword">pub</span><span class="z-storage"> extern</span><span class="z-keyword"> fn</span><span class="z-entity z-name z-function"> sum</span><span>(</span><span class="z-variable">x</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> i32</span><span>,</span><span class="z-variable"> y</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> i32</span><span>)</span><span class="z-keyword z-operator"> -&gt;</span><span class="z-entity z-name"> i32</span><span> {</span></span>
<span class="giallo-l"><span class="z-variable">    x</span><span class="z-keyword z-operator"> +</span><span class="z-variable"> y</span></span>
<span class="giallo-l"><span>}</span></span></code></pre>
<p>Once this file compiled to <code>simple.wasm</code>, we can instantiate the module,
and call the exported <code>sum</code> function:</p>
<pre class="giallo z-code"><code data-lang="sql"><span class="giallo-l"><span class="z-comment">-- New instance of the `simple.wasm` WebAssembly module.</span></span>
<span class="giallo-l"><span class="z-keyword">SELECT</span><span> wasm_new_instance(</span><span class="z-string">&#39;/absolute/path/to/simple.wasm&#39;</span><span>, </span><span class="z-string">&#39;ns&#39;</span><span>);</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">-- Call a WebAssembly exported function!</span></span>
<span class="giallo-l"><span class="z-keyword">SELECT</span><span> ns_sum(</span><span class="z-constant z-numeric">1</span><span>, </span><span class="z-constant z-numeric">2</span><span>);</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">-- ns_sum</span></span>
<span class="giallo-l"><span class="z-comment">-- --------</span></span>
<span class="giallo-l"><span class="z-comment">-- 3</span></span>
<span class="giallo-l"><span class="z-comment">-- (1 row)</span></span></code></pre>
<p><em>Et voil√† !</em> The <code>ns_sum</code> function calls the Rust <code>sum</code> function through
WebAssembly! How fun is that üòÑ?</p>
<h2 id="inspect-a-webassembly-instance">Inspect a WebAssembly instance<a role="presentation" class="anchor" href="#inspect-a-webassembly-instance" title="Anchor link to this header">#</a>
</h2>
<p>This section shows how to inspect a WebAssembly instance. At the same
time, it quickly explains how the extension works under the hood.</p>
<p>The extension provides two foreign data wrappers, gathered together in
the <code>wasm</code> foreign schema:</p>
<ul>
<li><code>wasm.instances</code> is a table with the <code>id</code> and <code>wasm_file</code> columns,
respectively for the unique instance ID, and the path of the WebAssembly
module,</li>
<li><code>wasm.exported_functions</code> is a table with the <code>instance_id</code>, <code>name</code>,
<code>inputs</code>, and <code>outputs</code> columns, respectively for the instance ID of the
exported function, its name, its input types (already formatted for Postgres),
and its output types (already formatted for Postgres).</li>
</ul>
<p>Let‚Äôs see:</p>
<pre class="giallo z-code"><code data-lang="sql"><span class="giallo-l"><span class="z-comment">-- Select all WebAssembly instances.</span></span>
<span class="giallo-l"><span class="z-keyword">SELECT</span><span class="z-keyword z-operator"> *</span><span class="z-keyword"> FROM</span><span class="z-constant z-other"> wasm</span><span>.</span><span class="z-constant z-other">instances</span><span>;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">-- id                                   |          wasm_file</span></span>
<span class="giallo-l"><span class="z-comment">-- -------------------------------------+-------------------------------</span></span>
<span class="giallo-l"><span class="z-comment">-- 426e17af-c32f-5027-ad73-239e5450dd91 | /absolute/path/to/simple.wasm</span></span>
<span class="giallo-l"><span class="z-comment">-- (1 row)</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">-- Select all exported functions for a specific instance.</span></span>
<span class="giallo-l"><span class="z-keyword">SELECT</span></span>
<span class="giallo-l"><span class="z-keyword">    name</span><span>,</span></span>
<span class="giallo-l"><span>    inputs,</span></span>
<span class="giallo-l"><span>    outputs</span></span>
<span class="giallo-l"><span class="z-keyword">FROM</span></span>
<span class="giallo-l"><span class="z-constant z-other">    wasm</span><span>.</span><span class="z-constant z-other">exported_functions</span></span>
<span class="giallo-l"><span class="z-keyword">WHERE</span></span>
<span class="giallo-l"><span>    instance_id </span><span class="z-keyword z-operator">=</span><span class="z-string"> &#39;426e17af-c32f-5027-ad73-239e5450dd91&#39;</span><span>;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">-- name   |     inputs      | outputs</span></span>
<span class="giallo-l"><span class="z-comment">-- -------+-----------------+---------</span></span>
<span class="giallo-l"><span class="z-comment">-- ns_sum | integer,integer | integer</span></span>
<span class="giallo-l"><span class="z-comment">-- (1 row)</span></span></code></pre>
<p>Based on these information, the <code>wasm</code> Postgres extension is able to
generate the SQL function to call the WebAssembly exported functions.</p>
<p>It sounds simplistic, and‚Ä¶ to be honest, it is! The trick is to use
<a rel="noopener external" target="_blank" href="https://www.postgresql.org/docs/current/fdwhandler.html">foreign data
wrappers</a>,
which is an awesome feature of Postgres.</p>
<h2 id="how-fast-is-it-or-is-it-an-interesting-alternative-to-pl-pgsql">How fast is it, or: Is it an interesting alternative to PL/pgSQL?<a role="presentation" class="anchor" href="#how-fast-is-it-or-is-it-an-interesting-alternative-to-pl-pgsql" title="Anchor link to this header">#</a>
</h2>
<p>As we said, the extension API is rather small for now. The idea is to
explore, to experiment, to have fun with WebAssembly inside a database.
It is particularly interesting in two cases:</p>
<ol>
<li>To write extensions or procedures with any languages that compile to
WebAssembly in place of
<a rel="noopener external" target="_blank" href="https://www.postgresql.org/docs/10/plpgsql.html">PL/pgSQL</a>,</li>
<li>To remove a potential performance bottleneck where speed is
involved.</li>
</ol>
<p>Thus we run a basic benchmark. Like most of the benchmarks out there, it
must be taken with a grain of salt.</p>
<blockquote>
<p>The goal is to compare the execution time between WebAssembly and
PL/pgSQL, and see how both approaches scale.</p>
</blockquote>
<p>The Postgres WebAssembly extension uses
<a rel="noopener external" target="_blank" href="https://www.postgresql.org/docs/current/fdwhandler.html">Wasmer</a> as the
runtime, compiled with the Cranelift backend (<a rel="noopener external" target="_blank" href="https://medium.com/wasmer/a-webassembly-compiler-tale-9ef37aa3b537">learn more about the
different
backends</a>).
We run the benchmark with Postgres 10, on a MacBook Pro 15" from 2016,
2.9Ghz Core i7 with 16Gb of memory.</p>
<p>The methodology is the following:</p>
<ul>
<li>Load both the <code>plpgsql_fibonacci</code> and the <code>wasm_fibonacci</code> functions,</li>
<li>Run them with a query like
<code>SELECT *_fibonacci(n) FROM generate_series(1, 1000)</code> where <code>n</code> has the
following values: 50, 500, and 5000, so that we can observe how both
approaches scale,</li>
<li>Write the timings down,</li>
<li>Run this methodology multiple times, and compute the median of the
results.</li>
</ul>
<p>Here come the results. The lower, the better.</p>
<figure>
<p><img src="https://mnt.io/articles/announcing-the-first-postgres-extension-to-run-webassembly/./benchmarks.png" alt="Benchmarks" loading="lazy" decoding="async" /></p>
  <figcaption>
<p>Comparing WebAssembly vs. PL/pgSQL when computing the Fibonacci sequence
with n=50, 500 and 5000.</p>
  </figcaption>
</figure>
<p>We notice that the Postgres WebAssembly extension is faster to run
numeric computations. The WebAssembly approach scales pretty well
compared to the PL/pgSQL approach, <em>in this situation</em>.</p>
<h3 id="">When to use the WebAssembly extension?<a role="presentation" class="anchor" href="#" title="Anchor link to this header">#</a>
</h3>
<p>So far, the extension only supports integers (on 32- and 64-bits). The
extension doesn‚Äôt support strings <em>yet</em>. It also doesn‚Äôt support
records, views or other Postgres types. Keep in mind this is the very
first step.</p>
<p>Hence, it is too soon to tell whether WebAssembly can be an alternative
to PL/pgSQL. But regarding the benchmark results above, we are sure they
can live side-by-side, WebAssembly has clearly a place in the ecosystem!
And we want to continue to pursue this exploration.</p>
<h2 id="-1">Conclusion<a role="presentation" class="anchor" href="#-1" title="Anchor link to this header">#</a>
</h2>
<p>We are already talking with people that are interested in using
WebAssembly inside databases. If you have any particular use cases,
please reach us at <a rel="noopener external" target="_blank" href="https://wasmer.io/">wasmer.io</a>, or on Twitter at
<a rel="noopener external" target="_blank" href="https://twitter.com/wasmerio">@wasmerio</a> directly or me
<a rel="noopener external" target="_blank" href="https://twitter.com/mnt_io">@mnt_io</a>.</p>
<p>Everything is open source, as usual! Happy hacking.</p>


    <nav class="previous-next-articles"><a href="https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;announcing-the-fastest-webassembly-runtime-for-go-wasmer&#x2F;" class="button text-align-start" style="view-transition-name: article-title-announcing-the-fastest-webassembly-runtime-for-go-wasmer">‚ùÆ&nbsp;Announcing the fastest WebAssembly runtime for Go: wasmer</a><a href="https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;announcing-the-first-java-library-to-run-webassembly-wasmer-jni&#x2F;" class="button text-align-end" style="view-transition-name: article-title-announcing-the-first-java-library-to-run-webassembly-wasmer-jni">Announcing the first Java library to run WebAssembly: Wasmer JNI&nbsp;‚ùØ</a></nav>
  </article>

</main>

<footer class="full-width content-grid">
  <div class="footer">
    <div>
      <h2>Contact me</h2>

      <ul>
        <li><a href="https://matrix.to/#/@mnt_io:matrix.org" title="Say hi on Matrix">@mnt_io:matrix.org</a></li>
        <li><a href="mailto:ivan@mnt.io" title="Good ol' email">ivan@mnt.io</a></li>
        <li><a href="https://floss.social/@hywan" title="Say hi on Mastodon" rel="me">Mastodon</a></li>
        <li><a href="https://github.com/Hywan" title="Say hi on Github">Github</a></li>
      </ul>
    </div>
    <div>
      <h2>Recommendations</h2>

      <ul>
        <li><a href="https://fasterthanli.me/">fasterthanli.me</a></li>
        <li><a href="https://without.boats/blog/">without.boats</a></li>
        <li><a href="https://faultlore.com/blah/">faultlore</a></li>
        <li><a href="https://smallcultfollowing.com/babysteps/blog/">smallcultfollowing</a></li>
        <li><a href="https://orlp.net/blog/">orlp</a></li>
        <li><a href="https://blog.m-ou.se/">m-ou.se</a></li>
        <li><a href="https://nadrieril.github.io/">nadrieril</a></li>
      </ul>
    </div>

    <div>
      <h2>More</h2>

      <ul>
        <li><a href="https://mnt.io/lore/">Lore</a></li>
        <li><a href="https://mnt.io/rss.xml">RSS</a></li>
        <li><a href="https://mnt.io/atom.xml">Atom</a></li>
        <li><a href="https://github.com/Hywan/mnt.io" title="Source code of this site">Source code</a></li>
        <li><a href="https://dblp.org/search/index.php?query=Ivan%20Enderlin" title="Computer Science Bibliography">DBLP</a></li>
      </ul>
    </div>
  </div>
</footer>

<script>
  window.addEventListener('DOMContentLoaded', (_event) => {
    new PagefindUI({
      element: "#search",
      resetStyles: false,
      showSubResults: true,
      showImages: false,
    });
  });
</script>
</body>
</html>
