<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="content-security-policy" content="default-src 'self'; child-src 'self' https://www.youtube-nocookie.com; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:">
  <meta name="viewport" content="width=device-width, minimum-scale=1">

  <title>Announcing the first Java library to run WebAssembly: Wasmer JNI</title>

  <link rel="stylesheet" href="https://mnt.io/style/min/main.css?h=c1d7c9eded14e7411b85">
  <link rel="stylesheet" href="https://mnt.io/style/min/syntax-theme.css?h=ef9797b0398b3ffe9058">
  <link rel="stylesheet" href="https://mnt.io/style/min/search.css" fetchpriority="low">

  <meta name="author" content="Ivan Enderlin">
  <meta name="description" content="This article presents the `wasmer-java` project: the first Java library to run WebAssembly.">
  <meta name="keywords" content="rust, webassembly, java, runtime, binding">
  <meta property="og:title" content="Announcing the first Java library to run WebAssembly: Wasmer JNI">
  <meta property="og:site_name" content="mnt.io">
  <meta property="og:locale" content="en_GB">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://mnt.io/articles/announcing-the-first-java-library-to-run-webassembly-wasmer-jni/">
  <meta property="og:image" content="https://mnt.io/image/site-poster.jpg">
  <meta name="fediverse:creator" content="@hywan@floss.social">

  <script defer src="https://mnt.io/search/pagefind-ui.js" fetchpriority="low"></script>
</head>
<body class="content-grid">

<nav id="menu" class="full-width content-grid">
  <ul>
    <li><a href="/" accesskey="h">Home</a></li>
    <li><a href="https://mnt.io/articles/" accesskey="a">Articles</a></li>
    <li><a href="https://mnt.io/series/" accesskey="s">Series</a></li>
    <li><a href="https://matrix.to/#/&#x23;mnt_io:matrix.org" title="Public Matrix room to discuss about this blog's content" target="_blank" accesskey="d">Discuss</a></li>
    <li>
      <a href="javascript:document.getElementById('search').showModal()" accesskey="k">
        <svg viewBox="0 0 500 500" class="icon">
          <description>Search</description>
          <circle r="180" cx="210" cy="210" fill="none" stroke="currentColor" stroke-width="40" />
          <line x1="340" y1="340" x2="480" y2="480" stroke="currentColor" stroke-width="40" stroke-linecap="round" />
        </svg>
      </a>
    </li>
  </ul>
</nav>

<dialog id="search" tabindex="-1" closedby="any"></dialog>

<main vocab="https://schema.org">

  <article class="article" typeof="Article" data-pagefind-body>
    <header>
      <h1 property="name" style="view-transition-name: article-title-announcing-the-first-java-library-to-run-webassembly-wasmer-jni">Announcing the first Java library to run WebAssembly: Wasmer JNI</h1>

      
  <div class="metadata" data-pagefind-ignore="all">
    <time title="Published date" datetime="2020-05-13" property="datePublished">May 13, 2020</time>
    <span title="Reading time" property="timeRequired" content="PT7M">7 minutes read</span>
    
    <span title="Keywords" property="keywords" content="rust, webassembly, java, runtime, binding">
      Keywords:&nbsp;<a href="/keywords/rust">rust</a>, <a href="/keywords/webassembly">webassembly</a>, <a href="/keywords/java">java</a>, <a href="/keywords/runtime">runtime</a>, <a href="/keywords/binding">binding</a></span>
    
      <span><a href="https://github.com/Hywan/mnt.io/edit/main/content/articles&#x2F;2020-05-13-announcing-the-first-java-library-to-run-webassembly-wasmer-jni&#x2F;index.md" title="Submit a patch for this page">Edit</a> this page</span>
      
      <meta property="description" content="This article presents the `wasmer-java` project: the first Java library to run WebAssembly." />
      
    
  </div>

    </header>

    <p><em>This is a copy of <a rel="noopener external" target="_blank" href="https://medium.com/wasmer/announcing-the-first-java-library-to-run-webassembly-wasmer-jni-89e319d2ac7c">an article I wrote for
Wasmer</a>.</em></p>
<hr />
<p><a rel="noopener external" target="_blank" href="https://webassembly.org/">WebAssembly</a> is a portable binary format.
That means the same file can run anywhere.</p>
<blockquote>
<p>To uphold this bold statement, each language, platform and system must
be able to run WebAssembly — as fast and safely as possible.</p>
</blockquote>
<p>People who are familiar with Wasmer are used to this kind of
announcement! Wasmer is written in Rust, and comes with an additional
native C API. But you can use it in a lot of other languages. After
having announced libraries to use Wasmer, and thus WebAssembly, in:</p>
<ul>
<li><a rel="noopener external" target="_blank" href="https://github.com/wasmerio/php-ext-wasm"><strong>PHP</strong> with the <code>ext/wasm</code>
extension</a>,</li>
<li><a rel="noopener external" target="_blank" href="https://github.com/wasmerio/python-ext-wasm"><strong>Python</strong> with the <code>wasmer</code>
library</a>,</li>
<li><a rel="noopener external" target="_blank" href="https://github.com/wasmerio/ruby-ext-wasm"><strong>Ruby</strong> with the <code>wasmer</code>
library</a>,</li>
<li><a rel="noopener external" target="_blank" href="https://github.com/wasmerio/go-ext-wasm"><strong>Go</strong> with the <code>wasmer</code> library</a>
(see
<a rel="noopener external" target="_blank" href="https://medium.com/wasmer/announcing-the-fastest-webassembly-runtime-for-go-wasmer-19832d77c050">Announcing the fastest WebAssembly runtime for Go: <code>wasmer</code></a>),
and even</li>
<li><a rel="noopener external" target="_blank" href="https://github.com/wasmerio/postgres-ext-wasm"><strong>Postgres</strong> with the <code>wasmer</code> library</a>
(see
<a rel="noopener external" target="_blank" href="https://medium.com/wasmer/announcing-the-first-postgres-extension-to-run-webassembly-561af2cfcb1">Announcing the first Postgres extension to run WebAssembly</a>),</li>
<li>and many other contributions in
<a rel="noopener external" target="_blank" href="https://github.com/migueldeicaza/WasmerSharp">.NET/C#</a>,
<a rel="noopener external" target="_blank" href="https://github.com/dirkschumacher/wasmr">R</a> and
<a rel="noopener external" target="_blank" href="https://github.com/tessi/wasmex">Elixir</a>…</li>
</ul>
<p>…we are jazzed to announce that <strong><a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm">Wasmer has now landed in
Java</a></strong>!</p>
<p>Let’s discover the Wasmer JNI library together.</p>
<h2 id="installation">Installation<a role="presentation" class="anchor" href="#installation" title="Anchor link to this header">#</a>
</h2>
<p>The Wasmer JNI (<em>Java Native Interface</em>) library is based on the <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/wasmer">Wasmer
runtime</a>, which is written in
<a rel="noopener external" target="_blank" href="https://www.rust-lang.org/">Rust</a>, and is compiled to a shared library.
For your convenience, we produce one JAR (<em>Java Archive</em>) per
architecture and platform. By now, the following are supported,
consistently tested, and pre-packaged (available in
<a rel="noopener external" target="_blank" href="https://bintray.com/wasmer/wasmer-jni/wasmer-jni">Bintray</a> and <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm/releases">Github
Releases</a>):</p>
<ul>
<li>
<p><code>amd64-darwin</code> for macOS, x86 64bits,</p>
</li>
<li>
<p><code>amd64-linux</code> for Linux, x86 64 bits,</p>
</li>
<li>
<p><code>amd64-windows</code> for Windows, x86 64 bits.</p>
</li>
</ul>
<p>More architectures and more platforms will be added in the near future.
If you need a specific one, <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm/issues/new?assignees=&amp;labels=%F0%9F%8E%89+enhancement&amp;template=---feature-request.md&amp;title=">feel free to
ask</a>!
However, it is possible to <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm#development">produce your own JAR for your own platform
and
architecture</a>.</p>
<p>The JAR files are named as follows:
<code>wasmer-jni-$(architecture)-$(os)-$(version).jar</code>. Thus, to include
Wasmer JNI as a dependency of your project (assuming you use
<a rel="noopener external" target="_blank" href="http://gradle.org/">Gradle</a>), write for instance:</p>
<pre class="giallo z-code"><code data-lang="plain"><span class="giallo-l"><span>dependencies {</span></span>
<span class="giallo-l"><span>    implementation &quot;org.wasmer:wasmer-jni-amd64-linux:0.2.0&quot;</span></span>
<span class="giallo-l"><span>}</span></span></code></pre>
<p>JAR are hosted on the Bintray/JCenter repository under the
<code>[wasmer-jni](https://bintray.com/wasmer/wasmer-jni/wasmer-jni)</code>
project. They are also attached to our <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm/releases">Github releases as
assets</a>.</p>
<h2 id="calling-a-webassembly-function-from-java">Calling a WebAssembly function from Java<a role="presentation" class="anchor" href="#calling-a-webassembly-function-from-java" title="Anchor link to this header">#</a>
</h2>
<p>As usual, let’s start with a simple Rust program that we will compile to
WebAssembly, and then execute from Java.</p>
<pre class="giallo z-code"><code data-lang="rust"><span class="giallo-l"><span>#[no_mangle]</span></span>
<span class="giallo-l"><span class="z-keyword">pub</span><span class="z-storage"> extern</span><span class="z-keyword"> fn</span><span class="z-entity z-name z-function"> sum</span><span>(</span><span class="z-variable">x</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> i32</span><span>,</span><span class="z-variable"> y</span><span class="z-keyword z-operator">:</span><span class="z-entity z-name"> i32</span><span>)</span><span class="z-keyword z-operator"> -&gt;</span><span class="z-entity z-name"> i32</span><span> {</span></span>
<span class="giallo-l"><span class="z-variable">    x</span><span class="z-keyword z-operator"> +</span><span class="z-variable"> y</span></span>
<span class="giallo-l"><span>}</span></span></code></pre>
<p>After compilation to WebAssembly, we get a file like <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm/raw/master/examples/simple.wasm">this
one</a>,
named <code>simple.wasm</code>.</p>
<p>The following Java program executes the <code>sum</code> exported function by
passing <code>5</code> and <code>37</code> as arguments:</p>
<pre class="giallo z-code"><code data-lang="java"><span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> org</span><span class="z-punctuation z-separator">.</span><span class="z-storage">wasmer</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Instance</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">io</span><span class="z-punctuation z-separator">.</span><span class="z-storage">IOException</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">nio</span><span class="z-punctuation z-separator">.</span><span class="z-storage">file</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Files</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">nio</span><span class="z-punctuation z-separator">.</span><span class="z-storage">file</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Paths</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage">class</span><span class="z-entity z-name"> SimpleExample</span><span class="z-punctuation z-section"> {</span></span>
<span class="giallo-l"><span class="z-storage">    public static</span><span class="z-storage z-type z-primitive"> void</span><span class="z-entity z-name z-function"> main</span><span>(</span><span class="z-storage z-type">String</span><span>[]</span><span class="z-variable z-parameter"> args</span><span>)</span><span class="z-storage"> throws</span><span class="z-storage z-type"> IOException</span><span class="z-punctuation z-section"> {</span></span>
<span class="giallo-l"><span class="z-comment">        // Read the WebAssembly bytes.</span></span>
<span class="giallo-l"><span class="z-storage z-type z-primitive">        byte</span><span>[]</span><span class="z-variable"> bytes</span><span class="z-keyword z-operator"> =</span><span class="z-variable"> Files</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">readAllBytes</span><span>(</span><span class="z-variable">Paths</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">get</span><span>(</span><span class="z-string">&quot;simple.wasm&quot;</span><span>))</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Instantiate the WebAssembly module.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Instance</span><span class="z-variable"> instance</span><span class="z-keyword z-operator"> =</span><span class="z-keyword"> new</span><span class="z-entity z-name z-function"> Instance</span><span>(bytes)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Get the `sum` exported function, call it by passing 5 and 37, and get the result.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Integer</span><span class="z-variable"> result</span><span class="z-keyword z-operator"> =</span><span> (Integer)</span><span class="z-variable"> instance</span><span class="z-punctuation z-separator">.</span><span class="z-variable">exports</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">getFunction</span><span>(</span><span class="z-string">&quot;sum&quot;</span><span>)</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">apply</span><span>(</span><span class="z-constant z-numeric">5</span><span class="z-punctuation z-separator">,</span><span class="z-constant z-numeric"> 37</span><span>)[</span><span class="z-constant z-numeric">0</span><span>]</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">        assert</span><span> result </span><span class="z-keyword z-operator">==</span><span class="z-constant z-numeric"> 42</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-variable">        instance</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">close</span><span>()</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-punctuation z-section">    }</span></span>
<span class="giallo-l"><span class="z-punctuation z-section">}</span></span></code></pre>
<p>Great! We have successfully executed a Rust program, compiled to
WebAssembly, in Java. As you can see, it is pretty straightforward. The
API is very similar to the standard JavaScript API, or the other API we
have designed for PHP, Python, Go, Ruby etc.</p>
<p>The assiduous reader might have noticed the <code>[0]</code> in <code>.apply(5, 37)[0]</code>
pattern. A WebAssembly function can return zero to many values, and in
this case, we are reading the first one.</p>
<blockquote>
<p>Note: Java values passed to WebAssembly exported functions are
automatically downcasted to WebAssembly values. Types are inferred at
runtime, and casting is done automatically. Thus, a WebAssembly
function acts as any regular Java function.</p>
</blockquote>
<p>Technically, an exported function is a <em>functional interface</em> as defined
by the Java Language Specification (i.e. it is a
<code>[FunctionalInterface](https://docs.oracle.com/javase/8/docs/api/java/lang/FunctionalInterface.html)</code>).
Thus, it is possible to write the following code where <code>sum</code> is an
actual function (of kind <code>org.wasmer.exports.Function</code>):</p>
<pre class="giallo z-code"><code data-lang="java"><span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> org</span><span class="z-punctuation z-separator">.</span><span class="z-storage">wasmer</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Instance</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> org</span><span class="z-punctuation z-separator">.</span><span class="z-storage">wasmer</span><span class="z-punctuation z-separator">.</span><span class="z-storage">exports</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Function</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">io</span><span class="z-punctuation z-separator">.</span><span class="z-storage">IOException</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">nio</span><span class="z-punctuation z-separator">.</span><span class="z-storage">file</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Files</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">nio</span><span class="z-punctuation z-separator">.</span><span class="z-storage">file</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Paths</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage">class</span><span class="z-entity z-name"> SimpleExample</span><span class="z-punctuation z-section"> {</span></span>
<span class="giallo-l"><span class="z-storage">    public static</span><span class="z-storage z-type z-primitive"> void</span><span class="z-entity z-name z-function"> main</span><span>(</span><span class="z-storage z-type">String</span><span>[]</span><span class="z-variable z-parameter"> args</span><span>)</span><span class="z-storage"> throws</span><span class="z-storage z-type"> IOException</span><span class="z-punctuation z-section"> {</span></span>
<span class="giallo-l"><span class="z-comment">        // Read the WebAssembly bytes.</span></span>
<span class="giallo-l"><span class="z-storage z-type z-primitive">        byte</span><span>[]</span><span class="z-variable"> bytes</span><span class="z-keyword z-operator"> =</span><span class="z-variable"> Files</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">readAllBytes</span><span>(</span><span class="z-variable">Paths</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">get</span><span>(</span><span class="z-string">&quot;simple.wasm&quot;</span><span>))</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Instantiate the WebAssembly module.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Instance</span><span class="z-variable"> instance</span><span class="z-keyword z-operator"> =</span><span class="z-keyword"> new</span><span class="z-entity z-name z-function"> Instance</span><span>(bytes)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Declare the `sum` function, as a regular Java function.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Function</span><span class="z-variable"> sum</span><span class="z-keyword z-operator"> =</span><span class="z-variable"> instance</span><span class="z-punctuation z-separator">.</span><span class="z-variable">exports</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">getFunction</span><span>(</span><span class="z-string">&quot;sum&quot;</span><span>)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Call `sum`.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Integer</span><span class="z-variable"> result</span><span class="z-keyword z-operator"> =</span><span> (Integer)</span><span class="z-variable"> sum</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">apply</span><span>(</span><span class="z-constant z-numeric">1</span><span class="z-punctuation z-separator">,</span><span class="z-constant z-numeric"> 2</span><span>)[</span><span class="z-constant z-numeric">0</span><span>]</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">        assert</span><span> result </span><span class="z-keyword z-operator">==</span><span class="z-constant z-numeric"> 3</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-variable">        instance</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">close</span><span>()</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-punctuation z-section">    }</span></span>
<span class="giallo-l"><span class="z-punctuation z-section">}</span></span></code></pre>
<p>But a WebAssembly module not only exports functions, it also exports
memory.</p>
<h2 id="reading-the-memory">Reading the memory<a role="presentation" class="anchor" href="#reading-the-memory" title="Anchor link to this header">#</a>
</h2>
<p>A WebAssembly instance has one or more linear memories, a contiguous and
byte-addressable range of memory spanning from offset 0 and extending up
to a varying memory size, represented by the <code>org.wasmer.Memory</code> class.
Let’s see how to use it. Consider the following Rust program:</p>
<pre class="giallo z-code"><code data-lang="rust"><span class="giallo-l"><span>#[no_mangle]</span></span>
<span class="giallo-l"><span class="z-keyword">pub</span><span class="z-storage"> extern</span><span class="z-keyword"> fn</span><span class="z-entity z-name z-function"> return_hello</span><span>()</span><span class="z-keyword z-operator"> -&gt; *</span><span class="z-storage">const</span><span class="z-entity z-name"> u8</span><span> {</span></span>
<span class="giallo-l"><span class="z-string">    b&quot;Hello, World!</span><span class="z-constant z-character">\0</span><span class="z-string">&quot;</span><span class="z-keyword z-operator">.</span><span class="z-entity z-name z-function">as_ptr</span><span>()</span></span>
<span class="giallo-l"><span>}</span></span></code></pre>
<p>The <code>return_hello</code> function returns a pointer to the statically
allocated string. The string exists in the linear memory of the
WebAssembly module. It is then possible to read it in Java:</p>
<pre class="giallo z-code"><code data-lang="java"><span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> org</span><span class="z-punctuation z-separator">.</span><span class="z-storage">wasmer</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Instance</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> org</span><span class="z-punctuation z-separator">.</span><span class="z-storage">wasmer</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Memory</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">io</span><span class="z-punctuation z-separator">.</span><span class="z-storage">IOException</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">nio</span><span class="z-punctuation z-separator">.</span><span class="z-storage">ByteBuffer</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">nio</span><span class="z-punctuation z-separator">.</span><span class="z-storage">file</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Files</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-keyword">import</span><span class="z-storage"> java</span><span class="z-punctuation z-separator">.</span><span class="z-storage">nio</span><span class="z-punctuation z-separator">.</span><span class="z-storage">file</span><span class="z-punctuation z-separator">.</span><span class="z-storage">Paths</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-storage">class</span><span class="z-entity z-name"> MemoryExample</span><span class="z-punctuation z-section"> {</span></span>
<span class="giallo-l"><span class="z-storage">    public static</span><span class="z-storage z-type z-primitive"> void</span><span class="z-entity z-name z-function"> main</span><span>(</span><span class="z-storage z-type">String</span><span>[]</span><span class="z-variable z-parameter"> args</span><span>)</span><span class="z-storage"> throws</span><span class="z-storage z-type"> IOException</span><span class="z-punctuation z-section"> {</span></span>
<span class="giallo-l"><span class="z-comment">        // Read the WebAssembly bytes.</span></span>
<span class="giallo-l"><span class="z-storage z-type z-primitive">        byte</span><span>[]</span><span class="z-variable"> bytes</span><span class="z-keyword z-operator"> =</span><span class="z-variable"> Files</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">readAllBytes</span><span>(</span><span class="z-variable">Paths</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">get</span><span>(</span><span class="z-string">&quot;memory.wasm&quot;</span><span>))</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Instantiate the WebAssembly module.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Instance</span><span class="z-variable"> instance</span><span class="z-keyword z-operator"> =</span><span class="z-keyword"> new</span><span class="z-entity z-name z-function"> Instance</span><span>(bytes)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Get a pointer to the statically allocated string returned by `return_hello`.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Integer</span><span class="z-variable"> pointer</span><span class="z-keyword z-operator"> =</span><span> (Integer)</span><span class="z-variable"> instance</span><span class="z-punctuation z-separator">.</span><span class="z-variable">exports</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">getFunction</span><span>(</span><span class="z-string">&quot;return_hello&quot;</span><span>)</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">apply</span><span>()[</span><span class="z-constant z-numeric">0</span><span>]</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Get the exported memory named `memory`.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        Memory</span><span class="z-variable"> memory</span><span class="z-keyword z-operator"> =</span><span class="z-variable"> instance</span><span class="z-punctuation z-separator">.</span><span class="z-variable">exports</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">getMemory</span><span>(</span><span class="z-string">&quot;memory&quot;</span><span>)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Get a direct byte buffer view of the WebAssembly memory.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        ByteBuffer</span><span class="z-variable"> memoryBuffer</span><span class="z-keyword z-operator"> =</span><span class="z-variable"> memory</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">buffer</span><span>()</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Prepare the byte array that will hold the data.</span></span>
<span class="giallo-l"><span class="z-storage z-type z-primitive">        byte</span><span>[]</span><span class="z-variable"> data</span><span class="z-keyword z-operator"> =</span><span class="z-keyword"> new</span><span class="z-storage z-type z-primitive"> byte</span><span>[</span><span class="z-constant z-numeric">13</span><span>]</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Let&#39;s position the cursor, and…</span></span>
<span class="giallo-l"><span class="z-variable">        memoryBuffer</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">position</span><span>(pointer)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // … read!</span></span>
<span class="giallo-l"><span class="z-variable">        memoryBuffer</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">get</span><span>(data)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Let&#39;s encode back to a Java string.</span></span>
<span class="giallo-l"><span class="z-storage z-type">        String</span><span class="z-variable"> result</span><span class="z-keyword z-operator"> =</span><span class="z-keyword"> new</span><span class="z-entity z-name z-function"> String</span><span>(data)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-comment">        // Hello!</span></span>
<span class="giallo-l"><span class="z-keyword">        assert</span><span class="z-variable"> result</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">equals</span><span>(</span><span class="z-string">&quot;Hello, World!&quot;</span><span>)</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"></span>
<span class="giallo-l"><span class="z-variable">        instance</span><span class="z-punctuation z-separator">.</span><span class="z-entity z-name z-function">close</span><span>()</span><span class="z-punctuation z-terminator">;</span></span>
<span class="giallo-l"><span class="z-punctuation z-section">    }</span></span>
<span class="giallo-l"><span class="z-punctuation z-section">}</span></span></code></pre>
<p>As we can see, the <code>Memory</code> API provides a <code>buffer</code> method. It returns a
<a rel="noopener external" target="_blank" href="https://docs.oracle.com/javase/8/docs/api/java/nio/ByteBuffer.html"><em>direct</em> byte
buffer</a>
(of kind <code>java.nio.ByteBuffer</code>) view of the memory. It’s a standard API
for any Java developer. We think it’s best to not reinvent the wheel and
use standard API as much as possible.</p>
<p>The WebAssembly memory is dissociated from the JVM memory, and thus from
the garbage collector.</p>
<blockquote>
<p>You can read <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm/blob/master/examples/GreetExample.java">the Greet
Example</a>
to see a more in-depth usage of the <code>Memory</code> API.</p>
</blockquote>
<h2 id="more-documentation">More documentation<a role="presentation" class="anchor" href="#more-documentation" title="Anchor link to this header">#</a>
</h2>
<p>The project comes with a <code>Makefile</code>. The <code>make javadoc</code> command will
generate a traditional local Javadoc for you, in the
<code>build/docs/javadoc/index.html</code> file.</p>
<p>In addition, the project’s <code>README.md</code> file has an <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm#api-of-the-wasmer-library">API of
the <code>wasmer</code> library
Section</a>.</p>
<p>Finally, the project comes with <a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm/tree/master/examples">a set of
examples</a>.
Use the <code>make run-example EXAMPLE=Simple</code> to run the
<code>SimpleExample.java</code> example for instance.</p>
<h2 id="performance">Performance<a role="presentation" class="anchor" href="#performance" title="Anchor link to this header">#</a>
</h2>
<p>WebAssembly aims at being safe, but also fast. Since Wasmer JNI is the
<em>first</em> Java library to execute WebAssembly, we can’t compare to prior
works in the Java ecosystem. However, you might know that Wasmer comes
with 3 backends: Singlepass, Cranelift and LLVM. We’ve even written an
article about it: <a rel="noopener external" target="_blank" href="https://medium.com/wasmer/a-webassembly-compiler-tale-9ef37aa3b537">A WebAssembly Compiler
tale</a>.
The Wasmer JNI library uses the Cranelift backend for the moment, which
offers the best compromise between compilation-time and execution-time.</p>
<h2 id="credits">Credits<a role="presentation" class="anchor" href="#credits" title="Anchor link to this header">#</a>
</h2>
<p>Asami (<a rel="noopener external" target="_blank" href="https://twitter.com/d0iasm">d0iasm</a> on Twitter) has improved
this project during its internship at Wasmer under my guidance. She
finished the internship before the release of the Wasmer JNI project,
but she deserves credits for pushing the project forward! Good work
Asami!</p>
<p>This is an opportunity to remind everyone that we hire anywhere in the
world. Asami was working from Japan while I am working from Switzerland,
and the rest of the team is from US, Spain, China etc. Feel free to
contact me (<a rel="noopener external" target="_blank" href="https://twitter.com/mnt_io">@mnt_io</a> or
<a rel="noopener external" target="_blank" href="https://twitter.com/syrusakbary">@syrusakbary</a> on Twitter) if you want
to join us on this big adventure!</p>
<h2 id="conclusion">Conclusion<a role="presentation" class="anchor" href="#conclusion" title="Anchor link to this header">#</a>
</h2>
<p>Wasmer JNI is a library to execute WebAssembly directly in Java. It
embeds the WebAssembly runtime
<a rel="noopener external" target="_blank" href="https://github.com/wasmerio/wasmer">Wasmer</a>. The first releases provide
the core API with <code>Module</code>, <code>Instance</code>, and <code>Memory</code>. It comes
pre-packaged as a JAR, one per architecture and per platform.</p>
<p>The source code is open and hosted on Github at
<a rel="noopener external" target="_blank" href="https://github.com/wasmerio/java-ext-wasm">wasmerio/java-ext-wasm</a>.
We are constantly improving the project, so if you have feedback,
issues, or feature requests please open an issue in the repository, or
reach us on Twitter at <a rel="noopener external" target="_blank" href="https://twitter.com/wasmerio">@wasmerio</a> or
<a rel="noopener external" target="_blank" href="https://twitter.com/mnt_io">@mnt_io</a>.</p>
<p>We look forward to see what you build with this!</p>

  </article>

</main>

<footer class="full-width content-grid">
  <div class="footer">
    <div>
      <h2>Contact me</h2>

      <ul>
        <li><a href="https://matrix.to/#/@mnt_io:matrix.org" title="Say hi on Matrix">@mnt_io:matrix.org</a></li>
        <li><a href="mailto:ivan@mnt.io" title="Good ol' email">ivan@mnt.io</a></li>
        <li><a href="https://floss.social/@hywan" title="Say hi on Mastodon" rel="me">Mastodon</a></li>
        <li><a href="https://github.com/Hywan" title="Say hi on Github">Github</a></li>
      </ul>
    </div>
    <div>
      <h2>Recommendations</h2>

      <ul>
        <li><a href="https://fasterthanli.me/">fasterthanli.me</a></li>
        <li><a href="https://without.boats/blog/">without.boats</a></li>
        <li><a href="https://faultlore.com/blah/">faultlore</a></li>
        <li><a href="https://smallcultfollowing.com/babysteps/blog/">smallcultfollowing</a></li>
        <li><a href="https://orlp.net/blog/">orlp</a></li>
        <li><a href="https://blog.m-ou.se/">m-ou.se</a></li>
        <li><a href="https://nadrieril.github.io/">nadrieril</a></li>
      </ul>
    </div>

    <div>
      <h2>More</h2>

      <ul>
        <li><a href="https://mnt.io/lore/">Lore</a></li>
        <li><a href="https://mnt.io/rss.xml">RSS</a></li>
        <li><a href="https://mnt.io/atom.xml">Atom</a></li>
        <li><a href="https://github.com/Hywan/mnt.io" title="Source code of this site">Source code</a></li>
        <li><a href="https://dblp.org/search/index.php?query=Ivan%20Enderlin" title="Computer Science Bibliography">DBLP</a></li>
      </ul>
    </div>
  </div>
</footer>

<script>
  window.addEventListener('DOMContentLoaded', (_event) => {
    new PagefindUI({
      element: "#search",
      resetStyles: false,
      showSubResults: true,
      showImages: false,
    });
  });
</script>
</body>
</html>
