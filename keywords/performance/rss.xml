<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title> - performance</title>
      <link>https://mnt.io</link>
      <description></description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://mnt.io/keywords/performance/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Mon, 23 Feb 2026 00:00:00 +0000</lastBuildDate>
      <item>
          <title>About memory pressure, lock contention, and Data-oriented Design</title>
          <pubDate>Mon, 23 Feb 2026 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/about-memory-pressure-lock-contention-and-data-oriented-design/</link>
          <guid>https://mnt.io/articles/about-memory-pressure-lock-contention-and-data-oriented-design/</guid>
          <description xml:base="https://mnt.io/articles/about-memory-pressure-lock-contention-and-data-oriented-design/">&lt;p&gt;I&#x27;m here to narrate you a story about performance. Recently, I was in the same
room as some Memory Pressure and some Lock Contention. It took me a while to
recognize them. Legend says it only happens in obscure, low-level systems,
but I&#x27;m here to refute the legend. While exploring, I had the pleasure of fixing a
funny bug in a higher-order stream: lucky us, to top it all off, we even have a
sweet treat! This story is also a pretext to introduce you to Data-oriented Design,
and to show how it improved execution time by 98.7% and throughput
by 7718.5%. I believe we have all the ingredients for a juicy story. Let&#x27;s cook,
and &lt;em lang=&quot;fr&quot;&gt;bon appétit !&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;on-a-beautiful-morning&quot;&gt;On a Beautiful Morning…&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#on-a-beautiful-morning&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;While powering on my &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;dygma.com&#x2F;pages&#x2F;defy&quot;&gt;Dygma Defy&lt;&#x2F;a&gt;, unlocking my computer, and checking
messages from my colleagues, I suddenly come across this one:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Does anyone also experience a frozen room list?&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;Ah yeah, for some years now, I&#x27;ve been employed by &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;element.io&#x2F;&quot;&gt;Element&lt;&#x2F;a&gt; to work on the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&quot;&gt;Matrix Rust SDK&lt;&#x2F;a&gt;. If one needs to write a complete, modern, cross-platform,
fast Matrix client or bot, this SDK is an excellent choice. The SDK is composed
of many crates. Some are very low in the stack and are not aimed at being used
directly by developers, like &lt;code&gt;matrix_sdk_crypto&lt;&#x2F;code&gt;. Some others are higher in the
stack — the highest is for User Interfaces (UI) with &lt;code&gt;matrix_sdk_ui&lt;&#x2F;code&gt;. While it is
a bit opinionated, it is designed to provide the high-quality features everybody
expects in a modern Matrix client.&lt;&#x2F;p&gt;
&lt;p&gt;One of these features is the Room List. The Room List is a place where users
spend a lot of their time in a messaging application (along with the Timeline,
i.e. the room&#x27;s messages). Some expectations for this component:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Be superfast,&lt;&#x2F;li&gt;
&lt;li&gt;List all the rooms,&lt;&#x2F;li&gt;
&lt;li&gt;Interact with rooms (open them, mark them as unread etc.),&lt;&#x2F;li&gt;
&lt;li&gt;Filter the rooms,&lt;&#x2F;li&gt;
&lt;li&gt;Sort the rooms.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let&#x27;s focus on the part that interests us today: &lt;em&gt;Sort the rooms&lt;&#x2F;em&gt;. The Room List
holds… no rooms. It actually provides a &lt;em&gt;stream of updates about rooms&lt;&#x2F;em&gt;; more
precisely a &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;Room&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. What does this mean? The
stream yields a vector of “diffs” of rooms. I&#x27;m writing &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;series&#x2F;reactive-programming-in-rust&#x2F;&quot;&gt;a series about reactive
programming&lt;&#x2F;a&gt; — you might be
interested to read more about it. Otherwise, here is what you need to know.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;enum.VectorDiff.html&quot;&gt;The &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; type&lt;&#x2F;a&gt; comes from &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;&quot;&gt;the &lt;code&gt;eyeball-im&lt;&#x2F;code&gt;
crate&lt;&#x2F;a&gt;, initially created for the Matrix Rust SDK as a solid
foundation for reactive programming. It looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Append&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vector&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Clear&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PushFront&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PushBack&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PopFront&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    PopBack&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Insert&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Set&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Remove&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Truncate&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        length&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    Reset&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;        values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vector&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    },&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It represents a &lt;em&gt;change&lt;&#x2F;em&gt; in &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;struct.ObservableVector.html&quot;&gt;an &lt;code&gt;ObservableVector&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.
This is like a &lt;code&gt;Vec&lt;&#x2F;code&gt;, but &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im&#x2F;0.8.0&#x2F;eyeball_im&#x2F;struct.ObservableVector.html#method.subscribe&quot;&gt;one can subscribe to the
changes&lt;&#x2F;a&gt;, and will receive… well… &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s!&lt;&#x2F;p&gt;
&lt;p&gt;The Room List type merges several streams into a single stream representing the
list of rooms. For example, let&#x27;s imagine the room at index 3 receives a new
message. Its “preview” (the &lt;em&gt;latest event&lt;&#x2F;em&gt; displayed beneath the room&#x27;s name,
e.g. &lt;q&gt;Alice: Hello!&lt;&#x2F;q&gt;) changes. Also, the Room List sorts rooms by their
“recency” (the &lt;em&gt;time&lt;&#x2F;em&gt; something happened in the room). And since the “preview”
has changed, its “recency” changes too, which means the room is sorted and
re-positioned. Then, we expect the Room List&#x27;s stream to yield:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Set { index: 3, value: new_room }&lt;&#x2F;code&gt; because of the new “preview”,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::Remove { index: 3 }&lt;&#x2F;code&gt; to remove the room… immediately followed by&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;VectorDiff::PushFront { value: new_room }&lt;&#x2F;code&gt; to insert the room at the top of the Room List.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;This reactive programming mechanism has proven to be extremely efficient.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I did my calculation: the size of &lt;code&gt;VectorDiff&amp;lt;Room&amp;gt;&lt;&#x2F;code&gt; is 72 bytes (mostly because
&lt;code&gt;Room&lt;&#x2F;code&gt; contains &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;sync&#x2F;struct.Arc.html&quot;&gt;an &lt;code&gt;Arc&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; over the real struct type). This is pretty
small for an update. Not only it brings a small memory footprint, but it crosses
the FFI boundary pretty easily, making it easy to map to other languages like
Swift or Kotlin — languages that provide UI components, like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;swiftui&#x2F;&quot;&gt;SwiftUI&lt;&#x2F;a&gt; or
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;compose&quot;&gt;Jetpack Compose&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Absolutely! These are two popular UI components where a &lt;code&gt;VectorDiff&lt;&#x2F;code&gt; maps
straightforwardly to their List component update operations. They are actually
(remarkably) pretty similar to each other&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-vectordiff_on_other_uis-1&quot;&gt;&lt;a href=&quot;#fn-vectordiff_on_other_uis&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;You&#x27;re always a good digression companion, thank you. Let&#x27;s go back on our
problem:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;What does &quot;frozen&quot; mean for the Room List?&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;It means that the Room List is simply… &lt;em&gt;blank&lt;&#x2F;em&gt;, &lt;em&gt;empty&lt;&#x2F;em&gt;, &lt;em
lang=&quot;fr&quot;&gt;vide&lt;&#x2F;em&gt;, &lt;em lang=&quot;es&quot;&gt;vacía&lt;&#x2F;em&gt;, &lt;em lang=&quot;it&quot;&gt;vuoto&lt;&#x2F;em&gt;, &lt;em
lang=&quot;ar&quot;&gt;خلو&lt;&#x2F;em&gt;… well, you get the idea.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;What could freeze the Room List?&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;What are our options?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;It would be a real pleasure if you let me assist you in this task.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;The network sync is not running properly, hence giving the &lt;em&gt;impression&lt;&#x2F;em&gt; of a
frozen Room List? Hmm, no, everything works as expected here. Moreover, local
data should be displayed.&lt;&#x2F;li&gt;
&lt;li&gt;The “source streams” used by the Room List are not yielding the expected
updates? No, everything works like a charm.&lt;&#x2F;li&gt;
&lt;li&gt;The “merge of streams” is broken for some reasons? No, it seems fine.&lt;&#x2F;li&gt;
&lt;li&gt;The filtering of the streams? Not touched since a long time.&lt;&#x2F;li&gt;
&lt;li&gt;The sorting? Ah, maybe, I reckon we have changed something here…&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Indeed, we have changed one sorter recently. Let&#x27;s take a look at how this Room List stream is computed, shall we?&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; stream!&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    loop&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Wait for the filter to be updated.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; filter&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; filter_cell&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;take&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;await&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Get the “raw” entries.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;entries&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Combine normal stream updates with other room updates.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; merge_streams&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;clone&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; other_updates&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;filter&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;filter&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sort_by&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_lexicographic&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vec!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Sort by latest event&amp;#39;s kind.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_latest_event&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Sort rooms by their recency.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_recency&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;                &#x2F;&#x2F; Finally, sort by name.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;                Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_name&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;            ]))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;dynamic_head_with_initial_value&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;page_size&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; limit_stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Clearing the stream before chaining with the real stream.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        yield&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; once&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;ready&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vec!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Reset&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; initial_values&lt;&#x2F;span&gt;&lt;span&gt; }]))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;chain&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;switch&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There is a lot going on here. Sadly, we are not going to explain everything in
this beautiful piece of art&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-switch-1&quot;&gt;&lt;a href=&quot;#fn-switch&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;.filter()&lt;&#x2F;code&gt;, &lt;code&gt;.sort_by()&lt;&#x2F;code&gt; and &lt;code&gt;.dynamic_head_with_initial_value()&lt;&#x2F;code&gt; methods
are part of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im-util&#x2F;0.10.0&#x2F;eyeball_im_util&#x2F;&quot;&gt;the &lt;code&gt;eyeball-im-util&lt;&#x2F;code&gt; crate&lt;&#x2F;a&gt;. They are used
to filter, sort etc. a stream: They are essentially mapping a &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt; to another &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. In
other terms, they “change” the &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s on-the-fly to simulate filtering,
sorting, or something else. Let&#x27;s see a very concrete example with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;eyeball-im-util&#x2F;0.10.0&#x2F;eyeball_im_util&#x2F;vector&#x2F;struct.Sort.html&quot;&gt;the &lt;code&gt;Sort&lt;&#x2F;code&gt;
higher-order stream&lt;&#x2F;a&gt; (the following example is
mostly a copy of the documentation of &lt;code&gt;Sort&lt;&#x2F;code&gt;, but &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;pull&#x2F;43&quot;&gt;since I wrote this algorithm,
I guess you, dear reader, will find it acceptable&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s imagine we have a vector of &lt;code&gt;char&lt;&#x2F;code&gt;. We want a &lt;code&gt;Stream&lt;&#x2F;code&gt; of &lt;em&gt;changes&lt;&#x2F;em&gt; about
this vector (the famous &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;). We also want to &lt;em&gt;simulate&lt;&#x2F;em&gt; a sorted
vector, by only modifying the &lt;em&gt;changes&lt;&#x2F;em&gt;. The solution looks like this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; std&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;cmp&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Ordering&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball_im&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ObservableVector&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; VectorDiff&lt;&#x2F;span&gt;&lt;span&gt;};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; eyeball_im_util&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;VectorObserverExt&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;use&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; stream_assert&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;{assert_next_eq, assert_pending};&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Our comparison function.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cmp&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;where&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    T&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ord&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;cmp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;right&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Our vector.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ObservableVector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;char&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; stream&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;subscribe&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sort_by&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;cmp&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                                            ^^^&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                                            |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;                                                            there&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;initial_values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_empty&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_pending!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Alrighty. That&#x27;s a good start. &lt;code&gt;vector&lt;&#x2F;code&gt; is empty, so the initial values from the
subscribe are empty, and the &lt;code&gt;stream&lt;&#x2F;code&gt; is also pending&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-stream_assert-1&quot;&gt;&lt;a href=&quot;#fn-stream_assert&quot;&gt;3&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;. I think
it&#x27;s time to play with this new toy, isn&#x27;t it?&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Append unsorted values.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;append&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;e&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;]);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; We get a `VectorDiff::Append` with sorted values!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Append&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;b&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;d&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;e&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;] }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_pending!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Let&amp;#39;s recap what we have. `vector` is our `ObservableVector`,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; `stream` is the “sorted view”&#x2F;“sorted stream” of `vector`:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | index    | 0 1 2 |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `vector` | d b e |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `stream` | b d e |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;So far, so good. It looks naive and simple: one operation in, one operation out.
It&#x27;s funnier when things get more complicated though:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Append multiple other values.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;vector&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;append&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;f&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;g&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;]);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; We get three `VectorDiff`s this time!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;PushFront&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;a&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Insert&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; index&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 2&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; value&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;c&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_next_eq!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    stream&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    VectorDiff&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Append&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; vector!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;f&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;g&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;] }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;assert_pending!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Let&amp;#39;s recap what we have:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | index    | 0 1 2 3 4 5 6 |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `vector` | d b e f g a c |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; | `stream` | a b c d e f g |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              ^   ^     ^^^&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              |   |     |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              |   |     with `VectorDiff::Append { .. }`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              |   with `VectorDiff::Insert { index: 2, .. }`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;              with `VectorDiff::PushFront { .. }`&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Notice how &lt;code&gt;vector&lt;&#x2F;code&gt; is &lt;em&gt;never&lt;&#x2F;em&gt; sorted. That&#x27;s the power of these higher-order
streams of &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s: light and —more importantly— &lt;strong&gt;combinable&lt;&#x2F;strong&gt;! I repeat
myself: we are always mapping a &lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt; to another
&lt;code&gt;Stream&amp;lt;Item = Vec&amp;lt;VectorDiff&amp;lt;T&amp;gt;&amp;gt;&amp;gt;&lt;&#x2F;code&gt;. That&#x27;s the same type! The whole collection
is never computed entirely, except for the initial values: only the changes are
handled and trigger a computation. Knowing that, in the manner of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;std&#x2F;future&#x2F;trait.Future.html&quot;&gt;&lt;code&gt;Future&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;,
&lt;code&gt;Stream&lt;&#x2F;code&gt; is lazy —i.e. it does something only when polled—, it makes things
pretty efficient. And…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;… as your favourite digression companion, I really, deeply, appreciate these
details. Nonetheless, I hope you don&#x27;t mind if… I suggest to you that… you might
want to, maybe, go back to… &lt;small&gt;the main… subject, don&#x27;t you think?&lt;&#x2F;small&gt;&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Which topic? Ah! The frozen Room List! Sorters are &lt;em&gt;not&lt;&#x2F;em&gt; the culprit. There.
Happy? Short enough?&lt;&#x2F;p&gt;
&lt;p&gt;These details were important. Kind of. I hope you&#x27;ve learned something along the
way. Next, let&#x27;s see how a sorter works, and how it could be responsible for our
memory pressure and lock contention.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;randomness&quot;&gt;Randomness&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#randomness&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Taking a step back, I was asking myself: &lt;q&gt;Is it really frozen?&lt;&#x2F;q&gt;. The
cherry on the cake: I was unable to reproduce the problem! Even the reporters
of the problem were unable to reproduce it consistently. Hmm, a random problem?
Fortunately, two of the reporters are obstinate. Ultimately, we got analysis.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;picture&gt;
    &lt;source srcset=&quot;.&amp;#x2F;memory-pressure.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
    &lt;source srcset=&quot;.&amp;#x2F;memory-pressure.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
    &lt;img src=&quot;.&amp;#x2F;memory-pressure.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
  &lt;&#x2F;picture&gt;
  &lt;figcaption&gt;
    &lt;p&gt;Memory analysis of Element X in Android Studio (Element X is based on the Matrix
Rust SDK). It presents a callback tree, with the number of allocations and
deallocations for each node in this tree. Thanks &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jmartinesp&quot;&gt;Jorge&lt;&#x2F;a&gt;!&lt;&#x2F;p&gt;
&lt;p&gt;And, holy cow, we see &lt;strong&gt;a lot&lt;&#x2F;strong&gt; of memory allocations, exactly 322&#x27;042 to be
precise, counting for 743Mib, for the &lt;code&gt;eyeball_im_util::vector::sort::SortBy&lt;&#x2F;code&gt;
type! I don&#x27;t remember exactly how many rooms are part of the Room List, but
it&#x27;s probably around 500-600.&lt;&#x2F;p&gt;

    &lt;p&gt;&lt;small&gt;Download fullsize image as: &lt;a href=&quot;.&amp;#x2F;memory-pressure.avif&quot; title=&quot;Download the AVIF image&quot;&gt;AVIF&lt;&#x2F;a&gt;,
      &lt;a href=&quot;.&amp;#x2F;memory-pressure.webp&quot; title=&quot;Download the WebP image&quot;&gt;WebP&lt;&#x2F;a&gt;,
      &lt;a href=&quot;.&amp;#x2F;memory-pressure.png&quot; title=&quot;Download the PNG image&quot;&gt;PNG&lt;&#x2F;a&gt;.&lt;&#x2F;small&gt;&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The Room List wasn&#x27;t frozen. It was taking &lt;strong&gt;a lot&lt;&#x2F;strong&gt; of time to yield values.
Sometimes, up to 5 minutes on a phone. Alright, we have two problems to solve
here:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Why is it random?&lt;&#x2F;li&gt;
&lt;li&gt;Why so many memory allocations and deallocations?&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;The second problem will be discussed in the next section. Let&#x27;s start with the
first problem in this section, shall we?&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s start at the beginning. &lt;code&gt;eyeball_im_util::vector::sort::SortBy&lt;&#x2F;code&gt; is used
like so:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;stream&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;sort_by&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_lexicographic&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;vec!&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_latest_event&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_recency&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Box&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_sorter_name&lt;&#x2F;span&gt;&lt;span&gt;()),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    ]))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;sort_by&lt;&#x2F;code&gt; receives a sorter: &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-ui&#x2F;0.16.0&#x2F;matrix_sdk_ui&#x2F;room_list_service&#x2F;sorters&#x2F;fn.new_sorter_lexicographic.html&quot;&gt;&lt;code&gt;new_sorter_lexicographic&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. It&#x27;s from
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-ui&#x2F;0.16.0&#x2F;matrix_sdk_ui&#x2F;room_list_service&#x2F;sorters&#x2F;&quot;&gt;&lt;code&gt;matrix_sdk_ui::room_list::sorters&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, and it&#x27;s a constructor for a…
lexicographic sorter. All sorters must implement &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-ui&#x2F;0.16.0&#x2F;matrix_sdk_ui&#x2F;room_list_service&#x2F;sorters&#x2F;trait.Sorter.html&quot;&gt;the &lt;code&gt;Sorter&lt;&#x2F;code&gt; trait&lt;&#x2F;a&gt;.
Once again, it&#x27;s a trait from &lt;code&gt;matrix_sdk_ui&lt;&#x2F;code&gt;, nothing fancy, it&#x27;s simply this:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; Trait “alias”.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; trait&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Fn&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; All functions `F` are auto-implementing `Sorter`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;impl&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;F&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; for&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; F&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;where&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    F&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; Fn&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Put it differently, all functions with two parameters of type &lt;code&gt;&amp;amp;Room&lt;&#x2F;code&gt;, and with
a return type &lt;code&gt;Ordering&lt;&#x2F;code&gt; is considered a sorter. There. It&#x27;s crystal clear now,
except… what&#x27;s a lexicographic sorter?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Should I really quote the documentation of &lt;code&gt;new_sorter_lexicographic&lt;&#x2F;code&gt;? My work
here is turning into a tragedy.&lt;&#x2F;p&gt;
&lt;p&gt;It creates a new sorter that will run multiple sorters. When the
&lt;math&gt;&lt;msup&gt;&lt;mi&gt;n&lt;&#x2F;mi&gt;&lt;mtext&gt;nth&lt;&#x2F;mtext&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt; sorter returns
&lt;code&gt;Ordering::Equal&lt;&#x2F;code&gt;, the next sorter is called. It stops as soon as a sorter
returns &lt;code&gt;Ordering::Greater&lt;&#x2F;code&gt; or &lt;code&gt;Ordering::Less&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This is an implementation of a lexicographic order as defined for &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Lexicographic_order#Cartesian_products&quot;&gt;cartesian
products&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;In short, we are executing 3 sorters: by &lt;em&gt;latest event&lt;&#x2F;em&gt;, by &lt;em&gt;recency&lt;&#x2F;em&gt;
and by &lt;em&gt;name&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;None of these sorters are using any form of randomness. It&#x27;s a &lt;em
lang=&quot;fr&quot;&gt;cul-de-sac&lt;&#x2F;em&gt;. Let&#x27;s take a step back by looking at &lt;code&gt;SortBy&lt;&#x2F;code&gt; in
&lt;code&gt;eyeball_im_util&lt;&#x2F;code&gt; itself maybe? &lt;i&gt;Scroll the documentation&lt;&#x2F;i&gt;, not here,
&lt;i&gt;read the initial patch&lt;&#x2F;i&gt;, hmm, I see a mention of a binary search, &lt;i&gt;jump
into the code&lt;&#x2F;i&gt;, ah, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;blob&#x2F;b7dc6fde71e507459ecbd7519a8a22f12bf2a8de&#x2F;eyeball-im-util&#x2F;src&#x2F;vector&#x2F;sort.rs#L315-L318&quot;&gt;here, look at the comment&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;When looking for the &lt;em&gt;position&lt;&#x2F;em&gt; of a value (e.g. where to insert a new
value?), &lt;code&gt;Vector::binary_search_by&lt;&#x2F;code&gt; is used — it is possible because the
&lt;code&gt;Vector&lt;&#x2F;code&gt; is sorted. When looking for the &lt;em&gt;unsorted index&lt;&#x2F;em&gt; of a value,
&lt;code&gt;Iterator::position&lt;&#x2F;code&gt; is used.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&#x2F;7.0.0&#x2F;imbl&#x2F;type.Vector.html#method.binary_search_by&quot;&gt;&lt;code&gt;Vector::binary_search_by&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; doesn&#x27;t mention any form of randomness in its
documentation. Another &lt;em lang=&quot;fr&quot;&gt;cul-de-sac&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Remember that the Room List appears frozen but it is actually blank. The problem
is not when the stream receives an update, but when the stream is “created”,
i.e. when the initial items are sorted for the first time before receiving
updates.&lt;&#x2F;p&gt;
&lt;p&gt;Moreover, the comment says &lt;q&gt;it is possible because the &lt;code&gt;Vector&lt;&#x2F;code&gt; is sorted&lt;&#x2F;q&gt;,
which indicates that “the vector” (I guess it&#x27;s a buffer somewhere) &lt;em&gt;has been
sorted&lt;&#x2F;em&gt; one way or another. What do you think?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Ah! Brilliant. That&#x27;s correct! Looking at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;blob&#x2F;b7dc6fde71e507459ecbd7519a8a22f12bf2a8de&#x2F;eyeball-im-util&#x2F;src&#x2F;vector&#x2F;sort.rs#L261&quot;&gt;the constructor of
&lt;code&gt;SortBy&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; (or its implementation), we notice it&#x27;s using
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;imbl&#x2F;7.0.0&#x2F;imbl&#x2F;type.Vector.html#method.sort_by&quot;&gt;&lt;code&gt;Vector::sort_by&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. And guess what? It&#x27;s relying on… &lt;i&gt;drum roll&lt;&#x2F;i&gt;…
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jneem&#x2F;imbl&#x2F;blob&#x2F;6feb48d04ed9bd2a004968541d1a90d61c423d31&#x2F;src&#x2F;vector&#x2F;mod.rs#L1575-L1583&quot;&gt;quicksort&lt;&#x2F;a&gt;! Following the path, we see
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jneem&#x2F;imbl&#x2F;blob&#x2F;6feb48d04ed9bd2a004968541d1a90d61c423d31&#x2F;src&#x2F;sort.rs#L177-L185&quot;&gt;it actually creates a pseudo random number generator (PRNG) to do the
quicksort&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Phew. Finally. Time for a cup of tea and a biscuit&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-biscuit-1&quot;&gt;&lt;a href=&quot;#fn-biscuit&quot;&gt;4&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;My guess here is the following. Depending on the (pseudo randomly) generated
pivot index, the number of comparisons may vary each time this runs. We can
enter a pathological case where more comparisons means more memory pressure,
which means slower sorting, which means… A Frozen Room List&lt;sup&gt;&lt;abbr
title=&quot;Trademark&quot;&gt;TM&lt;&#x2F;abbr&gt;&lt;&#x2F;sup&gt;, &lt;i&gt;play horror movie music&lt;&#x2F;i&gt;!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;memory-pressure&quot;&gt;Memory Pressure&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#memory-pressure&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A memory allocator is responsible for… well… allocating the memory. If you
believe this is a simple problem, please retract this offensive thought quickly:
what an oaf! Memory is managed based on the strategy or strategies used by the
memory allocator: there is not a unique solution. Each memory allocator comes
with trade-offs: do you allocate and replace multiple similar small objects
several times in a row, do you need fixed-size blocks of memory, dynamic blocks
etc.&lt;&#x2F;p&gt;
&lt;p&gt;Allocating memory is not free. The memory allocator has a cost in itself —which
could be mitigated by implementing a custom memory allocator maybe—, but there
is also &lt;strong&gt;a hardware cost&lt;&#x2F;strong&gt;, and it&#x27;s comparatively more difficult to mitigate.
Memory is allocated on the heap, i.e. &lt;em&gt;the RAM&lt;&#x2F;em&gt;, also called &lt;em&gt;the main memory&lt;&#x2F;em&gt;
(not be confused with &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;CPU_cache&quot;&gt;CPU caches: L1, L2…&lt;&#x2F;a&gt;). The RAM is nice and
all, but it lives far from the CPU. It &lt;em&gt;takes time&lt;&#x2F;em&gt; to allocate something on the
heap and…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Hold on a second. I heard it is around 100-150 nanoseconds to fetch a data from
the heap. In what world is this “costly”? How is this “far” from the CPU?&lt;&#x2F;p&gt;
&lt;p&gt;I understand we are talking about &lt;em&gt;random&lt;&#x2F;em&gt; accesses (the &lt;em&gt;R&lt;&#x2F;em&gt; in RAM), and
multiple indirections, but still, it sounds pretty fast, right?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Hmm, &lt;i&gt;refrain from opening the Pandora&#x27;s box&lt;&#x2F;i&gt;, let&#x27;s try to stay high-level
here, shall we? Be careful: the numbers I am going to present can vary depending
on your hardware, but the important part is &lt;strong&gt;the scale&lt;&#x2F;strong&gt;: keep that in mind.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Operation&lt;&#x2F;th&gt;&lt;th style=&quot;text-align: right&quot;&gt;Time&lt;&#x2F;th&gt;&lt;th style=&quot;text-align: right&quot;&gt;“Human scale”&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;Fetch from L1 cache&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;1ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;1mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Branch misprediction&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;3ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;3mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Fetch from L2 cache&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;4ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;4mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Mutex lock&#x2F;unlock&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;17ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;17mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;Fetch from the main memory&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;100ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;1h40mn&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;SSD random read&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;16&#x27;000ns&lt;&#x2F;td&gt;&lt;td style=&quot;text-align: right&quot;&gt;11.11 days&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;figcaption&gt;
&lt;p&gt;Latency numbers for the year 2020 for various operations (source:
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;people.eecs.berkeley.edu&#x2F;~rcs&#x2F;research&#x2F;interactive_latency.html&quot;&gt;&lt;cite&gt;Latency Numbers Every Programmer Shoud Know&lt;&#x2F;cite&gt; from Colin Scott (UC
Berkeley)&lt;&#x2F;a&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;The time in the second column is given in nanoseconds, i.e.
&lt;math&gt;&lt;mfrac&gt;&lt;mn&gt;1&lt;&#x2F;mn&gt;&lt;mn&gt;1&#x27;000&#x27;000&#x27;000&lt;&#x2F;mn&gt;&lt;&#x2F;mfrac&gt;&lt;&#x2F;math&gt; second. The time in
the third column is “humanized” to give us a better sense of the scale here: we
imagine 1ns maps to 1min.&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Do you see the difference between the L1&#x2F;L2 caches and the main memory? 1ns to
100ns is the same difference as 1mn to 1h40. So, yes, it takes time to read
from memory. That&#x27;s why we try to avoid allocations as much as possible.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;svg viewBox=&quot;0 0 200 55&quot; role=&quot;img&quot; id=&quot;memory-race&quot;&gt;
  &lt;style&gt;
  #memory-race text { font-size: 4pt }
  #memory-race circle {
    fill: oklch(69.50% .140 76.18);
    animation: 4s linear 0s infinite alternate slide;
  }
  #memory-race .l1 { animation-duration: .5s }
  #memory-race .l2 { animation-duration: 2s }
  #memory-race .ram { animation-duration: 50s }
  @keyframes slide {
    from {
      transform: translateX(15%);
    }
    to {
      transform: translateX(85%);
    }
  }
  &lt;&#x2F;style&gt;
  &lt;text x=&quot;0&quot; y=&quot;12&quot;&gt;CPU&lt;&#x2F;text&gt;
  &lt;text x=&quot;0&quot; y=&quot;27&quot;&gt;CPU&lt;&#x2F;text&gt;
  &lt;text x=&quot;0&quot; y=&quot;42&quot;&gt;CPU&lt;&#x2F;text&gt;
  &lt;text x=&quot;180&quot; y=&quot;12&quot;&gt;L1&lt;&#x2F;text&gt;
  &lt;text x=&quot;180&quot; y=&quot;27&quot;&gt;L2&lt;&#x2F;text&gt;
  &lt;text x=&quot;180&quot; y=&quot;42&quot;&gt;RAM&lt;&#x2F;text&gt;
  &lt;circle cx=&quot;0&quot; cy=&quot;10&quot; r=&quot;4&quot; class=&quot;l1&quot; &#x2F;&gt;
  &lt;circle cx=&quot;0&quot; cy=&quot;25&quot; r=&quot;4&quot; class=&quot;l2&quot; &#x2F;&gt;
  &lt;circle cx=&quot;0&quot; cy=&quot;40&quot; r=&quot;4&quot; class=&quot;ram&quot; &#x2F;&gt;
&lt;&#x2F;svg&gt;
&lt;figcaption&gt;
&lt;p&gt;Not comfortable with numbers? Let&#x27;s try to visualise it with 1ns = 1s! On
the left: the CPU. On the right, the L1 cache, the L2 cache, and the RAM. The
“balls” represent the time it takes to move information between the CPU and the
L1&#x2F;L2 caches or the RAM.&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;Sadly, in our case, it appears we are allocating 322&#x27;042 times to sort the
initial rooms of the Room List, for a total of 743&#x27;151&#x27;616 bits allocated,
with 287 bytes per allocation. Of course, if we are doing quick napkin
maths&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-napkin-math-1&quot;&gt;&lt;a href=&quot;#fn-napkin-math&quot;&gt;5&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;, it should take around 200ms. We are far from The Frozen
Room List&lt;sup&gt;&lt;abbr title=&quot;Trademark&quot;&gt;TM&lt;&#x2F;abbr&gt;&lt;&#x2F;sup&gt;, but there is more going
on.&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-suspens-1&quot;&gt;&lt;a href=&quot;#fn-suspens&quot;&gt;6&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Do you remember the memory allocator? Its role is to also avoid &lt;em&gt;fragmentation&lt;&#x2F;em&gt;
as much as possible. The number of memory “blocks” isn&#x27;t infinite: when memory
blocks are freed, and new ones are allocated later, maybe the previous blocks
are no longer available and cannot be reused. The allocator has to find a good
place, while keeping fragmentation under control. Maybe the blocks must be moved
to create enough space to insert the new blocks (it&#x27;s often preferable to have
contiguous blocks).&lt;&#x2F;p&gt;
&lt;p&gt;That&#x27;s what I call &lt;strong&gt;memory pressure&lt;&#x2F;strong&gt;. We are asking too much, too fast, and
the memory allocator we use in the Matrix Rust SDK is not designed to handle
this use case.&lt;&#x2F;p&gt;
&lt;p&gt;What are our solutions then?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;May I suggest an approach? What about finding where we are allocating and
deallocating memory? Then we might be able to reduce either the number of
allocations, or the size of the value being allocated (and deallocated), with
the hope of making the memory allocator happier. Possible solutions:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;If the allocated value is too large to fit in the stack, we could return a
pointer to it if possible,&lt;&#x2F;li&gt;
&lt;li&gt;Maybe we don&#x27;t need the full value: we could return just a pointer to a
fragment of it?&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Excellent ideas. Let&#x27;s track which sorter creates the problem. We start with
the sorter that was recently modified: &lt;code&gt;latest_event&lt;&#x2F;code&gt;. In short, this sorter
compares the &lt;code&gt;LatestEventValue&lt;&#x2F;code&gt; of two rooms: the idea is that rooms with a
&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt; representing a &lt;em&gt;local event&lt;&#x2F;em&gt;, i.e. an event that is not sent
yet, or is sending, must be at the top of the Room List. Alright, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;3eb693acadb08db8e41de90ef51730d206168e7c&#x2F;crates&#x2F;matrix-sdk-ui&#x2F;src&#x2F;room_list_service&#x2F;sorters&#x2F;latest_event.rs#L64C1-L69C2&quot;&gt;let&#x27;s look at
its core part&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; new_sorter&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; latest_events&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;        |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;latest_event&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;latest_event&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    move&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;| -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cmp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;latest_events&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span&gt;) }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Alright. For each sorting iteration, the &lt;code&gt;Room::latest_event&lt;&#x2F;code&gt; method is called
twice. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;3eb693acadb08db8e41de90ef51730d206168e7c&#x2F;crates&#x2F;matrix-sdk-base&#x2F;src&#x2F;room&#x2F;latest_event.rs#L38&quot;&gt;This method is as follows&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; latest_event&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; LatestEventValue&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;clone&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Oh, there it is. We are acquiring a read lock over the &lt;code&gt;info&lt;&#x2F;code&gt; value, then we
are reading the &lt;code&gt;latest_event&lt;&#x2F;code&gt; field, and we are cloning the value. Cloning
is important here as we don&#x27;t want to hold the read lock for too long. This
is our culprit. The size of the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;3eb693acadb08db8e41de90ef51730d206168e7c&#x2F;crates&#x2F;matrix-sdk-base&#x2F;src&#x2F;latest_event.rs#L29&quot;&gt;&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; type
is 144 bytes (it doesn&#x27;t count the size of the event itself, because this size
is dynamic).&lt;&#x2F;p&gt;
&lt;p&gt;Before going further, let&#x27;s check whether another sorter has a similar problem,
shall we? &lt;i&gt;Look at the other sorters&lt;&#x2F;i&gt;, oh!, turns out &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;blob&#x2F;01c0775e5974ad8a8690f5c580e79612ddcdfa2d&#x2F;crates&#x2F;matrix-sdk-ui&#x2F;src&#x2F;room_list_service&#x2F;sorters&#x2F;recency.rs#L90&quot;&gt;the &lt;code&gt;recency&lt;&#x2F;code&gt;
sorter&lt;&#x2F;a&gt; also uses the &lt;code&gt;latest_event&lt;&#x2F;code&gt; method! Damn, this is
becoming really annoying.&lt;&#x2F;p&gt;
&lt;p&gt;Question: do we need the entire &lt;code&gt;LatestEventValue&lt;&#x2F;code&gt;? Probably not!&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;For the &lt;code&gt;latest_event&lt;&#x2F;code&gt; sorter, we actually only need to know when this
&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt; is &lt;em&gt;local&lt;&#x2F;em&gt;, that&#x27;s it.&lt;&#x2F;li&gt;
&lt;li&gt;For the &lt;code&gt;recency&lt;&#x2F;code&gt; sorter, we only need to know the timestamp of the
&lt;code&gt;LatestEventValue&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;So instead of copying the whole value in memory twice per sorter iteration, for
two sorters, let&#x27;s try to write more specific methods:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; latest_event_is_local&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_local&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; latest_event_timestamp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;MilliSecondsSinceUnixEpoch&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;    self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;timestamp&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Just like that, &lt;strong&gt;the throughput has been improved by 18%&lt;&#x2F;strong&gt; according to the
&lt;code&gt;room_list&lt;&#x2F;code&gt; benchmark. You can see &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;commit&#x2F;62eb1996d917fb1928bdb9bba40d78a6eefe0bbd&quot;&gt;the patch in “action”&lt;&#x2F;a&gt;. Can we
declare victory over memory pressure?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I beg your pardon, but I don&#x27;t believe it&#x27;s a victory. We have reduced the size
of allocations, but not the number of allocations itself.&lt;&#x2F;p&gt;
&lt;p&gt;Well, actually, &lt;code&gt;latest_event_is_local&lt;&#x2F;code&gt; returns a &lt;code&gt;bool&lt;&#x2F;code&gt;: it
can fit in the stack. And &lt;code&gt;latest_event_timestamp&lt;&#x2F;code&gt; returns an
&lt;code&gt;Option&amp;lt;MilliSecondsSinceUnixEpoch&amp;gt;&lt;&#x2F;code&gt;, where &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;ruma&#x2F;0.14.1&#x2F;ruma&#x2F;struct.MilliSecondsSinceUnixEpoch.html&quot;&gt;&lt;code&gt;MilliSecondsSinceUnixEpoch&lt;&#x2F;code&gt; is a
&lt;code&gt;Uint&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, which &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;js_int&#x2F;0.2.2&#x2F;js_int&#x2F;struct.UInt.html&quot;&gt;itself is a &lt;code&gt;f64&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;: it can
also fit in the stack.&lt;&#x2F;p&gt;
&lt;p&gt;So, yes, we may have reduced the number of allocations greatly, that&#x27;s agreed,
it explains the 18% throughput improvement. However, issue reporters were
mentioning a lag of 5 minutes or so, do you remember? How do you explain the
remaining 4 minutes 6 seconds then? This is still unacceptable, right?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Definitely yes! Everything above 200ms (from our napkin maths) is unacceptable
here. Memory pressure was an important problem, and it&#x27;s now solved, but it
wasn&#x27;t the only problem.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;lock-contention&quot;&gt;Lock Contention&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#lock-contention&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;The assiduous reader may have noticed that we are still dealing with a lock
here.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;info&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;read&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;latest_event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;…&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;        ^^^^^^&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;        |&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F;        this read lock acquisition&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Do you remember we had 322&#x27;042 allocations? It represents the number of times
the &lt;code&gt;latest_event&lt;&#x2F;code&gt; method was called basically, which means…&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;… the lock is acquired 322&#x27;042 times!&lt;&#x2F;p&gt;
&lt;p&gt;…&lt;&#x2F;p&gt;
&lt;p&gt;… no?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;… yes… and please, stop interrupting me, I was trying to build up the suspense for
a climax.&lt;&#x2F;p&gt;
&lt;p&gt;Anyway. Avoiding a lock isn&#x27;t an easy task. However, this lock around &lt;code&gt;info&lt;&#x2F;code&gt;
is particularly annoying because it&#x27;s called by almost all sorters! They need
information about a &lt;code&gt;Room&lt;&#x2F;code&gt;; all the information is in this &lt;code&gt;info&lt;&#x2F;code&gt; field, which
is a read-write lock. Hmmm.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s change our strategy. We need to take a step back:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;The sorters need this data.&lt;&#x2F;li&gt;
&lt;li&gt;Running the sorters won&#x27;t change this data.&lt;&#x2F;li&gt;
&lt;li&gt;When the data does change the sorters will be re-run.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Maybe we could fetch, ahead of time, all the necessary data for all sorters in
a single type: it will be refreshed when the data changes, which is right before the
sorters run again.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;The idea here is to organise the data around a specific layout. The focus on the
data layout aims at being CPU cache friendly as much as possible. This kind of
approach is called &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Data-oriented_design&quot;&gt;&lt;em&gt;Data-oriented Design&lt;&#x2F;em&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;That&#x27;s correct. If the type is small enough, it can fit more easily in the
CPU caches, like L1 or L2. Do you remember how fast they are? 1ns and 4ns,
much faster than the 100ns for the main memory. Moreover, it removes the lock
contention and the memory pressure entirely!&lt;&#x2F;p&gt;
&lt;details&gt;
&lt;summary&gt;
&lt;p&gt;I highly recommend watching the following talks&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-talks-1&quot;&gt;&lt;a href=&quot;#fn-talks&quot;&gt;7&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; if you want to learn more about Data-oriented Design (DoD)&lt;&#x2F;p&gt;
&lt;&#x2F;summary&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;rX0ItVEVjHc&quot;
    title=&quot;Data-Oriented Design and C++, by Mike Acton, at the CppCon 2014&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Data-Oriented Design and C++, by Mike Acton, at the CppCon 2014&lt;&#x2F;p&gt;

    &lt;p&gt;The transformation of data is the only purpose of any program. Common approaches in C++ which are antithetical to this goal will be presented in the context of a performance-critical domain (console game development). Additionally, limitations inherent in any C++ compiler and how that affects the practical use of the language when transforming that data will be demonstrated. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;CppCon&#x2F;CppCon2014&#x2F;tree&#x2F;master&#x2F;Presentations&#x2F;Data-Oriented%20Design%20and%20C%2B%2B&quot;&gt;View the slides&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
  &lt;iframe
    class=&quot;youtube-player&quot;
    src=&quot;https:&#x2F;&#x2F;www.youtube-nocookie.com&#x2F;embed&#x2F;WDIkqP4JbkE&quot;
    title=&quot;Cpu Caches and Why You Care, by Scott Meyers, at the code::dive conference 2014&quot;
    frameborder=&quot;0&quot;
    allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot;
    referrerpolicy=&quot;strict-origin-when-cross-origin&quot;
    allowfullscreen
    loading=&quot;lazy&quot;&gt;&lt;&#x2F;iframe&gt;

  &lt;figcaption&gt;
    &lt;p&gt;Video: Cpu Caches and Why You Care, by Scott Meyers, at the code::dive conference 2014&lt;&#x2F;p&gt;

    &lt;p&gt;This talk explores CPU caches and their impact on program performance.&lt;&#x2F;p&gt;

  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;p&gt;So. Let&#x27;s be serious: I suggest trying to do some Data-oriented Design here.
We start by putting all our data in a single type:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItem&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::latest_event_timestamp`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_latest_event_timestamp&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;MilliSecondsSinceUnixEpoch&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::latest_event_is_local`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_latest_event_is_local&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::recency_stamp`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_recency_stamp&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomRecencyStamp&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::cached_display_name`, already as a string.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_display_name&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F;&#x2F; Cache of `Room::is_space`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_is_space&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; Cache of `Room::state`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    cached_state&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomState&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItem&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; refresh_cached_data&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; room&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Room&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;        self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;cached_latest_event_timestamp &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;=&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; room&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;new_latest_event_timestamp&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; etc.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;At this point, the size of &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; is 64 bytes, acceptably small!&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;The L1 and L2 caches nowadays have a size of several kilobytes. You can try to
run &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;man.freebsd.org&#x2F;cgi&#x2F;man.cgi?query=sysctl&quot;&gt;&lt;code&gt;sysctl&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; or &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;linux.die.net&#x2F;man&#x2F;1&#x2F;getconf&quot;&gt;&lt;code&gt;getconf&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; in a shell to see how much your hardware supports
(look for an entry like “cache line”, or “cache line size” for example).&lt;&#x2F;p&gt;
&lt;p&gt;On my system for example, the L1 (data) cache size is 65Kb, and the cache line
size is 128 bytes.&lt;&#x2F;p&gt;
&lt;p&gt;Ideally, we —at the very least— want one &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; to fit in a cache line.
Compacting the type to avoid inner padding would be ideal. If there is a &lt;em&gt;cache
miss&lt;&#x2F;em&gt; in L1, the CPU will look at the next cache, so L2, and so on, until
reaching the main memory. So the cost of a cache miss is: look up in L1, plus
cache miss, plus look up in L2, etc.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;commit&#x2F;a84c97b292c658109bfb40391b5f10b0708276d4&quot;&gt;A bit of plumbing later&lt;&#x2F;a&gt;, this new &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; type is
used everywhere by the Room List, by all its filters and all its sorters. For
example, the &lt;code&gt;latest_event&lt;&#x2F;code&gt; sorter now looks like:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; new_sorter&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Sorter&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; latest_events&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; = |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomListItem&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomListItem&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;cached_latest_event_is_local,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;cached_latest_event_is_local)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    move&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;| -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Ordering&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; cmp&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;latest_events&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; left&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; right&lt;&#x2F;span&gt;&lt;span&gt;) }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The lock acquisitions happen only in &lt;code&gt;refresh_cached_data&lt;&#x2F;code&gt;, when a new update
happens, not during the filtering or sorting anymore. Let&#x27;s see what the
benchmark has to say now.&lt;&#x2F;p&gt;
&lt;p&gt;Before:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellscript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; cargo bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; room_list&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomList&#x2F;Create&#x2F;1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; rooms ×&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    time:   [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;53.027&lt;&#x2F;span&gt;&lt;span&gt; ms &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;53.149&lt;&#x2F;span&gt;&lt;span&gt; ms &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;53.273&lt;&#x2F;span&gt;&lt;span&gt; ms]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    thrpt:&lt;&#x2F;span&gt;&lt;span&gt;  [18.771&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Kelem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 18.815&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Kelem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 18.858&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Kelem&#x2F;s]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;After:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellscript&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;$&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; cargo bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --bench&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; room_list&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomList&#x2F;Create&#x2F;1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; rooms ×&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1000&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;           time:   [&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;676.29&lt;&#x2F;span&gt;&lt;span&gt; µs &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;676.84&lt;&#x2F;span&gt;&lt;span&gt; µs &lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;677.50&lt;&#x2F;span&gt;&lt;span&gt; µs]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;           thrpt:&lt;&#x2F;span&gt;&lt;span&gt;  [1.4760&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Melem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1.4775&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Melem&#x2F;s&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 1.4787&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; Melem&#x2F;s]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;    change:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;           time:   [-98.725% -98.721% -98.716%] (&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;p&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0.00&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt; 0.05&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;           thrpt:&lt;&#x2F;span&gt;&lt;span&gt;  [+7686.9%&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; +7718.5% +7745.6%]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;           Performance&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; has improved.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Boom!&lt;&#x2F;p&gt;
&lt;p&gt;We don&#x27;t see the 5 minutes lag mentioned by the reporters, but remember it&#x27;s
random. Nonetheless, &lt;strong&gt;the performance impact is huge&lt;&#x2F;strong&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;From 18.8Kelem&#x2F;s to 1.4Melem&#x2F;s,&lt;&#x2F;li&gt;
&lt;li&gt;From 53ms to 676µs, or —to compare with the same unit— 0.676ms, so &lt;strong&gt;78× faster&lt;&#x2F;strong&gt;!&lt;&#x2F;li&gt;
&lt;li&gt;The throughput has improved by 7718.5%, and the time by 98.7%.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Can we claim victory now?&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Apparently yes! The reporters were unable to reproduce the problem anymore. It
seems it&#x27;s solved! Looking at profilers, we see millions fewer allocations in
the benchmark runs (the benchmark does a lot of allocations for the setup, but
the difference is pretty noticeable).&lt;&#x2F;p&gt;
&lt;p&gt;Data-oriented Design is fascinating. Understanding how computers work, how the
memory and the CPU work, is crucial to optimise algorithms. The changes we&#x27;ve
applied are small compared to the performance improvement they have provided!&lt;&#x2F;p&gt;
&lt;p&gt;You said everything above 200ms is unacceptable. With 676µs, I reckon the target
is reached. It&#x27;s even below the napkin maths about main memory access, which
suggests we are not hitting the RAM anymore in the filters and sorters (not
in an uncivilised way at least). Also, it&#x27;s funny that the difference between
an L1&#x2F;L2 cache access (1-4ns) and a main memory access (100ns) is on average
40 times faster, which looks suspiciously similar to the 78 times factor we see
here. It also suggests we are hitting L1 more frequently than L2, which is a
good sign!&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;The benchmark Iteration Times and Regression graphs are interesting to look at.&lt;&#x2F;p&gt;
&lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;1-iteration-times.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;1-iteration-times.svg&quot; alt=&quot;Iteration times&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;figcaption&gt;
&lt;p&gt;The initial Iteration Times, before our patches. Notice how the points do not
follow any “trend”. It&amp;#39;s a clear sign the program is acting erratically.&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;2-iteration-times.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;about-memory-pressure-lock-contention-and-data-oriented-design&#x2F;.&#x2F;2-iteration-times.svg&quot; alt=&quot;Iteration times&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;figcaption&gt;
&lt;p&gt;The final Iteration Times&#x2F;Regression, after our patches. Notice how the points
are linear.&lt;&#x2F;p&gt;
&lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;p&gt;The second graph is the kind of graph I like. Predictable.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;In this concrete case, it&#x27;s difficult to improve the performance further because
&lt;code&gt;RoomListItem&lt;&#x2F;code&gt; is used by sorters, and by filters, and in other places of the
code. The current usage of &lt;code&gt;RoomListItem&lt;&#x2F;code&gt; falls into the definition of &lt;em&gt;Array of
Structures&lt;&#x2F;em&gt; in the Data-oriented Design terminology. After all, we clearly have
a &lt;code&gt;Vec&amp;lt;RoomListItem&amp;gt;&lt;&#x2F;code&gt; at the root of everything. It is efficient but &lt;em&gt;Structure
of Arrays&lt;&#x2F;em&gt; might be even more efficient. Instead of having:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItem&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    a&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    b&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u64&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    c&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; bool&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; rooms&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;RoomListItem&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;we would have:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItems&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    a&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;bool&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    b&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    c&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;bool&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; rooms&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; RoomListItems&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This is not applicable in our situation because sorters are iterating over
different fields. However, if you&#x27;re sure only one field in a single loop is
used, this &lt;em&gt;Structure of Arrays&lt;&#x2F;em&gt; is cache friendlier as it loads less data into
the CPU caches: less padding, fewer useless bytes. By making better use of the
cache line, not only we are pretty sure the program will run faster, but the
CPU will be better at predicting what data will be loaded in the cache line,
boosting the performance even more!&lt;&#x2F;p&gt;
&lt;p&gt;Just so you know my role here is not restricted to recite documentation or to
summarise Wikipedia entries.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Of course you&amp;#39;re valuable! Now, the surprise.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;The Dessert&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;Of course, let&amp;#39;s not forget about our dessert! I won&amp;#39;t dig too much: the
patch contains all the necessary gory details. In short, it&amp;#39;s about how
&lt;code&gt;VectorDiff::Set&lt;&#x2F;code&gt; can create a nasty bug in &lt;code&gt;SortBy&lt;&#x2F;code&gt;. Basically, when a value
in the vector is updated, a &lt;code&gt;VectorDiff::Set&lt;&#x2F;code&gt; is emitted. &lt;code&gt;SortBy&lt;&#x2F;code&gt; is then
responsible for computing a new &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;it was calculating the old position of the value,&lt;&#x2F;li&gt;
&lt;li&gt;it was calculating the new position,&lt;&#x2F;li&gt;
&lt;li&gt;depending on that, it was emitting the appropriate &lt;code&gt;VectorDiff&lt;&#x2F;code&gt;s.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;However, the old “value” wasn&amp;#39;t removed from the buffer &lt;em&gt;immediately&lt;&#x2F;em&gt; and
not &lt;em&gt;every time&lt;&#x2F;em&gt;. In theory, it should not cause any problem —it was an
optimisation after all— except if… the items manipulated by the stream are
“shallow clones”. Shallow cloning a value won&amp;#39;t copy the value entirely: we get
a new value, but its state is synced with the original value. This happens with
types such as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;#[derive(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Clone&lt;&#x2F;span&gt;&lt;span&gt;)]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; S&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    inner&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Arc&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;T&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here, cloning a value of type &lt;code&gt;S&lt;&#x2F;code&gt; and changing its &lt;code&gt;inner&lt;&#x2F;code&gt; field will also
update the original value.&lt;&#x2F;p&gt;
&lt;p&gt;Just like that, it was possible to systematically create… &lt;strong&gt;an infinite loop&lt;&#x2F;strong&gt;.
Funky isn&amp;#39;t it?&lt;&#x2F;p&gt;
&lt;p&gt;You can view the patch &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jplatte&#x2F;eyeball&#x2F;pull&#x2F;80&quot;&gt;Fix an infinite loop when &lt;code&gt;SortBy&amp;lt;Stream&amp;lt;Item = T&amp;gt;&amp;gt;&lt;&#x2F;code&gt; handles a &lt;code&gt;VectorDiff::Set&lt;&#x2F;code&gt; where &lt;code&gt;T&lt;&#x2F;code&gt; is a shallow clone
type&lt;&#x2F;a&gt; to learn more.&lt;&#x2F;p&gt;
&lt;p&gt;I think this is a concrete example of when jumping on an optimisation can lead
to a bug. I&amp;#39;m not saying we should not prematurely optimise our programs: I&amp;#39;m
a partisan of the “we should” camp. I&amp;#39;m saying that bugs can be pretty subtle
sometimes, and this bug would have been avoided if we hadn&amp;#39;t taken a shortcut in
this algorithm. It&amp;#39;s important to be correct first, then measure, then improve.&lt;&#x2F;p&gt;
&lt;p&gt;I hope you&amp;#39;ve learned a couple of things, and you&amp;#39;ve enjoyed your reading.&lt;&#x2F;p&gt;
&lt;p&gt;I would like to thank &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;artificialworlds.net&#x2F;blog&#x2F;&quot;&gt;Andy Balaam&lt;&#x2F;a&gt; and &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;poljar&quot;&gt;Damir Jelić&lt;&#x2F;a&gt; for the
reviews and the feedback!&lt;&#x2F;p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn-vectordiff_on_other_uis&quot;&gt;
&lt;p&gt;On &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;swiftui&#x2F;&quot;&gt;SwiftUI&lt;&#x2F;a&gt;, there is the
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.apple.com&#x2F;documentation&#x2F;swift&#x2F;collectiondifference&#x2F;change&quot;&gt;&lt;code&gt;CollectionDifference.Change&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; enum. For example: &lt;code&gt;VectorDiff::PushFront&lt;&#x2F;code&gt;
is equivalent to &lt;code&gt;Change.insert(offset: 0)&lt;&#x2F;code&gt;. On &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;compose&quot;&gt;Jetpack Compose&lt;&#x2F;a&gt;, there is
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;kotlinlang.org&#x2F;api&#x2F;core&#x2F;kotlin-stdlib&#x2F;kotlin.collections&#x2F;-mutable-list&#x2F;&quot;&gt;&lt;code&gt;MutableList&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; object. For example: &lt;code&gt;VectorDiff::Clear&lt;&#x2F;code&gt; is equivalent to
&lt;code&gt;MutableList.clear()&lt;&#x2F;code&gt;! &lt;a href=&quot;#fr-vectordiff_on_other_uis-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-switch&quot;&gt;
&lt;p&gt;I would &lt;em&gt;love&lt;&#x2F;em&gt; to talk about how this &lt;code&gt;Stream&lt;&#x2F;code&gt; produces
a &lt;code&gt;Stream&lt;&#x2F;code&gt;, how the outer stream and the inner stream are switched (with
&lt;code&gt;.switch()&lt;&#x2F;code&gt;!), how we&amp;#39;ve implemented that from scratch, but it&amp;#39;s probably
for another article. Meanwhile, you can take a look at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;async-rx&#x2F;0.1.3&#x2F;async_rx&#x2F;struct.Switch.html&quot;&gt;&lt;code&gt;async_rx::Switch&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-switch-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-stream_assert&quot;&gt;
&lt;p&gt;Do you know &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;stream_assert&#x2F;0.1.1&#x2F;stream_assert&#x2F;&quot;&gt;&lt;code&gt;stream_assert&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;? It&amp;#39;s another crate we&amp;#39;ve
written to easily apply assertions on &lt;code&gt;Stream&lt;&#x2F;code&gt;s. Pretty convenient. &lt;a href=&quot;#fr-stream_assert-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-biscuit&quot;&gt;
&lt;p&gt;Yes, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.biscuitsec.org&#x2F;&quot;&gt;biscuit&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-biscuit-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-napkin-math&quot;&gt;
&lt;p&gt;I highly recommend to read the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;sirupsen&#x2F;napkin-math&#x2F;&quot;&gt;Napkin Math&lt;&#x2F;a&gt; project, with
the great talk at &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=IxkSlnrRFqc&quot;&gt;SRECON&amp;#39;19, &lt;cite&gt;Advanced Napkin Math: Estimating System
Performance from First Principles&lt;&#x2F;cite&gt; by Simon Eskildsen&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-napkin-math-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-suspens&quot;&gt;
&lt;p&gt;Do you remember the lock contention? Wait for it. At this step of
the story, I wasn&amp;#39;t aware we had a lock contention yet. &lt;a href=&quot;#fr-suspens-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-talks&quot;&gt;
&lt;p&gt;If you are curious and enjoy watching talks, I&amp;#39;m maintaining
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;playlist?list=PLOkMRkzDhWGX_4YWI4ZYGbwFPqKnDRudf&quot;&gt;a playlist of interesting talks I&amp;#39;ve watched&lt;&#x2F;a&gt;. Also
you can read this old article &lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;one-conference-per-day-for-one-year-2017&#x2F;&quot;&gt;Once conference per day, for one year
(2017)&lt;&#x2F;a&gt;. &lt;a href=&quot;#fr-talks-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;section&gt;
</description>
      </item>
      <item>
          <title>From 19k to 4.2M events&#x2F;sec: story of a SQLite query optimisation</title>
          <pubDate>Fri, 12 Sep 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://mnt.io/articles/from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation/</link>
          <guid>https://mnt.io/articles/from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation/</guid>
          <description xml:base="https://mnt.io/articles/from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation/">&lt;p&gt;Sit down comfortably. Take a cushion if you wish. This is, &lt;i&gt;clear its
throat&lt;&#x2F;i&gt;, the story of a funny performance quest. The &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&quot;&gt;Matrix Rust SDK&lt;&#x2F;a&gt; is a
set of crates aiming at providing all the necessary tooling to develop robust
and safe &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;matrix.org&#x2F;&quot;&gt;Matrix&lt;&#x2F;a&gt; clients. Of course, it involves databases to persist some
data. The Matrix Rust SDK supports multiple databases: in-memory, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;&quot;&gt;SQLite&lt;&#x2F;a&gt;, and
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;API&#x2F;IndexedDB_API&quot;&gt;IndexedDB&lt;&#x2F;a&gt;. This story is about the SQLite database.&lt;&#x2F;p&gt;
&lt;p&gt;The structure we want to persist is a novel type we have designed specifically
for the Matrix Rust SDK: a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-common&#x2F;0.14.0&#x2F;matrix_sdk_common&#x2F;linked_chunk&#x2F;index.html&quot;&gt;&lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;. It&#x27;s the underlying structure that
holds all events manipulated by the Matrix Rust SDK. It is somewhat similar to
a &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Linked_List&quot;&gt;linked list&lt;&#x2F;a&gt;; the differences are subtle and the goal of this article is
&lt;em&gt;not&lt;&#x2F;em&gt; to present all the details. We have developed many API around this type
to make all operations fast and efficient in the context of the Matrix protocol.
What we need to know is that in a &lt;code&gt;LinkedChunk&amp;lt;_, Item, Gap&amp;gt;&lt;&#x2F;code&gt;, each node
contains a &lt;code&gt;ChunkContent&amp;lt;Item, Gap&amp;gt;&lt;&#x2F;code&gt; defined as:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;enum&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; ChunkContent&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Item&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Gap&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Gap&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Gap&lt;&#x2F;span&gt;&lt;span&gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;    Items&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Item&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;),&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Put it differently: each node can contain a &lt;em&gt;gap&lt;&#x2F;em&gt;, or a set of &lt;em&gt;items&lt;&#x2F;em&gt; (be
Matrix events).&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;May I recapitulate?&lt;&#x2F;p&gt;
&lt;p&gt;Each Matrix &lt;em&gt;room&lt;&#x2F;em&gt; contains a &lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;, which is a set of &lt;em&gt;chunks&lt;&#x2F;em&gt;. Each
&lt;em&gt;chunk&lt;&#x2F;em&gt; is either a &lt;em&gt;gap&lt;&#x2F;em&gt; or a set of &lt;em&gt;events&lt;&#x2F;em&gt;. It seems to map fairly easily to
SQL tables, isn&#x27;t it?&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;You&#x27;re right: it&#x27;s pretty straightforward! Let&#x27;s see the first table:
&lt;code&gt;linked_chunks&lt;&#x2F;code&gt; which contains all the chunks. (Note that the schemas are
simplified for the sake of clarity).&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;linked_chunks&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which linked chunk does this chunk belong to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;linked_chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Identifier of the chunk, unique per linked chunk.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;id&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Identifier of the previous chunk.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;previous&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Identifier of the next chunk.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;next&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Our enum for the content of the chunk: `E` for events, `G` for a gap.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;type&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; TEXT CHECK&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;type&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; IN&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;E&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;G&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;)) &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Alrighty. Next contenders: the &lt;code&gt;event_chunks&lt;&#x2F;code&gt; and the &lt;code&gt;gap_chunks&lt;&#x2F;code&gt; tables, which
store the &lt;code&gt;ChunkContent&lt;&#x2F;code&gt;s of each chunk, respectively for &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt;
and &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt;. In &lt;code&gt;event_chunks&lt;&#x2F;code&gt;, each row corresponds to an event. In
&lt;code&gt;gap_chunks&lt;&#x2F;code&gt;, each row corresponds to a gap.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;event_chunks&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which linked chunk does this event belong to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;linked_chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which chunk does this event refer to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- The event ID.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;event_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Position (index) in the **chunk**.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;position&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;gap_chunks&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which linked chunk does this event belong to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;linked_chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- Which chunk does this gap refer to?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;chunk_id&amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; INTEGER&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Last contender, &lt;code&gt;events&lt;&#x2F;code&gt;. The assiduous reader may have noted that
&lt;code&gt;event_chunks&lt;&#x2F;code&gt; doesn&#x27;t contain the content of the events: only its ID and its
position, &lt;i&gt;roll its eyes&lt;&#x2F;i&gt;… let&#x27;s digress a bit, should we? Why is that? To
handle out-of-band events. In the Matrix protocol, we can receive events via:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#get_matrixclientv3sync&quot;&gt;the &lt;code&gt;&#x2F;sync&lt;&#x2F;code&gt; endpoint&lt;&#x2F;a&gt;, it&#x27;s the main source of inputs, we get most
of the events via this API,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#get_matrixclientv3roomsroomidmessages&quot;&gt;the &lt;code&gt;&#x2F;messages&lt;&#x2F;code&gt; endpoint&lt;&#x2F;a&gt;, when we need to get events around a
particular events; this is helpful if we need to paginate backwards or
forwards around an event,&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#get_matrixclientv3roomsroomidcontexteventid&quot;&gt;the &lt;code&gt;&#x2F;context&lt;&#x2F;code&gt; endpoint&lt;&#x2F;a&gt;, if we need to get more context about
an event.&lt;&#x2F;li&gt;
&lt;li&gt;but there is more, like &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;client-server-api&#x2F;#mroompinned_events&quot;&gt;pinned events&lt;&#x2F;a&gt;, and so on.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;When an event is fetched but cannot be positioned regarding other events, it is
considered &lt;em&gt;out-of-band&lt;&#x2F;em&gt;: it belongs to zero linked chunk, but we keep it in the
database. Maybe we can attach it to a linked chunk later, or we want to keep it
for saving future network requests. Anyway. You&#x27;re a great digression companion.
Let&#x27;s jump back to our tables.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;code&gt;events&lt;&#x2F;code&gt; table contains &lt;em&gt;all&lt;&#x2F;em&gt; the events: in-band &lt;em&gt;and&lt;&#x2F;em&gt; out-of-band.&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;-- Events and their content.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;CREATE TABLE&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;events&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- The ID of the event.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;event_id&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- The JSON encoded content of the event (it&amp;#39;s an encrypted value).&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;    &amp;quot;content&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; BLOB &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;NOT NULL&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    -- … other things …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;At some point, we need to fetch metadata about a &lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;. A certain
algorithm needs these metadata to work efficiently. We don&#x27;t need to load all
events, however we need:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;to know all the chunks that are part of a linked chunk,&lt;&#x2F;li&gt;
&lt;li&gt;for each chunk, the number of events: 0 in case of a &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt;
(&lt;code&gt;G&lt;&#x2F;code&gt;), or the number of events in case of a &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt; (&lt;code&gt;E&lt;&#x2F;code&gt;).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;A first implementation has landed in the Matrix Rust SDK. All good. When
suddenly…&lt;&#x2F;p&gt;
&lt;h2 id=&quot;incredibly-slow-sync&quot;&gt;&lt;q cite=&quot;https:&#x2F;&#x2F;github.com&#x2F;element-hq&#x2F;element-x-ios-rageshakes&#x2F;issues&#x2F;4248&quot;&gt;Incredibly slow sync&lt;&#x2F;q&gt;&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#incredibly-slow-sync&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;A power-user&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-power-user-1&quot;&gt;&lt;a href=&quot;#fn-power-user&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; was &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;element-hq&#x2F;element-x-ios-rageshakes&#x2F;issues&#x2F;4248&quot;&gt;experiencing slowness&lt;&#x2F;a&gt;. It&#x27;s always
a delicate situation. How to know the reason of the slowness? Is it the device?
The network? The asynchronous runtime? A lock contention? The file system? …
The database?&lt;&#x2F;p&gt;
&lt;p&gt;We don&#x27;t have the device within easy reach. Hopefully, Matrix users are always
nice and willing to help! We have added a bunch of logs, then the user has
reproduced the problem, and shared their logs (via a rageshake) with us. Logs
are never trivial to analyse. However, here is a tip we use in the Matrix Rust
SDK: we have a special tracing type that logs the time spent in a portion of the
code; called &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-common&#x2F;0.14.0&#x2F;matrix_sdk_common&#x2F;tracing_timer&#x2F;struct.TracingTimer.html&quot;&gt;&lt;code&gt;TracingTimer&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Basically, when a &lt;code&gt;TracingTimer&lt;&#x2F;code&gt; is created, it keeps its creation time in
memory. And when the &lt;code&gt;TracingTimer&lt;&#x2F;code&gt; is dropped, it emits a log containing the
elapsed time since its creation. It looks like this (it uses
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;tracing&#x2F;&quot;&gt;the &lt;code&gt;tracing&lt;&#x2F;code&gt; library&lt;&#x2F;a&gt;):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;pub&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt; struct&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; TracingTimer&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; String&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;: &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;static DefaultCallsite&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    start&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Instant&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;    level&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;:&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Level&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;impl&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Drop&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; for&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; TracingTimer&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    fn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; drop&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-storage&quot;&gt;mut&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span&gt;) {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; enabled&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;level_enabled!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;level)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;            let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; interest&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;interest&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;            !&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;interest&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;is_never&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;                &amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;__macro_support&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;__is_enabled&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt;self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;(),&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; interest&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        };&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        if&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; !&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;enabled&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;            return&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; message&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; format!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;_{}_ finished in {:?}&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;id,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;start&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;elapsed&lt;&#x2F;span&gt;&lt;span&gt;());&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable z-language&quot;&gt; self&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;callsite&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; fields&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;fields&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; message_field&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; fields&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;field&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;message&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; [(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;message_field&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Some&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;message&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; as&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;dyn&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Value&lt;&#x2F;span&gt;&lt;span&gt;))];&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; This function is hidden from docs, but we have to use it&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; because there is no other way of obtaining a `ValueSet`.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; It&amp;#39;s not entirely clear why it is private. See this issue:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; https:&#x2F;&#x2F;github.com&#x2F;tokio-rs&#x2F;tracing&#x2F;issues&#x2F;2363&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; values&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; fields&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;value_set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;values&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        tracing&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Event&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;dispatch&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; &amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;values&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    }&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And with that, let&#x27;s use its companion macro &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;matrix-sdk-common&#x2F;0.14.0&#x2F;matrix_sdk_common&#x2F;macro.timer.html&quot;&gt;&lt;code&gt;timer!&lt;&#x2F;code&gt;&lt;&#x2F;a&gt; (I won&#x27;t copy-paste it
here, it&#x27;s pretty straightforward):&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;{&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;    let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _timer&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt; timer!&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;quot;built something important&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; … build something important …&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;    &#x2F;&#x2F; `_timer` is dropped here, and will emit a log.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;}&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With this technique, we were able to inspect the logs and saw immediately what
was slow… assuming we have added &lt;code&gt;timer!&lt;&#x2F;code&gt;s at the right places! It&#x27;s not magic,
it doesn&#x27;t find performance issues for you. You have to probe the correct places
in your code, and refine if necessary.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;comte&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Comte&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;comte.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;comte.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;

  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;I don&#x27;t know if you heard about &lt;em&gt;sampling profilers&lt;&#x2F;em&gt;, but those are programs
far superior at analysing performance problems, compared to your… rustic
&lt;code&gt;TracingTimer&lt;&#x2F;code&gt; (pun intended!). Such programs can provide flamegraphs, call
trees etc.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m personally a regular user of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;mstange&#x2F;samply&quot;&gt;samply&lt;&#x2F;a&gt;, a command line CPU profiler relying
on the &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;firefox-devtools&#x2F;profiler&quot;&gt;Firefox profiler&lt;&#x2F;a&gt; for its UI. It works on macOS, Linux and Windows.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;I do also use &lt;code&gt;samply&lt;&#x2F;code&gt; pretty often! But you need an access to the processes
to use such tools. Here, the Matrix Rust SDK is used and embedded inside Matrix
clients. We have no access to it. It lives on devices everywhere around the
world. We may use better log analysers to infer “call trees”, but supporting
asynchronous logs (because the code is asynchronous) makes it very difficult.
And I honestly don&#x27;t know if such a thing exists.&lt;&#x2F;p&gt;
&lt;p&gt;So. Yes. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;pull&#x2F;5407&quot;&gt;We found the culprit&lt;&#x2F;a&gt;. With &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;BurntSushi&#x2F;ripgrep&quot;&gt;&lt;code&gt;ripgrep&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;, we were able to scan
megabytes of logs and find the culprit pretty quickly. I was looking for lags of
the order of a second. I wasn&#x27;t disappointed:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;shellsession&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-punctuation z-separator&quot;&gt;$&lt;&#x2F;span&gt;&lt;span&gt; rg &lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt;&amp;#39;_method_ finished in.*&amp;gt; load_all_chunks_metadata&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt; all.log &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; rg&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;\d+(\.\d+)?s&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --only-matching&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; sort&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; --numeric-sort --reverse&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;107.121747125s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;79.909931458s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;10.348993583s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;8.827636417s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;8.614481625s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;8.009787875s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;5.99637875s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;4.118492334s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.910040333s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.718858334s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.689340667s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;3.661383208s&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;107 seconds. Be 1 minute and 47 seconds. Hello sweety.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-slow-query&quot;&gt;The slow query&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#the-slow-query&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;load_all_chunks_metadata&lt;&#x2F;code&gt; is a method that runs this SQL query:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-support z-function&quot;&gt;    COUNT&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;event_id&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; number_of_events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;FROM&lt;&#x2F;span&gt;&lt;span&gt; linked_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; lc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;LEFT JOIN&lt;&#x2F;span&gt;&lt;span&gt; event_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; ec&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;ON&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;WHERE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;linked_chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;GROUP BY&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;For each chunk of the linked chunk, it counts the number of events associated to
this chunk. That&#x27;s it.&lt;&#x2F;p&gt;
&lt;p&gt;Do you remember that a chunk can be of two kinds: &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt; if it
contains a set of events, or &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt; if it contains a gap, so, no
event.&lt;&#x2F;p&gt;
&lt;p&gt;This query does the following:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;if the chunk is of kind &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt;, it does count all events
associated to itself (via &lt;code&gt;ec.chunk_id = lc.id&lt;&#x2F;code&gt;),&lt;&#x2F;li&gt;
&lt;li&gt;otherwise, the chunk is of kind &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt;, so it will try to count
but… no event is associated to it: it&#x27;s impossible to get
&lt;code&gt;ec.chunk_id = lc.id&lt;&#x2F;code&gt; to be true for a gap. This query will scan &lt;em&gt;all events&lt;&#x2F;em&gt;
for each gap… for no reason whatsoever! This is a linear scan here. If there
are 300 gaps for this linked chunk, and 5000 events, 1.5 millions events will
be scanned for &lt;strong&gt;no reason&lt;&#x2F;strong&gt;!&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;How lovingly inefficient.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;12-6x-faster&quot;&gt;&lt;math&gt;&lt;mn&gt;12.6&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#12-6x-faster&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;q&gt;Let&#x27;s use an &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;lang_createindex.html&quot;&gt;&lt;code&gt;INDEX&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;&lt;&#x2F;q&gt; I hear you say (let&#x27;s pretend
you&#x27;re saying that, please, for the sake of the narrative!).&lt;&#x2F;p&gt;
&lt;p&gt;A database index provides rapid lookups after all. It has become a reflex
amongst the developer community.&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;procureur&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Procureur&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;procureur.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;procureur.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;Indexes are designed to quickly locate data without scanning the full table. An
index contains a copy of the data, organised in a way enabling very efficient
search. Behind the scene, it uses various data structures, involving trade-offs
between lookup performance and index size. Most of the time, an index makes it
possible to transform a linear lookup,
&lt;math&gt;
&lt;mi&gt;O&lt;&#x2F;mi&gt;&lt;mo&gt;(&lt;&#x2F;mo&gt;
&lt;mi&gt;n&lt;&#x2F;mi&gt;
&lt;mo&gt;)&lt;&#x2F;mo&gt;
&lt;&#x2F;math&gt;,
to a logarithmic lookup,
&lt;math&gt;
&lt;mi&gt;O&lt;&#x2F;mi&gt;&lt;mo&gt;(&lt;&#x2F;mo&gt;
&lt;mo lspace=&quot;0&quot; rspace=&quot;0&quot;&gt;log&lt;&#x2F;mo&gt;&lt;mo&gt;(&lt;&#x2F;mo&gt;
&lt;mi&gt;n&lt;&#x2F;mi&gt;
&lt;mo&gt;)&lt;&#x2F;mo&gt;
&lt;mo&gt;)&lt;&#x2F;mo&gt;
&lt;&#x2F;math&gt;.
See &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Database_index&quot;&gt;Database index&lt;&#x2F;a&gt; to learn more.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;That&#x27;s correct. But we didn&#x27;t want to use an index here. The reason is twofold:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;More spaces&lt;&#x2F;strong&gt;. Remember that &lt;em&gt;Le Procureur&lt;&#x2F;em&gt; said an index contains a
&lt;em&gt;copy&lt;&#x2F;em&gt; of the data. Here, the data is &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;spec.matrix.org&#x2F;v1.15&#x2F;appendices&#x2F;#event-ids&quot;&gt;the event ID&lt;&#x2F;a&gt;. It&#x27;s not
heavy, but it&#x27;s not nothing. Moreover, we are not counting the &lt;em&gt;key&lt;&#x2F;em&gt; to
associate the &lt;em&gt;copied data&lt;&#x2F;em&gt; to the row containing the real data in the source
table.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Still extra useless time&lt;&#x2F;strong&gt;. We would still need to traverse the index for
gaps, which is pointless.
&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;arch.html&quot;&gt;SQLite implements indexes as B-Trees&lt;&#x2F;a&gt;, which is really
efficient, but still, we already know that a gap has zero event because…
it&#x27;s… a gap between events!&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Do you remember that the &lt;code&gt;linked_chunks&lt;&#x2F;code&gt; table has a &lt;code&gt;type&lt;&#x2F;code&gt; column? It contains
&lt;code&gt;E&lt;&#x2F;code&gt; when the chunk is of kind &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt; —it represents a set of
events—, and &lt;code&gt;G&lt;&#x2F;code&gt; when of kind &lt;code&gt;ChunkContent::Gap&lt;&#x2F;code&gt; —it represents a gap—. Maybe…
&lt;i&gt; stare into the void&lt;&#x2F;i&gt;&lt;&#x2F;p&gt;
&lt;div class=&quot;conversation&quot; data-character=&quot;factotum&quot;&gt;
  &lt;div class=&quot;conversation--character&quot;&gt;
    &lt;span lang=&quot;fr&quot;&gt;Le Factotum&lt;&#x2F;span&gt;

    &lt;picture role=&quot;presentation&quot;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.avif&quot; type=&quot;image&#x2F;avif&quot; &#x2F;&gt;
      &lt;source srcset=&quot;&#x2F;image&#x2F;factotum.webp&quot; type=&quot;image&#x2F;webp&quot; &#x2F;&gt;
      &lt;img src=&quot;&#x2F;image&#x2F;factotum.png&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;
    &lt;&#x2F;picture&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;conversation--message&quot;&gt;
    &lt;p&gt;May I interrupt?&lt;&#x2F;p&gt;
&lt;p&gt;Do you know that SQLite provides &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;lang_expr.html#the_case_expression&quot;&gt;a &lt;code&gt;CASE&lt;&#x2F;code&gt; expression&lt;&#x2F;a&gt;? I know it&#x27;s
unusual. SQL designers prefer to think in terms of sets, sub-sets, joins,
temporal tables, partial indexes… but honestly, for what I&#x27;m concerned, in
our case, it&#x27;s simple enough and it can be powerful. It&#x27;s a maddeningly
pragmatic &lt;code&gt;match&lt;&#x2F;code&gt; statement.&lt;&#x2F;p&gt;
&lt;p&gt;Moreover, the &lt;code&gt;type&lt;&#x2F;code&gt; column is already typed as an enum with the &lt;code&gt;CHECK(&quot;type&quot; IN (&#x27;E&#x27;, &#x27;G&#x27;))&lt;&#x2F;code&gt; constraint. Maybe the SQL engine can run some even smarter
optimisations for us.&lt;&#x2F;p&gt;

  &lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Oh, that would be brilliant! If &lt;code&gt;type&lt;&#x2F;code&gt; is &lt;code&gt;E&lt;&#x2F;code&gt;, we count the number of events,
otherwise we conclude it&#x27;s &lt;em&gt;de facto&lt;&#x2F;em&gt; zero, isn&#x27;t it? Let&#x27;s try. The SQL query
then becomes:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;sql&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;    lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    CASE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;type&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    WHEN&lt;&#x2F;span&gt;&lt;span class=&quot;z-string&quot;&gt; &amp;#39;E&amp;#39;&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt; THEN&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        SELECT&lt;&#x2F;span&gt;&lt;span class=&quot;z-support z-function&quot;&gt; COUNT&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;event_id&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        FROM&lt;&#x2F;span&gt;&lt;span&gt; event_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; ec&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;        WHERE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; ec&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    ELSE&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;        0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    END&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;    as&lt;&#x2F;span&gt;&lt;span&gt; number_of_events&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;FROM&lt;&#x2F;span&gt;&lt;span&gt; linked_chunks &lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; lc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword&quot;&gt;WHERE&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt; lc&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-other&quot;&gt;linked_chunk_id&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span&gt; ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Since we have spotted the problem, we have written a benchmark to measure the
solutions. The benchmark simulates 10&#x27;000 events, with 1 gap every 80 events.
A set of data we consider &lt;em&gt;realistic&lt;&#x2F;em&gt; somehow for a normal user (not for a
power-user though, because a power-user has usually more gaps than events). Here
are the before&#x2F;after results.&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Lower bound&lt;&#x2F;th&gt;
        &lt;th&gt;Estimate&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Upper bound&lt;&#x2F;th&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;thead&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;Throughput&lt;&#x2F;td&gt;
        &lt;td&gt;19.832 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;19.917 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;19.999 Kelem&#x2F;s&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;math&gt;&lt;msup&gt;&lt;mi&gt;R&lt;&#x2F;mi&gt;&lt;mn&gt;2&lt;&#x2F;mn&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;0.0880234&lt;&#x2F;td&gt;
        &lt;td&gt;0.1157540&lt;&#x2F;td&gt;
        &lt;td&gt;0.0857823&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Mean&lt;&#x2F;td&gt;
        &lt;td&gt;500.03 ms&lt;&#x2F;td&gt;
        &lt;td&gt;502.08 ms&lt;&#x2F;td&gt;
        &lt;td&gt;504.24 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Standard Deviation&quot;&gt;Std. Dev.&lt;&#x2F;td&gt;
        &lt;td&gt;2.2740 ms&lt;&#x2F;td&gt;
        &lt;td&gt;3.6256 ms&lt;&#x2F;td&gt;
        &lt;td&gt;4.1963 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Median&lt;&#x2F;td&gt;
        &lt;td&gt;498.23 ms&lt;&#x2F;td&gt;
        &lt;td&gt;500.93 ms&lt;&#x2F;td&gt;
        &lt;td&gt;506.25 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Median Absolute Deviation&quot;&gt;MAD&lt;&#x2F;td&gt;
        &lt;td&gt;129.84 µs&lt;&#x2F;td&gt;
        &lt;td&gt;4.1713 ms&lt;&#x2F;td&gt;
        &lt;td&gt;6.1184 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&#x27;s results for the original query with &lt;code&gt;COUNT&lt;&#x2F;code&gt; and &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;details&gt;
  &lt;summary&gt;
&lt;p&gt;The Probability Distribution Function graph, and the Iteration times graph for
the &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt; approach&lt;&#x2F;p&gt;
  &lt;&#x2F;summary&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-pdf.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-pdf.svg&quot; alt=&quot;Probability distribution function&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Probability Distribution Function for the &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-iteration-times.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;1-iteration-times.svg&quot; alt=&quot;Iteration times&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Iteration Times for the &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Lower bound&lt;&#x2F;th&gt;
        &lt;th&gt;Estimate&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Upper bound&lt;&#x2F;th&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;thead&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;Throughput&lt;&#x2F;td&gt;
        &lt;td&gt;251.61 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;251.84 Kelem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;251.98 Kelem&#x2F;s&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;math&gt;&lt;msup&gt;&lt;mi&gt;R&lt;&#x2F;mi&gt;&lt;mn&gt;2&lt;&#x2F;mn&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;0.9999778&lt;&#x2F;td&gt;
        &lt;td&gt;0.9999833&lt;&#x2F;td&gt;
        &lt;td&gt;0.9999673&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Mean&lt;&#x2F;td&gt;
        &lt;td&gt;39.684 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.703 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.726 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Standard Deviation&quot;&gt;Std. Dev.&lt;&#x2F;td&gt;
        &lt;td&gt;8.8237 µs&lt;&#x2F;td&gt;
        &lt;td&gt;35.948 µs&lt;&#x2F;td&gt;
        &lt;td&gt;47.987 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Median&lt;&#x2F;td&gt;
        &lt;td&gt;39.683 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.691 ms&lt;&#x2F;td&gt;
        &lt;td&gt;39.725 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Median Absolute Deviation&quot;&gt;MAD&lt;&#x2F;td&gt;
        &lt;td&gt;1.9369 µs&lt;&#x2F;td&gt;
        &lt;td&gt;13.000 µs&lt;&#x2F;td&gt;
        &lt;td&gt;50.566 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s results for the new query with the &lt;code&gt;CASE&lt;&#x2F;code&gt; expression.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;details&gt;
  &lt;summary&gt;
&lt;p&gt;The Probability Distribution Function graph, and the Linear Regression graph
for the &lt;code&gt;CASE&lt;&#x2F;code&gt; approach&lt;&#x2F;p&gt;
  &lt;&#x2F;summary&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-pdf.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-pdf.svg&quot; alt=&quot;Probability distribution function&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Probability Distribution Function for the &lt;code&gt;CASE&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-linear-regression.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;2-linear-regression.svg&quot; alt=&quot;Linear regression&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Linear Regression for the &lt;code&gt;CASE&lt;&#x2F;code&gt; approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;p&gt;The throughput and the time are &lt;math&gt;&lt;mn&gt;12.6&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; better. No
&lt;code&gt;INDEX&lt;&#x2F;code&gt;. No more &lt;code&gt;LEFT JOIN&lt;&#x2F;code&gt;. Just a simple &lt;code&gt;CASE&lt;&#x2F;code&gt; expression. &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;pull&#x2F;5411&quot;&gt;You can see the
patches containing the benchmark and the fix&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;But that&amp;#39;s not all…&lt;&#x2F;p&gt;
&lt;h2 id=&quot;&quot;&gt;&lt;math&gt;&lt;mn&gt;211&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;p&gt;It&amp;#39;s clearly better, but we couldn&amp;#39;t stop ourselves. Having spotted the problem,
and having found this solution, it has made us creative! We have noticed that
we are running one query per chunk of kind &lt;code&gt;ChunkContent::Items&lt;&#x2F;code&gt;. If the linked
chunk contains 100 chunks, it will run 101 queries.&lt;&#x2F;p&gt;
&lt;p&gt;Then suddenly, &lt;i&gt;hit forehead with the hand&amp;#39;s palm&lt;&#x2F;i&gt;, an idea pops! What if
we could only use 2 queries for all scenarios!&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;The first query would count all events for each chunk in &lt;code&gt;events_chunk&lt;&#x2F;code&gt; in
one pass, and would store that in a &lt;code&gt;HashMap&lt;&#x2F;code&gt;,&lt;&#x2F;li&gt;
&lt;li&gt;The second query would fetch all chunks also in one pass,&lt;&#x2F;li&gt;
&lt;li&gt;Finally, Rust will fill the number of events for each chunk based on the data
in the &lt;code&gt;HashMap&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;The first query translates like so in Rust:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;&#x2F;&#x2F; The first query.&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_events_by_chunk_ids&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; transaction&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;prepare&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        r#&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            ec.chunk_id,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            COUNT(ec.event_id)&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        FROM event_chunks as ec&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        WHERE ec.linked_chunk_id = ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        GROUP BY ec.chunk_id&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        &amp;quot;#&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;query_map&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;hashed_linked_chunk_id&lt;&#x2F;span&gt;&lt;span&gt;,),&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Ok&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; usize&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    })&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;collect&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;HashMap&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And the second query translates like so&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-simplified-code-1&quot;&gt;&lt;a href=&quot;#fn-simplified-code&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;:&lt;&#x2F;p&gt;
&lt;pre class=&quot;giallo z-code&quot;&gt;&lt;code data-lang=&quot;rust&quot;&gt;&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;transaction&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;prepare&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        r#&amp;quot;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        SELECT&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.id,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.previous,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.next,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;            lc.type&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        FROM linked_chunks as lc&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        WHERE lc.linked_chunk_id = ?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-string&quot;&gt;        &amp;quot;#&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    )&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;query_map&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;hashed_linked_chunk_id&lt;&#x2F;span&gt;&lt;span&gt;,),&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; |&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Ok&lt;&#x2F;span&gt;&lt;span&gt;((&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Option&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;u64&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            row&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; String&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        ))&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    })&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;|&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;| -&amp;gt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt; Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;identifier&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; chunk_type&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; metadata&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt;;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-comment&quot;&gt;        &#x2F;&#x2F; Let&amp;#39;s use the `HashMap` from the first query here!&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-storage&quot;&gt;        let&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_events&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt; =&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; number_of_events_by_chunk_ids&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;copied&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;.&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;unwrap_or&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-constant z-numeric&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;);&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;        Ok&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;ChunkMetadata&lt;&#x2F;span&gt;&lt;span&gt; {&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            identifier&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            previous&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            next&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-variable&quot;&gt;            number_of_events&lt;&#x2F;span&gt;&lt;span&gt;,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;        })&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span&gt;    })&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;
&lt;span class=&quot;giallo-l&quot;&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;    .&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name z-function&quot;&gt;collect&lt;&#x2F;span&gt;&lt;span class=&quot;z-keyword z-operator&quot;&gt;::&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Result&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-entity z-name&quot;&gt;Vec&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt;_&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;,&lt;&#x2F;span&gt;&lt;span class=&quot;z-variable&quot;&gt; _&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;()&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Only two queries. All tests are passing. Now let&amp;#39;s see what the benchmark has to
say!&lt;&#x2F;p&gt;
&lt;figure&gt;
  &lt;table&gt;
    &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Lower bound&lt;&#x2F;th&gt;
        &lt;th&gt;Estimate&lt;&#x2F;th&gt;
        &lt;th title=&quot;0.95 confidence level&quot;&gt;Upper bound&lt;&#x2F;th&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;thead&gt;
    &lt;tbody&gt;
      &lt;tr&gt;
        &lt;td&gt;Throughput&lt;&#x2F;td&gt;
        &lt;td&gt;4.1490 Melem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;4.1860 Melem&#x2F;s&lt;&#x2F;td&gt;
        &lt;td&gt;4.2221 Melem&#x2F;s&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;math&gt;&lt;msup&gt;&lt;mi&gt;R&lt;&#x2F;mi&gt;&lt;mn&gt;2&lt;&#x2F;mn&gt;&lt;&#x2F;msup&gt;&lt;&#x2F;math&gt;&lt;&#x2F;td&gt;
        &lt;td&gt;0.9961591&lt;&#x2F;td&gt;
        &lt;td&gt;0.9976310&lt;&#x2F;td&gt;
        &lt;td&gt;0.9960356&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Mean&lt;&#x2F;td&gt;
        &lt;td&gt;2.3670 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.3824 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.3984 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Standard Deviation&quot;&gt;Std. Dev.&lt;&#x2F;td&gt;
        &lt;td&gt;16.065 µs&lt;&#x2F;td&gt;
        &lt;td&gt;26.872 µs&lt;&#x2F;td&gt;
        &lt;td&gt;31.871 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td&gt;Median&lt;&#x2F;td&gt;
        &lt;td&gt;2.3556 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.3801 ms&lt;&#x2F;td&gt;
        &lt;td&gt;2.4047 ms&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
      &lt;tr&gt;
        &lt;td title=&quot;Median Absolute Deviation&quot;&gt;MAD&lt;&#x2F;td&gt;
        &lt;td&gt;3.8003 µs&lt;&#x2F;td&gt;
        &lt;td&gt;36.438 µs&lt;&#x2F;td&gt;
        &lt;td&gt;46.445 µs&lt;&#x2F;td&gt;
      &lt;&#x2F;tr&gt;
    &lt;&#x2F;tbody&gt;
  &lt;&#x2F;table&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s results for the two queries approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
&lt;&#x2F;figure&gt;
&lt;details&gt;
  &lt;summary&gt;
&lt;p&gt;The Probability Distribution Function graph, and the Linear Regression graph
for the two queries approach&lt;&#x2F;p&gt;
  &lt;&#x2F;summary&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-pdf.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-pdf.svg&quot; alt=&quot;Probability distribution function&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Probability Distribution Function for the two queries approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
  &lt;figure&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-linear-regression.svg&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;mnt.io&#x2F;articles&#x2F;from-19k-to-4-2m-events-per-sec-story-of-a-sqlite-query-optimisation&#x2F;.&#x2F;3-linear-regression.svg&quot; alt=&quot;Linear regression&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
  &lt;figcaption&gt;
&lt;p&gt;Benchmark&amp;#39;s Linear Regression for the two queries approach.&lt;&#x2F;p&gt;
  &lt;&#x2F;figcaption&gt;
  &lt;&#x2F;figure&gt;
&lt;&#x2F;details&gt;
&lt;p&gt;&lt;strong&gt;It is &lt;math&gt;&lt;mn&gt;16.7&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster compared to the previous
solution, so &lt;math&gt;&lt;mn&gt;211&lt;&#x2F;mn&gt;&lt;mo&gt;×&lt;&#x2F;mo&gt;&lt;&#x2F;math&gt; faster than the first query!
We went from 502ms to 2ms. That&amp;#39;s mental! From a throughput of 19.9 Kelem&#x2F;s
to 4.2 Melem&#x2F;s!&lt;&#x2F;strong&gt; &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;matrix-org&#x2F;matrix-rust-sdk&#x2F;pull&#x2F;5425&quot;&gt;You can see the patches containing the improvement&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The throughput is measured by &lt;em&gt;element&lt;&#x2F;em&gt;, where an &lt;em&gt;element&lt;&#x2F;em&gt; here represents
a Matrix event. Consequently, 4 Melem&#x2F;s means 4 millions events per second,
which means that &lt;code&gt;load_all_chunks_metadata&lt;&#x2F;code&gt; can do its computation at a rate of
4 millions events per second.&lt;&#x2F;p&gt;
&lt;p&gt;I think we can stop here. Performance are finally acceptable.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;-1&quot;&gt;Lessons&lt;a role=&quot;presentation&quot; class=&quot;anchor&quot; href=&quot;#-1&quot; title=&quot;Anchor link to this header&quot;&gt;#&lt;&#x2F;a&gt;
&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;bheisler.github.io&#x2F;criterion.rs&#x2F;book&#x2F;index.html&quot;&gt;Write benchmarks (with Criterion)&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;Run benchmarks.&lt;&#x2F;li&gt;
&lt;li&gt;Be aware of &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;sqlite.org&#x2F;queryplanner-ng.html&quot;&gt;the SQL query planner&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;Be careful with joins.&lt;&#x2F;li&gt;
&lt;li&gt;Know your data.&lt;&#x2F;li&gt;
&lt;li&gt;Take a step back and count.&lt;&#x2F;li&gt;
&lt;li&gt;SQLite is fast.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Notice how the SQL tables layout didn&amp;#39;t change. Notice how the &lt;code&gt;LinkedChunk&lt;&#x2F;code&gt;
implementation didn&amp;#39;t change. Only the SQL queries have changed, and it has
dramatically improved the situation.&lt;&#x2F;p&gt;
&lt;p&gt;This is joint effort between &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;bouvier.cc&#x2F;&quot;&gt;Benjamin Bouvier&lt;&#x2F;a&gt;, &lt;a rel=&quot;noopener external&quot; target=&quot;_blank&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;poljar&quot;&gt;Damir Jelić&lt;&#x2F;a&gt; and
I.&lt;&#x2F;p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn-power-user&quot;&gt;
&lt;p&gt;We consider a &lt;em&gt;power-user&lt;&#x2F;em&gt; a user with more than 2000 rooms. I
hear your laugth! But guess what? We have users with more than 4000 rooms.
And I&amp;#39;m excluding bots here. The Matrix Rust SDK can be used to develop
bots, which can sit in thousands and thousands rooms easily. That said: we
have to be performant. &lt;a href=&quot;#fr-power-user-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-simplified-code&quot;&gt;
&lt;p&gt;The code has been simplified a little bit. In reality, basic
Rust types, like &lt;code&gt;u64&lt;&#x2F;code&gt; or &lt;code&gt;Option&amp;lt;u64&amp;gt;&lt;&#x2F;code&gt;, are mapped to linked chunk&amp;#39;s types. &lt;a href=&quot;#fr-simplified-code-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;section&gt;
</description>
      </item>
    </channel>
</rss>
